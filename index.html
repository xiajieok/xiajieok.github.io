<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Kubernetes%E7%9A%84%E8%B0%83%E5%BA%A6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Kubernetes%E7%9A%84%E8%B0%83%E5%BA%A6.html" class="post-title-link" itemprop="url">Kubernetes的调度</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h2><h3 id="基本概述"><a href="#基本概述" class="headerlink" title="基本概述"></a>基本概述</h3><p>kube-scheduler 是kubernetes 集群的默认调度器，该调度器将Pod绑定在对应的node上，之后对应的node上的kubelet才能够创建和运行Pod。<br>对每个新建的Pod或者未被调度的Pod，kube-scheduler 会选择一个最优的node去运行这个Pod。Pod内的每个容器以及自身都有不通的资源需求。因此，Pod在被调度之前，会根据特定的资源调度需求，对集群中的Node进行一次过滤。<br>调度器会在集群中过滤后的可调度节点，根据一些列函数进行打分，最终选择出得分最高的node。之后，调度器将这个调度通知给kube-apiserver，进行绑定。</p>
<h2 id="亲和性"><a href="#亲和性" class="headerlink" title="亲和性"></a>亲和性</h2><p>原则</p>
<ul>
<li>同时指定了nodeSelector和nodeAffinity，必须同时满足两个条件</li>
<li>如果nodeAffinity指定了多个nodeSelectorTerms，满足一个即可</li>
<li>如果在nodeSelectorTerms中有多个matchExpressions,则一个节点必须满足全部才可以加</li>
<li>如果修改或删除了Pod所调度到的节点的标签，Pod不会被删除</li>
<li>软策略中的weight属性代表权重，范围1-100。如果存在多个软策略的话，权重越大越亲和。对于反亲和规则而言，权重越大越不亲和</li>
</ul>
<p>应用的运行对于kubernetes在亲和性上有一些要求，可以概况为以下几个方面：</p>
<ol>
<li>Pod固定调度的某些节点上</li>
<li>Pod不会调度到某些节点上</li>
<li>Pod的多个副本调度到相同节点上</li>
<li>Pod的多个副本调度不同节点上</li>
</ol>
<h3 id="调度到某些节点上"><a href="#调度到某些节点上" class="headerlink" title="调度到某些节点上"></a>调度到某些节点上</h3><h4 id="方式一、nodeSelector"><a href="#方式一、nodeSelector" class="headerlink" title="方式一、nodeSelector"></a>方式一、nodeSelector</h4><p>在对于Pod的定义中通过nodeSelector指定label，Pod将会只调度到具有该标签的node上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">env</span>: <span class="built_in">test</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  nodeSelector:</span><br><span class="line">    disktype: ssd</span><br></pre></td></tr></table></figure>

<p>上述例子中，Pod将会只调度到包含disktype&#x3D;ssd的node上。</p>
<h4 id="方式二、nodeName"><a href="#方式二、nodeName" class="headerlink" title="方式二、nodeName"></a>方式二、nodeName</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webpc</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webpc</span><br><span class="line">    spec:</span><br><span class="line">      nodeName: web-server</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<p>上述例子中，将会只调度到主机名为web-server的node上。</p>
<h4 id="方式三、亲和性"><a href="#方式三、亲和性" class="headerlink" title="方式三、亲和性"></a>方式三、亲和性</h4><p>NodeAffinity 亲和性调度，用来取代nodeSelector的策略，支持IN，NOTLn，exists,doesNotExit,GT,Lt。</p>
<p>又分为两类：</p>
<ol>
<li>soft，表示调度的时候，无法满足节点的时候会选择非nodeSelector匹配的节点。PreferredDuringSchedulingIgnoreDuringExecution 优先满足制定规则，并不强求</li>
<li>hard，表示调度的时候，必须满足亲和性设置。requiredDuringSchedulingIgnoredDuringExecution 必须调度到满足条件的节点，如不满足，则一直重试。</li>
</ol>
<p>也可以分为三类：</p>
<ol>
<li>亲和节点 NodeAffinity</li>
<li>亲和Pod podAffinity</li>
<li>不亲和Pod podAntiAffinity</li>
</ol>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">&quot;eureka&quot;</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka-pod</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka-pod</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        nodeAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            nodeSelectorTerms:</span><br><span class="line">              - matchExpressions:</span><br><span class="line">                - key: kubernetes.io/hostname</span><br><span class="line">                  operator: In</span><br><span class="line">                  values:</span><br><span class="line">                    - k8s-node-217</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证，新的Pod已经调度到k8s-node-217</span></span><br><span class="line">~<span class="comment"># kubectl get pods -o wide |grep eureka</span></span><br><span class="line">eureka-0                  1/1     Running             0          2d23h   10.200.128.142   uat-master     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">eureka-1                  1/1     Running             0          2d23h   10.200.128.141   uat-master     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">eureka-2                  0/1     ContainerCreating   0          1s      &lt;none&gt;           k8s-node-217   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述示例中，terms满足一个条件就行（或的关系），但是match的条件必须全部满足（且的关系）。</p>
<h3 id="调度到不同的节点"><a href="#调度到不同的节点" class="headerlink" title="调度到不同的节点"></a>调度到不同的节点</h3><p>调度到不同的节点，在亲和性中的应用需要使用到topolgyKey。toplogyKey 对应的值是node上的一个标签的名称，比如节点zone&#x3D;A 标签，其他节点有zone&#x3D;B 标签。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">KIND:     StatefulSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: affinity &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     If specified, the pod<span class="string">&#x27;s scheduling constraints</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     Affinity is a group of affinity scheduling rules.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FIELDS:</span></span><br><span class="line"><span class="string">   nodeAffinity	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Describes node affinity scheduling rules for the pod.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   podAffinity	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Describes pod affinity scheduling rules (e.g. co-locate this pod in the</span></span><br><span class="line"><span class="string">     same node, zone, etc. as some other pod(s)).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   podAntiAffinity	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod</span></span><br><span class="line"><span class="string">     in the same node, zone, etc. as some other pod(s)).</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain --api-version=apps/v1 sts.spec.template.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution.topologyKey</span><br><span class="line">KIND:     StatefulSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">FIELD:    topologyKey &lt;string&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     This pod should be co-located (affinity) or not co-located (anti-affinity)</span><br><span class="line">     with the pods matching the labelSelector <span class="keyword">in</span> the specified namespaces, <span class="built_in">where</span></span><br><span class="line">     co-located is defined as running on a node whose value of the label with</span><br><span class="line">     key topologyKey matches that of any node on <span class="built_in">which</span> any of the selected pods</span><br><span class="line">     is running. Empty topologyKey is not allowed.</span><br></pre></td></tr></table></figure>

<p>topology 就是拓扑的意思，指的是一个拓扑域，一个范围的概念，比如一个node、一个机柜、一个机房，实际对应的是node的标签。而这里的topologyKey对应的是node上标签的Key。那么怎么样才算属于一个拓扑域呢？</p>
<p>如果使用<code>k8s.io/hostname</code>，则表示拓扑域为node范围，那么<code>k8s.io/hostname</code> 对应的值不一样的就是不同的拓扑域。比如Pod1在<code>k8s.io/hostname=n1</code>的node上，Pod2在<code>k8s.io/hostname=n2</code>的node上，Pod3在<code>k8s.io/hostname=n1</code>的node上。那么Pod1和Pod3在一个拓扑域，Pod2 则和其他两个Pod不在同一个拓扑域。因此，概况来说，拥有相同标签的key，就可以认定为在同一个拓扑域。</p>
<p>原则上，topologyKey可以是任何合法的标签key，但是有一些限制：</p>
<ol>
<li>topologyKey不可以为空</li>
<li>对于 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 的 Pod 反亲和性，引入 LimitPodHardAntiAffinityTopology 准入控制器来限制 topologyKey 只能是 kubernetes.io&#x2F;hostname。如果要使用自定义拓扑域，则可以修改准入控制器，或者直接禁用它。</li>
<li>对于 preferredDuringSchedulingIgnoredDuringExecution 的 Pod 反亲和性，空的 topologyKey 表示所有拓扑域。除上述情况外，topologyKey 可以是任何合法的标签 key。</li>
</ol>
<p>此外，还有一些官网文档中提示的拓扑域可以使用：</p>
<ol>
<li>topology.kubernetes.io&#x2F;region</li>
<li>topology.kubernetes.io&#x2F;zone</li>
</ol>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">&quot;eureka&quot;</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka-pod</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka-pod</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - topologyKey: kubernetes.io/hostname</span><br><span class="line">              labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                - key: app</span><br><span class="line">                  operator: In</span><br><span class="line">                  values:</span><br><span class="line">                  - eureka-pod</span><br></pre></td></tr></table></figure>

<p>上述示例中指定创建了label为<code>app=eureka-pod</code> 的statefulSet，并且指定副本数量为3。根据反亲和性规则，以<code>kubernetes.io/hostname</code>为key的拓扑域，将不会调度到node上已经运行了label为<code>app=eureka-pod</code>的Pod，这样就会将3个副本分别部署在不同hostname的node上。</p>
<p>验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># kubectl get pods -o wide |grep eureka</span></span><br><span class="line">eureka-0                  1/1     Running   0          5m47s   10.200.128.152   uat-master     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">eureka-1                  0/1     Pending   0          38s     &lt;none&gt;           &lt;none&gt;         &lt;none&gt;           &lt;none&gt;</span><br><span class="line">eureka-2                  1/1     Running   0          108s    10.200.96.155    k8s-node-217   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>由于示例中只有两个node，因此有一个Pod处于pending状态，但是其他的两个节点均被分配了Pod。</p>
<p>亲和性的进阶应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    podAntiAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        - topologyKey: kubernetes.io/hostname</span><br><span class="line">          labelSelector:</span><br><span class="line">            matchExpressions:</span><br><span class="line">            - key: app</span><br><span class="line">              operator: In</span><br><span class="line">              values:</span><br><span class="line">              - eureka-pod</span><br><span class="line">    podAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        - topologyKey: kubernetes.io/hostname</span><br><span class="line">          labelSelector:</span><br><span class="line">            matchExpressions:</span><br><span class="line">            - key: app</span><br><span class="line">              operator: In</span><br><span class="line">              values:</span><br><span class="line">              - geteway-pod</span><br></pre></td></tr></table></figure>

<p>上述例子中，根据反亲和性和亲和性规则，每个节点上都会有eureka-pod的Pod，和gateway-pod的Pod。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/labels-annotations-taints/">https://kubernetes.io/zh/docs/reference/labels-annotations-taints/</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%20(%E4%BA%8C).html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%20(%E4%BA%8C).html" class="post-title-link" itemprop="url">深入理解StatefulSet（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇介绍了 StatefulSet 的基础原理，但是只使用了应用之一的拓扑状态。这一篇将会介绍使用存储状态。</p>
<h3 id="应用背景"><a href="#应用背景" class="headerlink" title="应用背景"></a>应用背景</h3><p>应用的多个实例分别绑定了不同的存储数据。典型例子就是一个数据库应用的多个存储实例。StatefulSet 的核心功能就是通过某种方式记录这些状态，然后在Pod被重新创建时，能够为新Pod恢复这些状态。比较典型之一，Redis的主从架构。</p>
<h3 id="知识点解析"><a href="#知识点解析" class="headerlink" title="知识点解析"></a>知识点解析</h3><h4 id="主从架构"><a href="#主从架构" class="headerlink" title="主从架构"></a>主从架构</h4><p><img src="https://img.mknight.cn/medivh/1649409054685.png" alt="1649409054685.png"></p>
<p>当我们启动多个redis实例的时候，他们相互之间就可以通过slaveof 命令形成主库和从库关系，之后会按照三个阶段完成数据的第一次同步。</p>
<ol>
<li>第一阶段是主从库间建立连接、协商同步的过程，主要是为全量复制做准备。在这一步，从库和主库建立连接，并告诉主库即将建立连接，主库确认回复后，主从库间就可以开始同步了。</li>
<li>在第二阶段，主库将所有数据同步给从库。从库收到数据后，在本地完成数据加载。这个过程依赖于内存快照RDB。</li>
<li>第三个阶段，主库会把第二阶段执行过程中新收到的写命令，再发送给从库。具体的操作是，当主库完成RDB文件发送后，就会把此时replocation buffer中修改操作发送给从库，从库再执行这些操作。这样一来，主从库就实现同步了。</li>
</ol>
<p>之后的同步如果不出现意外，都会采用增量的方式进行同步。</p>
<p>此外，有一些其他注意事项：</p>
<ul>
<li>为避免数据混乱，从节点是默认不允许写的</li>
<li>首次连接需要同步全量 RDB ，此后执行基于长连接的命令传播</li>
<li>建议使用 主-从-从 的级联架构，减轻每一个从节点连进来主节点都要进行一次生成RDB和传输RDB的压力</li>
<li>从节点断连后，如短时间内重新连入，则只需要进行增量更新。如未同步的数据过多 （repl_backlog_buffer中未同步的数据已被覆盖），则需要进行一次全量同步</li>
</ul>
<p>综上所述，Redis主从架构的基本原理在于同步和保持可用性的持久化。</p>
<h4 id="PV-PVC"><a href="#PV-PVC" class="headerlink" title="PV&#x2F;PVC"></a>PV&#x2F;PVC</h4><p>PV (PersistentVolume）是设置的存储，群集的一部分，也是一种资源。场景的PV有很多种，比如NAS、NFS和ceph等等。</p>
<p>PVC 是用户的存储请求，和Pod类似。Pod消耗节点资源，PVC消耗PV资源。并且可以设置请求特定的大小和模式。其主要作用是确保相关Pod正在使用的PVC不会从系统中删除。因为如果被移除的话会导致数据丢失。</p>
<p>PV访问模式:</p>
<ol>
<li>ReadWriteOnce——该卷可以被单个节点以读&#x2F;写模式挂载</li>
<li>ReadOnlyMany——该卷可以被多个节点以只读模式挂载</li>
<li>ReadWriteMany——该卷可以被多个节点以读&#x2F;写模式挂载</li>
</ol>
<p>在命令行中，访问模式缩写为：</p>
<ul>
<li>RWO - ReadWriteOnce</li>
<li>ROX - ReadOnlyMany</li>
<li>RWX - ReadWriteMany</li>
</ul>
<p>PVC回收策略：</p>
<ol>
<li>Retain（保留）——手动回收</li>
<li>Recycle（回收）——基本擦除（ rm -rf &#x2F;thevolume&#x2F;* ）</li>
<li>Delete（删除）——关联的存储资产（例如 AWS EBS、GCE PD、Azure Disk 和 OpenStack Cinder 卷）</li>
</ol>
<p>将被删除当前，只有 NFS 和 HostPath 支持回收策略。AWS EBS、GCE PD、Azure Disk 和 Cinder 卷支持删除策略。</p>
<p>PVC的状态：</p>
<ol>
<li>Available（可用）——一块空闲资源还没有被任何声明绑定</li>
<li>Bound（已绑定）——卷已经被声明绑定</li>
<li>Released（已释放）——声明被删除，但是资源还未被集群重新声明</li>
<li>Failed（失败）——该卷的自动回收失败</li>
</ol>
<p>使用PVC时需要注意，在每个node节点上都需要安装nfs-utis，不然会报错，比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  Warning  FailedMount  54s (x8 over 117s)  kubelet            MountVolume.SetUp failed <span class="keyword">for</span> volume <span class="string">&quot;redis01&quot;</span> : mount failed: <span class="built_in">exit</span> status 32</span><br><span class="line">Mounting <span class="built_in">command</span>: mount</span><br><span class="line">Mounting arguments: -t nfs 192.168.1.10:/Public/redis-master /var/lib/kubelet/pods/0645dd81-4bba-4fd5-bf08-ffeb72367254/volumes/kubernetes.io~nfs/redis01</span><br><span class="line">Output: mount: wrong fs <span class="built_in">type</span>, bad option, bad superblock on 192.168.1.10:/Public/redis-master,</span><br><span class="line">       missing codepage or helper program, or other error</span><br><span class="line">       (<span class="keyword">for</span> several filesystems (e.g. nfs, cifs) you might</span><br><span class="line">       need a /sbin/mount.&lt;<span class="built_in">type</span>&gt; helper program)</span><br><span class="line"></span><br><span class="line">       In some cases useful info is found <span class="keyword">in</span> syslog - try</span><br><span class="line">       dmesg | <span class="built_in">tail</span> or so.</span><br></pre></td></tr></table></figure>

<h3 id="应用部署"><a href="#应用部署" class="headerlink" title="应用部署"></a>应用部署</h3><h4 id="创建PV"><a href="#创建PV" class="headerlink" title="创建PV"></a>创建PV</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: redis01 <span class="comment"># PV名字</span></span><br><span class="line">spec:</span><br><span class="line">  storageClassName: redis <span class="comment">#卷的名字</span></span><br><span class="line">  persistentVolumeReclaimPolicy: Retain <span class="comment">#回收模式</span></span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce <span class="comment"># 访问模式</span></span><br><span class="line">  nfs:</span><br><span class="line">    path: /Public/redis-master <span class="comment"># NFS目录</span></span><br><span class="line">    server: 192.168.1.10 <span class="comment"># nfs 信息</span></span><br><span class="line">----</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: redis02</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: redis</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  nfs:</span><br><span class="line">    path: /Public/redis2</span><br><span class="line">    server: 192.168.1.10</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: redis03</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: redis</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  nfs:</span><br><span class="line">    path: /Public/redis3</span><br><span class="line">    server: 192.168.1.10</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@uat-master ~]# kubectl get pv</span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                               STORAGECLASS   REASON   AGE</span><br><span class="line">redis01   1Gi        RWO            Retain           Bound    default/redis-data-redis-master-0   redis                   60m</span><br><span class="line">redis02   1Gi        RWO            Retain           Bound    default/redis-data-redis-slave-0    redis                   60m</span><br><span class="line">redis03   1Gi        RWO            Retain           Bound    default/redis-data-redis-slave-1    redis                   60m</span><br></pre></td></tr></table></figure>

<h4 id="redis配置文件"><a href="#redis配置文件" class="headerlink" title="redis配置文件"></a>redis配置文件</h4><p>redis-cm.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-config</span><br><span class="line">data:</span><br><span class="line">  master.conf: |</span><br><span class="line">        port 6379</span><br><span class="line">  slave.conf: |</span><br><span class="line">    port 6379</span><br><span class="line">    slaveof redis-master-0.redis-master 6379</span><br></pre></td></tr></table></figure>

<p>redis-master-sts.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-master</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis-master</span><br><span class="line">  serviceName: redis-master</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis-master</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: redis</span><br><span class="line">          image: redis</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">          args:</span><br><span class="line">            - -c</span><br><span class="line">            - redis-server /usr/local/etc/redis/redis.conf</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 6379</span><br><span class="line">              name: masterport</span><br><span class="line">              protocol: TCP</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /usr/local/etc/redis</span><br><span class="line">              name: conf</span><br><span class="line">            - name: redis-data</span><br><span class="line">              mountPath: /data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: conf</span><br><span class="line">          configMap:</span><br><span class="line">            name: redis-config</span><br><span class="line">            items:</span><br><span class="line">              - key: master.conf</span><br><span class="line">                path: redis.conf</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: redis-data</span><br><span class="line">    spec: <span class="comment"># 必须满足下面两个，pod才会绑定到pv上面</span></span><br><span class="line">      accessModes: [ <span class="string">&quot;ReadWriteOnce&quot;</span> ] <span class="comment">#读取模式</span></span><br><span class="line">      storageClassName: <span class="string">&quot;redis&quot;</span> <span class="comment"># 绑定pv名字为redis</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi</span><br></pre></td></tr></table></figure>

<p>redis-slave-sts.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-slave</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis-slave</span><br><span class="line">  serviceName: redis-slave</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis-slave</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: redis</span><br><span class="line">          image: redis</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          <span class="built_in">command</span>:</span><br><span class="line">            - sh</span><br><span class="line">          args:</span><br><span class="line">            - -c</span><br><span class="line">            - redis-server /usr/local/etc/redis/redis.conf</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 6379</span><br><span class="line">              name: redis-slave</span><br><span class="line">              protocol: TCP</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /usr/local/etc/redis</span><br><span class="line">              name: conf</span><br><span class="line">            - name: redis-data</span><br><span class="line">              mountPath: /data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: conf</span><br><span class="line">          configMap:</span><br><span class="line">            name: redis-config</span><br><span class="line">            items:</span><br><span class="line">              - key: slave.conf</span><br><span class="line">                path: redis.conf</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: redis-data</span><br><span class="line">    spec: <span class="comment"># 必须满足下面两个，pod才会绑定到pv上面</span></span><br><span class="line">      accessModes: [ <span class="string">&quot;ReadWriteOnce&quot;</span> ] <span class="comment"># 读取模式</span></span><br><span class="line">      storageClassName: <span class="string">&quot;redis&quot;</span> <span class="comment"># 绑定pv名字为redis</span></span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi</span><br></pre></td></tr></table></figure>

<p>master-head.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-master</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: redis-master</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">    - port: 6379</span><br><span class="line">      targetPort: 6379</span><br><span class="line">      name: redis</span><br></pre></td></tr></table></figure>

<p>slave-head.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-slave</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 6379</span><br><span class="line">      targetPort: 6379</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: redis-slave</span><br><span class="line">  clusterIP: None</span><br></pre></td></tr></table></figure>

<p>上述编排文件都apply后，检查：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@uat-master ~]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                               STORAGECLASS   REASON   AGE</span><br><span class="line">redis01   1Gi        RWO            Retain           Bound    default/redis-data-redis-master-0   redis                   72m</span><br><span class="line">redis02   1Gi        RWO            Retain           Bound    default/redis-data-redis-slave-0    redis                   72m</span><br><span class="line">redis03   1Gi        RWO            Retain           Bound    default/redis-data-redis-slave-1    redis                   72m</span><br><span class="line">[root@uat-master ~]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME                        STATUS   VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">redis-data-redis-master-0   Bound    redis01   1Gi        RWO            redis          54m</span><br><span class="line">redis-data-redis-slave-0    Bound    redis02   1Gi        RWO            redis          51m</span><br><span class="line">redis-data-redis-slave-1    Bound    redis03   1Gi        RWO            redis          40m</span><br></pre></td></tr></table></figure>

<p>登录master pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@uat-master ~]<span class="comment"># kubectl exec -it po/redis-master-0 -- bash</span></span><br><span class="line">root@redis-master-0:/data<span class="comment"># ls -l</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 196 Apr  8 09:01 dump.rdb</span><br><span class="line">root@redis-master-0:/data<span class="comment"># pwd</span></span><br><span class="line">/data</span><br><span class="line">root@redis-master-0:/data<span class="comment"># df -h</span></span><br><span class="line">Filesystem                         Size  Used Avail Use% Mounted on</span><br><span class="line">overlay                             46G   15G   31G  33% /</span><br><span class="line">tmpfs                               64M     0   64M   0% /dev</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">192.168.1.10:/Public/redis-master  1.3T  505G  816G  39% /data</span><br><span class="line">/dev/mapper/centos-root             46G   15G   31G  33% /etc/hosts</span><br><span class="line">shm                                 64M     0   64M   0% /dev/shm</span><br><span class="line">tmpfs                              2.0G   12K  2.0G   1% /run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /proc/acpi</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /proc/scsi</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /sys/firmware</span><br><span class="line">root@redis-master-0:/data<span class="comment"># ls -l</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 196 Apr  8 09:01 dump.rdb</span><br><span class="line">root@redis-master-0:/data<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; info Replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=10.200.96.163,port=6379,state=online,offset=3668,lag=1</span><br><span class="line">slave1:ip=10.200.96.159,port=6379,state=online,offset=3668,lag=1</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:33c2abd3e8ee089411772f5b64790d9463400872</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:3668</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:3668</span><br><span class="line">127.0.0.1:6379&gt; info Keyspace</span><br><span class="line"><span class="comment"># Keyspace</span></span><br><span class="line">db0:keys=2,expires=0,avg_ttl=0</span><br></pre></td></tr></table></figure>

<p>在显示信息中看到了slave节点的信息，而且生成了rdb文件。之后检查nfs上也存在对应的文件，无论是master pod还是slave pod对应的目录。</p>
<p>解析DNS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># nslookup redis-slave.default.svc.cluster.local</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      redis-slave.default.svc.cluster.local</span><br><span class="line">Address 1: 10.200.128.144 redis-slave-0.redis-slave.default.svc.cluster.local</span><br><span class="line">Address 2: 10.200.96.162 redis-slave-1.redis-slave.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup redis-master.default.svc.cluster.local</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      redis-master.default.svc.cluster.local</span><br><span class="line">Address 1: 10.200.128.143 redis-master-0.redis-master.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>稳定的持久化存储，Pod重新调度后还是能访问到相同的持久化数据，基于PVC来实现</li>
<li>稳定的网络标识符，Pod重新调度后PodName和HostName不变</li>
<li>有序部署和扩展</li>
<li>有序收缩</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Redis%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Redis%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98.html" class="post-title-link" itemprop="url">Redis集群技术演变</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>按照需求来分，将实例区分为单机和集群两种类型。</p>
<ul>
<li>单机适合容量和性能要求不高的小型存储</li>
<li>集群应对性能和容量要求较高的场景</li>
</ul>
<h2 id="单机"><a href="#单机" class="headerlink" title="单机"></a>单机</h2><h3 id="安全加固"><a href="#安全加固" class="headerlink" title="安全加固"></a>安全加固</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rename-command FLUSHALL &quot;&quot;</span><br><span class="line">rename-command FLUSHDB  &quot;&quot;</span><br><span class="line">rename-command CONFIG   &quot;&quot;</span><br><span class="line">rename-command KEYS     &quot;&quot;</span><br><span class="line">rename-command SHUTDOWN &quot;&quot;</span><br><span class="line">rename-command DEL &quot;&quot;</span><br><span class="line">rename-command EVAL &quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>但是注意是否和以下故障切换是否冲突“config”</p>
<h3 id="原生主从（master-slave"><a href="#原生主从（master-slave" class="headerlink" title="原生主从（master-slave)"></a>原生主从（master-slave)</h3><p>实现高可用，暴露master节点。支持Redis所有指令。<br>使用Redis 自带的哨兵（Sentinel）集群对实例进行状态监控与 Failover。Sentinel 是 Redis 自带的高可用组件，将 Redis 注册到由多个 Sentinel 组成的 Sentinel 集群后，Sentinel 会对 Redis 实例进行健康检查，当 Redis 发生故障后，Sentinel 会通过 Gossip 协议进行故障检测，确认宕机后会通过一个简化的 Raft 协议来提升 Slave 成为新的 Master。</p>
<img src="https://img.mknight.cn/medivh/1562750986206.png"  />

<p>通常情况仅使用1 个 Slave 节点进行冷备，如果有读写分离请求，可以建立多个Read only slave 来进行读写分离。</p>
<ul>
<li>只读Slave 节点可以按照需求设置 slave-priority 参数为0，防止故障切换时选择了只读节点而不是热备 Slave 节点；</li>
<li>Sentinel 进行故障切换后会执行 CONFIG REWRITE 命令将SLAVEOF 配置落地，如果 Redis 配置中禁用了 CONFIG 命令，切换时会发生错误，可以通过修改 Sentinel 代码来替换 CONFIG 命令；</li>
<li>Sentinel Group 监控的节点不宜过多，实测超过 500 个切换过程偶尔会进入 TILT 模式，导致Sentinel 工作不正常，推荐部署多个 Sentinel 集群并保证每个集群监控的实例数量小于 300 个；</li>
<li>Master 节点应与 Slave 节点跨机器部署，有能力的使用方可以跨机架部署，不推荐跨机房部署 Redis 主从实例；</li>
<li>Sentinel 切换功能主要依赖 down-after-milliseconds 和failover-timeout 两个参数，down-after-milliseconds 决定了Sentinel 判断 Redis 节点宕机的超时，知乎使用 30000 作为阈值。而 failover-timeout 则决定了两次切换之间的最短等待时间，如果对于切换成功率要求较高，可以适当缩短failover-timeout 到秒级保证切换成功，具体详见Redis 官方文档[2]；</li>
<li>单机网络故障等同于机器宕机，但如果机房全网发生大规模故障会造成主从多次切换，此时资源发现服务可能更新不够及时，需要人工介入。</li>
</ul>
<h3 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h3><p>Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：</p>
<ul>
<li>监控（Monitoring）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li>
<li>提醒（Notification）： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li>
<li>自动故障迁移（Automatic failover）： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</li>
</ul>
<p>优点：</p>
<ul>
<li>基于主从模式，所有主从的优点，sentinel都有</li>
<li>主从可以切换，故障可以转移，系统可用性好</li>
<li>是主从模式的升级，系统更健壮，可用性更高</li>
</ul>
<p>缺点：</p>
<ul>
<li>较难支持在线扩容</li>
<li>在集群容量达到上限时只能升级机器内存，而不能实现水平扩容</li>
</ul>
<p>主从同步可能会遇到的问题：</p>
<ul>
<li>端口不通</li>
<li>认证失败</li>
</ul>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>端口</th>
<th>其他</th>
</tr>
</thead>
<tbody><tr>
<td>Master,Sentinel1</td>
<td>192.168.1.233</td>
<td>6379,26379</td>
<td></td>
</tr>
<tr>
<td>slave01,Sentinel2</td>
<td>192.168.1.234</td>
<td>6379,26379</td>
<td></td>
</tr>
<tr>
<td>slave02,Sentinel3</td>
<td>192.168.1.235</td>
<td>6379,26379</td>
<td></td>
</tr>
</tbody></table>
<h4 id="配置redis文件"><a href="#配置redis文件" class="headerlink" title="配置redis文件"></a>配置redis文件</h4><ul>
<li>在3台服务器上分别安装Redis。需要注意的是，如果要给Redis设置密码，需要在3个Redis的配置文件中设置相同的密码。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#master</span><br><span class="line">requirepass &quot;Redis-Password&quot;</span><br><span class="line">#slave </span><br><span class="line">masterauth  &quot;Redis-Password&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>在2个SlaveRedis的配置文件中声明所从属的主数据库。<code>slaveof 192.168.1.233 6379</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">daemonize                   yes    </span><br><span class="line">pidfile                     /var/run/redis.pid</span><br><span class="line">port                        6379     </span><br><span class="line">bind                        192.168.1.233</span><br><span class="line">timeout                     120     </span><br><span class="line">tcp-keepalive               60     </span><br><span class="line">loglevel                    notice  </span><br><span class="line">logfile                     /var/log/redis/redis.log</span><br><span class="line">syslog-enabled              no</span><br><span class="line">databases                   16     </span><br><span class="line">stop-writes-on-bgsave-error no</span><br><span class="line">rdbcompression              yes</span><br><span class="line">rdbchecksum                 yes</span><br><span class="line">dbfilename                  dump.rdb</span><br><span class="line">dir                         /var/lib/redis</span><br><span class="line">save                        7200    100000</span><br><span class="line">maxclients                  10000    </span><br><span class="line">maxmemory                   1GB</span><br><span class="line">maxmemory-policy            volatile-lru</span><br><span class="line">maxmemory-samples           5</span><br><span class="line">appendonly                  no</span><br><span class="line">appendfilename              appendonly.aof    </span><br><span class="line">hash-max-ziplist-entries    512     </span><br><span class="line">hash-max-ziplist-value      64</span><br><span class="line">list-max-ziplist-entries    512</span><br><span class="line">list-max-ziplist-value      64</span><br><span class="line">set-max-intset-entries      512</span><br><span class="line">zset-max-ziplist-entries    128</span><br><span class="line">zset-max-ziplist-value      64</span><br><span class="line">activerehashing             yes     </span><br><span class="line">client-output-buffer-limit  normal                      0      0     0</span><br><span class="line">client-output-buffer-limit  slave                       256mb  64mb  60</span><br><span class="line">client-output-buffer-limit  pubsub                      256mb  64b   120</span><br><span class="line">hz                          10</span><br><span class="line">requirepass                 &quot;alkq2caiAmq82s&quot;</span><br><span class="line">masterauth                  &quot;alkq2caiAmq82s&quot;</span><br><span class="line">rename-command              flushall   &quot;&quot;</span><br><span class="line">rename-command              flushdb    &quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三台机器启动后检查主从状态，数量和状态对的上就没啥问题了。<br><img src="https://img.mknight.cn/medivh/1562755390514.png"  /><br><img src="https://img.mknight.cn/medivh/1562755494148.png"  /></p>
<h4 id="配置sentinel"><a href="#配置sentinel" class="headerlink" title="配置sentinel"></a>配置sentinel</h4><p>注意加上认证部分。<br>配置项解释：</p>
<ul>
<li><code>sentinel monitor mymaster 192.168.1.233 6379 2</code>给master取名叫mymaster，2代表集群中有两个sentinel认为master死了的时候，才能真正认为master死了。sentinel集群中通过gossip协互相通信。</li>
<li><code>down-after-milliseconds</code> sentinel会向master发送心跳PING来确认master是否存活，如果master在“一定时间范围”内不回应PONG 或者是回复了一个错误消息，那么这个sentinel会主观地(单方面地)认为这个master已经不可用了(subjectively down, 也简称为SDOWN)。而这个down-after-milliseconds就是用来指定这个“一定时间范围”的，单位是毫秒。</li>
<li><code>parallel-syncs</code>不过需要注意的是，这个时候sentinel并不会马上进行failover主备切换，这个sentinel还需要参考sentinel集群中其他sentinel的意见，如果超过某个数量的sentinel也主观地认为该master死了，那么这个master就会被客观地(注意哦，这次不是主观，是客观，与刚才的subjectively down相对，这次是objectively down，简称为ODOWN)认为已经死了。需要一起做出决定的sentinel数量在上一条配置中进行配置。</li>
<li>在发生failover主备切换时，这个选项指定了最多可以有多少个slave同时对新的master进行同步，这个数字越小，完成failover所需的时间就越长，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为 1 来保证每次只有一个slave处于不能处理命令请求的状态。</li>
</ul>
<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">bind 192.168.1.233</span><br><span class="line">logfile &quot;/var/log/redis/sentinel.log&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.1.233 6379 2</span><br><span class="line">sentinel auth-pass mymaster alkq2caiAmq82s</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">bind 192.168.1.234</span><br><span class="line">logfile &quot;/var/log/redis/sentinel.log&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.1.233 6379 2</span><br><span class="line">sentinel auth-pass mymaster alkq2caiAmq82s</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">bind 192.168.1.235</span><br><span class="line">logfile &quot;/var/log/redis/sentinel.log&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.1.233 6379 2</span><br><span class="line">sentinel auth-pass mymaster alkq2caiAmq82s</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><p>然后依次启动，之后检查状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel.conf</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">redis-server sentinel.conf --sentinel</span><br><span class="line"></span><br><span class="line">[root@base_233 ~]# redis-cli -h 192.168.1.233 -p 26379</span><br><span class="line">192.168.1.233:26379&gt; info Sentinel</span><br><span class="line"># Sentinel</span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=192.168.1.233:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure>
<h5 id="检查配置文件的变化"><a href="#检查配置文件的变化" class="headerlink" title="检查配置文件的变化"></a>检查配置文件的变化</h5><img src="https://img.mknight.cn/medivh/1562756643624.png"  />
<img src="https://img.mknight.cn/medivh/1562756689621.png"  />

<p>发现slave机器上会自动增加其他两个节点的信息。</p>
<p>启动日志<br><img src="https://img.mknight.cn/medivh/1562756729219.png"  /></p>
<h4 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h4><ul>
<li>PING ：返回 PONG 。</li>
<li>SENTINEL masters ：列出所有被监视的主服务器，以及这些主服务器的当前状态。</li>
<li>SENTINEL slaves <master name> ：列出给定主服务器的所有从服务器，以及这些从服务器的当前状态。</li>
<li>SENTINEL get-master-addr-by-name <master name> ： 返回给定名字的主服务器的 IP 地址和端口号。 如果这个主服务器正在执行故障转移操作， 或者针对这个主服务器的故障转移操作已经完成， 那么这个命令返回新的主服务器的 IP 地址和端口号。</li>
<li>SENTINEL reset <pattern> ： 重置所有名字和给定模式 pattern 相匹配的主服务器。 pattern 参数是一个 Glob 风格的模式。 重置操作清楚主服务器目前的所有状态， 包括正在执行中的故障转移， 并移除目前已经发现和关联的， 主服务器的所有从服务器和 Sentinel 。</li>
<li>SENTINEL failover <master name> ： 当主服务器失效时， 在不询问其他 Sentinel 意见的情况下， 强制开始一次自动故障迁移 （不过发起故障转移的 Sentinel 会向其他 Sentinel 发送一个新的配置，其他 Sentinel 会根据这个配置进行相应的更新）。</li>
</ul>
<h4 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h4><p>一次故障转移操作由以下步骤组成：</p>
<ul>
<li>发现主服务器已经进入客观下线状态。</li>
<li>对我们的当前纪元进行自增（详情请参考 Raft leader election ）， 并尝试在这个纪元中当选。</li>
<li>如果当选失败， 那么在设定的故障迁移超时时间的两倍之后， 重新尝试当选。 如果当选成功， 那么执行以下步骤。</li>
<li>选出一个从服务器，并将它升级为主服务器。</li>
<li>向被选中的从服务器发送 SLAVEOF NO ONE 命令，让它转变为主服务器。</li>
<li>通过发布与订阅功能， 将更新后的配置传播给所有其他 Sentinel ， 其他 Sentinel 对它们自己的配置进行更新。</li>
<li>向已下线主服务器的从服务器发送 SLAVEOF 命令， 让它们去复制新的主服务器。</li>
<li>当所有从服务器都已经开始复制新的主服务器时， 领头 Sentinel 终止这次故障迁移操作。</li>
</ul>
<blockquote>
<p>每当一个 Redis 实例被重新配置（reconfigured） —— 无论是被设置成主服务器、从服务器、又或者被设置成其他主服务器的从服务器 —— Sentinel 都会向被重新配置的实例发送一个 CONFIG REWRITE 命令， 从而确保这些配置会持久化在硬盘里。</p>
</blockquote>
<p>日志说明：</p>
<ul>
<li>+sdown 表示哨兵主观认为数据库下线</li>
<li>+odown 表示哨兵客观认为数据库下线</li>
<li>+try-failover 表示哨兵开始进行故障恢复</li>
<li>+failover-end 表示哨兵完成故障修复，其中包括了领头哨兵的选举、备选从数据库的选择等等较为复杂的过程</li>
<li>+switch-master表示主数据库从51服务器迁移到52服务器</li>
<li>+slave列出了新的主数据库的2个从数据库，而哨兵并没有彻底清除51服务器的实力信息，这是因为停止的实例有可能会在将来恢复，哨兵会让其重新加入进来</li>
</ul>
<p>故障转移过程：</p>
<ul>
<li>观察slave节点日志：master故障了<img src="https://img.mknight.cn/medivh/1562816515954.png"  />
  * 发现master故障，
  * 选举出来233为master
  * 切换master
  * 更新sentinel配置文件
  * 将原来的master切换为slave，并且定义为down</li>
<li>观察sentinel配置文件，master已经切换为新的地址<img src="https://img.mknight.cn/medivh/1562837169421.png"  /></li>
</ul>
<p>之前一直不成功主要的原因就是配置了<code>rename-command &quot;RENAMECONFIG&quot;</code>,导致失败的，这个要多注意一下。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ul>
<li>slave不能写<img src="https://img.mknight.cn/medivh/1562837656576.png"  /></li>
</ul>
<h4 id="访问sentinel集群"><a href="#访问sentinel集群" class="headerlink" title="访问sentinel集群"></a>访问sentinel集群</h4><p>以Python为例，程序通过sentinel提供的端口进行访问，获取master地址进行写操作，读操作默认是轮询。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Python 2.6.6 (r266:84292, Jan 22 2014, 09:42:36) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; from redis.sentinel import Sentinel #加载redis模块</span><br><span class="line">&gt;&gt;&gt; sentinel = Sentinel([(&#x27;192.168.221.160&#x27;, 26379),</span><br><span class="line">...                      (&#x27;192.168.221.161&#x27;, 26379)],</span><br><span class="line">...                     socket_timeout=0.1) #连接哨兵服务器</span><br><span class="line">&gt;&gt;&gt; sentinel.discover_master(&#x27;mymaster&#x27;) #获取主redis服务器地址</span><br><span class="line">(&#x27;192.168.221.161&#x27;, 6379)</span><br><span class="line">&gt;&gt;&gt; sentinel.discover_slaves(&#x27;mymaster&#x27;)#获取从redis服务区地址</span><br><span class="line">[(&#x27;192.168.221.160&#x27;, 6379)]</span><br><span class="line">&gt;&gt;&gt; master = sentinel.master_for(&#x27;mymaster&#x27;, socket_timeout=0.1) </span><br><span class="line">&gt;&gt;&gt; master.set(&#x27;foo&#x27;,&#x27;bar&#x27;) #获取主redis服务器并进行写入</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; slave = sentinel.slave_for(&#x27;mymaster&#x27;, socket_timeout=0.1)</span><br><span class="line">&gt;&gt;&gt; slave.get(&#x27;foo&#x27;)#获取从redis服务器进行获取</span><br><span class="line">&#x27;bar&#x27;</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="集群-Cluster"><a href="#集群-Cluster" class="headerlink" title="集群(Cluster)"></a>集群(Cluster)</h2><p>cluster的出现是为了解决单机Redis容量有限的问题，将Redis的数据根据一定的规则分配到多台机器。对cluster的一些理解：</p>
<ul>
<li>cluster可以说是sentinel和主从模式的结合体，通过cluster可以实现主从和master重选功能，所以如果配置两个副本三个分片的话，就需要六个Redis实例。</li>
<li>因为Redis的数据是根据一定规则分配到cluster的不同机器的，当数据量过大时，可以新增机器进行扩容。这种模式适合数据量巨大的缓存要求，当数据量不是很大使用sentinel即可。</li>
</ul>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Redis集群是一个可以在多个Redis节点之间进行数据共享的设施。</p>
<p>Redis集群不支持需要同时处理多个键的命令，因为在执行这些命令的时候需要在多个Redis节点之间移动数据，会降低集群性能。<br>Redis集群通过分区来提供一定程度的可用性：即使集群中有一部分节点失效，集群也可以继续处理命令请求。</p>
<p>优点：</p>
<ul>
<li>将数据自动切分到多个节点的能力</li>
<li>当部分节点失效的时候，集群仍然可以继续处理命令请求</li>
</ul>
<h3 id="数据共享"><a href="#数据共享" class="headerlink" title="数据共享"></a>数据共享</h3><p>一个集群包含16384个哈希槽，数据库中的每个键都属于这16384个哈希槽的其中一个。<br>每个节点负责处理一部分哈希槽，比如一个集群有三个节点，就均分为3大块哈希槽。</p>
<p>这种哈希槽的处理方式使用处更容易或者更快的添加删除节点。比如</p>
<ul>
<li>增加节点。ABC只需要将部分哈希槽移动到新的D就可以了</li>
<li>删除节点，ABCD只需要将要删除的D节点的哈希槽移动到ABC就可以了</li>
</ul>
<h3 id="集群中的主从复制"><a href="#集群中的主从复制" class="headerlink" title="集群中的主从复制"></a>集群中的主从复制</h3><p>集群中的主从复制功能：集群中的每个节点都有N个复制品，其中一个复制品为主节点，其余的为从节点。<br>比如之前的B节点下线了，那么集群中会丢失部分哈希槽。但是如果创建集群的时候为B节点添加了从节点B1，那么在B下线的时候，B1就会为新的主节点，取代处理之前对应的哈希槽。这样集群就会正常运作了。</p>
<h3 id="集群一致性保证"><a href="#集群一致性保证" class="headerlink" title="集群一致性保证"></a>集群一致性保证</h3><p>集群不保证数据的强一致性，在特定条件下，集群可能会丢失已经被执行过的写命令。</p>
<p>使用异步复制是丢失写命令的一个原因，示例如下：</p>
<ul>
<li>客户端向主节点B发送写的命令</li>
<li>主节点B执行写命令，并向客户端放回命令回复</li>
<li>主机点B</li>
</ul>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><p>创建三个目录，然后依次修改端口，之后发送到其他节点机器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">daemonize                   yes    </span><br><span class="line">pidfile                     /var/run/redis7000.pid</span><br><span class="line">port                        6379     </span><br><span class="line">bind                        192.168.1.233</span><br><span class="line">timeout                     120     </span><br><span class="line">tcp-keepalive               60     </span><br><span class="line">loglevel                    notice  </span><br><span class="line">logfile                     /var/log/redis/redis7000.log</span><br><span class="line">syslog-enabled              no</span><br><span class="line">databases                   16     </span><br><span class="line">stop-writes-on-bgsave-error no</span><br><span class="line">rdbcompression              yes</span><br><span class="line">rdbchecksum                 yes</span><br><span class="line">dbfilename                  dump.rdb</span><br><span class="line">dir                         /usr/local/redis_cluster/7000</span><br><span class="line">save                        7200    100000</span><br><span class="line">maxclients                  10000    </span><br><span class="line">maxmemory                   1GB</span><br><span class="line">maxmemory-policy            volatile-lru</span><br><span class="line">maxmemory-samples           5</span><br><span class="line">appendonly                  no</span><br><span class="line">appendfilename              appendonly.aof    </span><br><span class="line">hash-max-ziplist-entries    512     </span><br><span class="line">hash-max-ziplist-value      64</span><br><span class="line">list-max-ziplist-entries    512</span><br><span class="line">list-max-ziplist-value      64</span><br><span class="line">set-max-intset-entries      512</span><br><span class="line">zset-max-ziplist-entries    128</span><br><span class="line">zset-max-ziplist-value      64</span><br><span class="line">activerehashing             yes     </span><br><span class="line">client-output-buffer-limit  normal                      0      0     0</span><br><span class="line">client-output-buffer-limit  slave                       256mb  64mb  60</span><br><span class="line">client-output-buffer-limit  pubsub                      256mb  64b   120</span><br><span class="line">hz                          10</span><br><span class="line"></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file  nodes.conf   </span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">7000/bin/redis-server 7000/cluster.conf</span><br><span class="line">7001/bin/redis-server 7001/cluster.conf</span><br><span class="line">7002/bin/redis-server 7002/cluster.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="1-创建集群"><a href="#1-创建集群" class="headerlink" title="1 创建集群"></a>1 创建集群</h4><p>对于5.0以前的版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis_cluster/7000/bin/redis-trib.rb create --replicas 2 192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000  192.168.1.235:7001 192.168.1.235:7002</span><br></pre></td></tr></table></figure>
<p>对于5.0的版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis_cluster/7000/bin/redis-cli --cluster  create --cluster-replicas 2   192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000  192.168.1.235:7001 192.168.1.235:7002</span><br></pre></td></tr></table></figure>

<p>如果使用了错误的版本命令，会有下面的警告信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@base_233 redis_cluster]# /usr/local/redis_cluster/7000/bin/redis-trib.rb create --replicas 2 192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000  192.168.1.235:7001 192.168.1.235:7002</span><br><span class="line">WARNING: redis-trib.rb is not longer available!</span><br><span class="line">You should use redis-cli instead.</span><br><span class="line"></span><br><span class="line">All commands and features belonging to redis-trib.rb have been moved</span><br><span class="line">to redis-cli.</span><br><span class="line">In order to use them you should call redis-cli with the --cluster</span><br><span class="line">option followed by the subcommand name, arguments and options.</span><br><span class="line"></span><br><span class="line">Use the following syntax:</span><br><span class="line">redis-cli --cluster SUBCOMMAND [ARGUMENTS] [OPTIONS]</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">redis-cli --cluster create 192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000 192.168.1.235:7001 192.168.1.235:7002 --cluster-replicas 2</span><br><span class="line"></span><br><span class="line">To get help about all subcommands, type:</span><br><span class="line">redis-cli --cluster help</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<blockquote>
<p>redis 5.0 放弃redis-trib.rb，使用<code>redis-cli --cluster create</code>创建集群。也就是说5.0以后所有的集群操作都是通过<code>redis-cli --cluster</code> 来执行的。</p>
</blockquote>
<p>创建集群后会提示是否能更新以上的配置？选择yes</p>
<h4 id="修复集群"><a href="#修复集群" class="headerlink" title="修复集群"></a>修复集群</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis_cluster/7000/bin/redis-cli --cluster check  192.168.1.233:7001</span><br></pre></td></tr></table></figure>

<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p><a target="_blank" rel="noopener" href="https://github.com/ZhuoRoger/redismon">https://github.com/ZhuoRoger/redismon</a><br>or<br><a target="_blank" rel="noopener" href="https://github.com/iambocai/falcon-monit-scripts">https://github.com/iambocai/falcon-monit-scripts</a></p>
<h2 id="备份机制"><a href="#备份机制" class="headerlink" title="备份机制"></a>备份机制</h2><h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>每秒或者每次写操作，安全，速度不够快，也存在丢失1秒的可能。可以在从机器上开启。</p>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p>快照，定时，或者数量改变时，存储到一个二进制文件。容易恢复，文件小，但是存在不完整的可能。</p>
<p>主库开启RDB，每天<br>从库开启AOF，</p>
<p>如果只配置AOF,重启时加载AOF文件恢复数据；<br>如果同时 配置了RBD和AOF,启动是只加载AOF文件恢复数据;<br>如果只配置RBD,启动是讲加载dump文件恢复数据。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="http://doc.redisfans.com/topic/sentinel.html">http://doc.redisfans.com/topic/sentinel.html</a><br><a target="_blank" rel="noopener" href="https://redis.io/topics/sentinel-clients">sentinel客户端使用参考</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yiwangzhibujian/p/7047458.html">sentinel和cluster的对比</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%A4%9A%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84Kubernetes%E7%BD%91%E7%BB%9C%E6%89%93%E9%80%9A%E6%96%B9%E6%A1%88%E7%A0%94%E7%A9%B6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%A4%9A%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84Kubernetes%E7%BD%91%E7%BB%9C%E6%89%93%E9%80%9A%E6%96%B9%E6%A1%88%E7%A0%94%E7%A9%B6.html" class="post-title-link" itemprop="url">多环境下的Kubernetes网络打通方案研究</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>本文中的Kubernetes集群统称为集群。</p>
</blockquote>
<p>现实的工作环境中，我们可能会在开发环境使用Kubernetes，也会在测试和开发环境使用Kubernetes。而一般来说，大部分人不会直接去连接或访问生产环境的集群，但是对于开发环境就不一样了。很多开发人员需要经常访问开发环境，而不是在本地起一堆依赖的服务。而且真的只有这么一个问题吗？</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>整理了若干常见的问题：</p>
<ol>
<li>开发人员本地服务访问开发环境</li>
<li>新集群和旧集群的网络互通，或者迁移</li>
<li>域名访问</li>
</ol>
<p>因此，我们需要解决以上问题，才能更安心的使用Kubernetes。</p>
<h2 id="网络互通"><a href="#网络互通" class="headerlink" title="网络互通"></a>网络互通</h2><p>首先来解决最主要的问题，如何实现不同网络环境下的互通问题？</p>
<p>众所周知，集群暴露服务的方式有以下几种：</p>
<ol>
<li>NodePort 每个服务维护一个端口，服务越多端口越多</li>
<li>LoadBalancer 在nodePort的基础上使用公有云的负载均衡器</li>
<li>ClusterIP 每个service有一个虚拟IP</li>
<li>Ingress 一个服务暴露多个service的服务，本质是一种路由转发机制</li>
</ol>
<h3 id="场景一、注册中心eureka的应用"><a href="#场景一、注册中心eureka的应用" class="headerlink" title="场景一、注册中心eureka的应用"></a>场景一、注册中心eureka的应用</h3><p>首先eureka可以使用StatefulSet的方式，实现一个集群的部署。以下文件可以直接使用：</p>
<ul>
<li>服务配置文件 <a target="_blank" rel="noopener" href="https://img.mknight.cn/k8s/eureka/eureka-svc-np.yaml">https://img.mknight.cn/k8s/eureka/eureka-svc-np.yaml</a></li>
<li>StatefulSet 文件 <a target="_blank" rel="noopener" href="https://img.mknight.cn/k8s/eureka/eureka-sts.yaml">https://img.mknight.cn/k8s/eureka/eureka-sts.yaml</a></li>
<li>Service 文件 <a target="_blank" rel="noopener" href="https://img.mknight.cn/k8s/eureka/eureka-svc-np.yaml">https://img.mknight.cn/k8s/eureka/eureka-svc-np.yaml</a></li>
</ul>
<h4 id="1-办公网访问应用"><a href="#1-办公网访问应用" class="headerlink" title="1. 办公网访问应用"></a>1. 办公网访问应用</h4><p>开发人员本地访问的时候可以使用NodePort的方式访问，也可以使用Ingress的方式访问。</p>
<p><img src="https://img.mknight.cn/medivh/1651052056989.png" alt="1651052056989.png"></p>
<p>如图所示，创建了两个Python的应用，并注册到eureka。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@time:2022/04/27</span></span><br><span class="line"><span class="string">@file:test_eureka.py</span></span><br><span class="line"><span class="string">@author:medivh</span></span><br><span class="line"><span class="string">@IDE:PyCharm </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">import</span> py_eureka_client.eureka_client <span class="keyword">as</span> eureka_client</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setEureka</span>():</span><br><span class="line">    eureka_client.init(eureka_server=<span class="string">&quot;http://192.168.1.217:31331/eureka&quot;</span>,</span><br><span class="line">                       app_name=<span class="string">&quot;flask_server-2&quot;</span>,</span><br><span class="line">                       <span class="comment"># 当前组件的主机名，可选参数，如果不填写会自动计算一个，如果服务和 eureka 服务器部署在同一台机器，请必须填写，否则会计算出 127.0.0.1</span></span><br><span class="line">                       instance_host=<span class="string">&#x27;10.1.3.141&#x27;</span>,</span><br><span class="line">                       instance_port=<span class="number">5001</span>,</span><br><span class="line">                       <span class="comment"># 调用其他服务时的高可用策略，可选，默认为随机</span></span><br><span class="line">                       ha_strategy=eureka_client.HA_STRATEGY_RANDOM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setEureka()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/info&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_info</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello Info!&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>, threaded=<span class="literal">True</span>, port=<span class="number">5001</span>, host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>另外一个测试脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@time:2022/04/27</span></span><br><span class="line"><span class="string">@file:test_eureka-service.py</span></span><br><span class="line"><span class="string">@author:medivh</span></span><br><span class="line"><span class="string">@IDE:PyCharm </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> py_eureka_client.eureka_client <span class="keyword">as</span> eureka_client</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">eureka_client.init(eureka_server=<span class="string">&quot;http://192.168.1.109:31331/eureka&quot;</span>, app_name=<span class="string">&#x27;do_service&#x27;</span>, instance_host=<span class="string">&quot;10.1.3.141&quot;</span>,</span><br><span class="line">                   instance_port=<span class="number">5011</span>)</span><br><span class="line"><span class="comment"># get请求的调用</span></span><br><span class="line">res = eureka_client.do_service(<span class="string">&quot;flask_server-2&quot;</span>, <span class="string">&quot;/info&quot;</span>,</span><br><span class="line">                               <span class="comment"># 返回类型，默认为 `string`，可以传入 `json`，如果传入值是 `json`，那么该方法会返回一个 `dict` 对象</span></span><br><span class="line">                               return_type=<span class="string">&quot;string&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line">res = eureka_client.do_service(<span class="string">&quot;O2O-SERVICE&quot;</span>, <span class="string">&quot;/env-path/actuator/info&quot;</span>,</span><br><span class="line">                               <span class="comment"># 返回类型，默认为 `string`，可以传入 `json`，如果传入值是 `json`，那么该方法会返回一个 `dict` 对象</span></span><br><span class="line">                               return_type=<span class="string">&quot;string&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment">## post请求的调用</span></span><br><span class="line"><span class="comment"># d = &#123;&#x27;a&#x27;: 1&#125;</span></span><br><span class="line"><span class="comment"># res = eureka_client.do_service(&#x27;helloindex&#x27;, &#x27;/user&#x27;, return_type=&#x27;string&#x27;, method=&#x27;POST&#x27;, data=json.dumps(d))</span></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line">res = eureka_client.do_service(<span class="string">&quot;O2O-SERVICE&quot;</span>, <span class="string">&quot;/env-path/actuator/info&quot;</span>,</span><br><span class="line">                               <span class="comment"># 返回类型，默认为 `string`，可以传入 `json`，如果传入值是 `json`，那么该方法会返回一个 `dict` 对象</span></span><br><span class="line">                               return_type=<span class="string">&quot;string&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>

<p>调用测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">python test_eureka-service.py</span><br><span class="line">Hello Info!</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/Users/medivh/github/box/test_eureka-service.py&quot;</span>, line 19, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    res = eureka_client.do_service(<span class="string">&quot;O2O-SERVICE&quot;</span>, <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  File <span class="string">&quot;/Users/medivh/github/box/venv/lib/python3.8/site-packages/py_eureka_client/eureka_client.py&quot;</span>, line 1736, <span class="keyword">in</span> do_service</span><br><span class="line">    <span class="built_in">return</span> cli.do_service(app_name=app_name, service=service, return_type=return_type,</span><br><span class="line">  File <span class="string">&quot;/Users/medivh/github/box/venv/lib/python3.8/site-packages/py_eureka_client/eureka_client.py&quot;</span>, line 1467, <span class="keyword">in</span> do_service</span><br><span class="line">    <span class="built_in">return</span> self.walk_nodes(app_name, service, prefer_ip, prefer_https, walk_using_urllib)</span><br><span class="line">  File <span class="string">&quot;/Users/medivh/github/box/venv/lib/python3.8/site-packages/py_eureka_client/eureka_client.py&quot;</span>, line 1415, <span class="keyword">in</span> walk_nodes</span><br><span class="line">    raise http_client.URLError(<span class="string">&quot;Try all up instances in registry, but all fail&quot;</span>)</span><br><span class="line">urllib.error.URLError: &lt;urlopen error Try all up instances <span class="keyword">in</span> registry, but all fail&gt;</span><br><span class="line">[2022-04-27 17:32:39]-[eureka_client]-[line:1409] -WARNING: <span class="keyword">do</span> service / <span class="keyword">in</span> node [o2o-service-287077292-hj7q7:o2o-service:8080] error, use next node. Error: &lt;urlopen error timed out&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个时候说明注册中心是可以正常使用的，但是如果调用集群的服务就无法访问了，毕竟不在一个网段，也没有合适的路由。接下来就去解决这个问题。</p>
<h4 id="2-办公网访问集群Pod-Service"><a href="#2-办公网访问集群Pod-Service" class="headerlink" title="2.办公网访问集群Pod&#x2F;Service"></a>2.办公网访问集群Pod&#x2F;Service</h4><p>在网关和路由器上添加路由，把属于集群的Pod和Service的子网IP全部转发给其中某个node，这样访问Pod IP和Service IP，网络包会到达某个node，而集群内的node中，CNI会与这些目的地址互通。</p>
<p>网段：</p>
<table>
<thead>
<tr>
<th>网段名称</th>
<th>网段范围</th>
</tr>
</thead>
<tbody><tr>
<td>办公网段</td>
<td>10.1.3.0&#x2F;24</td>
</tr>
<tr>
<td>Pod地址池</td>
<td>10.200.0.0&#x2F;16</td>
</tr>
<tr>
<td>Svc地址池</td>
<td>10.96.0.0&#x2F;12</td>
</tr>
</tbody></table>
<p>如果不记得当时设置的网段是多少，可以用以下方式查询：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl get cm kubeadm-config -n kube-system -o yaml | grep -i podsub</span><br><span class="line">      podSubnet: 10.200.0.0/16</span><br><span class="line">~ kubectl get cm kubeadm-config -n kube-system -o yaml | grep -i servicesub</span><br><span class="line">      serviceSubnet: 10.96.0.0/12</span><br></pre></td></tr></table></figure>

<h5 id="steps-1"><a href="#steps-1" class="headerlink" title="steps 1"></a>steps 1</h5><p>选择集群中的一个节点进行路由转发，可以使用一台配置不高的节点，打上污点不允许调度占用资源。本文中使用的是master节点。</p>
<ol>
<li>设置污点 <code>kubectl taint nodes k8s-master forward=k8s-node5:NoSchedule</code></li>
<li>开启路由转发 <code>echo &quot;net.ipv4.ip_forward = 1&quot;  &gt;&gt; /etc/sysctl.conf</code></li>
<li>查看是否生效 <code>sysctl -p</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启转发</span></span><br><span class="line">~ vim /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">~ sysctl -p</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 在k8s-master上设置snat</span></span><br><span class="line">~ iptables -t nat -A POSTROUTING -s 10.200.0.0/16  -d 10.1.3.0/24   -j MASQUERADE</span><br><span class="line">~ iptables -t nat -A POSTROUTING -s 10.96.0.0/12 -d 110.1.3.0/24   -j MASQUERADE</span><br><span class="line"> </span><br><span class="line"><span class="comment"># (可选)查看设置的snat</span></span><br><span class="line">~ iptables -t nat -L -n --line-numbers | grep -A 10 <span class="string">&quot;Chain POSTROUTING&quot;</span></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination        </span><br><span class="line">1    ......</span><br><span class="line">2    ......</span><br><span class="line">3    ......</span><br><span class="line">4    MASQUERADE  all  --  10.1.3.0/24          10.200.0.0/16</span><br><span class="line">5    MASQUERADE  all  --  10.1.3.0/24          10.96.0.0/12</span><br><span class="line"></span><br><span class="line"><span class="comment"># (可选)如配置失误可删除已设置的snat条目</span></span><br><span class="line">~ iptables -t nat -D POSTROUTING 4</span><br></pre></td></tr></table></figure>

<h5 id="setps-2"><a href="#setps-2" class="headerlink" title="setps 2"></a>setps 2</h5><p>在办公网的出口路由上设置静态路由，将集群的Pod和Service网段，路由到master节点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在路由器上需要做的配置：</span></span><br><span class="line">ip route add -net  10.200.0.0/16 gw 192.168.1.109</span><br><span class="line">ip route add -net  10.96.0.0/12 gw 192.168.1.109</span><br></pre></td></tr></table></figure>

<p><img src="https://img.mknight.cn/medivh/1651115644098.png" alt="1651115644098.png"></p>
<h5 id="setps-3"><a href="#setps-3" class="headerlink" title="setps 3"></a>setps 3</h5><p>这个时候在办公网主机上<code>ping</code> 集群中的Pod或者service的IP，理论上就是通的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pod </span></span><br><span class="line">➜  ~ traceroute 10.200.96.148</span><br><span class="line">traceroute to 10.200.96.148 (10.200.96.148), 64 hops max, 52 byte packets</span><br><span class="line"> 1  10.1.3.1 (10.1.3.1)  2.781 ms  2.422 ms  2.388 ms</span><br><span class="line"> 2  bogon (192.168.1.109)  2.723 ms  3.352 ms  3.647 ms</span><br><span class="line"> 3  bogon (10.200.96.128)  3.724 ms  3.485 ms  3.417 ms</span><br><span class="line"> 4  10.200.96.148 (10.200.96.148)  3.551 ms  3.440 ms  3.390 ms</span><br><span class="line"></span><br><span class="line"> <span class="comment"># service </span></span><br><span class="line"></span><br><span class="line"> ➜  ~ traceroute 10.96.230.195</span><br><span class="line">traceroute to 10.96.230.195 (10.96.230.195), 64 hops max, 52 byte packets</span><br><span class="line"> 1  10.1.3.1 (10.1.3.1)  5.698 ms  2.482 ms  2.375 ms</span><br><span class="line"> 2  10.96.230.195 (10.96.230.195)  2.774 ms  2.807 ms  2.834 ms</span><br></pre></td></tr></table></figure>

<h5 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h5><p>如果以上操作都执行了，但是还是不通，请检查以下项目：</p>
<ol>
<li>转发是否开启</li>
<li>iptables的规则是否正确</li>
<li>iptables规则是否有<code> MASQUERADE  all  --  192.168.1.0/24       0.0.0.0/0</code> 这么一条</li>
</ol>
<p>至此，解决了开发人员无法在办公网访问集群环境的IP问题。</p>
<h2 id="跨集群访问"><a href="#跨集群访问" class="headerlink" title="跨集群访问"></a>跨集群访问</h2><p>如果我们有多个集群，这个时候如果实现网络打通呢，比如新旧集群迁移的时候？</p>
<h3 id="以IP形式访问"><a href="#以IP形式访问" class="headerlink" title="以IP形式访问"></a>以IP形式访问</h3><p>其实我们依然可以采用之前的方案，添加静态路由。</p>
<p>网段：</p>
<table>
<thead>
<tr>
<th>网段名称</th>
<th>网段范围</th>
</tr>
</thead>
<tbody><tr>
<td>办公网段</td>
<td>10.1.3.0&#x2F;24</td>
</tr>
<tr>
<td>集群A Pod地址池</td>
<td>10.200.0.0&#x2F;16</td>
</tr>
<tr>
<td>集群A Svc地址池</td>
<td>10.96.0.0&#x2F;12</td>
</tr>
<tr>
<td>集群B Pod地址池</td>
<td>10.100.0.0&#x2F;16</td>
</tr>
<tr>
<td>集群B Svc地址池</td>
<td>10.254.0.0&#x2F;16</td>
</tr>
</tbody></table>
<p>主要实现逻辑是每个集群选择一个节点，开启路由转发，实现办公网段可以访问集群中的IP。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~ iptables -t nat -A POSTROUTING -s 10.1.3.0/24 -d 10.254.0.0/16 -j MASQUERADE -w</span><br><span class="line">~ iptables -t nat -A POSTROUTING -s 10.1.3.0/24 -d 10.100.0.0/16 -j MASQUERADE -w</span><br><span class="line">~ iptables -t nat -L -n --line-numbers | grep -A 10 <span class="string">&quot;Chain POSTROUTING&quot;</span></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">1    MASQUERADE  all  --  10.100.72.0/24       0.0.0.0/0</span><br><span class="line">2    KUBE-POSTROUTING  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */</span><br><span class="line">3    MASQUERADE  all  --  10.1.3.0/24          10.254.0.0/16</span><br><span class="line">4    MASQUERADE  all  --  10.1.3.0/24          10.100.0.0/16</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">1    RETURN     all  --  0.0.0.0/0            0.0.0.0/0</span><br><span class="line"></span><br><span class="line">~ iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -d 0.0.0.0/0  -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 办公网</span></span><br><span class="line">➜  ~ traceroute 10.100.5.7</span><br><span class="line">traceroute to 10.100.5.7 (10.100.5.7), 64 hops max, 52 byte packets</span><br><span class="line"> 1  bogon (10.1.3.1)  2.699 ms  2.201 ms  2.140 ms</span><br><span class="line"> 2  *.demo.yourdomain.com (192.168.1.243)  2.213 ms  7.957 ms  7.389 ms</span><br><span class="line"> 3  bogon (10.100.5.0)  2.902 ms  4.637 ms  2.616 ms</span><br><span class="line"> 4  bogon (10.100.5.7)  4.109 ms  3.944 ms  2.782 ms</span><br><span class="line"></span><br><span class="line"> <span class="comment"># A集群到B集群</span></span><br><span class="line">~ tracepath 10.100.5.7</span><br><span class="line"> 1?: [LOCALHOST]                                         pmtu 1500</span><br><span class="line"> 1:  gateway                                               0.365ms</span><br><span class="line"> 1:  gateway                                               2.044ms</span><br><span class="line"> 2:  192.168.1.243                                         0.767ms</span><br><span class="line"> 3:  192.168.1.243                                         0.848ms pmtu 1450</span><br><span class="line"> 3:  10.100.5.0                                            1.536ms</span><br><span class="line"> 4:  10.100.5.7                                            1.382ms reached</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>办公网通过注册中心调用</p>
<p><img src="https://img.mknight.cn/medivh/1651117439545.png" alt="1651117439545.png"></p>
<h3 id="以域名形式访问Service"><a href="#以域名形式访问Service" class="headerlink" title="以域名形式访问Service"></a>以域名形式访问Service</h3><p>实现了办公网和集群的网络互通后，就可以实现自由访问Pod和Service了。但是由于Pod IP会经常变化，Service IP也不是很容易记住，所以希望通过内网DNS的形式访问<code>*.cluser.local</code>时自动解析相应的IP。</p>
<h4 id="steps-1-获取coredns的IP"><a href="#steps-1-获取coredns的IP" class="headerlink" title="steps 1. 获取coredns的IP"></a>steps 1. 获取coredns的IP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl get svc -n kube-system -l k8s-app=kube-dns</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   34d</span><br></pre></td></tr></table></figure>

<h4 id="steps-2-部署DNS服务dnsmasq"><a href="#steps-2-部署DNS服务dnsmasq" class="headerlink" title="steps 2. 部署DNS服务dnsmasq"></a>steps 2. 部署DNS服务dnsmasq</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install dnsmasq</span><br></pre></td></tr></table></figure>

<p>修改&#x2F;etc&#x2F;dnsmasq.conf：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">resolv-file=/etc/resolv.dnsmasq.conf   <span class="comment">#指定上游dns服务器</span></span><br><span class="line">strict-order   <span class="comment">#严格按照resolv-file文件中的顺序进行从上到下解析，直到成功为止</span></span><br><span class="line">server=/cluster.local/10.96.0.10  <span class="comment">#指定以cluster.local为后缀的域名，使用coredns的地址解析,这里可以不配直接把coredns配置在/etc/resolv.dnsmasq.conf 里面。</span></span><br><span class="line">listen-address=192.168.1.109   <span class="comment">#指定本地IP地址</span></span><br><span class="line">addn-hosts=/etc/dnsmasq.hosts   <span class="comment">#自定义dns记录文件</span></span><br><span class="line">conf-dir=/etc/dnsmasq.d    <span class="comment">#所有的解析记录都会存在此目录下</span></span><br></pre></td></tr></table></figure>

<p>修改resolv.dnsmasq.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 61.139.2.69</span><br><span class="line">nameserver 202.106.0.20</span><br><span class="line">nameserver 192.168.1.109</span><br></pre></td></tr></table></figure>

<p>开机并启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> dnsmasq &amp;&amp; systemctl start dnsmasq</span><br></pre></td></tr></table></figure>

<h4 id="steps-3-验证"><a href="#steps-3-验证" class="headerlink" title="steps 3. 验证"></a>steps 3. 验证</h4><p>在其他机器上测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~ traceroute eureka.default.svc.cluster.local</span><br><span class="line">traceroute to eureka.default.svc.cluster.local (10.200.229.155), 30 hops max, 60 byte packets</span><br><span class="line"> 1  192.168.1.1 (192.168.1.1)  0.151 ms  0.145 ms  0.137 ms</span><br><span class="line"> 2  new.eureka.com (192.168.1.109)  0.622 ms  0.595 ms *</span><br><span class="line"> 3  bogon (10.200.229.128)  1.311 ms  1.972 ms  2.019 ms</span><br><span class="line"> 4  bogon (10.200.229.155)  2.075 ms  2.743 ms  2.741 ms</span><br><span class="line"></span><br><span class="line">curl -I eureka.default.svc.cluster.local:8761</span><br><span class="line">HTTP/1.1 200</span><br><span class="line">X-Application-Context: DiscoveryServer:8761</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Content-Language: en-US</span><br><span class="line">Content-Length: 7451</span><br><span class="line">Date: Thu, 28 Apr 2022 05:47:08 GMT</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后来在其他的服务器上测试可以正常访问，在Mac下能使用nslookup解析，但是无法访问，也无法路由跟踪，以后再解决。</p>
<p>后来发现如果是Mac的话，直接在网络设置-高级-DNS，添加dns地址并拖到上面即可实现访问。只是奇怪的是手动修改<code>/etc/resolv.conf</code> 并没有实现访问，这种界面的形式反而可以，总之，解决了问题。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/OpenFalcon%20CentOS%207.2%E9%83%A8%E7%BD%B2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/OpenFalcon%20CentOS%207.2%E9%83%A8%E7%BD%B2.html" class="post-title-link" itemprop="url">OpenFalcon CentOS 7.2部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>OpenFalcon是一款企业级、高可用、可扩展的开源监控解决方案。</p>
<img src="https://img.mknight.cn/2018/1539584391262.png" width="1013"/>

<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>当前平台相关组件部署在OAM主机，其余主机均部署agent.</p>
<h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y redis</span><br></pre></td></tr></table></figure>
<h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><h4 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mysql-server</span><br></pre></td></tr></table></figure>
<h4 id="初始化MySQL表结构"><a href="#初始化MySQL表结构" class="headerlink" title="初始化MySQL表结构"></a>初始化MySQL表结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp/ &amp;&amp; git clone https://github.com/open-falcon/falcon-plus.git</span><br><span class="line">cd /tmp/falcon-plus/scripts/mysql/db_schema/</span><br><span class="line">mysql -h 127.0.0.1 -u root -pYmQwODk2Y2I0ZmVm &lt; 1_uic-db-schema.sql</span><br><span class="line">mysql -h 127.0.0.1 -u root -pYmQwODk2Y2I0ZmVm &lt; 2_portal-db-schema.sql</span><br><span class="line">mysql -h 127.0.0.1 -u root -pYmQwODk2Y2I0ZmVm &lt; 3_dashboard-db-schema.sql</span><br><span class="line">mysql -h 127.0.0.1 -u root -pYmQwODk2Y2I0ZmVm &lt; 4_graph-db-schema.sql</span><br><span class="line">mysql -h 127.0.0.1 -u root -pYmQwODk2Y2I0ZmVm &lt; 5_alarms-db-schema.sql</span><br><span class="line">rm -rf /tmp/falcon-plus/</span><br></pre></td></tr></table></figure>
<p>注意，请确保redis和MySQL已启动。</p>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><h3 id="创建工作目录"><a href="#创建工作目录" class="headerlink" title="创建工作目录"></a>创建工作目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export FALCON_HOME=/usr/local</span><br><span class="line">export WORKSPACE=$FALCON_HOME/open-falcon</span><br><span class="line">mkdir -p $WORKSPAC</span><br><span class="line">tar -xzvf open-falcon-v0.2.0.tar.gz -C $WORKSPACE</span><br></pre></td></tr></table></figure>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>修改所有组件的MySQL信息root:password</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cd $WORKSPACE</span><br><span class="line">./open-falcon start</span><br><span class="line"></span><br><span class="line"># 检查所有模块的启动状况</span><br><span class="line">./open-falcon check</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ./open-falcon [start|stop|restart|check|monitor|reload] module</span><br><span class="line">./open-falcon start agent</span><br><span class="line"></span><br><span class="line">./open-falcon check</span><br><span class="line">        falcon-graph         UP           53007</span><br><span class="line">          falcon-hbs         UP           53014</span><br><span class="line">        falcon-judge         UP           53020</span><br><span class="line">     falcon-transfer         UP           53026</span><br><span class="line">       falcon-nodata         UP           53032</span><br><span class="line">   falcon-aggregator         UP           53038</span><br><span class="line">        falcon-agent         UP           53044</span><br><span class="line">      falcon-gateway         UP           53050</span><br><span class="line">          falcon-api         UP           53056</span><br><span class="line">        falcon-alarm         UP           53063</span><br><span class="line"></span><br><span class="line">For debugging , You can check $WorkDir/$moduleName/log/logs/xxx.log</span><br></pre></td></tr></table></figure>
<h2 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>agent用于采集机器负载监控指标，比如cpu.idle、load.1min、disk.io.util等等，每隔60秒push给Transfer。agent与Transfer建立了长连接，数据发送速度比较快，agent提供了一个http接口&#x2F;v1&#x2F;push用于接收用户手工push的一些数据，然后通过长连接迅速转发给Transfer。</p>
<h3 id="部署说明"><a href="#部署说明" class="headerlink" title="部署说明"></a>部署说明</h3><p>agent需要部署到所有要被监控的机器上，比如公司有10万台机器，那就要部署10万个agent。agent本身资源消耗很少，不用担心。</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;debug&quot;: true,  # 控制一些debug信息的输出，生产环境通常设置为false</span><br><span class="line">    &quot;hostname&quot;: &quot;&quot;, # agent采集了数据发给transfer，endpoint就设置为了hostname，默认通过`hostname`获取，如果配置中配置了hostname，就用配置中的</span><br><span class="line">    &quot;ip&quot;: &quot;&quot;, # agent与hbs心跳的时候会把自己的ip地址发给hbs，agent会自动探测本机ip，如果不想让agent自动探测，可以手工修改该配置</span><br><span class="line">    &quot;plugin&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false, # 默认不开启插件机制</span><br><span class="line">        &quot;dir&quot;: &quot;./plugin&quot;,  # 把放置插件脚本的git repo clone到这个目录</span><br><span class="line">        &quot;git&quot;: &quot;https://github.com/open-falcon/plugin.git&quot;, # 放置插件脚本的git repo地址</span><br><span class="line">        &quot;logs&quot;: &quot;./logs&quot; # 插件执行的log，如果插件执行有问题，可以去这个目录看log</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;heartbeat&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: true,  # 此处enabled要设置为true</span><br><span class="line">        &quot;addr&quot;: &quot;127.0.0.1:6030&quot;, # hbs的地址，端口是hbs的rpc端口</span><br><span class="line">        &quot;interval&quot;: 60, # 心跳周期，单位是秒</span><br><span class="line">        &quot;timeout&quot;: 1000 # 连接hbs的超时时间，单位是毫秒</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;transfer&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: true,</span><br><span class="line">        &quot;addrs&quot;: [</span><br><span class="line">            &quot;127.0.0.1:18433&quot;</span><br><span class="line">        ],  # transfer的地址，端口是transfer的rpc端口, 可以支持写多个transfer的地址，agent会保证HA</span><br><span class="line">        &quot;interval&quot;: 60, # 采集周期，单位是秒，即agent一分钟采集一次数据发给transfer</span><br><span class="line">        &quot;timeout&quot;: 1000 # 连接transfer的超时时间，单位是毫秒</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;http&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: true,  # 是否要监听http端口</span><br><span class="line">        &quot;listen&quot;: &quot;:1988&quot;,</span><br><span class="line">        &quot;backdoor&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;collector&quot;: &#123;</span><br><span class="line">        &quot;ifacePrefix&quot;: [&quot;eth&quot;, &quot;em&quot;], # 默认配置只会采集网卡名称前缀是eth、em的网卡流量，配置为空就会采集所有的，lo的也会采集。可以从/proc/net/dev看到各个网卡的流量信息</span><br><span class="line">        &quot;mountPoint&quot;: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;default_tags&quot;: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ignore&quot;: &#123;  # 默认采集了200多个metric，可以通过ignore设置为不采集</span><br><span class="line">        &quot;cpu.busy&quot;: true,</span><br><span class="line">        &quot;df.bytes.free&quot;: true,</span><br><span class="line">        &quot;df.bytes.total&quot;: true,</span><br><span class="line">        &quot;df.bytes.used&quot;: true,</span><br><span class="line">        &quot;df.bytes.used.percent&quot;: true,</span><br><span class="line">        &quot;df.inodes.total&quot;: true,</span><br><span class="line">        &quot;df.inodes.free&quot;: true,</span><br><span class="line">        &quot;df.inodes.used&quot;: true,</span><br><span class="line">        &quot;df.inodes.used.percent&quot;: true,</span><br><span class="line">        &quot;mem.memtotal&quot;: true,</span><br><span class="line">        &quot;mem.memused&quot;: true,</span><br><span class="line">        &quot;mem.memused.percent&quot;: true,</span><br><span class="line">        &quot;mem.memfree&quot;: true,</span><br><span class="line">        &quot;mem.swaptotal&quot;: true,</span><br><span class="line">        &quot;mem.swapused&quot;: true,</span><br><span class="line">        &quot;mem.swapfree&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./open-falcon start agent  启动进程</span><br><span class="line">./open-falcon stop agent  停止进程</span><br><span class="line">./open-falcon monitor agent  查看日志</span><br><span class="line">./falcon-agent --check 健康检查，或者浏览器访问其1988端口</span><br></pre></td></tr></table></figure>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><h3 id="克隆前端组件代码"><a href="#克隆前端组件代码" class="headerlink" title="克隆前端组件代码"></a>克隆前端组件代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd $WORKSPACE</span><br><span class="line">git clone https://github.com/open-falcon/dashboard.git</span><br></pre></td></tr></table></figure>
<h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python-virtualenv</span><br><span class="line">yum install -y python-devel</span><br><span class="line">yum install -y openldap-devel</span><br><span class="line">yum install -y mysql-devel</span><br><span class="line">yum groupinstall &quot;Development tools&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd $WORKSPACE/dashboard/</span><br><span class="line">virtualenv ./env</span><br><span class="line"></span><br><span class="line">./env/bin/pip install -r pip_requirements.txt -i https://pypi.douban.com/simple</span><br></pre></td></tr></table></figure>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dashboard的配置文件为： &#x27;rrd/config.py&#x27;，请根据实际情况修改</span><br><span class="line"></span><br><span class="line">## API_ADDR 表示后端api组件的地址</span><br><span class="line">API_ADDR = &quot;http://127.0.0.1:8080/api/v1&quot;</span><br><span class="line"></span><br><span class="line">## 根据实际情况，修改PORTAL_DB_*, 默认用户名为root，默认密码为&quot;&quot;</span><br><span class="line">## 根据实际情况，修改ALARM_DB_*, 默认用户名为root，默认密码为&quot;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><h4 id="开发者模式启动"><a href="#开发者模式启动" class="headerlink" title="开发者模式启动"></a>开发者模式启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./env/bin/python wsgi.py</span><br><span class="line"></span><br><span class="line">open http://127.0.0.1:8081 in your browser.</span><br></pre></td></tr></table></figure>
<h4 id="生产环境启动"><a href="#生产环境启动" class="headerlink" title="生产环境启动"></a>生产环境启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash control start</span><br><span class="line"></span><br><span class="line">open http://127.0.0.1:8081 in your browser.</span><br></pre></td></tr></table></figure>
<h3 id="停止dashboard运行"><a href="#停止dashboard运行" class="headerlink" title="停止dashboard运行"></a>停止dashboard运行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash control stop</span><br></pre></td></tr></table></figure>
<h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash control tail</span><br></pre></td></tr></table></figure>
<h3 id="dashbord用户管理"><a href="#dashbord用户管理" class="headerlink" title="dashbord用户管理"></a>dashbord用户管理</h3><p>dashbord没有默认创建任何账号包括管理账号，需要你通过页面进行注册账号。<br>想拥有管理全局的超级管理员账号，需要手动注册用户名为root的账号（第一个帐号名称为root的用户会被自动设置为超级管理员）。<br>超级管理员可以给普通用户分配权限管理。</p>
<blockquote>
<p>小提示：注册账号能够被任何打开dashboard页面的人注册，所以当给相关的人注册完账号后，需要去关闭注册账号功能。只需要去修改api组件的配置文件cfg.json，将signup_disable配置项修改为true，重启api即可。当需要给人开账号的时候，再将配置选项改回去，用完再关掉即可。</p>
</blockquote>
<h2 id="初次使用"><a href="#初次使用" class="headerlink" title="初次使用"></a>初次使用</h2><h3 id="注册管理员账号"><a href="#注册管理员账号" class="headerlink" title="注册管理员账号"></a>注册管理员账号</h3><p>访问dashboard主机8081端口，点击”sign up”<br><img src="https://img.mknight.cn/2018/1539585168733.png" width="1229"/></p>
<p>用户名必须为root</p>
<img src="https://img.mknight.cn/2018/1539585230624.png" width="397"/>

<h3 id="个人信息维护"><a href="#个人信息维护" class="headerlink" title="个人信息维护"></a>个人信息维护</h3><p>注意填写邮箱地址和IM信息，IM部分可以写微信号，这些信息为以后的报警通知使用。<br><img src="https://img.mknight.cn/2018/1539585311738.png" width="1232"/></p>
<h3 id="Dashboard-使用介绍"><a href="#Dashboard-使用介绍" class="headerlink" title="Dashboard 使用介绍"></a>Dashboard 使用介绍</h3><ul>
<li>左边的侧边栏会显示所有加入的agent主机，或者自定义的endpoint。</li>
<li>右中间位置limit50表示显示50行内容，可以自行选择。</li>
<li>右下方是endpiont的监控项目，选中后点击看图即可画图。</li>
</ul>
<img src="https://img.mknight.cn/2018/1539585454798.png" width="1229"/>
### 画图示例
1、选中监控项，点击选择看图视角
<img src="https://img.mknight.cn/2018/1539585659674.png" width="794"/>
2、这样图就出来啦
<img src="https://img.mknight.cn/2018/1539585675701.png" width="1226"/>

<p>另外还可以自定义screen，此处不再具体介绍</p>
<h2 id="hostgroup"><a href="#hostgroup" class="headerlink" title="hostgroup"></a>hostgroup</h2><p>简单说就是主机组，然后绑定模板<br>hostgroup-》Add host</p>
<h2 id="template"><a href="#template" class="headerlink" title="template"></a>template</h2><p>Like this.</p>
<img src="https://img.mknight.cn/2018/1539589162286.png" width="1222"/>

<h2 id="监控使用"><a href="#监控使用" class="headerlink" title="监控使用"></a>监控使用</h2><p>参考  <a target="_blank" rel="noopener" href="http://book.open-falcon.org/zh_0_2/usage/getting-started.html">http://book.open-falcon.org/zh_0_2&#x2F;usage&#x2F;getting-started.html</a></p>
<h2 id="报警组件"><a href="#报警组件" class="headerlink" title="报警组件"></a>报警组件</h2><p>报警部分分为邮件和微信报警，其中微信报警。启动邮件报警部分有点特殊，因为阿里云机器默认是不允许开发25端口的，因此只能使用ssl的456端口。但是问题又来了，官方的组件不支持ssl。因此对于这个问题只能是重新编译。</p>
<h3 id="邮件"><a href="#邮件" class="headerlink" title="邮件"></a>邮件</h3><p><a target="_blank" rel="noopener" href="https://github.com/GitHamburg/mail-provider.git">https://github.com/GitHamburg/mail-provider.git</a></p>
<h4 id="1-二进制安装-推荐"><a href="#1-二进制安装-推荐" class="headerlink" title="1.二进制安装(推荐)"></a>1.二进制安装(推荐)</h4><p>下载编译好的二进制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://cactifans.hi-www.com/open-falcon/mail-provider.tar.gz</span><br><span class="line">mkdir -p mail-provider</span><br><span class="line">tar zxvf mail-provider.tar.gz  -C mail-provider</span><br><span class="line">cd mail-provider</span><br></pre></td></tr></table></figure>
<p>修改cfg.json文件相关信息，使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./control start</span><br></pre></td></tr></table></figure>
<h4 id="2-源码编译（如无科学上网方法，请勿尝试）"><a href="#2-源码编译（如无科学上网方法，请勿尝试）" class="headerlink" title="2.源码编译（如无科学上网方法，请勿尝试）"></a>2.源码编译（如无科学上网方法，请勿尝试）</h4><p>下载之后为源码，安装golang环境，环境配置参考golang环境配置 编译方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd $GOPATH/src</span><br><span class="line">mkdir github.com/open-falcon/ -p</span><br><span class="line">cd github.com/open-falcon/</span><br><span class="line">git clone https://github.com/GitHamburg/mail-provider.git</span><br><span class="line">cd mail-provider</span><br><span class="line">go get ./...</span><br><span class="line">./control build</span><br></pre></td></tr></table></figure>
<p>编译成功之后，修改cfg.json文件相关信息，使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./control start</span><br></pre></td></tr></table></figure>
<h4 id="3、使用方法"><a href="#3、使用方法" class="headerlink" title="3、使用方法"></a>3、使用方法</h4><p>坐着说可以发送给多人，但是实际curl使用的时候发现并不可以。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://$ip:4000/sender/mail -d &quot;tos=a@a.com&amp;subject=xx&amp;content=yy&quot;</span><br></pre></td></tr></table></figure>
<h3 id="微信"><a href="#微信" class="headerlink" title="微信"></a>微信</h3><p><a target="_blank" rel="noopener" href="https://github.com/Yanjunhui/chat.git">https://github.com/Yanjunhui/chat.git</a></p>
<h4 id="一-申请企业号"><a href="#一-申请企业号" class="headerlink" title="一.申请企业号"></a>一.申请企业号</h4><p>以个人邮箱申请就可以, 不通过企业认证的话,有200人的限制,一般足够用了</p>
<h4 id="二-获取对接权限"><a href="#二-获取对接权限" class="headerlink" title="二.获取对接权限"></a>二.获取对接权限</h4><h5 id="1、获取corpid"><a href="#1、获取corpid" class="headerlink" title="1、获取corpid"></a>1、获取corpid</h5><p>登录后,我的企业 —-&gt; 企业信息 –&gt; CorpID<br><img src="https://img.mknight.cn/2018/1539593796324.png" width="901"/><br>将 CorpID 配置到配置文件 config.conf 内 的 CorpID</p>
<h5 id="2、开启回调模式获取key"><a href="#2、开启回调模式获取key" class="headerlink" title="2、开启回调模式获取key"></a>2、开启回调模式获取key</h5><p>登录后,顶部菜单[企业应用] —-&gt; 添加应用<br>进入新添加的应用<br>拿到 AgentId 和 Secret<br><img src="https://img.mknight.cn/2018/1539593870748.png" width="536"/></p>
<h5 id="3、关注微信公众号"><a href="#3、关注微信公众号" class="headerlink" title="3、关注微信公众号"></a>3、关注微信公众号</h5><p>使用微信关注企业号才可以从微信收到信息,否则只能从微信企业号 APP 中收到信息<br><img src="https://img.mknight.cn/2018/1539594107364.png" width="845"/></p>
<h4 id="三、使用"><a href="#三、使用" class="headerlink" title="三、使用"></a>三、使用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://www.github.com/yanjunhui/chat.git</span><br></pre></td></tr></table></figure>

<h4 id="修改chat配置文件"><a href="#修改chat配置文件" class="headerlink" title="修改chat配置文件"></a>修改chat配置文件</h4><img src="https://img.mknight.cn/2018/1539594319320.png" width="479"/>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#http 服务端口</span><br><span class="line">[http]</span><br><span class="line">port = 4567</span><br><span class="line"></span><br><span class="line">#微信接口信息</span><br><span class="line">[weixin]</span><br><span class="line">CorpID = xxxxxx</span><br><span class="line">#ID 应用ID</span><br><span class="line">AgentId = 1   </span><br><span class="line"># Secret</span><br><span class="line">Secret = xxxxxxx</span><br><span class="line">#最后一个无所谓</span><br><span class="line">EncodingAESKey = wodH5dMSQtlfySHED5dkk6dF7saukFpPxlwhWRsVeEn</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">打开目录 cd chat</span><br><span class="line">启动 ./control.sh start</span><br><span class="line">停止 ./control.sh stop</span><br><span class="line">重启 ./control.sh restart</span><br><span class="line">状态 ./control.sh status</span><br></pre></td></tr></table></figure>

<p>但是更新了版本，不知道为啥不正常，发布了微信。</p>
<p>推荐另一种方式，更好调试。</p>
<h3 id="Falcon-wechat"><a href="#Falcon-wechat" class="headerlink" title="Falcon-wechat"></a>Falcon-wechat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/falcon-wechat</span><br><span class="line">cd /usr/local/falcon-wechat</span><br><span class="line">wget https://dl.cactifans.com/open-falcon/falcon-wechat-0.0.1.tar.gz</span><br><span class="line">tar zxvf falcon-wechat-0.0.1.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;debug&quot;: true,</span><br><span class="line">&quot;http&quot;: &#123;</span><br><span class="line">&quot;listen&quot;: &quot;0.0.0.0:9527&quot;,</span><br><span class="line">&quot;token&quot;: &quot;&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;wechat&quot;: &#123;</span><br><span class="line">&quot;corpid&quot;: &quot;wxa7c63522727b6bf0&quot;,</span><br><span class="line">&quot;secret&quot;: &quot;d5S-_XGVd-5HA0o9bkvMMK5Wh1qwCC-YQei4WcL9hSM&quot;,</span><br><span class="line">&quot;agentid&quot;: 1</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后修改alarm接口，重启即可，还能看日志。</p>
<p><a target="_blank" rel="noopener" href="https://www.cactifans.org/open-falcon/1788.html">https://www.cactifans.org/open-falcon/1788.html</a></p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><a target="_blank" rel="noopener" href="http://book.open-falcon.org/zh_0_2/">http://book.open-falcon.org/zh_0_2&#x2F;</a><br><a target="_blank" rel="noopener" href="https://github.com/open-falcon/falcon-plus">https://github.com/open-falcon/falcon-plus</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%9F%BA%E4%BA%8EKubernetes%E7%9A%84Jenkins%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81slave.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%9F%BA%E4%BA%8EKubernetes%E7%9A%84Jenkins%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81slave.html" class="post-title-link" itemprop="url">基于Kubernetes的Jenkins实现动态slave</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一般情况下都是在物理机或者虚拟机上部署Jenkins，但是这种部署方式会存在一些缺点，比如：</p>
<ol>
<li>master节点故障，整体不可用</li>
<li>每个slave都需要维护，较为繁琐</li>
<li>资源分配不均衡，且资源利用率低</li>
</ol>
<p>因此需要更可靠和高效的方式来完成CI&#x2F;CD流程。</p>
<p><img src="https://img.mknight.cn/medivh/1649815494764.png" alt="1649815494764.png"></p>
<p>如图所示，master和slave以Pod的形式运行在kubernetes集群中，并且将配置数据存储到PV中。但是其中slave运行在多个节点，但是不是一直运行的状态，会根据需求动态创建并自动删除。</p>
<p>工作流程：</p>
<ol>
<li>master接收到build请求，会根据配置的label动态创建一个slave的Pod并注册到master</li>
<li>slave运行完job，该Pod自动注销并且删除</li>
<li>恢复到最初的状态</li>
</ol>
<p>架构优点：</p>
<ol>
<li>高可用。当master故障时，kubernetes 会自动创建一个新的Pod，并且将之前的PV分配给新的Pod，保证数据的完整</li>
<li>动态伸缩。根据job来动态创建slave的Pod，并且完成后自动释放资源，提供资源利用率</li>
<li>可扩展。当资源不足时，可以通过增加node的方式快速增加slave</li>
</ol>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="编排文件"><a href="#编排文件" class="headerlink" title="编排文件"></a>编排文件</h3><ol>
<li>PV&#x2F;PVC 提供数据持久化</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  nfs:</span><br><span class="line">    server: x.x.x.x</span><br><span class="line">    path: /Public/jenkins</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-pvc</span><br><span class="line">  namespace: devops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 500Gi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>角色授权</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-sa</span><br><span class="line">  namespace: devops</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-cr</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">&quot;extensions&quot;</span>, <span class="string">&quot;apps&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods/exec&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-crd</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: jenkins-cr</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: jenkins-sa</span><br><span class="line">  namespace: devops</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建deployment</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: devops </span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: jenkins</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      serviceAccount: jenkins-sa</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: jenkins/jenkins:lts</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name:JAVA_OPTS</span><br><span class="line">          value: -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai -Dhudson.model.DownloadService.noSignatureCheck=<span class="literal">true</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: web</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">          name: agent</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkinshome</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">      volumes:</span><br><span class="line">      - name: jenkinshome</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: jenkins-pvc</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: devops </span><br><span class="line">  labels:</span><br><span class="line">    app: jenkins</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30002</span><br><span class="line">  - name: agent</span><br><span class="line">    port: 50000</span><br><span class="line">    targetPort: agent</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>依次执行上述编排文件即可。需要注意PV的文件目录权限是否需要单独修改。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>Jenkins启动后先进行初步配置，此处不在详细描述。需要注意的是：</p>
<ul>
<li>访问的地址是使用的nodePort：30002端口</li>
<li>初始化的密码文件可以从nfs目录上获取</li>
<li>必要插件Pipline和kubernetes</li>
</ul>
<h4 id="配置kubernetes"><a href="#配置kubernetes" class="headerlink" title="配置kubernetes"></a>配置kubernetes</h4><p>节点管理-》Configure Clouds -》kubernetes</p>
<p><img src="https://img.mknight.cn/medivh/1649817346433.png" alt="1649817346433.png"></p>
<p>Kubernetes Cloud details</p>
<p><img src="https://img.mknight.cn/medivh/1649817406288.png" alt="1649817406288.png"></p>
<blockquote>
<ol>
<li>注意此处填写的是kubernetes 集群6443的地址。</li>
<li>由于之前创建了account，因此此处无需填写凭据</li>
<li>命名空间可以独立</li>
<li>信息填写完成后注意测试一下。如果测试失败，很可能是权限问题，需要把ServiceAccount的凭证jenkins-sa添加进来。</li>
</ol>
</blockquote>
<p><img src="https://img.mknight.cn/medivh/1649817519819.png" alt="1649817519819.png"></p>
<blockquote>
<p>注意此处的Jenkins地址，要填写 <a target="_blank" rel="noopener" href="http://jenkins.devops.svc.cluster.local:8080/">http://jenkins.devops.svc.cluster.local:8080</a> 。因为之后slave的Pod是需要访问master节点的，只有这种域名的形式才能更灵活的满足需求。如果想不明白为什么是这样的域名，可以思考一下域名解析的过程。</p>
</blockquote>
<p><img src="https://img.mknight.cn/medivh/1649817671870.png" alt="1649817671870.png"></p>
<p><img src="https://img.mknight.cn/medivh/1649817705400.png" alt="1649817705400.png"></p>
<blockquote>
<p>这两部分是配置slave的Pod的，重点部分在于镜像。jnlp是Jenkins的slave访问master的一种方式。</p>
</blockquote>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p><img src="https://img.mknight.cn/medivh/1649817799601.png" alt="1649817799601.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl get pods -n devops</span><br><span class="line">NAME                       READY   STATUS        RESTARTS   AGE</span><br><span class="line">jenkins-666657ffdd-vvdx8   1/1     Running       0          16h</span><br><span class="line">test-6-5gh46-qfs4k-jz13z   0/2     Terminating   0          61s</span><br></pre></td></tr></table></figure>

<p>此时slave的Pod已经运行完成，自动终止了，之后会自动释放。</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="使用podTemplate"><a href="#使用podTemplate" class="headerlink" title="使用podTemplate"></a>使用podTemplate</h3><p>根据标签，调度到其他节点，且使用Jenkins-slave的label</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">podTemplate(cloud: <span class="string">&#x27;kubernetes&#x27;</span>, inheritFrom: <span class="string">&#x27;jenkins-slave&#x27;</span>, label: <span class="string">&#x27;jenkins-slave&#x27;</span>, name: <span class="string">&#x27;test-label&#x27;</span>, namespace: <span class="string">&#x27;devops&#x27;</span>) &#123;</span><br><span class="line">    // some block</span><br><span class="line">&#125;</span><br><span class="line">node(<span class="string">&#x27;jenkins-slave&#x27;</span>) &#123;</span><br><span class="line">    stage(<span class="string">&#x27;get code&#x27;</span>) &#123;</span><br><span class="line">      git credentialsId: <span class="string">&#x27;04bfb304-3573-4876-ad8c-52e43d047d6a&#x27;</span>, url: <span class="string">&#x27;http://192.168.1.110/SystemProject/joyshebao/DiscoveryServer.git&#x27;</span> </span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;build&#x27;</span>) &#123;</span><br><span class="line">      container(<span class="string">&#x27;maven381&#x27;</span>) &#123;</span><br><span class="line">          sh <span class="string">&#x27;mvn -Dmaven.test.skip=true clean package  -f  pom.xml&#x27;</span></span><br><span class="line">          archiveArtifacts <span class="string">&#x27;**/target/*.jar&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调度后的Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">jenkins-666657ffdd-vvdx8   1/1     Running   0          2d17h   10.200.128.174   uat-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">jenkins-slave-6pz0c        2/2     Running   0          19s     10.200.229.150   pre-205      &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="使用变量"><a href="#使用变量" class="headerlink" title="使用变量"></a>使用变量</h3><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>纠结了好几天，总算调试出一些结果。</p>
<ol>
<li>事实证明，label的作用是决定是否使用模板，和kubernetes中的label毫无关系；</li>
<li>脚本式的pipeline和声明式的pipeline存在很大的不同，至少语法上就有很大差别；</li>
<li>解决了maven项目重复下载依赖的问题，挂载.m2目录即可；</li>
</ol>
<p>目前仍存在的问题：</p>
<ol>
<li>如何决定让slave不运行在某些机器上？</li>
<li>哪种pipeline才是主流呢？</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/influxdb%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/influxdb%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.html" class="post-title-link" itemprop="url">influxdb基本使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">brew install influxdb</span><br><span class="line"></span><br><span class="line">ln -sfv /usr/local/opt/influxdb/*.plist ~/Library/LaunchAgents</span><br><span class="line"></span><br><span class="line"># 配置文件在/etc/influxdb/influxdb.conf ，如果没有就将/usr/local/etc/influxdb.conf 拷一个过去</span><br><span class="line"></span><br><span class="line">配置缓存：cache-max-memory-size</span><br><span class="line"></span><br><span class="line">#启动服务</span><br><span class="line"></span><br><span class="line">launchctl load ~/Library/LaunchAgents/homebrew.mxcl.influxdb.plist</span><br><span class="line"></span><br><span class="line">#停止服务</span><br><span class="line"></span><br><span class="line">launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.influxdb.plist</span><br><span class="line"></span><br><span class="line">#前台启动</span><br><span class="line"></span><br><span class="line">influxd -config /usr/local/etc/influxdb.conf</span><br><span class="line"></span><br><span class="line">查看influxdb运行配置</span><br><span class="line"></span><br><span class="line">influxd config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动客户端</span><br><span class="line"></span><br><span class="line">influx -precision rfc3339</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1、创建数据库</span><br><span class="line"></span><br><span class="line">create database mydb</span><br><span class="line"></span><br><span class="line">2、删除数据库</span><br><span class="line"></span><br><span class="line">drop database mydb</span><br><span class="line"></span><br><span class="line">3、使用数据库</span><br><span class="line"></span><br><span class="line">use mydb</span><br><span class="line"></span><br><span class="line">4、插入数据库</span><br><span class="line"></span><br><span class="line">insert mt,type=item,sensor=sensor01 value=3,is_delete=0</span><br><span class="line"></span><br><span class="line">注意：第一次插入数据会确定数据类型，之后的插入不能换数据类型。</span><br><span class="line"></span><br><span class="line">插入同一时间的数据会覆盖旧的，时间是主键。可以乱序插入。</span><br><span class="line"></span><br><span class="line">5、查询</span><br><span class="line"></span><br><span class="line">select * from mt</span><br><span class="line"></span><br><span class="line">where 中对字符串的过滤必须用单引号，tag默认为字符串类型</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Jenkins%202.121%20%E9%83%A8%E7%BD%B2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Jenkins%202.121%20%E9%83%A8%E7%BD%B2.html" class="post-title-link" itemprop="url">Jenkins 2.121 部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JDK     1.8.0_91</span><br><span class="line">Tomecat apache-tomcat-8.0.45</span><br><span class="line">Jenkins 1.121.3</span><br></pre></td></tr></table></figure>
<h2 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h2><h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/ &amp;&amp; tar -zxvf ./jdk1.8.0_91.tar.gz -C /usr/local</span><br><span class="line">ln -s /usr/local/jdk1.8.0_91 /usr/local/java</span><br><span class="line">echo &#x27;</span><br><span class="line">#JDK</span><br><span class="line">############################################################</span><br><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">############################################################</span><br><span class="line">&#x27; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h3 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/</span><br><span class="line">wget http://mirrors.cnnic.cn/apache/maven/maven-3/3.0.5/binaries/apache-maven-3.0.5-bin.tar.gz</span><br><span class="line">tar -zxvf apache-maven-3.0.5-bin.tar.gz  -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -s apache-maven-3.0.5 maven</span><br><span class="line"></span><br><span class="line">echo &#x27;</span><br><span class="line">#maven</span><br><span class="line">############################################################</span><br><span class="line">export MAVEN_HOME=/usr/local/maven</span><br><span class="line">export PATH=$&#123;MAVEN_HOME&#125;/bin:$&#123;PATH&#125;</span><br><span class="line">############################################################</span><br><span class="line">&#x27; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h2><h3 id="部署war包"><a href="#部署war包" class="headerlink" title="部署war包"></a>部署war包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src</span><br><span class="line">wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span><br><span class="line">cp jenkins.war /usr/local/apache-tomcat-8.0.45/webapps</span><br></pre></td></tr></table></figure>
<h3 id="启动tomcat"><a href="#启动tomcat" class="headerlink" title="启动tomcat"></a>启动tomcat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/apache-tomcat-8.0.45/bin/catalina.sh start</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>访问<a target="_blank" rel="noopener" href="http://192.168.1.232:8080/jenkins">http://192.168.1.232:8080/jenkins</a> 根据提示输入初始化安装的key<br>如果提示离线安装，可以选择跳过代理设置。之后再设置插件管理中的更新地址，更改https为http。</p>
<blockquote>
<p>注意，有时候第一次启动后登录会出现空白页面，解决方式：重启一下就好了。如果还不能解决，那你就遇上大问题了。youxia</p>
</blockquote>
<h3 id="1-修改主目录"><a href="#1-修改主目录" class="headerlink" title="1 修改主目录"></a>1 修改主目录</h3><ol>
<li>修改&#x2F;etc&#x2F;profile<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">############################################################</span><br><span class="line">JENKINS_HOME=/xxxx/jenkins/data</span><br><span class="line">############################################################</span><br></pre></td></tr></table></figure></li>
<li>修改tomcat<br>增加以下内容</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JENKINS_HOME=&quot;/xxxx/jenkins/data&quot;</span><br></pre></td></tr></table></figure>



<h3 id="2-配置插件"><a href="#2-配置插件" class="headerlink" title="2 配置插件"></a>2 配置插件</h3><p>系统管理-管理插件-高级，将URL修改为http，然后重新获取即可。<br><img src="https://img.mknight.cn/medivh/1553484237221.png" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">创建项目</span><br><span class="line">切换到指定目录</span><br><span class="line">mvn archetype:create -DgroupId=com.learn -DartifactId=LearnNew -DarchetypeArtifactId=maven-archetype-webapp</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8EMac%E4%B8%8AMySQL%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8EMac%E4%B8%8AMySQL%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98.html" class="post-title-link" itemprop="url">关于Mac上MySQL认证失败的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>今天遇到了点小问题，想重构一个项目，顺便创建一个干净的数据库，但是连接失败！</p>
</blockquote>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><img src="https://img.mknight.cn/medivh/1638526336673.png" alt="1638526336673.png"></p>
<p>事实上我在终端上测试后确定账号和密码是没有问题的，因此重点查看软件和MySQL。终于仔细检查后发现是认证失败的问题。这个问题就很纳闷，咋会遇到这种问题，只好看看大家有没有遇到过。难道是Sequel Pro的问题？不应该吧，这就是一个普通的开源软件。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>终于找到一篇靠谱的文章，描述了异常的原因，而不是直接说怎么解决。<br>主要原因是8.x版本的MySQL的验证机制变成了caching_sha2_password，并不是原来的mysql_native_password。问题说简单也简单，说复杂也复杂，升级个版本还有这样的问题，怪不得没有太多人愿意随便升版本。</p>
<h3 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h3><p>低版本的MySQL，比如5.6，使用的时候是这样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database xxx charset=utf8mb4;</span><br><span class="line">CREATE USER <span class="string">&#x27;xxx&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON xxx.* TO <span class="string">&#x27;xxx&#x27;</span>@<span class="string">&#x27;%&#x27;</span>  WITH GRANT OPTION; </span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>而对于高版本的比如8.x就得用以下的方式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;123456&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>完事,再用Sequel Pro 连接就成功了,其他工具navicat也是这么操作,一样可以连接了。</p>
<p><img src="https://img.mknight.cn/medivh/1638526875427.png" alt="1638526875427.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实其他版本的MySQL也会有其他的问题，和低版本相比而言，之后再整理一下。<br>很快就要休假了，反而又热爱上了工作，可笑。。。<br>但愿假期一切安好吧！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E5%AE%A1%E6%89%B9%E8%A7%84%E8%8C%83.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E5%AE%A1%E6%89%B9%E8%A7%84%E8%8C%83.html" class="post-title-link" itemprop="url">数据库操作审批规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%9A%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">业务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="总则"><a href="#总则" class="headerlink" title="总则"></a>总则</h2><p>为规范生产环境数据库管理和操作，提高审核执行效率，特制定本规范。</p>
<h2 id="适用范围"><a href="#适用范围" class="headerlink" title="适用范围"></a>适用范围</h2><p>本规范中所定义的数据管理内容，指生产环境中的数据库（公司内部项目以及外部项目中的数据库），且包括并不限于 MySQL、Redis、Hive 等。</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><ul>
<li>普通数据：<ul>
<li>表结构、常规非涉密字段等数据</li>
</ul>
</li>
<li>涉密数据：<ul>
<li>用户信息，包括并不限于手机号、姓名、地址、IP、IMEI 等</li>
<li>公司运行数据，包括并不限于业务订单等</li>
</ul>
</li>
</ul>
<h2 id="操作等级"><a href="#操作等级" class="headerlink" title="操作等级"></a>操作等级</h2><table>
<thead>
<tr>
<th>等级</th>
<th>审核</th>
<th>审核对象</th>
<th>适用类型</th>
<th>数量</th>
<th>是否涉密</th>
<th>可靠性级别</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>否</td>
<td>自行审核</td>
<td>查询表结构、数量、非涉密数据</td>
<td>&lt;1000</td>
<td>否</td>
<td>普通</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>是</td>
<td>项目组长</td>
<td>修改表结构或字段、插入数据，查询大量数据</td>
<td>&lt;5000</td>
<td>否</td>
<td>普通&#x2F;重要</td>
<td>评估后如果影响大，抄送给相关业务线人员，以及技术总监</td>
</tr>
<tr>
<td>2</td>
<td>是</td>
<td>项目组长</td>
<td>查询涉密数据</td>
<td>&lt;100</td>
<td>是</td>
<td>普通</td>
<td>抄送技术总监</td>
</tr>
<tr>
<td>3</td>
<td>是</td>
<td>技术总监</td>
<td>删除表、数据等</td>
<td></td>
<td>否</td>
<td>重要</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>是</td>
<td>技术总监</td>
<td>查询涉密数据</td>
<td>&gt;100</td>
<td>是</td>
<td>普通</td>
<td></td>
</tr>
</tbody></table>
<h2 id="操作规则"><a href="#操作规则" class="headerlink" title="操作规则"></a>操作规则</h2><ul>
<li>所有操作必须通过邮件来传递，运维人员不接受邮件以外的请求;</li>
<li>所有操作必须在主题中表明操作等级，通过操作等级来区分是否需要审核或者其他;</li>
<li>运维人员只接受项目组长或技术总监审核结果，不接受开发者操作请求（可弹性）;</li>
<li>严禁 drop 或者 delete 表操作。如有特殊情况，项目组长在邮件内容中说明操作理由；</li>
<li>SQL 语法错误，不予执行；</li>
<li>SQL 需按照标准语法，必须使用分号结尾,且插入语句不得包含数据库名称。</li>
</ul>
<h3 id="示例如下："><a href="#示例如下：" class="headerlink" title="示例如下："></a>示例如下：</h3><h4 id="开发人员希望查询-A-表的表结构，"><a href="#开发人员希望查询-A-表的表结构，" class="headerlink" title="开发人员希望查询 A 表的表结构，"></a>开发人员希望查询 A 表的表结构，</h4><p>1.邮件需要填写以下内容：</p>
<ul>
<li><p>邮件主题 等级 0+简要目的说明</p>
</li>
<li><p>收件人 项目组长</p>
</li>
<li><p>抄送 运维人员</p>
</li>
<li><p>邮件内容<br> * 查询 SQL</p>
<p>2.项目组长审核</p>
<p>3.上述流程完成，运维人员收到项目组长同意的结果后执行上述查询请求。</p>
</li>
</ul>
<h4 id="开发人员查询用户数据且大于-100-条："><a href="#开发人员查询用户数据且大于-100-条：" class="headerlink" title="开发人员查询用户数据且大于 100 条："></a>开发人员查询用户数据且大于 100 条：</h4><p>1.开发人员发起请求</p>
<ul>
<li><p>邮件主题 等级 4+简要目的说明</p>
</li>
<li><p>收件人 项目组长</p>
</li>
<li><p>抄送 运维人员</p>
</li>
<li><p>邮件内容<br> _ 查询原因<br>_ 查询 SQL</p>
<p>2.项目组长审核</p>
</li>
<li><p>如果审核通过，项目组长发送邮件给技术总监请求审核；</p>
</li>
<li><p>如果未通过，开发者调整 SQL 或取消查询</p>
<p>3.技术总监收到项目组长邮件申请请求</p>
</li>
<li><p>审核结果回复给项目组长</p>
<p>4.上述流程完成，运维人员收到技术总监同意的结果后执行上述查询请求。</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
