<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="https://img.econow.cn/2018/1545104669394.png"><link rel="icon" type="image/png" sizes="16x16" href="https://img.econow.cn/2018/1545104669394.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="前言中国观鸟记录中心，这个网站有点特殊，不同于平时常见的网站，header的部分字段和响应数据都是加密的。最重要的是加密方式是在Ajax中处理的。综上所述，记录一下这类网站的逆向过程。"><meta property="og:type" content="article"><meta property="og:title" content="【爬虫实战】使用Python和JS逆向观鸟网Search接口"><meta property="og:url" content="https://econow.cn/2023/11/20/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E8%A7%82%E9%B8%9F%E7%BD%91Search%E6%8E%A5%E5%8F%A3/index.html"><meta property="og:site_name" content="Medivh&#39;s castle"><meta property="og:description" content="前言中国观鸟记录中心，这个网站有点特殊，不同于平时常见的网站，header的部分字段和响应数据都是加密的。最重要的是加密方式是在Ajax中处理的。综上所述，记录一下这类网站的逆向过程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.econow.cn/blog/1700536925964.png"><meta property="og:image" content="https://img.econow.cn/blog/1700452323638.png"><meta property="og:image" content="https://img.econow.cn/blog/1700452561333.png"><meta property="og:image" content="https://img.econow.cn/blog/1700458588820.png"><meta property="og:image" content="https://img.econow.cn/blog/1700458839224.png"><meta property="og:image" content="https://img.econow.cn/blog/1700458975775.png"><meta property="og:image" content="https://img.econow.cn/blog/1700459701417.png"><meta property="og:image" content="https://img.econow.cn/blog/1700459982736.png"><meta property="og:image" content="https://img.econow.cn/blog/1700460340474.png"><meta property="og:image" content="https://img.econow.cn/blog/1700460523251.png"><meta property="og:image" content="https://img.econow.cn/blog/1700534818585.png"><meta property="og:image" content="https://img.econow.cn/blog/1700534808172.png"><meta property="og:image" content="https://img.econow.cn/blog/1700534921610.png"><meta property="og:image" content="https://img.econow.cn/blog/1700534510371.png"><meta property="og:image" content="https://img.econow.cn/blog/1700534510371.png"><meta property="og:image" content="https://img.econow.cn/blog/1700535161627.png"><meta property="og:image" content="https://img.econow.cn/blog/1700535161627.png"><meta property="og:image" content="https://img.econow.cn/blog/1700535161627.png"><meta property="og:image" content="https://img.econow.cn/blog/1700535576237.png"><meta property="og:image" content="https://img.econow.cn/blog/1700535617406.png"><meta property="og:image" content="https://img.econow.cn/blog/1694161435741.png"><meta property="og:image" content="https://img.econow.cn/blog/1694161563211.png"><meta property="og:image" content="https://img.econow.cn/blog/1700536292935.png"><meta property="og:image" content="https://img.econow.cn/blog/1700536383895.png"><meta property="og:image" content="https://img.econow.cn/blog/1700536531773.png"><meta property="og:image" content="https://img.econow.cn/blog/1700536531773.png"><meta property="article:published_time" content="2023-11-20T03:08:57.000Z"><meta property="article:modified_time" content="2023-11-21T03:24:32.247Z"><meta property="article:author" content="medivh"><meta property="article:tag" content="Python"><meta property="article:tag" content="爬虫"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.econow.cn/blog/1700536925964.png"><link rel="canonical" href="https://econow.cn/2023/11/20/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E8%A7%82%E9%B8%9F%E7%BD%91Search%E6%8E%A5%E5%8F%A3/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://econow.cn/2023/11/20/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E8%A7%82%E9%B8%9F%E7%BD%91Search%E6%8E%A5%E5%8F%A3/","path":"2023/11/20/【爬虫实战】使用Python和JS逆向观鸟网Search接口/","title":"【爬虫实战】使用Python和JS逆向观鸟网Search接口"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>【爬虫实战】使用Python和JS逆向观鸟网Search接口 | Medivh's castle</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?21ded952ca9fc25e2b0630494a17ec7f"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Medivh's castle</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%9B%AE%E7%9A%84%E6%95%B4%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">一、目的整理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">二、逻辑分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%87%BD%E6%95%B0%E5%AE%9A%E4%BD%8D"><span class="nav-number">3.1.</span> <span class="nav-text">1. 函数定位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%8A%A0%E5%AF%86%E9%80%BB%E8%BE%91"><span class="nav-number">3.2.</span> <span class="nav-text">2. 加密逻辑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">三、代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8F%91%E5%87%BA%E8%AF%B7%E6%B1%82%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-number">4.1.</span> <span class="nav-text">1. 发出请求获取数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%A7%A3%E5%AF%86%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE"><span class="nav-number">4.2.</span> <span class="nav-text">2. 解密请求数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%8F%A6%E5%A4%96%E4%B8%80%E7%A7%8D%E5%AE%9A%E4%BD%8D%E6%96%B9%E5%BC%8F%E2%80%94hook%E5%87%BD%E6%95%B0"><span class="nav-number">5.</span> <span class="nav-text">四、另外一种定位方式—hook函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%9D%E6%AD%A5%E7%90%86%E8%A7%A3"><span class="nav-number">5.1.</span> <span class="nav-text">1. 初步理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-number">5.2.</span> <span class="nav-text">2. 简单使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">五、总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">medivh</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">103</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">48</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://econow.cn/2023/11/20/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E8%A7%82%E9%B8%9F%E7%BD%91Search%E6%8E%A5%E5%8F%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="medivh"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Medivh's castle"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="【爬虫实战】使用Python和JS逆向观鸟网Search接口 | Medivh's castle"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">【爬虫实战】使用Python和JS逆向观鸟网Search接口</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-20 11:08:57" itemprop="dateCreated datePublished" datetime="2023-11-20T11:08:57+08:00">2023-11-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-11-21 11:24:32" itemprop="dateModified" datetime="2023-11-21T11:24:32+08:00">2023-11-21</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a> </span></span><span id="/2023/11/20/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E8%A7%82%E9%B8%9F%E7%BD%91Search%E6%8E%A5%E5%8F%A3/" class="post-meta-item leancloud_visitors" data-flag-title="【爬虫实战】使用Python和JS逆向观鸟网Search接口" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>中国观鸟记录中心，这个网站有点特殊，不同于平时常见的网站，header的部分字段和响应数据都是加密的。最重要的是加密方式是在Ajax中处理的。综上所述，记录一下这类网站的逆向过程。</p><h2 id="一、目的整理"><a href="#一、目的整理" class="headerlink" title="一、目的整理"></a>一、目的整理</h2><p>首先看一下目标数据：</p><p><img data-src="https://img.econow.cn/blog/1700536925964.png"></p><p>可以看到header里有个Sign的加密字段。</p><p>提交的数据也是加密后的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IlK5l/qQzp2wezTIFutF0AhbjY1YFnaupfdqZDsQEGPRmJuseYDk0aC72qTdeUMExSFPav6CkGqUNvQ/K2HawAQ3dO5naN23qx/I9QZboOdfxwJ5KJ2Rq++s5qRv0DiC8YaC+n3+dokGwzQGXIzvtkSOgeOOzEsuo47NXcInmQU: </span><br></pre></td></tr></table></figure><p>响应数据也是一样加密的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;count&quot;</span>: 365105,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: <span class="string">&quot;tOlWskGAcviXt0rdOEToBWsBg0Ch1EkiAcpX7208UVAFBKwJtL5sDR6h/VV2f7YeJfKbF2Yvav2nsH1P8h1zCXv/b4ygt4uxYOfNU+8n...后续省略&quot;</span>,</span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: 1700450808,</span><br><span class="line">    <span class="string">&quot;sign&quot;</span>: <span class="string">&quot;1387B4CC7227D0DD5C5CD3459AF60197&quot;</span>,</span><br><span class="line">    <span class="string">&quot;requestId&quot;</span>: <span class="string">&quot;ED797483-CCB0-4CC6-8362-D0253922BA7F&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以我们逆向的顺序就是先破解Sign，然后破解提交的data，最后就是响应数据。</p><h2 id="二、逻辑分析"><a href="#二、逻辑分析" class="headerlink" title="二、逻辑分析"></a>二、逻辑分析</h2><h3 id="1-函数定位"><a href="#1-函数定位" class="headerlink" title="1. 函数定位"></a>1. 函数定位</h3><p>首先要分析Sign的生成方式定位。如果按照往常全局搜索的方式的话，大概率是拿不到想要结果的，因为这个网站的相关功能真的搜不到。其实无论是<code>Sign</code>关键字还是搜索接口地址都是一样的。这种情况就需要使用另外一种方式了，使用启动器逐级查找。毕竟隐藏的再深的接口或者函数总之要在启动器这里留下痕迹的。</p><p>一级一级去查：</p><p><img data-src="https://img.econow.cn/blog/1700452323638.png"></p><p>需要注意URL得是正确的</p><p><img data-src="https://img.econow.cn/blog/1700452561333.png"></p><p>可以看到这时候已经有返回值了，所以要往上一层找。</p><p>接下来就找到了这里，可以看到<code>r</code>和 <code>k</code>分别携带了加密的Sign和提交的data。</p><p><img data-src="https://img.econow.cn/blog/1700458588820.png"></p><p>既然已经生成了明文，所以就需要继续往前找。这样就找到了<code>t.ajax</code>。</p><p><img data-src="https://img.econow.cn/blog/1700458839224.png"></p><p>里面有一个明显的参数<code>data</code>和<code>headers</code>，但是这个header里是未定义的，<code>data</code>里的数据也不是密文。所以再继续请求看一下。</p><p><img data-src="https://img.econow.cn/blog/1700458975775.png"></p><p>这时候可以看到请求成功后返回的数据就是咱们之前看到的接口响应数据。</p><p>到了这里就可以说明一些问题，既然在发送请求前<code>data</code>和<code>header</code>都是明文的，加密处理就只能出现在发送请求这一段代码里，也就是<code>t.ajax</code>。接下来再次定位一下这段代码验证一下。</p><p><img data-src="https://img.econow.cn/blog/1700459701417.png"></p><p>现在就跟踪到了<code>jquery.min.js</code>，说明有可能这里的代码被改写过。这个函数代码有很多，浏览一下看看哪里有嫌疑的地方打上断点。由图可知，到了这里，<code>data</code>和<code>header</code>还都是明文的。对于后面的代码不太好直接判断哪些代码是相关的，只能根据一些经验进行猜测，比如相关的就是<code>data</code>和<code>header</code>，所以在后面打上断点。</p><p><img data-src="https://img.econow.cn/blog/1700459982736.png"></p><p>可以看到<code>k.data</code>的值已经变化了，之前的是一个对象，现在变成了字符串。但是header还是空白的，所以还得继续完后走。</p><p><img data-src="https://img.econow.cn/blog/1700460340474.png"></p><h3 id="2-加密逻辑"><a href="#2-加密逻辑" class="headerlink" title="2. 加密逻辑"></a>2. 加密逻辑</h3><p>继续走到后面发现l的data和k的data已经生成密文了，所以加密函数一定在下面的代码里：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (k.<span class="property">beforeSend</span> &amp;&amp; (k.<span class="property">beforeSend</span>.<span class="title function_">call</span>(l, v, k) === !<span class="number">1</span> || <span class="number">2</span> === t))</span><br><span class="line">               <span class="keyword">return</span> v.<span class="title function_">abort</span>();</span><br></pre></td></tr></table></figure><p><img data-src="https://img.econow.cn/blog/1700460523251.png"></p><p>这时候答案就呼之欲出了，加密逻辑在这里：</p><ul><li>c是日期函数生成的</li><li>d 是uuid</li><li>e是之前的字符串JSON处理</li><li>f 就是前面三个参数进行MD5处理。</li></ul><p>可以看到使用的是encrypt这个加密方式对sign做了处理。其实这个库在node.js 中对应的是<code>node-jsencrypt</code>，使用的时候要提前安装。</p><p>但是在复制JS代码后执行的时候会发现没有<code>encryptUnicodeLong</code>这个方法，因为这个是自定义的。因此需要修改源码来实现，点击<code>encryptUnicodeLong</code>可以看到下面的代码</p><p><img data-src="https://img.econow.cn/blog/1700534818585.png"></p><p><img data-src="https://img.econow.cn/blog/1700534808172.png"></p><p>可以看到有若干的中文注释，所以又很好的佐证了这是自定义的方法。所以我们完全可以仿照这种写法将这三段放入我们的源码中。找到node-jsencrypt 的相关文件加进去就可以了：</p><p><img data-src="https://img.econow.cn/blog/1700534921610.png"></p><p>全部代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//任意长度RSA Key分段加密解密长字符串</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取RSA key 长度</span></span><br><span class="line">    <span class="title class_">JSEncrypt</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getkeylength</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="variable language_">this</span>.<span class="property">key</span>.<span class="property">n</span>.<span class="title function_">bitLength</span>() + <span class="number">7</span>) &gt;&gt; <span class="number">3</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分段解密，支持中文</span></span><br><span class="line">    <span class="title class_">JSEncrypt</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">decryptUnicodeLong</span> = <span class="keyword">function</span> (<span class="params">string</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> k = <span class="variable language_">this</span>.<span class="title function_">getKey</span>();</span><br><span class="line">        <span class="comment">//解密长度=key size.hex2b64结果是每字节每两字符，所以直接*2</span></span><br><span class="line">        <span class="keyword">var</span> maxLength = ((k.<span class="property">n</span>.<span class="title function_">bitLength</span>() + <span class="number">7</span>) &gt;&gt; <span class="number">3</span>) * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> hexString = <span class="title function_">b64tohex</span>(string);</span><br><span class="line">            <span class="keyword">var</span> decryptedString = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> rexStr = <span class="string">&quot;.&#123;1,&quot;</span> + maxLength + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> rex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(rexStr, <span class="string">&#x27;g&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> subStrArray = hexString.<span class="title function_">match</span>(rex);</span><br><span class="line">            <span class="keyword">if</span> (subStrArray) &#123;</span><br><span class="line">                subStrArray.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">entry</span>) &#123;</span><br><span class="line">                    decryptedString += k.<span class="title function_">decrypt</span>(entry);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> decryptedString;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分段加密，支持中文</span></span><br><span class="line">    <span class="title class_">JSEncrypt</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">encryptUnicodeLong</span> = <span class="keyword">function</span> (<span class="params">string</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> k = <span class="variable language_">this</span>.<span class="title function_">getKey</span>();</span><br><span class="line">        <span class="comment">//根据key所能编码的最大长度来定分段长度。key size - 11：11字节随机padding使每次加密结果都不同。</span></span><br><span class="line">        <span class="keyword">var</span> maxLength = ((k.<span class="property">n</span>.<span class="title function_">bitLength</span>() + <span class="number">7</span>) &gt;&gt; <span class="number">3</span>) - <span class="number">11</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> subStr = <span class="string">&quot;&quot;</span>, encryptedString = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> subStart = <span class="number">0</span>, subEnd = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> bitLen = <span class="number">0</span>, tmpPoint = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = string.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">                <span class="comment">//js 是使用 Unicode 编码的，每个字符所占用的字节数不同</span></span><br><span class="line">                <span class="keyword">var</span> charCode = string.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">                <span class="keyword">if</span> (charCode &lt;= <span class="number">0x007f</span>) &#123;</span><br><span class="line">                    bitLen += <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (charCode &lt;= <span class="number">0x07ff</span>) &#123;</span><br><span class="line">                    bitLen += <span class="number">2</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (charCode &lt;= <span class="number">0xffff</span>) &#123;</span><br><span class="line">                    bitLen += <span class="number">3</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bitLen += <span class="number">4</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//字节数到达上限，获取子字符串加密并追加到总字符串后。更新下一个字符串起始位置及字节计算。</span></span><br><span class="line">                <span class="keyword">if</span> (bitLen &gt; maxLength) &#123;</span><br><span class="line">                    subStr = string.<span class="title function_">substring</span>(subStart, subEnd)</span><br><span class="line">                    encryptedString += k.<span class="title function_">encrypt</span>(subStr);</span><br><span class="line">                    subStart = subEnd;</span><br><span class="line">                    bitLen = bitLen - tmpPoint;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    subEnd = i;</span><br><span class="line">                    tmpPoint = bitLen;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            subStr = string.<span class="title function_">substring</span>(subStart, len)</span><br><span class="line">            encryptedString += k.<span class="title function_">encrypt</span>(subStr);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">hex2b64</span>(encryptedString);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//添加的函数与方法结束</span></span><br></pre></td></tr></table></figure><h2 id="三、代码实现"><a href="#三、代码实现" class="headerlink" title="三、代码实现"></a>三、代码实现</h2><h3 id="1-发出请求获取数据"><a href="#1-发出请求获取数据" class="headerlink" title="1. 发出请求获取数据"></a>1. 发出请求获取数据</h3><p>需要注意提前安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install node-jsencrypt            </span><br></pre></td></tr></table></figure><p>JS部分：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">JSEncrypt</span> = <span class="built_in">require</span>(<span class="string">&quot;node-jsencrypt&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getUuid</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> s = [];</span><br><span class="line">    <span class="keyword">var</span> a = <span class="string">&quot;0123456789abcdef&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        s[i] = a.<span class="title function_">substr</span>(<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">0x10</span>), <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    s[<span class="number">14</span>] = <span class="string">&quot;4&quot;</span>;</span><br><span class="line">    s[<span class="number">19</span>] = a.<span class="title function_">substr</span>((s[<span class="number">19</span>] &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>, <span class="number">1</span>);</span><br><span class="line">    s[<span class="number">8</span>] = s[<span class="number">13</span>] = s[<span class="number">18</span>] = s[<span class="number">23</span>];</span><br><span class="line">    <span class="keyword">var</span> b = s.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sort_ASCII</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="keyword">var</span> c = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> a) &#123;</span><br><span class="line">        b[c] = i;</span><br><span class="line">        c++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> d = b.<span class="title function_">sort</span>();</span><br><span class="line">    <span class="keyword">var</span> e = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> d) &#123;</span><br><span class="line">        e[d[i]] = a[d[i]]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dataTojson</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> b = [];</span><br><span class="line">    <span class="keyword">var</span> c = &#123;&#125;;</span><br><span class="line">    b = a.<span class="title function_">split</span>(<span class="string">&#x27;&amp;&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; b.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[i].<span class="title function_">indexOf</span>(<span class="string">&#x27;=&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> d = b[i].<span class="title function_">split</span>(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (d.<span class="property">length</span> == <span class="number">2</span>) &#123;</span><br><span class="line">                c[d[<span class="number">0</span>]] = d[<span class="number">1</span>]</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                c[d[<span class="number">0</span>]] = <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c[b[i]] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> paramPublicKey = <span class="string">&quot;MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCvxXa98E1uWXnBzXkS2yHUfnBM6n3PCwLdfIox03T91joBvjtoDqiQ5x3tTOfpHs3LtiqMMEafls6b0YWtgB1dse1W5m+FpeusVkCOkQxB4SZDH6tuerIknnmB/Hsq5wgEkIvO5Pff9biig6AyoAkdWpSek/1/B7zYIepYY0lxKQIDAQAB&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> encrypt = <span class="keyword">new</span> <span class="title class_">JSEncrypt</span>();</span><br><span class="line">encrypt.<span class="title function_">setPublicKey</span>(paramPublicKey);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_headers</span>(<span class="params">b</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="title class_">Date</span>.<span class="title function_">parse</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">var</span> d = <span class="title function_">getUuid</span>();</span><br><span class="line">    <span class="keyword">var</span> e = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title function_">sort_ASCII</span>(<span class="title function_">dataTojson</span>(b || <span class="string">&#x27;&#123;&#125;&#x27;</span>)));</span><br><span class="line">    b = encrypt.<span class="title function_">encryptUnicodeLong</span>(e);</span><br><span class="line">    <span class="keyword">var</span> f = crypto.<span class="title function_">createHash</span>(<span class="string">&quot;md5&quot;</span>).<span class="title function_">update</span>(e + d + c).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">timestamp</span>: c + <span class="string">&quot;&quot;</span>, <span class="attr">requestId</span>: d, <span class="attr">sign</span>: f</span><br><span class="line">        &#125;, <span class="string">&quot;data&quot;</span>: b</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>python部分：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded;charset=UTF-8&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;观鸟网.js&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        js_code = f.read()</span><br><span class="line">    js = execjs.<span class="built_in">compile</span>(js_code)</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;limit&quot;</span>: <span class="string">&quot;20&quot;</span>,</span><br><span class="line">        <span class="string">&quot;page&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    encoded = urlencode(data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;编码后的数据&#x27;</span>, encoded)</span><br><span class="line">    sign_data = js.call(<span class="string">&quot;get_headers&quot;</span>, encoded)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;sign_data:::&quot;</span>, sign_data[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line">    headers.update(sign_data[<span class="string">&#x27;headers&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;headers:::&quot;</span>, headers)</span><br><span class="line">    url = <span class="string">&#x27;https://api.birdreport.cn/front/activity/search&#x27;</span></span><br><span class="line">    res = requests.post(url, headers=headers, data=sign_data[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line">    data = res.json()</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(start())</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出结果：</p><p><img data-src="https://img.econow.cn/blog/1700534510371.png"></p><p><img data-src="https://img.econow.cn/blog/1700534510371.png"></p><h3 id="2-解密请求数据"><a href="#2-解密请求数据" class="headerlink" title="2. 解密请求数据"></a>2. 解密请求数据</h3><p><img data-src="https://img.econow.cn/blog/1700535161627.png"></p><p><img data-src="https://img.econow.cn/blog/1700535161627.png"></p><p>其实解密部分就在最开始的ajax发请求的那里</p><p><img data-src="https://img.econow.cn/blog/1700535161627.png"></p><p>可以看到<code>a.parseData(t)</code>就是解析的方法。</p><p><img data-src="https://img.econow.cn/blog/1700535576237.png"></p><p>加下来是具体的decode</p><p><img data-src="https://img.econow.cn/blog/1700535617406.png"></p><p>代码实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">BIRDREPORT_APIJS</span> = &#123;</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;www.birdreport.cn&quot;</span>, <span class="string">&quot;key&quot;</span>: <span class="string">&quot;3583ec0257e2f4c8195eec7410ff1619&quot;</span>, <span class="string">&quot;iv&quot;</span>: <span class="string">&quot;d93c0d5ec6352f20&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">decode</span>(<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> b = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(<span class="variable constant_">BIRDREPORT_APIJS</span>.<span class="property">key</span>);</span><br><span class="line">    <span class="keyword">var</span> c = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(<span class="variable constant_">BIRDREPORT_APIJS</span>.<span class="property">iv</span>);</span><br><span class="line">    <span class="keyword">var</span> d = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(a, b, &#123;</span><br><span class="line">        <span class="attr">iv</span>: c, <span class="attr">mode</span>: <span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span>, <span class="attr">padding</span>: <span class="title class_">CryptoJS</span>.<span class="property">pad</span>.<span class="property">Pkcs7</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> d.<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parseData</span>(<span class="params">res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> decode_str = <span class="title function_">decode</span>(res.<span class="property">data</span>);</span><br><span class="line">    <span class="keyword">var</span> results = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(decode_str);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;code&quot;</span>: res.<span class="property">code</span>, <span class="string">&quot;count&quot;</span>: res.<span class="property">count</span>, <span class="string">&quot;data&quot;</span>: results</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>python部分：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">res = requests.post(url, headers=headers, data=sign_data[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line">data = res.json()</span><br><span class="line">decode_data = js.call(<span class="string">&#x27;parseData&#x27;</span>,data)</span><br><span class="line"><span class="built_in">print</span>(decode_data)</span><br></pre></td></tr></table></figure><p>直接把密文传给解密函数即可。</p><p>输出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;code&#x27;</span>: 0, <span class="string">&#x27;count&#x27;</span>: 365555, <span class="string">&#x27;data&#x27;</span>: [&#123;<span class="string">&#x27;timeend&#x27;</span>: <span class="string">&#x27;2022-10-24 11:52&#x27;</span>, <span class="string">&#x27;point_id&#x27;</span>: 54428, <span class="string">&#x27;domain_type&#x27;</span>: 0, <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;湖南省长沙市天心区中南林业科技大学(东区)&#x27;</span>, <span class="string">&#x27;outside_count&#x27;</span>: 0, <span class="string">&#x27;point_name&#x27;</span>: <span class="string">&#x27;中南林业科技大学(东区)&#x27;</span>, <span class="string">&#x27;userid&#x27;</span>: 36405, <span class="string">&#x27;timebegin&#x27;</span>: <span class="string">&#x27;2022-10-24 10:52&#x27;</span>, <span class="string">&#x27;province_name&#x27;</span>: <span class="string">&#x27;湖南省&#x27;</span>, <span class="string">&#x27;visits_count&#x27;</span>: 0, <span class="string">&#x27;district_name&#x27;</span>: <span class="string">&#x27;天心区&#x27;</span>, <span class="string">&#x27;city_name&#x27;</span>: <span class="string">&#x27;长沙市&#x27;</span>, <span class="string">&#x27;serial_id&#x27;</span>: <span class="string">&#x27;2023112100136&#x27;</span>, <span class="string">&#x27;taxoncount&#x27;</span>: 1, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;2023112100136&#x27;</span>, <span class="string">&#x27;ctime&#x27;</span>: <span class="string">&#x27;2023-11-21 10:55:35&#x27;</span>, <span class="string">&#x27;location&#x27;</span>: <span class="string">&#x27;112.99929,28.13190&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: 554130, <span class="string">&#x27;state&#x27;</span>: 2, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;中南林野保文鸟&#x27;</span>, <span class="string">&#x27;statistics&#x27;</span>: 1&#125;.....省略]&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="四、另外一种定位方式—hook函数"><a href="#四、另外一种定位方式—hook函数" class="headerlink" title="四、另外一种定位方式—hook函数"></a>四、另外一种定位方式—hook函数</h2><h3 id="1-初步理解"><a href="#1-初步理解" class="headerlink" title="1. 初步理解"></a>1. 初步理解</h3><p>在编程中，”hook” 函数通常指的是一个被设计成允许其他函数插入其执行过程的函数。这种机制通常用于自定义或扩展某个功能，允许用户在特定的事件或操作发生时插入自己的代码。</p><p>那么在这个网站上如何使用呢？其实可以这么理解，hook只是一种思路，其目的就是伪造一个相似的函数名使相关请求进来，但是我们不做处理，然后再跳出去。</p><p>当在控制台插入写的伪造函数，就会取代原有的目标函数，原有逻辑就会调用新的伪造函数。</p><p>首先编写一个同样名字的函数，原函数为foo()</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _foo=foo</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo 截获开始&quot;</span>)</span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo 截获结束&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后打断点</p><img data-src="https://img.econow.cn/blog/1694161435741.png" width="797"><p>将刚才的伪造函数在控制台执行。</p><p>之后再点击继续执行脚本的箭头，此时会停留到伪造函数中的debugger上。</p><p><img data-src="https://img.econow.cn/blog/1694161563211.png"></p><p>点击调用堆栈，双击匿名函数就到了目标函数的位置。</p><h3 id="2-简单使用"><a href="#2-简单使用" class="headerlink" title="2. 简单使用"></a>2. 简单使用</h3><p>在这个网站上我们看到有加密的Sign以及data，但是基本可以猜测一下是否用到了<code>JSON.stringfy</code>,比如在处理data数据，具体有没有可以试一下。首先在目标接口的启动器上找到最初的调用的那一级，然后打断点。</p><p><img data-src="https://img.econow.cn/blog/1700536292935.png"></p><p>刷新后在控制台输入代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> stringfy = <span class="title class_">JSON</span>.<span class="property">stringify</span></span><br><span class="line">    <span class="title class_">JSON</span>.<span class="property">stringify</span> = <span class="keyword">function</span> (<span class="params">params</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Hook JSON.stringfy:::&quot;</span>,params)</span><br><span class="line">        <span class="keyword">debugger</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">stringfy</span>(params)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>这时候就捕获到了第一次使用<code>JSON.stringfy</code>，但是我们要留意当前调用的上一级，也就是截图中的beforeSend，是不是就是咱们之前看到那个加密的位置！</p><p><img data-src="https://img.econow.cn/blog/1700536383895.png"></p><p>假设是第一次使用，不知道具体位置，但是现在可以看一下<code>beforeSend</code>代码是否和加解密有关，打个断点试试。</p><p><img data-src="https://img.econow.cn/blog/1700536531773.png"></p><p><img data-src="https://img.econow.cn/blog/1700536531773.png" alt="加密"></p><p>以上只是一个初步使用，hook函数还有很多种使用方式。</p><h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>其实在这个网站上卡壳时间最长在以下几点：</p><ol><li>首先就是加密算法的自定义，之前没想到过，以为是版本问题</li><li>其次就是在加密函数那里，首次调试的时候把变量写死了，导致后续调用的时候总是验证失败</li></ol><p>经过这个网站的分析，增长了不少经验，也获取了更高效的技巧。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a target="_blank" rel="noopener" href="http://birdreport.cn/home/activity/page.html">中国观鸟记录中心</a></li></ul></div><footer class="post-footer"><div class="reward-container"><div>喜欢就点个赞吧！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/wechatpay.jpg" alt="medivh 微信"> <span>微信</span></div><div><img src="/images/alipay.jpg" alt="medivh 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>medivh</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://econow.cn/2023/11/20/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E8%A7%82%E9%B8%9F%E7%BD%91Search%E6%8E%A5%E5%8F%A3/" title="【爬虫实战】使用Python和JS逆向观鸟网Search接口">https://econow.cn/2023/11/20/【爬虫实战】使用Python和JS逆向观鸟网Search接口/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="post-tags"><a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a> <a href="/tags/%E7%88%AC%E8%99%AB/" rel="tag"><i class="fa fa-tag"></i> 爬虫</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2023/11/17/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E8%8E%B7%E5%8F%96%E6%98%93%E8%BD%A6%E7%BD%91%E6%B1%BD%E8%BD%A6%E5%8F%82%E6%95%B0%E8%AF%A6%E6%83%85/" rel="prev" title="【爬虫实战】使用Python和JS逆向获取易车网汽车参数详情"><i class="fa fa-angle-left"></i> 【爬虫实战】使用Python和JS逆向获取易车网汽车参数详情</a></div><div class="post-nav-item"><a href="/2023/11/21/%E3%80%90%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98%E3%80%91%E4%BD%BF%E7%94%A8Python%E5%92%8CJS%E9%80%86%E5%90%91%E9%97%AE%E8%B4%A2%E7%BD%91%E5%AE%9A%E4%BD%8D%E6%9E%84%E5%BB%BA%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BD%8D%E7%BD%AE/" rel="next" title="【爬虫实战】使用Python和JS逆向问财网定位构建动态数据的位置">【爬虫实战】使用Python和JS逆向问财网定位构建动态数据的位置 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2</a></div><div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">medivh</span></div></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"g1GwilqmVAUne2tDEDncEChG-gzGzoHsz","app_key":"YB2e5dSKMmMYYCtaSzxp9fdS","server_url":"https://api.econow.cn","security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script></body></html>