<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="https://img.econow.cn/2018/1545104669394.png"><link rel="icon" type="image/png" sizes="16x16" href="https://img.econow.cn/2018/1545104669394.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="前言近期在研究微信公众号文章的抓取方案。之前觉得就是单纯的文章内容加上若干个API就完了，但检查后才发现没那么简单，毕竟和普通的网站不是一回事。后来在网上搜索和测试了很久才终于打通了一条路。虽然不完美，但至少实现了。"><meta property="og:type" content="article"><meta property="og:title" content="使用mitmproxy批量获取公众号文章以及点赞、评论等数据"><meta property="og:url" content="https://econow.cn/2023/12/01/%E4%BD%BF%E7%94%A8mitmproxy%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E4%BB%A5%E5%8F%8A%E7%82%B9%E8%B5%9E%E3%80%81%E8%AF%84%E8%AE%BA%E7%AD%89%E6%95%B0%E6%8D%AE/index.html"><meta property="og:site_name" content="Medivh&#39;s castle"><meta property="og:description" content="前言近期在研究微信公众号文章的抓取方案。之前觉得就是单纯的文章内容加上若干个API就完了，但检查后才发现没那么简单，毕竟和普通的网站不是一回事。后来在网上搜索和测试了很久才终于打通了一条路。虽然不完美，但至少实现了。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.econow.cn/blog/1702019848983.png"><meta property="og:image" content="https://img.econow.cn/blog/1701941187834.png"><meta property="og:image" content="https://img.econow.cn/blog/1701849433441.png"><meta property="article:published_time" content="2023-12-01T09:05:19.000Z"><meta property="article:modified_time" content="2023-12-08T08:58:26.651Z"><meta property="article:author" content="medivh"><meta property="article:tag" content="Python"><meta property="article:tag" content="爬虫"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.econow.cn/blog/1702019848983.png"><link rel="canonical" href="https://econow.cn/2023/12/01/%E4%BD%BF%E7%94%A8mitmproxy%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E4%BB%A5%E5%8F%8A%E7%82%B9%E8%B5%9E%E3%80%81%E8%AF%84%E8%AE%BA%E7%AD%89%E6%95%B0%E6%8D%AE/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://econow.cn/2023/12/01/%E4%BD%BF%E7%94%A8mitmproxy%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E4%BB%A5%E5%8F%8A%E7%82%B9%E8%B5%9E%E3%80%81%E8%AF%84%E8%AE%BA%E7%AD%89%E6%95%B0%E6%8D%AE/","path":"2023/12/01/使用mitmproxy批量获取公众号文章以及点赞、评论等数据/","title":"使用mitmproxy批量获取公众号文章以及点赞、评论等数据"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>使用mitmproxy批量获取公众号文章以及点赞、评论等数据 | Medivh's castle</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?21ded952ca9fc25e2b0630494a17ec7f"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Medivh's castle</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%9B%AE%E6%A0%87%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">一、目标分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">二、逻辑分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">三、代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%8E%B7%E5%8F%96%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8"><span class="nav-number">4.1.</span> <span class="nav-text">1. 获取文章列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-mitmproxy"><span class="nav-number">4.2.</span> <span class="nav-text">2. mitmproxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Appium"><span class="nav-number">4.3.</span> <span class="nav-text">3. Appium</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-MongoDB"><span class="nav-number">4.4.</span> <span class="nav-text">4. MongoDB</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">四、总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">medivh</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">110</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">48</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://econow.cn/2023/12/01/%E4%BD%BF%E7%94%A8mitmproxy%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E4%BB%A5%E5%8F%8A%E7%82%B9%E8%B5%9E%E3%80%81%E8%AF%84%E8%AE%BA%E7%AD%89%E6%95%B0%E6%8D%AE/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="medivh"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Medivh's castle"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="使用mitmproxy批量获取公众号文章以及点赞、评论等数据 | Medivh's castle"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">使用mitmproxy批量获取公众号文章以及点赞、评论等数据</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-12-01 17:05:19" itemprop="dateCreated datePublished" datetime="2023-12-01T17:05:19+08:00">2023-12-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-12-08 16:58:26" itemprop="dateModified" datetime="2023-12-08T16:58:26+08:00">2023-12-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a> </span></span><span id="/2023/12/01/%E4%BD%BF%E7%94%A8mitmproxy%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E4%BB%A5%E5%8F%8A%E7%82%B9%E8%B5%9E%E3%80%81%E8%AF%84%E8%AE%BA%E7%AD%89%E6%95%B0%E6%8D%AE/" class="post-meta-item leancloud_visitors" data-flag-title="使用mitmproxy批量获取公众号文章以及点赞、评论等数据" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>近期在研究微信公众号文章的抓取方案。之前觉得就是单纯的文章内容加上若干个API就完了，但检查后才发现没那么简单，毕竟和普通的网站不是一回事。后来在网上搜索和测试了很久才终于打通了一条路。虽然不完美，但至少实现了。</p><h2 id="一、目标分析"><a href="#一、目标分析" class="headerlink" title="一、目标分析"></a>一、目标分析</h2><p>获取以下数据，以关注的某个公众号为例：</p><p><img data-src="https://img.econow.cn/blog/1702019848983.png" alt="效果"></p><h2 id="二、逻辑分析"><a href="#二、逻辑分析" class="headerlink" title="二、逻辑分析"></a>二、逻辑分析</h2><p>其实这些字段出现在不同的接口，单纯的获取文章信息毕竟容易，但是阅读数、点赞和在读等等获取的就比较麻烦。</p><p>主要涉及以下接口：</p><ul><li>文章URL、概要、链接 <code>/cgi-bin/appmsg</code></li><li>阅读数、在看数、点赞 <code>/mp/getappmsgext</code></li><li>评论数 <code>/mp/appmsg_comment</code></li></ul><p>到了这里，分析以下几个问题。</p><p>首先文章链接这个可以通过访问公众号后台，通过引用的方式搜索到公众号下的文章列表，那么该如何批量获取呢？</p><p>截图不再放了，由于被限流，暂时无法截图了。研究了很久，参考一些大佬的做法，但是可能某些不清楚的原因，无法复现。因此最后决定使用两步来解决这个问题。首先通过微信公众号的后台获取文章链接信息，然后根据URL发送到移动端的微信上使用Appium进行点击操作，这个时候使用<code>mitmproxy</code>进行抓包处理。</p><h2 id="三、代码实现"><a href="#三、代码实现" class="headerlink" title="三、代码实现"></a>三、代码实现</h2><h3 id="1-获取文章列表"><a href="#1-获取文章列表" class="headerlink" title="1. 获取文章列表"></a>1. 获取文章列表</h3><p>刚才提到了是从公众号后台获取的文章列表，那么代码怎么实现呢？核心逻辑分为以下几部分：</p><ol><li>加载cookie，访问官网主页，获取token，认定已经登录了</li><li>搜索公众号，使用查询参数</li><li>模拟点击下一页</li></ol><p>核心代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.访问官网主页</span></span><br><span class="line">url = <span class="string">&#x27;https://mp.weixin.qq.com&#x27;</span></span><br><span class="line">res = s.get(url=url, headers=headers, cookies=cookies, verify=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 获得token</span></span><br><span class="line">token = re.findall(<span class="string">r&#x27;.*?token=(\d+)&#x27;</span>, res.url)</span><br><span class="line"><span class="keyword">if</span> token:</span><br><span class="line">  token = token[<span class="number">0</span>]</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 2.检索公众号</span></span><br><span class="line">url = <span class="string">&#x27;https://mp.weixin.qq.com/cgi-bin/searchbiz&#x27;</span></span><br><span class="line">params = &#123;</span><br><span class="line">  <span class="string">&quot;action&quot;</span>: <span class="string">&quot;search_biz&quot;</span>,</span><br><span class="line">  <span class="string">&quot;begin&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;count&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: key, <span class="comment"># 公众号名称</span></span><br><span class="line">  <span class="string">&quot;token&quot;</span>: token, <span class="comment"># 前面获取的token</span></span><br><span class="line">  <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;zh_CN&quot;</span>,</span><br><span class="line">  <span class="string">&quot;f&quot;</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ajax&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 3.请求搜索页</span></span><br><span class="line">res = s.get(url=url, params=data, cookies=cookies, headers=headers, verify=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据请求结果获取fakeid</span></span><br><span class="line">fakeid = res.json()[<span class="string">&#x27;list&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;fakeid&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;fakeid&#x27;</span>, fakeid)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拼接参数，获取文章URL</span></span><br><span class="line">url = <span class="string">&#x27;https://mp.weixin.qq.com/cgi-bin/appmsg&#x27;</span></span><br><span class="line">params = &#123;</span><br><span class="line">  <span class="string">&quot;action&quot;</span>: <span class="string">&quot;list_ex&quot;</span>,</span><br><span class="line">  <span class="string">&quot;begin&quot;</span>: <span class="built_in">str</span>(page_size * (cur_page - <span class="number">1</span>)),  <span class="comment"># 从0开始，每次最多5条</span></span><br><span class="line">  <span class="string">&quot;count&quot;</span>: <span class="built_in">str</span>(page_size),</span><br><span class="line">  <span class="string">&quot;fakeid&quot;</span>: fakeid,</span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;9&quot;</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">  <span class="string">&quot;need_author_name&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;zh_CN&quot;</span>,</span><br><span class="line">  <span class="string">&quot;f&quot;</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ajax&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 4. 获取文章列表，翻页</span></span><br><span class="line">res = s.get(url=url, params=params, cookies=cookies, headers=headers, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>之后根据响应的数据进行存储即可。</p><h3 id="2-mitmproxy"><a href="#2-mitmproxy" class="headerlink" title="2. mitmproxy"></a>2. mitmproxy</h3><p>刚才已经获取了文章列表，接下来就是获取文章数据了。</p><p>首先简单介绍一下mitmproxy。<code>mitmproxy</code> 是一款用于拦截、修改、截获和重放网络流量的开源工具。它常用于网络安全、逆向工程、API 开发和调试等场景。以下是 <code>mitmproxy</code> 的一些主要特点和用途：</p><ol><li><strong>拦截和修改流量：</strong> <code>mitmproxy</code> 允许你在代理层面拦截和修改网络请求和响应。这使得你可以实时查看、编辑和修改应用程序和服务之间的通信。</li><li><strong>HTTPS 解密：</strong> <code>mitmproxy</code> 能够解密通过 HTTPS 发送的流量，这意味着你可以查看加密的流量内容，对于逆向工程和调试来说非常有用。</li><li><strong>流量记录和回放：</strong> <code>mitmproxy</code> 具有记录和回放网络流量的功能。你可以捕获一系列的请求和响应，然后将它们保存为文件，之后可以使用 <code>mitmproxy</code> 进行回放，模拟先前的网络流量。</li><li><strong>Web 界面和命令行界面：</strong> <code>mitmproxy</code> 提供了一个基于命令行的界面，以及一个可选的 Web 界面，使用户可以方便地查看和操作流量。这些界面提供了强大的过滤、搜索和导出功能。</li><li><strong>脚本支持：</strong> <code>mitmproxy</code> 提供了一个 Python API，允许用户编写脚本以自定义和扩展其功能。这使得用户可以根据需要编写脚本来处理流量、修改请求和响应等。</li><li><strong>跨平台：</strong> <code>mitmproxy</code> 是一个跨平台工具，支持在 Windows、macOS 和 Linux 等操作系统上运行。</li></ol><p>使用 <code>mitmproxy</code> 通常包括以下步骤：</p><ul><li>启动 <code>mitmproxy</code> 代理服务器。</li><li>将设备或应用程序的网络配置设置为使用 <code>mitmproxy</code> 作为代理。</li><li>在 <code>mitmproxy</code> 控制台或 Web 界面中查看、编辑和修改网络流量。</li></ul><p>由于其灵活性和强大的功能，<code>mitmproxy</code> 成为网络安全专业、开发人员和逆向工程师的常用工具之一。</p><p>所以，为什么选择mitmproxy而不是Charles，根据前面的功能特点也能看出来了，就是因为可以提供灵活的脚步支持，可以自定义修改来处理请求和响应。</p><p><strong>安装软件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mac </span></span><br><span class="line">brew install mitmproxy</span><br><span class="line"><span class="comment"># python</span></span><br><span class="line">pip install mitmproxy</span><br></pre></td></tr></table></figure><p>mitmproxy 有两种使用方式：</p><ol><li>命令行 <code>$ mitmdump -p 端口 -s 插件.py</code></li><li>Web <code>$ mitmweb -p 端口 -s 插件.py</code></li></ol><p><strong>安装证书</strong></p><p>启动后访问 <a target="_blank" rel="noopener" href="http://mitm.it/">http://mitm.it/</a>，根据平台和系统选择并安装。</p><p><strong>查看输出</strong></p><p>启动后就会看到如下的日志，当然输出的内容是根据代码展示的。</p><p><img data-src="https://img.econow.cn/blog/1701941187834.png"></p><p><strong>检查数据</strong></p><p>mitmproxy操作实例方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">flow.request.headers <span class="comment">#获取所有头信息，包含Host、User-Agent、Content-type等字段</span></span><br><span class="line">flow.request.url <span class="comment">#完整的请求地址，包含域名及请求参数，但是不包含放在body里面的请求参数</span></span><br><span class="line">flow.request.pretty_url <span class="comment">#同flow.request.url目前没看出什么差别</span></span><br><span class="line">flow.request.host <span class="comment">#域名</span></span><br><span class="line">flow.request.method <span class="comment">#请求方式。POST、GET等</span></span><br><span class="line">flow.request.scheme <span class="comment">#什么请求 ，如https</span></span><br><span class="line">flow.request.path <span class="comment"># 请求的路径，url除域名之外的内容</span></span><br><span class="line">flow.request.get_text() <span class="comment">#请求中body内容，有一些http会把请求参数放在body里面，那么可通过此方法获取，返回字典类型</span></span><br><span class="line">flow.request.query <span class="comment">#返回MultiDictView类型的数据，url直接带的键值参数</span></span><br><span class="line">flow.request.get_content()<span class="comment">#bytes,结果如flow.request.get_text()</span></span><br><span class="line">flow.request.raw_content <span class="comment">#bytes,结果如flow.request.get_content()</span></span><br><span class="line">flow.request.urlencoded_form <span class="comment">#MultiDictView，content-type：application/x-www-form-urlencoded时的请求参数，不包含url直接带的键值参数</span></span><br><span class="line">flow.request.multipart_form <span class="comment">#MultiDictView，content-type：multipart/form-data时的请求参数，不包含url直接带的键值参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以上均为获取request信息的一些常用方法，对于response，同理</span></span><br><span class="line">flow.response.status_code <span class="comment">#状态码</span></span><br><span class="line">flow.response.text<span class="comment">#返回内容，已解码</span></span><br><span class="line">flow.response.content <span class="comment">#返回内容，二进制</span></span><br><span class="line">flow.response.setText()<span class="comment">#修改返回内容，不需要转码</span></span><br></pre></td></tr></table></figure><p><strong>实际应用</strong></p><p>其实我这里是先把文章URL写入MongoDB，点击URL后通过监听脚本再次将点赞等值写入MongoDB。以下是部分监听代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">self, flow: http.HTTPFlow</span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot; HTTP 事件钩子 - 收到完整的响应 &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> flow.request.host == self.filter_host:</span><br><span class="line">    path = flow.request.path.split(<span class="string">&#x27;?&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&#x27;/s&#x27;</span>:</span><br><span class="line">      <span class="comment"># 获取请求参数，假设关联信息存储在参数中，你可以根据实际情况修改</span></span><br><span class="line">      ctx.current_url = process_url(flow.request.url)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;当前请求的URL&#x27;</span>, ctx.current_url)</span><br><span class="line">      <span class="keyword">if</span> path <span class="keyword">in</span> self.filter_path_list:</span><br><span class="line">        <span class="keyword">if</span> path == <span class="string">&#x27;/mp/getappmsgext&#x27;</span>:</span><br><span class="line">          response_json = json.loads(flow.response.text)</span><br><span class="line">          <span class="keyword">if</span> <span class="string">&#x27;appmsgstat&#x27;</span> <span class="keyword">in</span> response_json:</span><br><span class="line">            appmsgstat = response_json[<span class="string">&#x27;appmsgstat&#x27;</span>]</span><br><span class="line">            self.article_data[<span class="string">&#x27;read_num&#x27;</span>] = <span class="built_in">int</span>(appmsgstat[<span class="string">&#x27;read_num&#x27;</span>])  <span class="comment"># 阅读数</span></span><br><span class="line">            self.article_data[<span class="string">&#x27;like_num&#x27;</span>] = <span class="built_in">int</span>(appmsgstat[<span class="string">&#x27;like_num&#x27;</span>])  <span class="comment"># 在看数</span></span><br><span class="line">            self.article_data[<span class="string">&#x27;old_like_num&#x27;</span>] = <span class="built_in">int</span>(appmsgstat[<span class="string">&#x27;old_like_num&#x27;</span>])  <span class="comment"># 点赞数</span></span><br><span class="line">          <span class="keyword">elif</span> path == <span class="string">&#x27;/mp/appmsg_comment&#x27;</span>:</span><br><span class="line">            response_json = json.loads(flow.response.text)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;elected_comment_total_cnt&#x27;</span> <span class="keyword">in</span> response_json:</span><br><span class="line">              comment_total = response_json[<span class="string">&#x27;elected_comment_total_cnt&#x27;</span>]</span><br><span class="line">              self.article_data[<span class="string">&#x27;comment_total&#x27;</span>] = <span class="built_in">int</span>(comment_total)  <span class="comment"># 评论数</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">              self.article_data[<span class="string">&#x27;comment_total&#x27;</span>] = <span class="number">0</span>  <span class="comment"># 评论数</span></span><br></pre></td></tr></table></figure><p>注意这里使用了ctx，主要功能就是传递URL，不然不知道当前请求的是哪篇文章。</p><p><code>ctx</code> 是 mitmproxy 中的上下文对象，用于在不同的事件处理函数之间传递数据和共享状态。<code>ctx</code> 对象包含有关当前 mitmproxy 会话的信息，并允许你存储和检索自定义数据。</p><p>以下是 <code>ctx</code> 的主要用途：</p><ol><li><strong>传递数据：</strong> 在不同的事件处理函数之间传递数据。你可以在一个事件处理函数中设置某个值，然后在另一个事件处理函数中获取该值。</li><li><strong>存储状态：</strong> <code>ctx</code> 允许你在整个 mitmproxy 会话期间存储状态。例如，你可以在 <code>request</code> 函数中设置某个状态，然后在 <code>response</code> 函数中检查并相应地处理。</li><li><strong>共享变量：</strong> 通过 <code>ctx</code> 对象，你可以在不同的事件处理函数中共享变量，而不是将它们作为参数传递。</li></ol><p>注意<code>mitmporxy</code>的监听脚本是从上到下重复执行的，每次有请求进来所有流程都要走一遍。开始的时候不知道这个逻辑，导致在匹配文章链接的时候始终获取为None。直到后来查询到ctx，使用这样一个对象才匹配到了正确的值，便于后续的点赞等值的传递。</p><p>其实这个时候如果在手机上点击公众号文章就已经完成了最基础的数据采集，但是完全手动就没什么意义了，所以要实现自动点击。方案有很多，不同平台也有不同的做法。我这里没有Windows系统，在Mac上自动点击也没有太好的方案。因此决定使用Appium自动点击聊天窗口的URL。</p><h3 id="3-Appium"><a href="#3-Appium" class="headerlink" title="3. Appium"></a>3. Appium</h3><p>Appium是一个开源的移动应用程序自动化测试工具，它支持iOS和Android平台上的原生、混合和移动Web应用程序。Appium使用WebDriver协议，可以使用多种编程语言编写测试脚本，包括Java、Python、Ruby、C#等。</p><p>以下是一些Appium的主要特点和优势：</p><ol><li><strong>跨平台支持：</strong> Appium可以同时用于iOS和Android平台，使得开发人员和测试人员能够使用相同的工具和脚本来测试不同平台的应用程序。</li><li><strong>支持多种编程语言：</strong> Appium支持多种编程语言，包括Java、Python、Ruby、C#等，这使得开发人员可以选择他们熟悉的语言来编写测试脚本。</li><li><strong>支持多种应用类型：</strong> Appium支持测试原生应用、混合应用和移动Web应用。这种灵活性使得它适用于各种不同类型的移动应用。</li><li><strong>使用标准WebDriver协议：</strong> Appium使用WebDriver协议来与应用程序进行交互，这意味着开发人员可以使用熟悉的WebDriver API来编写测试脚本。</li><li><strong>无需修改应用程序：</strong> 与一些其他自动化工具不同，Appium不需要在应用程序中插入特殊的代码或库。这意味着应用程序的原始版本可以被测试，而不需要进行修改。</li><li><strong>支持多种设备：</strong> Appium支持连接到物理设备和模拟器，使得测试人员能够在不同的环境中执行测试。</li><li><strong>活跃的社区支持：</strong> Appium拥有庞大而活跃的社区，因此用户可以轻松地找到文档、教程和解决方案。</li><li><strong>集成性：</strong> Appium可以与各种测试框架和持续集成工具集成，从而实现更广泛的自动化测试流程。</li></ol><p>总体而言，Appium是一个功能强大、灵活且跨平台的移动应用程序自动化测试工具，适用于移动应用程序的开发和测试。</p><p>具体使用而言，Appium慢是真慢，但是不清楚是否还有其他更好的方案，但是目前来说可能Appium的方案可能最成熟。新版本的Appium软件分为两部分：</p><ol><li><code>Appium-Server</code> 用来启动服务</li><li><code>Appium-inspector</code>用来定位元素</li></ol><p>之前不熟悉啊，被坑了很久，一直不清楚咋回事，一直以为这是同一个软件的相互替代品。其实单独只启动server也是没问题的，但是首次使用的时候必须得定位元素啊，所以Appium-inspector就必须的。其次就是选择微信版本的时候，尽量低一点，毕竟不是拿来日常使用的，否则版本越高，程序运行的时候就会很慢。而且不同版本的APP往往定位元素的资源ID是不一样的，一定要注意。</p><p>首先是<code>Appium-Server</code>的启动，这个没啥好说的，配置网上搜搜就行。然后是<code>Appium-inspector</code>，这个需要进行一些配置，填写设备和APP的信息，如下所示：</p><p><img data-src="https://img.econow.cn/blog/1701849433441.png"></p><p>配置：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;appium:platformName&quot;</span>: <span class="string">&quot;Android&quot;</span>,</span><br><span class="line">  <span class="string">&quot;appium:deviceName&quot;</span>: <span class="string">&quot;99261FFAZ00FJ7&quot;</span>,</span><br><span class="line">  <span class="string">&quot;appium:platformVersion&quot;</span>: <span class="string">&quot;10&quot;</span>,</span><br><span class="line">  <span class="string">&quot;appium:appPackage&quot;</span>: <span class="string">&quot;com.tencent.mm&quot;</span>,</span><br><span class="line">  <span class="string">&quot;appium:appActivity&quot;</span>: <span class="string">&quot;com.tencent.mm.ui.LauncherUI&quot;</span>,</span><br><span class="line">  <span class="string">&quot;appium:unicodeKeyboard&quot;</span>: true,</span><br><span class="line">  <span class="string">&quot;appium:noReset&quot;</span>: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>deviceName 来自adb devices 展示的列表</p><p>appPackage 这个一般一个APP都是固定</p><p>appActivity 这个需要检查一下，可以先使用，不行再查</p><p>noReset 一定要设置，不然原来的微信就会被自动退出登录</p></blockquote><p>获取到所有元素：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">xml_source = driver.page_source</span><br><span class="line"><span class="keyword">from</span> xml.etree <span class="keyword">import</span> ElementTree <span class="keyword">as</span> ET</span><br><span class="line">root = ET.fromstring(xml_source)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取所有元素的资源 ID</span></span><br><span class="line">resource_ids = [element.get(<span class="string">&#x27;resource-id&#x27;</span>) <span class="keyword">for</span> element <span class="keyword">in</span> root.<span class="built_in">iter</span>()]</span><br><span class="line">resource_ids = [res_id <span class="keyword">for</span> res_id <span class="keyword">in</span> resource_ids <span class="keyword">if</span> res_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印资源 ID</span></span><br><span class="line"><span class="built_in">print</span>(resource_ids)</span><br></pre></td></tr></table></figure><p>输出:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;com.tencent.mm:id/e8x&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/fpn&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/fnj&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/bl6&#x27;</span>, <span class="string">&#x27;android:id/content&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/d5e&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/g8f&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/ffv&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/f6r&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/no&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/f67&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/nn&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/nl&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/be3&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/eh&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/nk&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/he6&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/gdh&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dmt&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/bg1&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/x1&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/ikd&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/fzg&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/j0l&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/e7t&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/bg1&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/x1&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/ikd&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/fzg&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/j0l&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/e7t&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/bg1&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/x1&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/ikd&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/fzg&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/j0l&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/e7t&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/e8y&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtf&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtx&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dub&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtf&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtx&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dub&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtf&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtx&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dub&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtf&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dtx&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dub&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/c_&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/c7&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/ef&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/eh&#x27;</span>, <span class="string">&#x27;android:id/text1&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/fdi&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dt5&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/fcu&#x27;</span>, <span class="string">&#x27;com.tencent.mm:id/dt5&#x27;</span>, <span class="string">&#x27;android:id/navigationBarBackground&#x27;</span>]</span><br></pre></td></tr></table></figure><blockquote><p>如果存在疑问，可以输出全部的资源ID来排查一下。</p></blockquote><h3 id="4-MongoDB"><a href="#4-MongoDB" class="headerlink" title="4. MongoDB"></a>4. MongoDB</h3><p>存储是放在了MongoDB中，以下是Mac系统的安装方式。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew tap mongodb/brew</span><br><span class="line">brew install mongodb-community</span><br><span class="line">brew services start mongodb-community</span><br></pre></td></tr></table></figure><p>在 MongoDB 中，你可以使用 <code>find</code> 方法来执行查询。以下是一些常见的 MongoDB 查询语句：</p><ol><li><p><strong>简单查询：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find(&#123; key: value &#125;)</span><br><span class="line"></span><br><span class="line">db.getCollection(&quot;未闻Code&quot;).find(&#123; &#x27;read_num&#x27;: &#123; $exists: false &#125; &#125;).count()</span><br></pre></td></tr></table></figure></li><li><p><strong>查询嵌套字段：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find(&#123; &quot;nested.key&quot;: value &#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>范围查询：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find(&#123; key: &#123; $gt: value1, $lt: value2 &#125; &#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>逻辑 AND 查询：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find(&#123; key1: value1, key2: value2 &#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>逻辑 OR 查询：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find(&#123; $or: [ &#123; key1: value1 &#125;, &#123; key2: value2 &#125; ] &#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>查询指定字段：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find(&#123;&#125;, &#123; key1: 1, key2: 1, _id: 0 &#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>排序查询结果：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find().sort(&#123; key: 1 &#125;) // 升序</span><br><span class="line">db.collection_name.find().sort(&#123; key: -1 &#125;) // 降序</span><br></pre></td></tr></table></figure></li><li><p><strong>限制查询结果数量：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find().limit(10)</span><br></pre></td></tr></table></figure></li><li><p><strong>跳过前 N 个文档：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find().skip(5)</span><br></pre></td></tr></table></figure></li><li><p><strong>模糊查询（正则表达式）：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascriptCopy code</span><br><span class="line">db.collection_name.find(&#123; key: /pattern/ &#125;)</span><br></pre></td></tr></table></figure></li></ol><p>请替换 <code>collection_name</code>、<code>key</code>、<code>value</code> 等为你实际的集合名、字段名和值。这些是基本的查询示例，你可以根据实际需要组合使用它们。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 查询是否有重复记录</span><br><span class="line">db.getCollection(&quot;WeChat&quot;).aggregate([</span><br><span class="line">  &#123; $<span class="keyword">group</span>: &#123; _id: &quot;$link&quot;, count: &#123; $sum: <span class="number">1</span> &#125; &#125; &#125;,</span><br><span class="line">  &#123; $<span class="keyword">match</span>: &#123; count: &#123; $gt: <span class="number">1</span> &#125; &#125; &#125;,</span><br><span class="line">  &#123; $project: &#123; _id: <span class="number">0</span>, link: &quot;$_id&quot;, count: <span class="number">1</span> &#125; &#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"># 查询是否有重复记录并删除</span><br><span class="line">var duplicates <span class="operator">=</span> db.getCollection(&quot;wechat&quot;).aggregate([</span><br><span class="line">  &#123; $<span class="keyword">group</span>: &#123; _id: &quot;$link&quot;, count: &#123; $sum: <span class="number">1</span> &#125;, docs: &#123; $push: &quot;$_id&quot; &#125; &#125; &#125;,</span><br><span class="line">  &#123; $<span class="keyword">match</span>: &#123; count: &#123; $gt: <span class="number">1</span> &#125; &#125; &#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">duplicates.forEach(<span class="keyword">function</span>(duplicate) &#123;</span><br><span class="line">  duplicate.docs.shift();  <span class="operator">/</span><span class="operator">/</span> 保留第一个记录，删除其他重复记录</span><br><span class="line">  db.getCollection(&quot;WeChat&quot;).deleteMany(&#123; _id: &#123; $<span class="keyword">in</span>: duplicate.docs &#125; &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"># 查询完成的记录总数</span><br><span class="line">db.getCollection(&quot;WeChat&quot;).find(&#123; <span class="string">&#x27;read_num&#x27;</span>: &#123; $<span class="keyword">exists</span>: <span class="literal">false</span> &#125; &#125;).<span class="built_in">count</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>目前依然存在的问题如下：</p><ol><li>单批获取文章大概在50页左右，无论如何睡眠等待均未有明显效果。解决方式：使用多个微信公众号的cookie，堆号</li><li>使用Appium自动点击，速度慢。暂未想到更好的方法。</li></ol><p>通过这几天的实践，熟悉了mitmproxy、appium以及mongodb的使用，基本实现了自动化获取文章信息。虽然存在若干问题，但至少实现了，之后有机会再慢慢摸索了。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a target="_blank" rel="noopener" href="https://docs.mitmproxy.org/stable/">https://docs.mitmproxy.org/stable/</a></li></ul></div><footer class="post-footer"><div class="reward-container"><div>喜欢就点个赞吧！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/wechatpay.jpg" alt="medivh 微信"> <span>微信</span></div><div><img src="/images/alipay.jpg" alt="medivh 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>medivh</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://econow.cn/2023/12/01/%E4%BD%BF%E7%94%A8mitmproxy%E6%89%B9%E9%87%8F%E8%8E%B7%E5%8F%96%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0%E4%BB%A5%E5%8F%8A%E7%82%B9%E8%B5%9E%E3%80%81%E8%AF%84%E8%AE%BA%E7%AD%89%E6%95%B0%E6%8D%AE/" title="使用mitmproxy批量获取公众号文章以及点赞、评论等数据">https://econow.cn/2023/12/01/使用mitmproxy批量获取公众号文章以及点赞、评论等数据/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="post-tags"><a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a> <a href="/tags/%E7%88%AC%E8%99%AB/" rel="tag"><i class="fa fa-tag"></i> 爬虫</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2023/11/30/%E4%BD%BF%E7%94%A8pyinstaller%E5%92%8Cpyqt%E8%BF%9B%E8%A1%8CPython%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%89%93%E5%8C%85/" rel="prev" title="使用pyinstaller和pyqt进行Python程序的打包"><i class="fa fa-angle-left"></i> 使用pyinstaller和pyqt进行Python程序的打包</a></div><div class="post-nav-item"><a href="/2025/04/28/%E3%80%90kubernetes%E3%80%91%E7%94%B1%E6%B5%85%E5%85%A5%E6%B7%B1%E7%9A%84%E6%80%BB%E7%BB%93/" rel="next" title="【kubernetes由浅入深的总结】">【kubernetes由浅入深的总结】 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2</a></div><div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">medivh</span></div></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"g1GwilqmVAUne2tDEDncEChG-gzGzoHsz","app_key":"YB2e5dSKMmMYYCtaSzxp9fdS","server_url":"https://api.econow.cn","security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script></body></html>