<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.econow.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.econow.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/page/2/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?21ded952ca9fc25e2b0630494a17ec7f"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E4%BD%BF%E7%94%A8Python%20smtplib%20%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%BD%BF%E7%94%A8Python%20smtplib%20%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6.html" class="post-title-link" itemprop="url">使用Python smtplib 发送邮件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
    <span id="/%E4%BD%BF%E7%94%A8Python%20smtplib%20%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6.html" class="post-meta-item leancloud_visitors" data-flag-title="使用Python smtplib 发送邮件" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>SMTP是发送邮件的协议，Python内置对SMTP的支持，可以发送纯文本邮件、HTML邮件以及带附件的邮件。<br>Python对SMTP支持有smtplib和email两个模块，email负责构造邮件，smtplib负责发送邮件。</p>
<h3 id="sample-1-发送文本邮件"><a href="#sample-1-发送文本邮件" class="headerlink" title="sample 1.发送文本邮件"></a>sample 1.发送文本邮件</h3><h4 id="构造MIMEText"><a href="#构造MIMEText" class="headerlink" title="构造MIMEText"></a>构造MIMEText</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">msg = MIMEText(&#x27;hello, send by Python...&#x27;, &#x27;plain&#x27;, &#x27;utf-8&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意到构造MIMEText对象时，第一个参数就是邮件正文，第二个参数是MIME的subtype，传入’plain’表示纯文本，最终的MIME就是’text&#x2F;plain’，最后一定要用utf-8编码保证多语言兼容性。</p>
<h4 id="使用smtp发送"><a href="#使用smtp发送" class="headerlink" title="使用smtp发送"></a>使用smtp发送</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 输入Email地址和口令:</span><br><span class="line">from_addr = xxx@x.com</span><br><span class="line">password = xxxxxxx</span><br><span class="line"># 输入收件人地址:</span><br><span class="line">to_addr = xxx@xx.com</span><br><span class="line"># 输入SMTP服务器地址，以QQ企业邮箱为例</span><br><span class="line">smtp_server = smtp.exmail.qq.com</span><br><span class="line">def _format_addr(s):</span><br><span class="line">    name, addr = parseaddr(s)</span><br><span class="line">    return formataddr((Header(name, &#x27;utf-8&#x27;).encode(), addr))</span><br><span class="line"></span><br><span class="line">msg = MIMEText(&#x27;hello, send by Python...&#x27;, &#x27;plain&#x27;, &#x27;utf-8&#x27;)</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Cc&#x27;] = _format_addr(&#x27;其他成员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line"></span><br><span class="line">server = smtplib.SMTP_SSL(smtp_server, 465)  # SMTP SSL协议默认端口是465，注意使用SMTP_SSL</span><br><span class="line">#server = smtplib.SMTP(smtp_server, 25)  # 25端口的话注意使用SMTP</span><br><span class="line">server.set_debuglevel(1)</span><br><span class="line">try:</span><br><span class="line">    server.login(from_addr, password)</span><br><span class="line">    print(&#x27;ok&#x27;)</span><br><span class="line">    server.sendmail(from_addr, [to_addr], msg.as_string())</span><br><span class="line">    server.quit()</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>编写了一个函数<code>_format_addr()</code>来格式化一个邮件地址。注意不能简单地传入<code>name &lt;addr@example.com&gt;</code>，因为如果包含中文，需要通过<code>Header</code>对象进行编码。<code>msg[&#39;To&#39;]</code>接收的是字符串而不是<code>list</code>，如果有多个邮件地址，用,分隔即可。</p>
</li>
<li><p>用<code>set_debuglevel(1)</code>就可以打印出和SMTP服务器交互的所有信息。SMTP协议就是简单的文本命令和响应。<code>login()</code>方法用来登录SMTP服务器，<code>sendmail()</code>方法就是发邮件，由于可以一次发给多个人，所以传入一个<code>list</code>，邮件正文是一个<code>str</code>，<code>as_string()</code>把<code>MIMEText</code>对象变成<code>str</code>。</p>
</li>
<li><p><code>From</code>:发件人</p>
</li>
<li><p><code>To</code>:收件人</p>
</li>
<li><p><code>Cc</code>:抄送人</p>
</li>
<li><p><code>Subject</code>：主题</p>
</li>
<li><p>此处必须注意<code>smtplib.SMTP_SSL</code>和<code>smtplib.SMTP</code>的区分，否则会报错提示连接失败。</p>
</li>
</ul>
<p>这样我们就收到了一封测试邮件。</p>
<img src="https://img.econow.cn/medivh/1550985997669.png" />

<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!usr/bin/env python</span><br><span class="line"># -*- coding:utf-8 _*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">@author:medivh</span><br><span class="line">@file: ex_send_mail.py</span><br><span class="line">@time: 2019/02/24</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import smtplib</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">from email import encoders</span><br><span class="line">from email.header import Header</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">from email.utils import parseaddr, formataddr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def _format_addr(s):</span><br><span class="line">    name, addr = parseaddr(s)</span><br><span class="line">    return formataddr((Header(name, &#x27;utf-8&#x27;).encode(), addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 输入Email地址和口令:</span><br><span class="line">from_addr = xxx@x.com</span><br><span class="line">password = xxxxxxx</span><br><span class="line"># 输入收件人地址:</span><br><span class="line">to_addr = xxx@xx.com</span><br><span class="line"># 输入SMTP服务器地址，以QQ企业邮箱为例</span><br><span class="line">smtp_server = smtp.exmail.qq.com</span><br><span class="line"></span><br><span class="line">msg = MIMEText(&#x27;hello, send by Python...&#x27;, &#x27;plain&#x27;, &#x27;utf-8&#x27;)</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Cc&#x27;] = _format_addr(&#x27;其他成员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line"></span><br><span class="line">server = smtplib.SMTP_SSL(smtp_server, 465)  # SMTP SSL协议默认端口是465，注意使用SMTP_SSL</span><br><span class="line">#server = smtplib.SMTP(smtp_server, 25)  # 25端口的话注意使用SMTP</span><br><span class="line">server.set_debuglevel(1)</span><br><span class="line">try:</span><br><span class="line">    server.login(from_addr, password)</span><br><span class="line">    print(&#x27;ok&#x27;)</span><br><span class="line">    server.sendmail(from_addr, [to_addr], msg.as_string())</span><br><span class="line">    server.quit()</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="samele-2-附件邮件"><a href="#samele-2-附件邮件" class="headerlink" title="samele 2.附件邮件"></a>samele 2.附件邮件</h3><p>如果Email中要加上附件怎么办？带附件的邮件可以看做包含若干部分的邮件：文本和各个附件本身，所以，可以构造一个MIMEMultipart对象代表邮件本身，然后往里面加上一个MIMEText作为邮件正文，再继续往里面加上表示附件的MIMEBase对象即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 邮件对象:</span><br><span class="line">msg = MIMEMultipart()</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line">msg_text = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; + &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.econow.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; + &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span><br><span class="line">msg.attach(MIMEText(msg, &#x27;html&#x27;, &#x27;utf-8&#x27;))</span><br><span class="line"></span><br><span class="line"># 添加附件就是加上一个MIMEBase，从本地读取一个图片:</span><br><span class="line">with open(&#x27;./hi.png&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">    # 设置附件的MIME和文件名，这里是png类型:</span><br><span class="line">    FileApart = MIMEApplication(f.read())</span><br><span class="line">    FileApart.add_header(&#x27;Content-Disposition&#x27;, &#x27;attachment&#x27;, filename=&#x27;hi.png&#x27;)</span><br><span class="line">    msg.attach(FileApart)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="https://img.econow.cn/medivh/1550987252487.png" />

<h3 id="sample-3-html-邮件"><a href="#sample-3-html-邮件" class="headerlink" title="sample 3.html 邮件"></a>sample 3.html 邮件</h3><p>在构造MIMEText对象时，把HTML字符串传进去，再把第二个参数由plain变为html就可以了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">msg = MIMEText(&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; +</span><br><span class="line">    &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.econow.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; +</span><br><span class="line">    &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;, &#x27;html&#x27;, &#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1550986154659.png" />
### samele 3.图片邮件
要把图片嵌入到邮件正文中，我们只需按照发送附件的方式，先把邮件作为附件添加进去，然后，在HTML中通过引用src="cid:0"就可以把附件作为图片嵌入了。如果有多个图片，给它们依次编号，然后引用不同的cid:x即可。
事实上，无论图片还是音频文件,使用方式都是一样的。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msgText = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; + &#x27;&lt;p&gt;&lt;img src=&quot;cid:0&quot;&gt;&lt;/p&gt;&#x27; + &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.econow.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; + &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span><br><span class="line"></span><br><span class="line"># 添加附件就是加上一个MIMEImage，从本地读取一个图片:</span><br><span class="line">with open(&#x27;./hi.png&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">    # 设置附件的MIME和文件名，这里是png类型:</span><br><span class="line">    FileApart = MIMEImage(f.read())</span><br><span class="line">    FileApart.add_header(&#x27;Content-ID&#x27;, &#x27;&lt;0&gt;&#x27;)</span><br><span class="line">    msg.attach(FileApart)</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1550988329662.png" />

<p>全部代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#!usr/bin/env python</span><br><span class="line"># -*- coding:utf-8 _*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">@author:medivh</span><br><span class="line">@file: ex_send_mail.py</span><br><span class="line">@time: 2019/02/24</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import smtplib</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">from email.mime.multipart import MIMEMultipart</span><br><span class="line">from email.mime.application import MIMEApplication</span><br><span class="line">from email.mime.image import MIMEImage</span><br><span class="line">from email.header import Header</span><br><span class="line">from email.utils import parseaddr, formataddr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def _format_addr(s):</span><br><span class="line">    name, addr = parseaddr(s)</span><br><span class="line">    return formataddr((Header(name, &#x27;utf-8&#x27;).encode(), addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 输入Email地址和口令:</span><br><span class="line">from_addr = xxx@x.com</span><br><span class="line">password = xxxx</span><br><span class="line"># 输入收件人地址:</span><br><span class="line">to_addr = xx@xx.com</span><br><span class="line"># 输入SMTP服务器地址，以QQ企业邮箱为例</span><br><span class="line">smtp_server = &#x27;smtp.exmail.qq.com&#x27;</span><br><span class="line"></span><br><span class="line">msg = MIMEMultipart()</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line">msgText = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; + &#x27;&lt;p&gt;&lt;img src=&quot;cid:0&quot;&gt;&lt;/p&gt;&#x27; + &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.econow.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; + &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span><br><span class="line">msg.attach(MIMEText(msgText, &#x27;html&#x27;, &#x27;utf-8&#x27;))</span><br><span class="line"># 添加附件就是加上一个MIMEImage，从本地读取一个图片:</span><br><span class="line">with open(&#x27;./hi.png&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">    # 设置附件的MIME和文件名，这里是png类型:</span><br><span class="line">    FileApart = MIMEImage(f.read())</span><br><span class="line">    FileApart.add_header(&#x27;Content-ID&#x27;, &#x27;&lt;0&gt;&#x27;)</span><br><span class="line">    msg.attach(FileApart)</span><br><span class="line"></span><br><span class="line">server = smtplib.SMTP_SSL(smtp_server, 465)  # SMTP SSL协议默认端口是465，注意使用SMTP_SSL</span><br><span class="line">server.set_debuglevel(3)</span><br><span class="line">try:</span><br><span class="line">    server.login(from_addr, password)</span><br><span class="line">    server.sendmail(from_addr, [to_addr], msg.as_string())</span><br><span class="line">    server.quit()</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="MIME-类型"><a href="#MIME-类型" class="headerlink" title="MIME 类型"></a>MIME 类型</h3><h4 id="通用类型"><a href="#通用类型" class="headerlink" title="通用类型"></a>通用类型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class email.mime.application.MIMEApplication(_data, _subtype=&#x27;octet-stream&#x27;, _encoder=email.encoders.encode_base64, *, policy=compat32, **_params)</span><br><span class="line">Module: email.mime.application</span><br><span class="line"></span><br><span class="line">    A subclass of MIMENonMultipart, the MIMEApplication class is used to represent MIME message objects of major type application. _data is a string containing the raw byte data. Optional _subtype specifies the MIME subtype and defaults to octet-stream.</span><br><span class="line"></span><br><span class="line">    Optional _encoder is a callable (i.e. function) which will perform the actual encoding of the data for transport. This callable takes one argument, which is the MIMEApplication instance. It should use get_payload() and set_payload() to change the payload to encoded form. It should also add any Content-Transfer-Encoding or other headers to the message object as necessary. The default encoding is base64. See the email.encoders module for a list of the built-in encoders.</span><br><span class="line"></span><br><span class="line">    Optional policy argument defaults to compat32.</span><br><span class="line"></span><br><span class="line">    _params are passed straight through to the base class constructor.</span><br><span class="line"></span><br><span class="line">    Changed in version 3.6: Added policy keyword-only parameter.</span><br></pre></td></tr></table></figure>
<h4 id="音频类型"><a href="#音频类型" class="headerlink" title="音频类型"></a>音频类型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class email.mime.audio.MIMEAudio(_audiodata, _subtype=None, _encoder=email.encoders.encode_base64, *, policy=compat32, **_params)¶</span><br><span class="line">    Module: email.mime.audio</span><br><span class="line"></span><br><span class="line">    A subclass of MIMENonMultipart, the MIMEAudio class is used to create MIME message objects of major type audio. _audiodata is a string containing the raw audio data. If this data can be decoded by the standard Python module sndhdr, then the subtype will be automatically included in the Content-Type header. Otherwise you can explicitly specify the audio subtype via the _subtype argument. If the minor type could not be guessed and _subtype was not given, then TypeError is raised.</span><br><span class="line"></span><br><span class="line">    Optional _encoder is a callable (i.e. function) which will perform the actual encoding of the audio data for transport. This callable takes one argument, which is the MIMEAudio instance. It should use get_payload() and set_payload() to change the payload to encoded form. It should also add any Content-Transfer-Encoding or other headers to the message object as necessary. The default encoding is base64. See the email.encoders module for a list of the built-in encoders.</span><br><span class="line"></span><br><span class="line">    Optional policy argument defaults to compat32.</span><br><span class="line"></span><br><span class="line">    _params are passed straight through to the base class constructor.</span><br><span class="line"></span><br><span class="line">    Changed in version 3.6: Added policy keyword-only parameter.</span><br></pre></td></tr></table></figure>
<h4 id="图片类型"><a href="#图片类型" class="headerlink" title="图片类型"></a>图片类型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class email.mime.image.MIMEImage(_imagedata, _subtype=None, _encoder=email.encoders.encode_base64, *, policy=compat32, **_params)</span><br><span class="line">    Module: email.mime.image</span><br><span class="line"></span><br><span class="line">    A subclass of MIMENonMultipart, the MIMEImage class is used to create MIME message objects of major type image. _imagedata is a string containing the raw image data. If this data can be decoded by the standard Python module imghdr, then the subtype will be automatically included in the Content-Type header. Otherwise you can explicitly specify the image subtype via the _subtype argument. If the minor type could not be guessed and _subtype was not given, then TypeError is raised.</span><br><span class="line"></span><br><span class="line">    Optional _encoder is a callable (i.e. function) which will perform the actual encoding of the image data for transport. This callable takes one argument, which is the MIMEImage instance. It should use get_payload() and set_payload() to change the payload to encoded form. It should also add any Content-Transfer-Encoding or other headers to the message object as necessary. The default encoding is base64. See the email.encoders module for a list of the built-in encoders.</span><br><span class="line"></span><br><span class="line">    Optional policy argument defaults to compat32.</span><br><span class="line"></span><br><span class="line">    _params are passed straight through to the MIMEBase constructor.</span><br><span class="line"></span><br><span class="line">    Changed in version 3.6: Added policy keyword-only parameter.</span><br></pre></td></tr></table></figure>
<p>综上所述，如果想不起来啥类型就使用<code>MIMEApplication</code>。</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/email.mime.html">https://docs.python.org/3/library/email.mime.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8ENginx%E5%9C%A8%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8ENginx%E5%9C%A8%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C.html" class="post-title-link" itemprop="url">关于Nginx在日常工作中的一些经验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/%E5%85%B3%E4%BA%8ENginx%E5%9C%A8%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C.html" class="post-meta-item leancloud_visitors" data-flag-title="关于Nginx在日常工作中的一些经验" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="负载均衡参数"><a href="#负载均衡参数" class="headerlink" title="负载均衡参数"></a>负载均衡参数</h3><p>在Nginx的负载均衡检查模块中，对于负载均衡的节点可以配置如下可选参数参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_fails=1fail_timeout=10s</span><br></pre></td></tr></table></figure>

<p>这个是Nginx在负载均衡功能中，用于判断后端节点状态，所用到两个参数。</p>
<p>Nginx基于连接探测，如果发现后端异常，在单位周期为fail_timeout设置的时间，中达到max_fails次数，这个周期次数内，如果后端同一个节点不可用，那么接将把节点标记为不可用，并等待下一个周期（同样时常为fail_timeout）再一次去请求，判断是否连接是否成功。如果成功，将恢复之前的轮询方式，如果不可用将在下一个周期(fail_timeout)再试一次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认：fail_timeout为10s,max_fails为1次。</span></span><br></pre></td></tr></table></figure>

<h3 id="proxy-next-upstream"><a href="#proxy-next-upstream" class="headerlink" title="proxy_next_upstream"></a>proxy_next_upstream</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_next_upstream http_500 | http_502 | http_503 | http_504 |http_404;</span><br></pre></td></tr></table></figure>

<p>当其中一台返回错误码404,500…等错误时，可以分配到下一台服务器程序继续处理，提高平台访问成功率，多可运用于前台程序负载。</p>
<p>场景:当访问A时，A返回error timeout时，访问会继续分配到下一台服务器处理，就等于一个请求分发到多台服务器，就可能出现多次处理的情况，<br>如果涉及到充值，就有可能充值多次的情况，这种情况下就要把proxy_next_upstream关掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_next_upstream off</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8ENginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8ENginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8.html" class="post-title-link" itemprop="url">关于Ngin正向代理和反向代理的应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/%E5%85%B3%E4%BA%8ENginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8.html" class="post-meta-item leancloud_visitors" data-flag-title="关于Ngin正向代理和反向代理的应用" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h3><p>代理（Proxy）也称网络代理，是一种特殊的网络服务，允许一个（一般为客户端）通过这个服务与另一个网络终端（一般为服务器）进行非直接的连接。一些网关、路由器等网络设备具备网络代理功能。一般认为代理服务有利于保障网络终端的隐私或安全，防止攻击。代理也可以称为正向代理。<br>所谓代理服务器就是位于发起请求的客户端与原始服务器端之间的一台跳板服务器，正向代理可以隐藏客户端，反向代理可以隐藏原始服务器。<br>提供代理服务的电脑系统或其它类型的网络终端称为代理服务器（英文：Proxy Server）。一个完整的代理请求过程为：客户端首先与代理服务器创建连接，接着根据代理服务器所使用的代理协议，请求对目标服务器创建连接、或者获得目标服务器的指定资源（如：文件）。在后一种情况中，代理服务器可能对目标服务器的资源下载至本地缓存，如果客户端所要获取的资源在代理服务器的缓存之中，则代理服务器并不会向目标服务器发送请求，而是直接传回已缓存的资源。一些代理协议允许代理服务器改变客户端的原始请求、目标服务器的原始响应，以满足代理协议的需要。代理服务器的选项和设置在计算机程序中，通常包括一个“防火墙”，允许用户输入代理地址，它会遮盖他们的网络活动，可以允许绕过互联网过滤实现网络访问。</p>
<img src="https://img.econow.cn/medivh/1630550846470.png"  />

<p>代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。代理不改变请求URI，并不会直接发送给前方持有资源的目标服务器。<br>持有资源实体的服务器被称为源服务器。从源服务器返回的响应经过代理服务器后再传给客户端。</p>
<img src="https://img.econow.cn/medivh/1630550861682.png"  />

<h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><ul>
<li>HTTP</li>
<li>HTTPS</li>
</ul>
<h4 id="Socks"><a href="#Socks" class="headerlink" title="Socks"></a>Socks</h4><ul>
<li>Socks4&#x2F;5</li>
</ul>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ol>
<li>提高访问速度：通常代理服务器都设置一个较大的缓冲区，当有外界的信息通过时，同时也将其保存到缓冲区中，当其他用户再访问相同的信息时， 则直接由缓冲区中取出信息，传给用户，以提高访问速度。</li>
<li>控制对内部资源的访问：如某大学FTP（前提是该代理地址在该资源的允许访问范围之内），使用教育网内地址段免费代理服务器，就可以用于对教育网开放的各类FTP下载上传，以及各类资料查询共享等服务。</li>
<li>过滤内容：例如限制对特定计算机的访问，将一种语言的数据翻译成另一种语言，或是防御代理服务器两边的攻击性访问。</li>
<li>隐藏真实IP：上网者也可以通过代理服务器隐藏自己的IP，免受攻击。但是只一个代理很难保证安全，更安全的方法是利用特定的工具创建代理链（如：Tor）。</li>
<li>突破自身IP访问限制：访问国外站点。</li>
<li>突破内容过滤机制限制，访问被过滤网站。</li>
</ol>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>在生产活动中比较常见的使用方式：</p>
<ul>
<li>使用代理IP抓取社保网站的信息；</li>
<li>打通内网和云环境的部分接口；</li>
<li>代理MongoDB给QMS。<br>主要用的的软件是Nginx，可以代理若干协议：</li>
</ul>
<img src="https://img.econow.cn/medivh/1630550965945.png"  />

<p>需要注意的是Nginx默认支持http代理，但是如果使用https代理需要增加模块：ngx_http_proxy_connect_module<br>需要注意的是安装patch命令，服务器默认是没有这个命令的。<br>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://nginx.org/download/nginx-1.9.2.tar.gz</span><br><span class="line">$ tar -xzvf nginx-1.9.2.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> nginx-1.9.2/</span><br><span class="line">$ patch -p1 &lt; /path/to/ngx_http_proxy_connect_module/patch/proxy_connect.patch</span><br><span class="line">$ ./configure \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--prefix=/usr/local/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--add-module=/root/ngx_http_proxy_connect_module</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>对于已经安装了nginx的可以使用以下方式（未实际验证过）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止NGINX服务</span></span><br><span class="line"><span class="comment"># systemctl stop nginx</span></span><br><span class="line"><span class="comment"># 备份原执行文件</span></span><br><span class="line"><span class="comment"># cp /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</span></span><br><span class="line"><span class="comment"># 在源代码路径重新编译</span></span><br><span class="line"><span class="comment"># cd /usr/local/src/nginx-1.16.0</span></span><br><span class="line">./configure \</span><br><span class="line">--user=www \</span><br><span class="line">--group=www \</span><br><span class="line">--prefix=/usr/local/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--add-module=/root/src/ngx_http_proxy_connect_module</span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># 不要make install</span></span><br><span class="line"><span class="comment"># 将新生成的可执行文件拷贝覆盖原来的nginx执行文件</span></span><br><span class="line"><span class="comment"># cp objs/nginx /usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="comment"># /usr/bin/nginx -V</span></span><br><span class="line">nginx version: nginx/1.16.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC)</span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --user=www --group=www --prefix=/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-threads --add-module=/root/src/ngx_http_proxy_connect_module</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen                         3128;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># dns resolver used by forward proxying</span></span><br><span class="line">    resolver                       8.8.8.8;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward proxy for CONNECT request</span></span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 563;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward proxy for non-CONNECT request</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://<span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意事项：</p>
<ul>
<li>resolver 必须配置，建议和服务器一致</li>
</ul>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>反向代理在电脑网络中是代理服务器的一种。服务器根据客户端的请求，从其关系的一组或多组后端服务器（如Web服务器）上获取资源，然后再将这些资源返回给客户端，客户端只会得知反向代理的IP地址，而不知道在代理服务器后面的服务器集群的存在[1]。<br>与正向代理不同，正向代理作为客户端的代理，将从互联网上获取的资源返回给一个或多个的客户端，服务端（如Web服务器）只知道代理的IP地址而不知道客户端的IP地址；而反向代理是作为服务器端（如Web服务器）的代理使用，而不是客户端。客户端借由前向代理可以间接访问很多不同互联网服务器（集群）的资源，而反向代理是供很多客户端都通过它间接访问不同后端服务器上的资源，而不需要知道这些后端服务器的存在，而以为所有资源都来自于这个反向代理服务器。</p>
<img src="https://img.econow.cn/medivh/1630551013440.png"  />

<p>反向代理在现时的互联网中并不少见，而另一些例子，像是CDN、SNI代理等，是反向代理结合DNS的一类延伸应用。<br><img src="https://img.econow.cn/medivh/1630551027126.png"  /></p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ul>
<li>对客户端隐藏服务器（集群）的IP地址</li>
<li>安全：作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS&#x2F;DDoS）的防护，更容易排查恶意软件等</li>
<li>为后端服务器（集群）统一提供加密和SSL加速（如SSL终端代理）</li>
<li>负载均衡，若服务器集群中有负荷较高者，反向代理通过URL重写，根据连线请求从负荷较低者获取与所需相同的资源或备援</li>
<li>对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务</li>
<li>对一些内容进行压缩，以节约带宽或为网络带宽不佳的网络提供服务</li>
<li>减速上传</li>
<li>为在私有网络下（如局域网）的服务器集群提供NAT穿透及外网发布服务</li>
<li>提供HTTP访问认证[2]</li>
<li>突破互联网封锁<br>该部分较为常见，不再叙述。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>代理服务器</li>
<li><a target="_blank" rel="noopener" href="https://www.kancloud.cn/lizhenjie1992/nginxx/2043708">https://www.kancloud.cn/lizhenjie1992/nginxx/2043708</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8EMac%E4%B8%8AMySQL%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8EMac%E4%B8%8AMySQL%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98.html" class="post-title-link" itemprop="url">关于Mac上MySQL认证失败的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
    </span>

  
    <span id="/%E5%85%B3%E4%BA%8EMac%E4%B8%8AMySQL%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98.html" class="post-meta-item leancloud_visitors" data-flag-title="关于Mac上MySQL认证失败的问题" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>今天遇到了点小问题，想重构一个项目，顺便创建一个干净的数据库，但是连接失败！</p>
</blockquote>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><img src="https://img.econow.cn/medivh/1638526336673.png" alt="1638526336673.png"></p>
<p>事实上我在终端上测试后确定账号和密码是没有问题的，因此重点查看软件和MySQL。终于仔细检查后发现是认证失败的问题。这个问题就很纳闷，咋会遇到这种问题，只好看看大家有没有遇到过。难道是Sequel Pro的问题？不应该吧，这就是一个普通的开源软件。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>终于找到一篇靠谱的文章，描述了异常的原因，而不是直接说怎么解决。<br>主要原因是8.x版本的MySQL的验证机制变成了caching_sha2_password，并不是原来的mysql_native_password。问题说简单也简单，说复杂也复杂，升级个版本还有这样的问题，怪不得没有太多人愿意随便升版本。</p>
<h3 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h3><p>低版本的MySQL，比如5.6，使用的时候是这样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database xxx charset=utf8mb4;</span><br><span class="line">CREATE USER <span class="string">&#x27;xxx&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON xxx.* TO <span class="string">&#x27;xxx&#x27;</span>@<span class="string">&#x27;%&#x27;</span>  WITH GRANT OPTION; </span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>而对于高版本的比如8.x就得用以下的方式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;123456&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>完事,再用Sequel Pro 连接就成功了,其他工具navicat也是这么操作,一样可以连接了。</p>
<p><img src="https://img.econow.cn/medivh/1638526875427.png" alt="1638526875427.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实其他版本的MySQL也会有其他的问题，和低版本相比而言，之后再整理一下。<br>很快就要休假了，反而又热爱上了工作，可笑。。。<br>但愿假期一切安好吧！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%88%9B%E5%BB%BAKubernetes%20manifest%20%E6%8C%87%E5%8D%97.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%88%9B%E5%BB%BAKubernetes%20manifest%20%E6%8C%87%E5%8D%97.html" class="post-title-link" itemprop="url">创建Kubernetes manifest 指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
    <span id="/%E5%88%9B%E5%BB%BAKubernetes%20manifest%20%E6%8C%87%E5%8D%97.html" class="post-meta-item leancloud_visitors" data-flag-title="创建Kubernetes manifest 指南" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>创建编排文件，是一件复杂的事情，很多时候可能没有头绪该如何开始。所以此篇文章提供一些创建的思路。</p>
<p>在定义资源时，将包含以下字段：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  ... </span><br></pre></td></tr></table></figure>

<blockquote>
<p>以下操作均在1.20.0版本，其他版本命令或结果有所不同。</p>
</blockquote>
<h2 id="字段详解"><a href="#字段详解" class="headerlink" title="字段详解"></a>字段详解</h2><h3 id="apiVersion"><a href="#apiVersion" class="headerlink" title="apiVersion"></a>apiVersion</h3><p>该字段指用于创建资源的API组和药使用的API版本。Kubernetes API被聚合到API组中，v1是要使用的apps API版本。如果想列出可用的API组及其版本，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl api-versions </span><br><span class="line">admissionregistration.k8s.io/v1</span><br><span class="line">admissionregistration.k8s.io/v1beta1</span><br><span class="line">apiextensions.k8s.io/v1</span><br><span class="line">apiextensions.k8s.io/v1beta1</span><br><span class="line">apiregistration.k8s.io/v1</span><br><span class="line">apiregistration.k8s.io/v1beta1</span><br><span class="line">apps/v1</span><br><span class="line">authentication.k8s.io/v1</span><br><span class="line">authentication.k8s.io/v1beta1</span><br><span class="line">authorization.k8s.io/v1</span><br><span class="line">authorization.k8s.io/v1beta1</span><br><span class="line">autoscaling/v1</span><br><span class="line">autoscaling/v2beta1</span><br><span class="line">autoscaling/v2beta2</span><br><span class="line">batch/v1</span><br><span class="line">batch/v1beta1</span><br><span class="line">certificates.k8s.io/v1</span><br><span class="line">certificates.k8s.io/v1beta1</span><br><span class="line">coordination.k8s.io/v1</span><br><span class="line">coordination.k8s.io/v1beta1</span><br><span class="line">crd.projectcalico.org/v1</span><br><span class="line">discovery.k8s.io/v1beta1</span><br><span class="line">events.k8s.io/v1</span><br><span class="line">events.k8s.io/v1beta1</span><br><span class="line">extensions/v1beta1</span><br><span class="line">flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">networking.k8s.io/v1</span><br><span class="line">networking.k8s.io/v1beta1</span><br><span class="line">node.k8s.io/v1</span><br><span class="line">node.k8s.io/v1beta1</span><br><span class="line">policy/v1beta1</span><br><span class="line">rbac.authorization.k8s.io/v1</span><br><span class="line">rbac.authorization.k8s.io/v1beta1</span><br><span class="line">scheduling.k8s.io/v1</span><br><span class="line">scheduling.k8s.io/v1beta1</span><br><span class="line">storage.k8s.io/v1</span><br><span class="line">storage.k8s.io/v1beta1</span><br><span class="line">v1</span><br></pre></td></tr></table></figure>

<h3 id="kind"><a href="#kind" class="headerlink" title="kind"></a>kind</h3><p>指定要创建的资源类型，比如Deployment、Pod和ReplicaSet等，可以使用以下命令查看可用的资源类型以及关联的API组：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl api-resources | more</span><br><span class="line">NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND</span><br><span class="line">bindings                                       v1                                     <span class="literal">true</span>         Binding</span><br><span class="line">componentstatuses                 cs           v1                                     <span class="literal">false</span>        ComponentStatus</span><br><span class="line">configmaps                        cm           v1                                     <span class="literal">true</span>         ConfigMap</span><br><span class="line">endpoints                         ep           v1                                     <span class="literal">true</span>         Endpoints</span><br><span class="line">events                            ev           v1                                     <span class="literal">true</span>         Event</span><br><span class="line">limitranges                       limits       v1                                     <span class="literal">true</span>         LimitRange</span><br><span class="line">namespaces                        ns           v1                                     <span class="literal">false</span>        Namespace</span><br><span class="line">nodes                             no           v1                                     <span class="literal">false</span>        Node</span><br><span class="line">persistentvolumeclaims            pvc          v1                                     <span class="literal">true</span>         PersistentVolum</span><br><span class="line">eClaim</span><br><span class="line">persistentvolumes                 pv           v1                                     <span class="literal">false</span>        PersistentVolum</span><br><span class="line">e</span><br><span class="line">pods                              po           v1                                     <span class="literal">true</span>         Pod</span><br><span class="line">podtemplates                                   v1                                     <span class="literal">true</span>         PodTemplate</span><br><span class="line">replicationcontrollers            rc           v1                                     <span class="literal">true</span>         ReplicationCont</span><br><span class="line">roller</span><br><span class="line">resourcequotas                    quota        v1                                     <span class="literal">true</span>         ResourceQuota</span><br><span class="line">secrets                                        v1                                     <span class="literal">true</span>         Secret</span><br><span class="line">serviceaccounts                   sa           v1                                     <span class="literal">true</span>         ServiceAccount</span><br><span class="line">services                          svc          v1                                     <span class="literal">true</span>         Service</span><br><span class="line">mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1        <span class="literal">false</span>        MutatingWebhook</span><br><span class="line">Configuration</span><br><span class="line">validatingwebhookconfigurations                admissionregistration.k8s.io/v1        <span class="literal">false</span>        ValidatingWebho</span><br><span class="line">okConfiguration</span><br><span class="line">customresourcedefinitions         crd,crds     apiextensions.k8s.io/v1                <span class="literal">false</span>        CustomResourceD</span><br><span class="line">efinition</span><br><span class="line">apiservices                                    apiregistration.k8s.io/v1              <span class="literal">false</span>        APIService</span><br><span class="line">controllerrevisions                            apps/v1                                <span class="literal">true</span>         ControllerRevis</span><br><span class="line">ion</span><br><span class="line">daemonsets                        ds           apps/v1                                <span class="literal">true</span>         DaemonSet</span><br><span class="line">deployments                       deploy       apps/v1                                <span class="literal">true</span>         Deployment</span><br><span class="line">replicasets                       rs           apps/v1                                <span class="literal">true</span>         ReplicaSet</span><br><span class="line">statefulsets                      sts          apps/v1                                <span class="literal">true</span>         StatefulSet</span><br><span class="line">tokenreviews                                   authentication.k8s.io/v1               <span class="literal">false</span>        TokenReview</span><br><span class="line">localsubjectaccessreviews                      authorization.k8s.io/v1                <span class="literal">true</span>         LocalSubjectAcc</span><br><span class="line">essReview</span><br><span class="line">selfsubjectaccessreviews                       authorization.k8s.io/v1                <span class="literal">false</span>        SelfSubjectAcce</span><br><span class="line">ssReview</span><br><span class="line">selfsubjectrulesreviews                        authorization.k8s.io/v1                <span class="literal">false</span>        SelfSubjectRule</span><br><span class="line">sReview</span><br><span class="line">subjectaccessreviews                           authorization.k8s.io/v1                <span class="literal">false</span>        SubjectAccessRe</span><br><span class="line">view</span><br><span class="line">horizontalpodautoscalers          hpa          autoscaling/v1                         <span class="literal">true</span>         HorizontalPodAu</span><br><span class="line">toscaler</span><br><span class="line">cronjobs                          cj           batch/v1beta1                          <span class="literal">true</span>         CronJob</span><br><span class="line"><span class="built_in">jobs</span>                                           batch/v1                               <span class="literal">true</span>         Job</span><br><span class="line">certificatesigningrequests        csr          certificates.k8s.io/v1                 <span class="literal">false</span>        CertificateSign</span><br><span class="line">ingRequest</span><br><span class="line">leases                                         coordination.k8s.io/v1                 <span class="literal">true</span>         Lease</span><br><span class="line">bgpconfigurations                              crd.projectcalico.org/v1               <span class="literal">false</span>        BGPConfiguratio</span><br><span class="line">n</span><br><span class="line">bgppeers                                       crd.projectcalico.org/v1               <span class="literal">false</span>        BGPPeer</span><br><span class="line">blockaffinities                                crd.projectcalico.org/v1               <span class="literal">false</span>        BlockAffinity</span><br><span class="line">caliconodestatuses                             crd.projectcalico.org/v1               <span class="literal">false</span>        CalicoNodeStatu</span><br><span class="line">s</span><br><span class="line">clusterinformations                            crd.projectcalico.org/v1               <span class="literal">false</span>        ClusterInformat</span><br><span class="line">ion</span><br><span class="line">felixconfigurations                            crd.projectcalico.org/v1               <span class="literal">false</span>        FelixConfigurat</span><br><span class="line">ion</span><br><span class="line">globalnetworkpolicies                          crd.projectcalico.org/v1               <span class="literal">false</span>        GlobalNetworkPo</span><br><span class="line">licy</span><br><span class="line">globalnetworksets                              crd.projectcalico.org/v1               <span class="literal">false</span>        GlobalNetworkSe</span><br><span class="line">t</span><br><span class="line">hostendpoints                                  crd.projectcalico.org/v1               <span class="literal">false</span>        HostEndpoint</span><br><span class="line">ipamblocks                                     crd.projectcalico.org/v1               <span class="literal">false</span>        IPAMBlock</span><br><span class="line">ipamconfigs                                    crd.projectcalico.org/v1               <span class="literal">false</span>        IPAMConfig</span><br><span class="line">ipamhandles                                    crd.projectcalico.org/v1               <span class="literal">false</span>        IPAMHandle</span><br><span class="line">ippools                                        crd.projectcalico.org/v1               <span class="literal">false</span>        IPPool</span><br><span class="line">ipreservations                                 crd.projectcalico.org/v1               <span class="literal">false</span>        IPReservation</span><br><span class="line">kubecontrollersconfigurations                  crd.projectcalico.org/v1               <span class="literal">false</span>        KubeControllers</span><br><span class="line">Configuration</span><br><span class="line">networkpolicies                                crd.projectcalico.org/v1               <span class="literal">true</span>         NetworkPolicy</span><br><span class="line">networksets                                    crd.projectcalico.org/v1               <span class="literal">true</span>         NetworkSet</span><br><span class="line">endpointslices                                 discovery.k8s.io/v1beta1               <span class="literal">true</span>         EndpointSlice</span><br><span class="line">events                            ev           events.k8s.io/v1                       <span class="literal">true</span>         Event</span><br><span class="line">ingresses                         ing          extensions/v1beta1                     <span class="literal">true</span>         Ingress</span><br><span class="line">flowschemas                                    flowcontrol.apiserver.k8s.io/v1beta1   <span class="literal">false</span>        FlowSchema</span><br><span class="line">prioritylevelconfigurations                    flowcontrol.apiserver.k8s.io/v1beta1   <span class="literal">false</span>        PriorityLevelCo</span><br><span class="line">nfiguration</span><br><span class="line">ingressclasses                                 networking.k8s.io/v1                   <span class="literal">false</span>        IngressClass</span><br><span class="line">ingresses                         ing          networking.k8s.io/v1                   <span class="literal">true</span>         Ingress</span><br><span class="line">networkpolicies                   netpol       networking.k8s.io/v1                   <span class="literal">true</span>         NetworkPolicy</span><br><span class="line">runtimeclasses                                 node.k8s.io/v1                         <span class="literal">false</span>        RuntimeClass</span><br><span class="line">poddisruptionbudgets              pdb          policy/v1beta1                         <span class="literal">true</span>         PodDisruptionBu</span><br><span class="line">dget</span><br><span class="line">podsecuritypolicies               psp          policy/v1beta1                         <span class="literal">false</span>        PodSecurityPoli</span><br><span class="line">cy</span><br><span class="line">clusterrolebindings                            rbac.authorization.k8s.io/v1           <span class="literal">false</span>        ClusterRoleBind</span><br><span class="line">ing</span><br><span class="line">clusterroles                                   rbac.authorization.k8s.io/v1           <span class="literal">false</span>        ClusterRole</span><br><span class="line">rolebindings                                   rbac.authorization.k8s.io/v1           <span class="literal">true</span>         RoleBinding</span><br><span class="line">roles                                          rbac.authorization.k8s.io/v1           <span class="literal">true</span>         Role</span><br><span class="line">priorityclasses                   pc           scheduling.k8s.io/v1                   <span class="literal">false</span>        PriorityClass</span><br><span class="line">csidrivers                                     storage.k8s.io/v1                      <span class="literal">false</span>        CSIDriver</span><br><span class="line">csinodes                                       storage.k8s.io/v1                      <span class="literal">false</span>        CSINode</span><br><span class="line">storageclasses                    sc           storage.k8s.io/v1                      <span class="literal">false</span>        StorageClass</span><br><span class="line">volumeattachments                              storage.k8s.io/v1                      <span class="literal">false</span>        VolumeAttachmen</span><br><span class="line">t</span><br></pre></td></tr></table></figure>

<p>使用<code>api-version</code>和<code>api-resources</code>命令可以找到可用资源与资源类型关联的API组以及API组版本。根据此信息填写<code>apiVersion:</code>和<code>kind:</code>字段。</p>
<p>如果想了解某种资源类型的用途，可以使用<code>kubectl explain</code>命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl explain --api-version=apps/v1 deployment</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Deployment enables declarative updates <span class="keyword">for</span> Pods and ReplicaSets.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">     APIVersion defines the versioned schema of this representation of an</span><br><span class="line">     object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">     value, and may reject unrecognized values. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#resources</span></span><br><span class="line"></span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">     Kind is a string value representing the REST resource this object</span><br><span class="line">     represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">     requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#types-kinds</span></span><br><span class="line"></span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">     Standard object metadata.</span><br><span class="line"></span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line"></span><br><span class="line">   status	&lt;Object&gt;</span><br><span class="line">     Most recently observed status of the Deployment.</span><br></pre></td></tr></table></figure>

<h3 id="metadata"><a href="#metadata" class="headerlink" title="metadata"></a>metadata</h3><p>用于唯一标识Kubernetes集群中的资源，可以为资源命名、分配标签、注解和指定命名空间等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain deployment.metadata | more</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: metadata &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Standard object metadata.</span><br><span class="line">                                                                                                                                             </span><br><span class="line">     ObjectMeta is metadata that all persisted resources must have, <span class="built_in">which</span></span><br><span class="line">     includes all objects <span class="built_in">users</span> must create.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   annotations  &lt;map[string]string&gt;</span><br><span class="line">     Annotations is an unstructured key value map stored with a resource that</span><br><span class="line">     may be <span class="built_in">set</span> by external tools to store and retrieve arbitrary metadata. They</span><br><span class="line">     are not queryable and should be preserved when modifying objects. More</span><br><span class="line">     info: http://kubernetes.io/docs/user-guide/annotations</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="spec"><a href="#spec" class="headerlink" title="spec"></a>spec</h3><p>可以定义要使用的容器镜像、副本数量、selector条件、存活或就绪探针的定义等。查看具体信息可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl explain deployment.spec | more</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line"></span><br><span class="line">     DeploymentSpec is the specification of the desired behavior of the</span><br><span class="line">     Deployment.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   minReadySeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     Minimum number of seconds <span class="keyword">for</span> <span class="built_in">which</span> a newly created pod should be ready</span><br><span class="line">     without any of its container crashing, <span class="keyword">for</span> it to be considered available.</span><br><span class="line">     Defaults to 0 (pod will be considered available as soon as it is ready)</span><br><span class="line"></span><br><span class="line">   paused	&lt;boolean&gt;</span><br><span class="line">     Indicates that the deployment is paused.</span><br><span class="line"></span><br><span class="line">   progressDeadlineSeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     The maximum time <span class="keyword">in</span> seconds <span class="keyword">for</span> a deployment to make progress before it is</span><br><span class="line">     considered to be failed. The deployment controller will <span class="built_in">continue</span> to process</span><br><span class="line">     failed deployments and a condition with a ProgressDeadlineExceeded reason</span><br><span class="line">     will be surfaced <span class="keyword">in</span> the deployment status. Note that progress will not be</span><br><span class="line">     estimated during the time a deployment is paused. Defaults to 600s.</span><br><span class="line"></span><br><span class="line">   replicas	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     Number of desired pods. This is a pointer to distinguish between explicit</span><br><span class="line">     zero and not specified. Defaults to 1.</span><br><span class="line"></span><br><span class="line">   revisionHistoryLimit	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     The number of old ReplicaSets to retain to allow rollback. This is a</span><br><span class="line">     pointer to distinguish between explicit zero and not specified. Defaults to</span><br><span class="line">     10.</span><br><span class="line"></span><br><span class="line">   selector	&lt;Object&gt; -required-</span><br><span class="line">     Label selector <span class="keyword">for</span> pods. Existing ReplicaSets whose pods are selected by</span><br><span class="line">     this will be the ones affected by this deployment. It must match the pod</span><br><span class="line">     template<span class="string">&#x27;s labels.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   strategy	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     The deployment strategy to use to replace existin</span></span><br></pre></td></tr></table></figure>

<h4 id="获取模板"><a href="#获取模板" class="headerlink" title="获取模板"></a>获取模板</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl create deployment nginx --image=nginx -o yaml --dry-run=client</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>或者ingress</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl create ingress my-ingress --rule=host/path=app1:80 -o yaml --dry-run=client</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: my-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: host</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: app1</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">        path: /path</span><br><span class="line">        pathType: Exact</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>还可以使用 <code>kubectl explain</code> 添加<code>--rescursive</code>参数，可以获取各个字段的分层视图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl explain deployment.spec.template.spec.containers.livenessProbe --recursive | more</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: livenessProbe &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Periodic probe of container liveness. Container will be restarted <span class="keyword">if</span> the</span><br><span class="line">     probe fails. Cannot be updated. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle<span class="comment">#container-probes</span></span><br><span class="line"></span><br><span class="line">     Probe describes a health check to be performed against a container to</span><br><span class="line">     determine whether it is alive or ready to receive traffic.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   <span class="built_in">exec</span>	&lt;Object&gt;</span><br><span class="line">      <span class="built_in">command</span>	&lt;[]string&gt;</span><br><span class="line">   failureThreshold	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   httpGet	&lt;Object&gt;</span><br><span class="line">      host	&lt;string&gt;</span><br><span class="line">      httpHeaders	&lt;[]Object&gt;</span><br><span class="line">         name	&lt;string&gt;</span><br><span class="line">         value	&lt;string&gt;</span><br><span class="line">      path	&lt;string&gt;</span><br><span class="line">      port	&lt;string&gt;</span><br><span class="line">      scheme	&lt;string&gt;</span><br><span class="line">   initialDelaySeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   periodSeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   successThreshold	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   tcpSocket	&lt;Object&gt;</span><br><span class="line">      host	&lt;string&gt;</span><br><span class="line">      port	&lt;string&gt;</span><br><span class="line">   timeoutSeconds	&lt;<span class="built_in">integer</span>&gt;</span><br></pre></td></tr></table></figure>

<p>如果想进一步了解更详细的信息，可以继续拼接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node-217 ~]<span class="comment"># kubectl explain deployment.spec.template.spec.containers.lifecycle</span></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: lifecycle &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Actions that the management system should take <span class="keyword">in</span> response to container</span><br><span class="line">     lifecycle events. Cannot be updated.</span><br><span class="line"></span><br><span class="line">     Lifecycle describes actions that the management system should take <span class="keyword">in</span></span><br><span class="line">     response to container lifecycle events. For the PostStart and PreStop</span><br><span class="line">     lifecycle handlers, management of the container blocks <span class="keyword">until</span> the action is</span><br><span class="line">     complete, unless the container process fails, <span class="keyword">in</span> <span class="built_in">which</span> <span class="keyword">case</span> the handler is</span><br><span class="line">     aborted.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   postStart	&lt;Object&gt;</span><br><span class="line">     PostStart is called immediately after a container is created. If the</span><br><span class="line">     handler fails, the container is terminated and restarted according to its</span><br><span class="line">     restart policy. Other management of the container blocks <span class="keyword">until</span> the hook</span><br><span class="line">     completes. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/<span class="comment">#container-hooks</span></span><br><span class="line"></span><br><span class="line">   preStop	&lt;Object&gt;</span><br><span class="line">     PreStop is called immediately before a container is terminated due to an</span><br><span class="line">     API request or management event such as liveness/startup probe failure,</span><br><span class="line">     preemption, resource contention, etc. The handler is not called <span class="keyword">if</span> the</span><br><span class="line">     container crashes or exits. The reason <span class="keyword">for</span> termination is passed to the</span><br><span class="line">     handler. The Pod<span class="string">&#x27;s termination grace period countdown begins before the</span></span><br><span class="line"><span class="string">     PreStop hooked is executed. Regardless of the outcome of the handler, the</span></span><br><span class="line"><span class="string">     container will eventually terminate within the Pod&#x27;</span>s termination grace</span><br><span class="line">     period. Other management of the container blocks <span class="keyword">until</span> the hook completes</span><br><span class="line">     or <span class="keyword">until</span> the termination grace period is reached. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/<span class="comment">#container-hooks</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><p>整个编排文件分为四个字段或者四部分：</p>
<ol>
<li>apiVersion API组及版本</li>
<li>kind  资源类型</li>
<li>metadata 资源注解</li>
<li>spec 定义和管理资源</li>
</ol>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取API 版本</span></span><br><span class="line">kubectl api-versions</span><br><span class="line"><span class="comment"># 获取资源类型和API版本</span></span><br><span class="line">kubectl api-resources</span><br><span class="line"><span class="comment"># 获取资源详情</span></span><br><span class="line">kubectl explain --api-version=apps/v1 replicaset</span><br><span class="line"><span class="comment"># 根据资源创建基础模板</span></span><br><span class="line">kubectl create deployment nginx --image=nginx -o yaml --dry-run=client</span><br><span class="line"><span class="comment"># 获取资源详情</span></span><br><span class="line">kubectl explain deployment.spec.selector.matchExpressions.operator</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%9F%BA%E4%BA%8EKubernetes%E7%9A%84Jenkins%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81slave.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%9F%BA%E4%BA%8EKubernetes%E7%9A%84Jenkins%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81slave.html" class="post-title-link" itemprop="url">基于Kubernetes的Jenkins实现动态slave</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
    <span id="/%E5%9F%BA%E4%BA%8EKubernetes%E7%9A%84Jenkins%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81slave.html" class="post-meta-item leancloud_visitors" data-flag-title="基于Kubernetes的Jenkins实现动态slave" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一般情况下都是在物理机或者虚拟机上部署Jenkins，但是这种部署方式会存在一些缺点，比如：</p>
<ol>
<li>master节点故障，整体不可用</li>
<li>每个slave都需要维护，较为繁琐</li>
<li>资源分配不均衡，且资源利用率低</li>
</ol>
<p>因此需要更可靠和高效的方式来完成CI&#x2F;CD流程。</p>
<p><img src="https://img.econow.cn/medivh/1649815494764.png" alt="1649815494764.png"></p>
<p>如图所示，master和slave以Pod的形式运行在kubernetes集群中，并且将配置数据存储到PV中。但是其中slave运行在多个节点，但是不是一直运行的状态，会根据需求动态创建并自动删除。</p>
<p>工作流程：</p>
<ol>
<li>master接收到build请求，会根据配置的label动态创建一个slave的Pod并注册到master</li>
<li>slave运行完job，该Pod自动注销并且删除</li>
<li>恢复到最初的状态</li>
</ol>
<p>架构优点：</p>
<ol>
<li>高可用。当master故障时，kubernetes 会自动创建一个新的Pod，并且将之前的PV分配给新的Pod，保证数据的完整</li>
<li>动态伸缩。根据job来动态创建slave的Pod，并且完成后自动释放资源，提供资源利用率</li>
<li>可扩展。当资源不足时，可以通过增加node的方式快速增加slave</li>
</ol>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="编排文件"><a href="#编排文件" class="headerlink" title="编排文件"></a>编排文件</h3><ol>
<li>PV&#x2F;PVC 提供数据持久化</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  nfs:</span><br><span class="line">    server: x.x.x.x</span><br><span class="line">    path: /Public/jenkins</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-pvc</span><br><span class="line">  namespace: devops</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 500Gi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>角色授权</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-sa</span><br><span class="line">  namespace: devops</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-cr</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">&quot;extensions&quot;</span>, <span class="string">&quot;apps&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods/exec&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-crd</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: jenkins-cr</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: jenkins-sa</span><br><span class="line">  namespace: devops</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建deployment</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: devops </span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: jenkins</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      serviceAccount: jenkins-sa</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: jenkins/jenkins:lts</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">        - name:JAVA_OPTS</span><br><span class="line">          value: -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85 -Duser.timezone=Asia/Shanghai -Dhudson.model.DownloadService.noSignatureCheck=<span class="literal">true</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: web</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">          name: agent</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /login</span><br><span class="line">            port: 8080</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          failureThreshold: 12</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkinshome</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">      volumes:</span><br><span class="line">      - name: jenkinshome</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: jenkins-pvc</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: devops </span><br><span class="line">  labels:</span><br><span class="line">    app: jenkins</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30002</span><br><span class="line">  - name: agent</span><br><span class="line">    port: 50000</span><br><span class="line">    targetPort: agent</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>依次执行上述编排文件即可。需要注意PV的文件目录权限是否需要单独修改。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>Jenkins启动后先进行初步配置，此处不在详细描述。需要注意的是：</p>
<ul>
<li>访问的地址是使用的nodePort：30002端口</li>
<li>初始化的密码文件可以从nfs目录上获取</li>
<li>必要插件Pipline和kubernetes</li>
</ul>
<h4 id="配置kubernetes"><a href="#配置kubernetes" class="headerlink" title="配置kubernetes"></a>配置kubernetes</h4><p>节点管理-》Configure Clouds -》kubernetes</p>
<p><img src="https://img.econow.cn/medivh/1649817346433.png" alt="1649817346433.png"></p>
<p>Kubernetes Cloud details</p>
<p><img src="https://img.econow.cn/medivh/1649817406288.png" alt="1649817406288.png"></p>
<blockquote>
<ol>
<li>注意此处填写的是kubernetes 集群6443的地址。</li>
<li>由于之前创建了account，因此此处无需填写凭据</li>
<li>命名空间可以独立</li>
<li>信息填写完成后注意测试一下。如果测试失败，很可能是权限问题，需要把ServiceAccount的凭证jenkins-sa添加进来。</li>
</ol>
</blockquote>
<p><img src="https://img.econow.cn/medivh/1649817519819.png" alt="1649817519819.png"></p>
<blockquote>
<p>注意此处的Jenkins地址，要填写 <a target="_blank" rel="noopener" href="http://jenkins.devops.svc.cluster.local:8080/">http://jenkins.devops.svc.cluster.local:8080</a> 。因为之后slave的Pod是需要访问master节点的，只有这种域名的形式才能更灵活的满足需求。如果想不明白为什么是这样的域名，可以思考一下域名解析的过程。</p>
</blockquote>
<p><img src="https://img.econow.cn/medivh/1649817671870.png" alt="1649817671870.png"></p>
<p><img src="https://img.econow.cn/medivh/1649817705400.png" alt="1649817705400.png"></p>
<blockquote>
<p>这两部分是配置slave的Pod的，重点部分在于镜像。jnlp是Jenkins的slave访问master的一种方式。</p>
</blockquote>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p><img src="https://img.econow.cn/medivh/1649817799601.png" alt="1649817799601.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl get pods -n devops</span><br><span class="line">NAME                       READY   STATUS        RESTARTS   AGE</span><br><span class="line">jenkins-666657ffdd-vvdx8   1/1     Running       0          16h</span><br><span class="line">test-6-5gh46-qfs4k-jz13z   0/2     Terminating   0          61s</span><br></pre></td></tr></table></figure>

<p>此时slave的Pod已经运行完成，自动终止了，之后会自动释放。</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="使用podTemplate"><a href="#使用podTemplate" class="headerlink" title="使用podTemplate"></a>使用podTemplate</h3><p>根据标签，调度到其他节点，且使用Jenkins-slave的label</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">podTemplate(cloud: <span class="string">&#x27;kubernetes&#x27;</span>, inheritFrom: <span class="string">&#x27;jenkins-slave&#x27;</span>, label: <span class="string">&#x27;jenkins-slave&#x27;</span>, name: <span class="string">&#x27;test-label&#x27;</span>, namespace: <span class="string">&#x27;devops&#x27;</span>) &#123;</span><br><span class="line">    // some block</span><br><span class="line">&#125;</span><br><span class="line">node(<span class="string">&#x27;jenkins-slave&#x27;</span>) &#123;</span><br><span class="line">    stage(<span class="string">&#x27;get code&#x27;</span>) &#123;</span><br><span class="line">      git credentialsId: <span class="string">&#x27;04bfb304-3573-4876-ad8c-52e43d047d6a&#x27;</span>, url: <span class="string">&#x27;http://192.168.1.110/SystemProject/joyshebao/DiscoveryServer.git&#x27;</span> </span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;build&#x27;</span>) &#123;</span><br><span class="line">      container(<span class="string">&#x27;maven381&#x27;</span>) &#123;</span><br><span class="line">          sh <span class="string">&#x27;mvn -Dmaven.test.skip=true clean package  -f  pom.xml&#x27;</span></span><br><span class="line">          archiveArtifacts <span class="string">&#x27;**/target/*.jar&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调度后的Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">jenkins-666657ffdd-vvdx8   1/1     Running   0          2d17h   10.200.128.174   uat-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">jenkins-slave-6pz0c        2/2     Running   0          19s     10.200.229.150   pre-205      &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="使用变量"><a href="#使用变量" class="headerlink" title="使用变量"></a>使用变量</h3><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>纠结了好几天，总算调试出一些结果。</p>
<ol>
<li>事实证明，label的作用是决定是否使用模板，和kubernetes中的label毫无关系；</li>
<li>脚本式的pipeline和声明式的pipeline存在很大的不同，至少语法上就有很大差别；</li>
<li>解决了maven项目重复下载依赖的问题，挂载.m2目录即可；</li>
</ol>
<p>目前仍存在的问题：</p>
<ol>
<li>如何决定让slave不运行在某些机器上？</li>
<li>哪种pipeline才是主流呢？</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E4%B8%80%E4%B8%AAFlask%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%B8%80%E4%B8%AAFlask%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html" class="post-title-link" itemprop="url">一个Flask项目经验总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
    <span id="/%E4%B8%80%E4%B8%AAFlask%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html" class="post-meta-item leancloud_visitors" data-flag-title="一个Flask项目经验总结" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题整理"><a href="#问题整理" class="headerlink" title="问题整理"></a>问题整理</h2><h3 id="Error-While-importing-‘run-app-dev’-an-ImportError-was-raised"><a href="#Error-While-importing-‘run-app-dev’-an-ImportError-was-raised" class="headerlink" title="Error: While importing ‘run_app_dev’, an ImportError was raised"></a>Error: While importing ‘run_app_dev’, an ImportError was raised</h3><p>网上说是循环调用的问题，但这个项目在我笔记本上是可以运行的，怀疑是不是flask的版本问题，因为我直接安装了最新的flask&#x3D;&#x3D;2.0.2，把最新的flask卸载后，安装1.1.2的flask 此问题解决。</p>
<h3 id="当flask-migrate没有MigrateCommand时"><a href="#当flask-migrate没有MigrateCommand时" class="headerlink" title="当flask_migrate没有MigrateCommand时"></a>当flask_migrate没有MigrateCommand时</h3><p>出现这个情况的原因是最新的flask_migrate，已经去除了MigrateCommand，可以直接在命令行中使用,如果需要使用MigrateCommand的话:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">可用 pip install flask_migrate==xx 命令</span><br><span class="line">把flask_migrate降低一个版本</span><br><span class="line">这里用的2.7.0版本的把问题解决了</span><br></pre></td></tr></table></figure>

<h3 id="ModuleNotFoundError-No-module-named-‘Crypto’解决方案"><a href="#ModuleNotFoundError-No-module-named-‘Crypto’解决方案" class="headerlink" title="ModuleNotFoundError: No module named ‘Crypto’解决方案"></a>ModuleNotFoundError: No module named ‘Crypto’解决方案</h3><p>方案一：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 uninstall pycryptodome</span><br><span class="line">pip3 uninstall crypto</span><br><span class="line">Pip3 install pycrypto</span><br></pre></td></tr></table></figure>

<p>方案二：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Pip3 install pycrypto</span><br><span class="line"><span class="comment">#然后手动修改 site-packages/crypto 目录改为Crypto即可</span></span><br></pre></td></tr></table></figure>

<h3 id="如何转义JSON"><a href="#如何转义JSON" class="headerlink" title="如何转义JSON"></a>如何转义JSON</h3><p>飞书更新的接口文档，要求卡片信息格式必须为转移后的JSON，和普通JSON的区别就是必须加转义符“\”。这个就很麻烦了。<br>实现方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">s1 = &#123;<span class="string">&quot;elements&quot;</span>:[&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hi&quot;</span>,<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;markdown&quot;</span>&#125;,&#123;<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;hr&quot;</span>&#125;,&#123;<span class="string">&quot;elements&quot;</span>:[&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hi text&quot;</span>,<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;plain_text&quot;</span>&#125;],<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;note&quot;</span>&#125;]&#125;</span><br><span class="line">s2 = json.dumps(s1)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(s2))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印结果</span></span><br><span class="line"><span class="string">&quot;&#123;\&quot;elements\&quot;: [&#123;\&quot;content\&quot;: \&quot;hi\&quot;, \&quot;tag\&quot;: \&quot;markdown\&quot;&#125;, &#123;\&quot;tag\&quot;: \&quot;hr\&quot;&#125;, &#123;\&quot;elements\&quot;: [&#123;\&quot;content\&quot;: \&quot;hi text\&quot;, \&quot;tag\&quot;: \&quot;plain_text\&quot;&#125;], \&quot;tag\&quot;: \&quot;note\&quot;&#125;]&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>简单来说就是通过两次<code>json.dumps()</code>来实现自动增加转义符的。</p>
<h3 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h3><p>在模糊查询的时候经常会遇到字段不确定的情况，因此使用原生SQL更为简单，并且能结合模糊查询来实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> request.args.get(<span class="string">&#x27;key&#x27;</span>) <span class="keyword">and</span> request.args.get(<span class="string">&#x27;value&#x27;</span>):</span><br><span class="line">    sql = <span class="string">&quot;&quot;&quot;select * from user where %s like &#x27;%s&#x27;&quot;&quot;&quot;</span> % (key, <span class="string">&quot;%&quot;</span> + value + <span class="string">&quot;%&quot;</span>)</span><br><span class="line">    c = db.session.execute(sql).fetchall()</span><br><span class="line">    <span class="keyword">if</span> c:</span><br><span class="line">        res_obj = c[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res_obj = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>单独动态查询的话也容易实现，但是模糊查询不太容易结合，只能使用下面的方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">params = &#123;key: value&#125;</span><br><span class="line">res_obj = db.session.query(User).filter_by(**params).<span class="built_in">all</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="二次优化"><a href="#二次优化" class="headerlink" title="二次优化"></a>二次优化</h4><p>将查询记录转变为非list类型的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&quot;&quot;&quot;select * from user where %s like &#x27;%s&#x27;&quot;&quot;&quot;</span> % (key, <span class="string">&quot;%&quot;</span> + value + <span class="string">&quot;%&quot;</span>)</span><br><span class="line">c = db.session.execute(sql).fetchall()</span><br><span class="line"><span class="keyword">if</span> c:</span><br><span class="line">    res_obj = <span class="built_in">tuple</span>(c)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    res_obj = <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增加判断条件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> <span class="built_in">isinstance</span>(res, <span class="built_in">tuple</span>):  <span class="comment"># 针对于模糊查询的情况</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> res:</span><br><span class="line">        lst.append(<span class="built_in">dict</span>(<span class="built_in">zip</span>(col.keys(), col)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当为tuple类型的时候，单独处理，独立于之前的list处理模式。</p>
<h3 id="flask-apscheduler-上下文的问题"><a href="#flask-apscheduler-上下文的问题" class="headerlink" title="flask_apscheduler 上下文的问题"></a>flask_apscheduler 上下文的问题</h3><p>最近调试apscheduler的时候出现以下的错误：</p>
<blockquote>
<p>RuntimeError: Working outside of application context.<br>This typically means that you attempted to use functionality that needed to interface with the current application object in some way. To solve this, set up an application context with app.app_context().  See the documentation for more information.</p>
</blockquote>
<p>其主要原因是由于调用到了公共变量，而flask引入了应用上下文管理，但是并没有获取到上下文导致。<br>解决方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> scheduler</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncAssets</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    同步资产信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> scheduler.app.app_context():</span><br><span class="line">            access_key_id = current_app.config.get(<span class="string">&#x27;ALI_KEY_ID&#x27;</span>)</span><br><span class="line">            access_key = current_app.config.get(<span class="string">&#x27;ALI_KEY&#x27;</span>)</span><br><span class="line">            access_r = current_app.config.get(<span class="string">&#x27;ALI_R&#x27;</span>)</span><br><span class="line">            self.client = AcsClient(access_key_id, access_key, access_r)</span><br></pre></td></tr></table></figure>

<h3 id="vue-时间格式化的问题"><a href="#vue-时间格式化的问题" class="headerlink" title="vue 时间格式化的问题"></a>vue 时间格式化的问题</h3><p>时间格式化处理使用moment.js。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install moment</span><br></pre></td></tr></table></figure>

<p>需要注意在格式化时间戳的时候检查是多少位，考虑是否除以1000和UTC的问题。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://momentjs.cn/">http://momentjs.cn</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E4%BD%BF%E7%94%A8Cloudera%E9%83%A8%E7%BD%B2%E5%92%8C%E7%AE%A1%E7%90%86hadoop%E9%9B%86%E7%BE%A4.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%BD%BF%E7%94%A8Cloudera%E9%83%A8%E7%BD%B2%E5%92%8C%E7%AE%A1%E7%90%86hadoop%E9%9B%86%E7%BE%A4.html" class="post-title-link" itemprop="url">使用Cloudera部署和管理hadoop集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
    </span>

  
    <span id="/%E4%BD%BF%E7%94%A8Cloudera%E9%83%A8%E7%BD%B2%E5%92%8C%E7%AE%A1%E7%90%86hadoop%E9%9B%86%E7%BE%A4.html" class="post-meta-item leancloud_visitors" data-flag-title="使用Cloudera部署和管理hadoop集群" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Cloude Manager 概述：</p>
<p>CDH 是 Cloudera 公司对整体 hadoop 集群环境进行监控与管理的企业级大数据管理平台。</p>
<p>Cloudera Manager 分为：</p>
<p>Cloudera Manager Server：对整个集群提供监控与管理操作。Cloudera Manager Server 通过部署在不同设备上的 Cloudera Manager Agent 进行管理整体集群。Cloudera Manager Server 需要部署在一台设备上。</p>
<p>Cloudera Manager Agent：部署在每个需要监控与管理的设备上。负责采集运行数据与执行下发的管理命令。</p>
<p>DataBase：关系型数据库是 Cloudera Manager 执行管理操作时，存储整体集群情况数据</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>先安装 Cloudrea Manager，再通过 Cloudrea Manager 在节点上安装 Cloudrea Manager 客户端，CDH，管理工具。<br><a target="_blank" rel="noopener" href="https://www.cloudera.com/documentation/manager/5-1-x.html">官方文档</a></p>
<h3 id="一、环境需求"><a href="#一、环境需求" class="headerlink" title="一、环境需求:"></a>一、环境需求:</h3><ul>
<li>关闭 selinux</li>
<li>各节点可以 SSH 登陆</li>
<li>在&#x2F;etc&#x2F;hosts 中添加各节点的主机名</li>
</ul>
<h3 id="二、环境准备"><a href="#二、环境准备" class="headerlink" title="二、环境准备"></a>二、环境准备</h3><p>1、修改以下参数，否则检查主机正确性时会出现 “已启用“透明大页面”，它可能会导致重大的性能问题。” 的警告</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"></span><br><span class="line"># vi /etc/rc.local</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>

<p>2、取代默认 JDK</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/java</span><br><span class="line">ln -s /usr/local/jdk1.8.0_91/ /usr/java/default</span><br></pre></td></tr></table></figure>

<p>因为默认情况下安装 Cloudrea Manager 的时候会自动安装一个 JDK7，所以在这里提前替换一下。如果之后检查的时候不生效，注意删除 JDK7，然后重启服务。正常的目录如下：<br><img src="https://img.econow.cn/medivh/1550050311058.png" /></p>
<h3 id="三、安装-Cloudrea-Manager"><a href="#三、安装-Cloudrea-Manager" class="headerlink" title="三、安装 Cloudrea Manager"></a>三、安装 Cloudrea Manager</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src</span><br><span class="line">wget http://archive.cloudera.com/cm5/installer/latest/cloudera-manager-installer.bin</span><br><span class="line">chmod +x cloudera-manager-installer.bin</span><br><span class="line">./cloudera-manager-installer.bin</span><br></pre></td></tr></table></figure>

<p>然后会出现以下画面，点击 Next 或者<Yes>,开始安装<br><img src="https://img.econow.cn/medivh/1550039104564.png" /></p>
<img src="https://img.econow.cn/medivh/1550039166335.png" />
最后安装完成，提示访问7180端口,账号密码都是admin
<img src="https://img.econow.cn/medivh/1550039183944.png" />

<h3 id="四、数据库准备工作"><a href="#四、数据库准备工作" class="headerlink" title="四、数据库准备工作"></a>四、数据库准备工作</h3><h4 id="1-Mysql-Install"><a href="#1-Mysql-Install" class="headerlink" title="1. Mysql Install"></a>1. Mysql Install</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh  http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">yum install mysql-server</span><br></pre></td></tr></table></figure>

<h4 id="2-Installing-the-MySQL-JDBC-Driver"><a href="#2-Installing-the-MySQL-JDBC-Driver" class="headerlink" title="2. Installing the MySQL JDBC Driver"></a>2. Installing the MySQL JDBC Driver</h4><p>If you already have the JDBC driver installed on the hosts that need it, you can skip this section. However, MySQL 5.6 requires a 5.1 driver version 5.1.26 or higher.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src</span><br><span class="line">wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.46.tar.gz</span><br><span class="line">tar zxvf mysql-connector-java-5.1.46.tar.gz</span><br><span class="line">mkdir -pv /usr/share/java</span><br><span class="line">cd mysql-connector-java-5.1.46</span><br><span class="line">sudo cp mysql-connector-java-5.1.46-bin.jar /usr/share/java/mysql-connector-java.jar</span><br></pre></td></tr></table></figure>

<h4 id="3-Creating-Databases-for-Cloudera-Software"><a href="#3-Creating-Databases-for-Cloudera-Software" class="headerlink" title="3. Creating Databases for Cloudera Software"></a>3. Creating Databases for Cloudera Software</h4><p>以下数据库名称仅供参考，只要匹配得上就行<br><img src="https://img.econow.cn/medivh/1550139934136.png" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br><span class="line">&gt; create database scm;</span><br><span class="line">&gt; grant all on *.* to &#x27;scm&#x27;@&#x27;%&#x27; identified by &#x27;scm&#x27; with grant option;</span><br><span class="line">&gt; create database hive_metastore;</span><br><span class="line">&gt; grant all on hive_metastore.* to &#x27;hive&#x27;@&#x27;%&#x27; identified by &#x27;hive&#x27; with grant option;</span><br><span class="line">&gt; flush privileges;</span><br></pre></td></tr></table></figure>

<h4 id="4-Set-up-the-Cloudera-Manager-Database"><a href="#4-Set-up-the-Cloudera-Manager-Database" class="headerlink" title="4. Set up the Cloudera Manager Database"></a>4. Set up the Cloudera Manager Database</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/cloudera/cm/schema/scm_prepare_database.sh  mysql cm -hlocalhost -uscm -pscm --scm-host localhost scm scm scm</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cloudera.com/documentation/enterprise/latest/topics/prepare_cm_database.html">详细参数参考</a></p>
<h3 id="五、安装-Cloudrea-Agent"><a href="#五、安装-Cloudrea-Agent" class="headerlink" title="五、安装 Cloudrea Agent"></a>五、安装 Cloudrea Agent</h3><h4 id="1-搜索主机"><a href="#1-搜索主机" class="headerlink" title="1.搜索主机"></a>1.搜索主机</h4><img src="https://img.econow.cn/medivh/1550039268472.png" />
注意搜索的时候主机名以逗号隔开，选择后点击继续。
#### 2.选择版本
选择使用Parcel安装，选择CDH版本,默认即可
<img src="https://img.econow.cn/medivh/1550039358949.png" />
然后选择是否安装JDK，如果已经安装了，这里就不需要勾选
<img src="https://img.econow.cn/medivh/1550039397866.png" />
#### 3.授权
默认使用root用户，提供公钥或者密码来授权连接
<img src="https://img.econow.cn/medivh/1550039466326.png" />
选择继续安装
<img src="https://img.econow.cn/medivh/1550039533173.png" />
如果安装过程中，下载安装jdk 或 cloudera-manager-agent失败，可以在节点上手动安装，然后再在Cloudrea  Manager上继续安装。此处的JDK只是为了启动CM，和以后要用的JDK不是一回事！

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install jdk</span><br><span class="line">yum -y install oracle-j2sdk1.7</span><br><span class="line">yum -y install cloudera-manager-agent</span><br></pre></td></tr></table></figure>

<h4 id="4-分配-Parcelf"><a href="#4-分配-Parcelf" class="headerlink" title="4.分配 Parcelƒ"></a>4.分配 Parcelƒ</h4><p>下载 Parcel 并分配 Parcel 到各节点</p>
<img src="https://img.econow.cn/medivh/1550039893581.png" />

<p>注意如果下载完后长时间不动，检查日志</p>
<p>分配完成后点击继续，进行主机检查<br><img src="https://img.econow.cn/medivh/1550050454788.png" /><br>标注的为有可能出现问题的地方。解决后，选择重新检查即可。如果验证部分通过，下面的版本部分出现不适用也可以忽略。</p>
<h3 id="六、添加-Services"><a href="#六、添加-Services" class="headerlink" title="六、添加 Services"></a>六、添加 Services</h3><h4 id="1-选择服务"><a href="#1-选择服务" class="headerlink" title="1.选择服务"></a>1.选择服务</h4><img src="https://img.econow.cn/medivh/1550140558695.png" />
此处会有add 的选项，点击

<p>根据个人需求选择安装服务类型，也可以 选择自定义<br><img src="https://img.econow.cn/medivh/1550197444765.png" /></p>
<blockquote>
<p>The Select Services page allows you to select the services you want to install and configure. Make sure that you have the appropriate license key for the services you want to use. You can choose from Cloudera Essentials, Data Engineering, Analytic Database, Operational Database, All Services, and Custom Services. To include Cloudera Navigator data management, check the box labeled Include Cloudera Navigator.</p>
</blockquote>
<p>服务选择页面允许你选择你想要的服务，然后选择继续。</p>
<blockquote>
<p>After selecting the services you want to add, click Continue. The Assign Roles page displays.</p>
</blockquote>
<h4 id="2-Assign-Roles-角色分配"><a href="#2-Assign-Roles-角色分配" class="headerlink" title="2.Assign Roles 角色分配"></a>2.Assign Roles 角色分配</h4><blockquote>
<p>The Assign Roles page suggests role assignments for the hosts in your cluster. You can click on the hostname for a role to select a different host. You can also click the View By Host button to see all the roles assigned to a host.<br>To review the recommended role assignments, see Recommended Cluster Hosts and Role Distribution.<br>After assigning all of the roles for your services, click Continue. The Setup Database page displays.</p>
</blockquote>
<p>简单说就是根据实际情况来分配对应角色。<br><img src="https://img.econow.cn/medivh/1550197498148.png" /></p>
<p><a target="_blank" rel="noopener" href="https://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_host_allocations.html#host_role_assignments">官网推荐分配策略参考</a><br>下面分别列出 3-10 和 3-20 台服务器的建议<br><img src="https://img.econow.cn/medivh/1550196758734.png" /></p>
<img src="https://img.econow.cn/medivh/1550196815297.png" />
下图为实际情况5个节点的分配
<img src="https://img.econow.cn/medivh/1550196894404.png" />
#### 3.Setup Database
>On the Setup Database page, you can enter the database names, usernames, and passwords you created in Step 4: Install and Configure Databases.
现在开始填写数据库信息，地址、账号和密码，就是之前准备环境的时候创建的库。
>Select the database type and enter the database name, username, and password for each service. Click Test Connection to validate the settings. If the connection is successful, a green checkmark and the word Successful appears next to each service. If there are any problems, the error is reported next to the service that failed to connect.

<blockquote>
<p>After verifying that each connection is successful, click Continue. The Review Changes page displays.</p>
</blockquote>
<img src="https://img.econow.cn/medivh/1550197550054.png" />
注意选择Mysql！填写完成后记得验证一下。下面的库就是之前创建好的
<img src="https://img.econow.cn/medivh/1550197181087.png" />
现在表是空的，之后就会创建以下的表
<img src="https://img.econow.cn/medivh/1550197226238.png" />
#### 4.启动服务
<img src="https://img.econow.cn/medivh/1550197594729.png" />
一般情况下除了hive以外，其他的服务都会正常启动。这个时候就要去修改以下hive配置。另外开一个页面，按照截图修改！
<img src="https://img.econow.cn/medivh/1550197756375.png" />
这样之前的hive元数据库就会自动创建表了。

<h2 id="集群验证"><a href="#集群验证" class="headerlink" title="集群验证"></a>集群验证</h2><h3 id="1-服务状态验证"><a href="#1-服务状态验证" class="headerlink" title="1.服务状态验证"></a>1.服务状态验证</h3><img src="https://img.econow.cn/medivh/1550197833064.png" />
这样所有的服务都绿了。
### 2.主机状态
<img src="https://img.econow.cn/medivh/1550198340635.png" />
状态正常，且心跳时间小于15秒
### 3.1任务测试一
登任意主机，执行下面任务（用Hadoop计算PI值，圆周率）
10指的是要运行10次map任务，10000指的是每个map任务，要投掷多少次，2个参数的乘积就是总的投掷次数。 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar /opt/cloudera/parcels/CDH/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar pi 10 10000</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1550198625749.png" />
然后在群集-》Cluster1-》Yarn-》应用程序查看执行结果
<img src="https://img.econow.cn/medivh/1550199361878.png" />

<p>执行结果：<br><img src="https://img.econow.cn/medivh/1550198647297.png" /></p>
<h4 id="3-2-任务测试二"><a href="#3-2-任务测试二" class="headerlink" title="3.2 任务测试二"></a>3.2 任务测试二</h4><p>1.编辑一段文本，示例如下；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aslkl hello</span><br><span class="line">hah</span><br><span class="line">hah</span><br><span class="line">hi</span><br><span class="line">en</span><br><span class="line">word</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<p>2.上传文件到 hdfs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -mkdir /test</span><br><span class="line">#如果提示没有权限，记得修改一下</span><br><span class="line">hadoop fs -chmod 777 -R /</span><br><span class="line">hadoop fs -put s.txt  /test</span><br><span class="line">#上传</span><br><span class="line">hadoop jar /opt/cloudera/parcels/CDH/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar wordcount /test/s.txt /out/</span><br><span class="line">#执行</span><br><span class="line">hadoop fs -text  /out/*</span><br><span class="line">#查看结果</span><br></pre></td></tr></table></figure>

<h4 id="4-1-MapReduce-测试"><a href="#4-1-MapReduce-测试" class="headerlink" title="4.1 MapReduce 测试"></a>4.1 MapReduce 测试</h4><p>创建表<br><img src="https://img.econow.cn/medivh/1550202246962.png" /><br>执行操作<br><img src="https://img.econow.cn/medivh/1550202281115.png" /><br>OK！</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="1-优化访问速度"><a href="#1-优化访问速度" class="headerlink" title="1.优化访问速度"></a>1.优化访问速度</h3><img src="https://img.econow.cn/medivh/1550199570686.png" />
### 2.部分命令
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service cloudera-scm-server stop </span><br><span class="line">service cloudera-scm-server-db stop</span><br><span class="line">#内置PostgreSQL</span><br><span class="line">service cloudera-scm-agent stop</span><br></pre></td></tr></table></figure>
### 3.邮件报警
#### 1.配置邮箱
点击 cloudera manager service 
<img src="https://img.econow.cn/medivh/1550394449078.png" />
点击配置，搜索alert，根据实际情况填写邮箱信息。注意区分25和465端口，并且保证邮箱地址正确。
<img src="https://img.econow.cn/medivh/1550394622296.png" />
页眉和页脚随意修改
<img src="https://img.econow.cn/medivh/1550394734754.png" />
修改完成后点击保存，然后重启！

<h4 id="2-测试邮件"><a href="#2-测试邮件" class="headerlink" title="2.测试邮件"></a>2.测试邮件</h4><img src="https://img.econow.cn/medivh/1550394787512.png" />
点击发送测试即可
<img src="https://img.econow.cn/medivh/1550394808019.png" />
这样就收到了测试邮件。
<img src="https://img.econow.cn/medivh/1550394890160.png" />
#### 3.可能出现的问题
* 日志报localhost和25端口 
<img src="https://img.econow.cn/medivh/1550395083684.png" />
原因是修改配置后没有重启cloudera manager service 
* QQ邮箱报535错误
<img src="https://img.econow.cn/medivh/1550394953596.png" />
检查用户名和授权码是否正确。注意QQ邮箱的是授权码不是纯粹的密码

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/request_time%E5%92%8Cupstream_response_time%E7%9A%84%E5%8C%BA%E5%88%AB.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/request_time%E5%92%8Cupstream_response_time%E7%9A%84%E5%8C%BA%E5%88%AB.html" class="post-title-link" itemprop="url">request_time和upstream_response_time的区别</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/request_time%E5%92%8Cupstream_response_time%E7%9A%84%E5%8C%BA%E5%88%AB.html" class="post-meta-item leancloud_visitors" data-flag-title="request_time和upstream_response_time的区别" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>一个正常的请求过程如下：</p>
<ol>
<li>用户发出请求</li>
<li>建立NGINX连接</li>
<li>发送响应</li>
<li>接收程序的响应数据</li>
<li>关闭NGINX连接</li>
</ol>
<p><strong>request_time</strong><br>request processing time in seconds with a milliseconds resolution; time elapsed between the first bytes were read from the client and the log write after the last bytes were sent to the client.</p>
<p>指的就是从接受用户请求的第一个字节到发送完响应数据的时间，即包括接收请求数据时间、程序响应时间、输出响应数据时间。<br>对于此部分对应的是1+2+3+4+5。</p>
<p><strong>upstream_response_time</strong><br>keeps times of responses obtained from upstream servers; times are kept in seconds with a milliseconds resolution. Several response times are separated by commas and colons like addresses in the $upstream_addr variable.<br>是指从Nginx向后端（php-cgi)建立连接开始到接受完数据然后关闭连接为止的时间。<br>对于此部分对应的是2+3+4+5。</p>
<p>从上面的描述可以看出，<code>$request_time</code>肯定大于等于<code>$upstream_response_time</code>，特别是使用POST方式传递参数时，因为Nginx会把<code>request body</code>缓存住，接受完毕后才会把数据一起发给后端。所以如果用户网络较差，或者传递数据较大时，<code>$request_time</code>会比<code>$upstream_response_time</code>大很多。</p>
<p>如果要从access_log中查看较慢的接口的话，可以在<code>log_format</code>中加入<code>$upstream_response_time</code>。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>从网上看到下列一组图片，感觉画的很形象。</p>
<ul>
<li><code>request_time</code>是从接收到客户端的第一个字节开始，到把所有的响应数据都发送完为止。<br><img src="https://img.econow.cn/medivh/1637907742862.png" alt="1637907742862.png"></li>
<li><code>upstream_response_time</code>是从与后端建立TCP连接开始到接收完响应数据并关闭连接为止。<br><img src="https://img.econow.cn/medivh/1637907762851.png" alt="1637907762851.png"></li>
</ul>
<p>所以，<code>request_time</code>会大于等于<code>upstream_response_time</code>。</p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p>对于较高的request—_time很可能是由于连接速度较慢的客户端造成的，对此无能为力，但是较高的request_time并不代表服务器或者程序的性能不够。总体来说，没必要在request_time上花费较多时间，而是应该重点关注upstream_response_time。</p>
<h3 id="nginx-log-format"><a href="#nginx-log-format" class="headerlink" title="nginx log_format"></a>nginx log_format</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_addr</span>,<span class="variable">$http_x_forwarded_for</span>  <span class="comment">#记录客户端IP地址</span></span><br><span class="line"><span class="variable">$remote_user</span>   <span class="comment">#记录客户端用户名称</span></span><br><span class="line"><span class="variable">$request</span>       <span class="comment">#记录请求的URL和HTTP协议</span></span><br><span class="line"><span class="variable">$status</span>        <span class="comment">#记录请求状态</span></span><br><span class="line"><span class="variable">$body_bytes_sent</span>  <span class="comment">#发送给客户端的字节数，不包括响应头的大小；该变量与Apache模块mod_log_config李的“%B”参数兼容</span></span><br><span class="line"><span class="variable">$bytes_sent</span>    <span class="comment">#发送给客户端的总字节数</span></span><br><span class="line"><span class="variable">$connection</span>    <span class="comment">#连接到序列号</span></span><br><span class="line"><span class="variable">$connection_requests</span> <span class="comment">#当前通过一个链接获得的请求数量</span></span><br><span class="line"><span class="variable">$msec</span>       <span class="comment">#日志写入时间，单位为秒精度是毫秒。</span></span><br><span class="line"><span class="variable">$pipe</span>       <span class="comment">#如果请求是通过HTTP流水线(pipelined)发送，pipe值为“p”,否则为&quot;.&quot;.</span></span><br><span class="line"><span class="variable">$http_referer</span>  <span class="comment">#记录从那个页面链接访问过来的</span></span><br><span class="line"><span class="variable">$http_user_agent</span>  <span class="comment">#记录客户端浏览器相关信息</span></span><br><span class="line"><span class="variable">$request_length</span>   <span class="comment">#请求的长度（包括请求行，请求头和请求正文）。</span></span><br><span class="line"><span class="variable">$request_time</span> <span class="comment">#请求处理时间，单位为秒，精度毫秒；从读入客户端的第一个字节开始，知道把最后一个字符发送给客户端后进行日志写入位置。</span></span><br><span class="line"><span class="variable">$time_iso8601</span> ISO8601标准格式下的本地时间</span><br><span class="line"><span class="variable">$time_local</span>  <span class="comment">#通用日志格式下的本地时间</span></span><br></pre></td></tr></table></figure>

<h2 id="NGINX的文件传输"><a href="#NGINX的文件传输" class="headerlink" title="NGINX的文件传输"></a>NGINX的文件传输</h2><h3 id="sendile"><a href="#sendile" class="headerlink" title="sendile"></a>sendile</h3><p>参数sendfile on 用于开启文件高效传输模式，同时配合tcp_nopush on 和tcp_nodelay on 两个指令，可防止网络及磁盘I&#x2F;O阻塞，提升Nginx工作效率。但需要注意的是，linux内核版本2.5.9以后的版本中两者是可以兼容的。</p>
<p>三个指令都开启的好处是，sendfile可以开启高效的文件传输模式，tcp_nopush开启可以确保在发送到客户端之前数据包已经充分“填满”， 这大大减少了网络开销，并加快了文件发送的速度。 然后，当它到达最后一个可能因为没有“填满”而暂停的数据包时，Nginx会忽略tcp_nopush参数， 然后，tcp_nodelay强制套接字发送数据。</p>
<p><img src="https://img.econow.cn/medivh/1637918539854.png" alt="1637918539854.png"></p>
<h3 id="tcp-nopush"><a href="#tcp-nopush" class="headerlink" title="tcp_nopush"></a>tcp_nopush</h3><p>当有数据时，先别着急发送, 确保数据包已经装满数据, 避免了网络拥塞。需要我们等到数据量达到最大时才通过网络一次发送全部数据，这种数据传输方式有益于大量数据的通信性能，典型的应用就是文件服务器。<br>对于nginx配置文件中的tcp_nopush，默认就是tcp_nopush,不需要特别指定，这个选项对于www，ftp等大文件很有帮助。</p>
<h3 id="tcp-nodelay"><a href="#tcp-nodelay" class="headerlink" title="tcp_nodelay"></a>tcp_nodelay</h3><p>有时要抓紧发货, 确保数据尽快发送, 提高可数据传输效率。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>平时对request_time和upstream_response_time这两个参数没什么研究，关注的不多，主要关注request_time。但是最近阿里云的日志服务统计数据出现了异常，request_time和upstream_response_time的值完全违反了字段定义的原则。理论上request_time无论如何也会大于upstream_response_time的，但是客服死活不承认。无奈之下，好好研究一番，通过阿里云官网文档截图和历史正常数据已经现在的异常数据，客服最终承认存在问题，表示整改。<br>事实证明，阿里云的客服技术水平也是良莠不齐。</p>
<p>经过此次事件，也遇到了一些Markdown语法的问题，不过幸运的是vs code提供了很多帮助，能直接定位到问题，而对应的问题都有参考方案。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_log_module.html">ngx_http_log_module</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/DavidAnson/markdownlint/blob/v0.24.0/doc/Rules.md">https://github.com/DavidAnson/markdownlint/blob/v0.24.0/doc/Rules.md</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/matplotlib%20%E5%AD%A6%E4%B9%A0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/matplotlib%20%E5%AD%A6%E4%B9%A0.html" class="post-title-link" itemprop="url">matplotlib 学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
    <span id="/matplotlib%20%E5%AD%A6%E4%B9%A0.html" class="post-meta-item leancloud_visitors" data-flag-title="matplotlib 学习" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="matplotlib-有乱码"><a href="#matplotlib-有乱码" class="headerlink" title="matplotlib 有乱码"></a>matplotlib 有乱码</h3><p>1、下载中文字体（黑体，看准系统版本）<br>2、找到matplotlib字体文件夹，例如：matplotlib&#x2F;mpl-data&#x2F;fonts&#x2F;ttf，将SimHei.ttf拷贝到ttf文件夹下面<br>3、修改matplotlib配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/lib/python3.5/dist-packages/matplotlib/mpl-data/matplotlibrc</span><br><span class="line"># 删除font.family和font.sans-serif两行前的#，并在font.sans-serif后添加中文字体Microsoft YaHei, ...(其余不变)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4、下面代码检查可使用的字体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from matplotlib.font_manager import FontManager</span><br><span class="line">import subprocess</span><br><span class="line"></span><br><span class="line">fm = FontManager()</span><br><span class="line">mat_fonts = set(f.name for f in fm.ttflist)</span><br><span class="line">#print(mat_fonts)</span><br><span class="line">output = subprocess.check_output(&#x27;fc-list :lang=zh -f &quot;%&#123;family&#125;\n&quot;&#x27;, shell=True)</span><br><span class="line">#print( &#x27;*&#x27; * 10, &#x27;系统可用的中文字体&#x27;, &#x27;*&#x27; * 10)</span><br><span class="line">#print (output)</span><br><span class="line">zh_fonts = set(f.split(&#x27;,&#x27;, 1)[0] for f in output.decode(&#x27;utf-8&#x27;).split(&#x27;\n&#x27;))</span><br><span class="line">available = mat_fonts &amp; zh_fonts</span><br><span class="line">print (&#x27;*&#x27; * 10, &#x27;可用的字体&#x27;, &#x27;*&#x27; * 10)</span><br><span class="line">for f in available:</span><br><span class="line">     print (f)</span><br></pre></td></tr></table></figure>

<img src="https://img.econow.cn/medivh/1555251933809.png"  />


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import matplotlib</span><br><span class="line">from matplotlib.font_manager import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plt.rcParams[&#x27;font.sans-serif&#x27;]=[&#x27;Arial Unicode MS&#x27;]</span><br><span class="line">plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False #解决保存图像是负号&#x27;-&#x27;显示为方块的问题</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">price = [39.5, 39.9, 45.4, 38.9, 33.34]</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">绘制水平条形图方法barh</span><br><span class="line">参数一：y轴</span><br><span class="line">参数二：x轴</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">plt.barh(range(5), price, height=0.7, color=&#x27;steelblue&#x27;, alpha=0.8)      # 从下往上画</span><br><span class="line">plt.yticks(range(5), [&#x27;tom&#x27;, &#x27;当当网&#x27;, &#x27;中国图书网&#x27;, &#x27;京东&#x27;, &#x27;天猫&#x27;])</span><br><span class="line">plt.xlim(30,47)</span><br><span class="line">plt.xlabel(&quot;价格&quot;)</span><br><span class="line">plt.title(&quot;不同平台图书价格&quot;)</span><br><span class="line">for x, y in enumerate(price):</span><br><span class="line">    plt.text(y + 0.2, x - 0.1, &#x27;%s&#x27; % y)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者直接指定字体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import matplotlib</span><br><span class="line">from matplotlib.font_manager import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">myfont = FontProperties(fname=&#x27;/System/Library/Fonts/PingFang.ttc&#x27;)</span><br><span class="line">matplotlib.rcParams[&#x27;axes.unicode_minus&#x27;]=False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">price = [39.5, 39.9, 45.4, 38.9, 33.34]</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">绘制水平条形图方法barh</span><br><span class="line">参数一：y轴</span><br><span class="line">参数二：x轴</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">plt.barh(range(5), price, height=0.7, color=&#x27;steelblue&#x27;, alpha=0.8)      # 从下往上画</span><br><span class="line">plt.yticks(range(5), [&#x27;tom&#x27;, &#x27;当当网&#x27;, &#x27;中国图书网&#x27;, &#x27;京东&#x27;, &#x27;天猫&#x27;],fontproperties=myfont)</span><br><span class="line">plt.xlim(30,47)</span><br><span class="line">plt.xlabel(&quot;价格&quot;,fontproperties=myfont)</span><br><span class="line">plt.title(&quot;不同平台图书价格&quot;,fontproperties=myfont)</span><br><span class="line">for x, y in enumerate(price):</span><br><span class="line">    plt.text(y + 0.2, x - 0.1, &#x27;%s&#x27; % y)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"g1GwilqmVAUne2tDEDncEChG-gzGzoHsz","app_key":"YB2e5dSKMmMYYCtaSzxp9fdS","server_url":null,"security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
