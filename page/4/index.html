<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/page/4/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8ENginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8ENginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E5%BA%94%E7%94%A8.html" class="post-title-link" itemprop="url">关于Ngin正向代理和反向代理的应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h3><p>代理（Proxy）也称网络代理，是一种特殊的网络服务，允许一个（一般为客户端）通过这个服务与另一个网络终端（一般为服务器）进行非直接的连接。一些网关、路由器等网络设备具备网络代理功能。一般认为代理服务有利于保障网络终端的隐私或安全，防止攻击。代理也可以称为正向代理。<br>所谓代理服务器就是位于发起请求的客户端与原始服务器端之间的一台跳板服务器，正向代理可以隐藏客户端，反向代理可以隐藏原始服务器。<br>提供代理服务的电脑系统或其它类型的网络终端称为代理服务器（英文：Proxy Server）。一个完整的代理请求过程为：客户端首先与代理服务器创建连接，接着根据代理服务器所使用的代理协议，请求对目标服务器创建连接、或者获得目标服务器的指定资源（如：文件）。在后一种情况中，代理服务器可能对目标服务器的资源下载至本地缓存，如果客户端所要获取的资源在代理服务器的缓存之中，则代理服务器并不会向目标服务器发送请求，而是直接传回已缓存的资源。一些代理协议允许代理服务器改变客户端的原始请求、目标服务器的原始响应，以满足代理协议的需要。代理服务器的选项和设置在计算机程序中，通常包括一个“防火墙”，允许用户输入代理地址，它会遮盖他们的网络活动，可以允许绕过互联网过滤实现网络访问。</p>
<img src="https://img.mknight.cn/medivh/1630550846470.png"  />

<p>代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。代理不改变请求URI，并不会直接发送给前方持有资源的目标服务器。<br>持有资源实体的服务器被称为源服务器。从源服务器返回的响应经过代理服务器后再传给客户端。</p>
<img src="https://img.mknight.cn/medivh/1630550861682.png"  />

<h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><h4 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h4><ul>
<li>HTTP</li>
<li>HTTPS</li>
</ul>
<h4 id="Socks"><a href="#Socks" class="headerlink" title="Socks"></a>Socks</h4><ul>
<li>Socks4&#x2F;5</li>
</ul>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ol>
<li>提高访问速度：通常代理服务器都设置一个较大的缓冲区，当有外界的信息通过时，同时也将其保存到缓冲区中，当其他用户再访问相同的信息时， 则直接由缓冲区中取出信息，传给用户，以提高访问速度。</li>
<li>控制对内部资源的访问：如某大学FTP（前提是该代理地址在该资源的允许访问范围之内），使用教育网内地址段免费代理服务器，就可以用于对教育网开放的各类FTP下载上传，以及各类资料查询共享等服务。</li>
<li>过滤内容：例如限制对特定计算机的访问，将一种语言的数据翻译成另一种语言，或是防御代理服务器两边的攻击性访问。</li>
<li>隐藏真实IP：上网者也可以通过代理服务器隐藏自己的IP，免受攻击。但是只一个代理很难保证安全，更安全的方法是利用特定的工具创建代理链（如：Tor）。</li>
<li>突破自身IP访问限制：访问国外站点。</li>
<li>突破内容过滤机制限制，访问被过滤网站。</li>
</ol>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>在生产活动中比较常见的使用方式：</p>
<ul>
<li>使用代理IP抓取社保网站的信息；</li>
<li>打通内网和云环境的部分接口；</li>
<li>代理MongoDB给QMS。<br>主要用的的软件是Nginx，可以代理若干协议：</li>
</ul>
<img src="https://img.mknight.cn/medivh/1630550965945.png"  />

<p>需要注意的是Nginx默认支持http代理，但是如果使用https代理需要增加模块：ngx_http_proxy_connect_module<br>需要注意的是安装patch命令，服务器默认是没有这个命令的。<br>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://nginx.org/download/nginx-1.9.2.tar.gz</span><br><span class="line">$ tar -xzvf nginx-1.9.2.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> nginx-1.9.2/</span><br><span class="line">$ patch -p1 &lt; /path/to/ngx_http_proxy_connect_module/patch/proxy_connect.patch</span><br><span class="line">$ ./configure \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--prefix=/usr/local/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--add-module=/root/ngx_http_proxy_connect_module</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>对于已经安装了nginx的可以使用以下方式（未实际验证过）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止NGINX服务</span></span><br><span class="line"><span class="comment"># systemctl stop nginx</span></span><br><span class="line"><span class="comment"># 备份原执行文件</span></span><br><span class="line"><span class="comment"># cp /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</span></span><br><span class="line"><span class="comment"># 在源代码路径重新编译</span></span><br><span class="line"><span class="comment"># cd /usr/local/src/nginx-1.16.0</span></span><br><span class="line">./configure \</span><br><span class="line">--user=www \</span><br><span class="line">--group=www \</span><br><span class="line">--prefix=/usr/local/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--add-module=/root/src/ngx_http_proxy_connect_module</span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># 不要make install</span></span><br><span class="line"><span class="comment"># 将新生成的可执行文件拷贝覆盖原来的nginx执行文件</span></span><br><span class="line"><span class="comment"># cp objs/nginx /usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="comment"># /usr/bin/nginx -V</span></span><br><span class="line">nginx version: nginx/1.16.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC)</span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --user=www --group=www --prefix=/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-threads --add-module=/root/src/ngx_http_proxy_connect_module</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen                         3128;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># dns resolver used by forward proxying</span></span><br><span class="line">    resolver                       8.8.8.8;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward proxy for CONNECT request</span></span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 563;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward proxy for non-CONNECT request</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://<span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意事项：</p>
<ul>
<li>resolver 必须配置，建议和服务器一致</li>
</ul>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>反向代理在电脑网络中是代理服务器的一种。服务器根据客户端的请求，从其关系的一组或多组后端服务器（如Web服务器）上获取资源，然后再将这些资源返回给客户端，客户端只会得知反向代理的IP地址，而不知道在代理服务器后面的服务器集群的存在[1]。<br>与正向代理不同，正向代理作为客户端的代理，将从互联网上获取的资源返回给一个或多个的客户端，服务端（如Web服务器）只知道代理的IP地址而不知道客户端的IP地址；而反向代理是作为服务器端（如Web服务器）的代理使用，而不是客户端。客户端借由前向代理可以间接访问很多不同互联网服务器（集群）的资源，而反向代理是供很多客户端都通过它间接访问不同后端服务器上的资源，而不需要知道这些后端服务器的存在，而以为所有资源都来自于这个反向代理服务器。</p>
<img src="https://img.mknight.cn/medivh/1630551013440.png"  />

<p>反向代理在现时的互联网中并不少见，而另一些例子，像是CDN、SNI代理等，是反向代理结合DNS的一类延伸应用。<br><img src="https://img.mknight.cn/medivh/1630551027126.png"  /></p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ul>
<li>对客户端隐藏服务器（集群）的IP地址</li>
<li>安全：作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS&#x2F;DDoS）的防护，更容易排查恶意软件等</li>
<li>为后端服务器（集群）统一提供加密和SSL加速（如SSL终端代理）</li>
<li>负载均衡，若服务器集群中有负荷较高者，反向代理通过URL重写，根据连线请求从负荷较低者获取与所需相同的资源或备援</li>
<li>对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务</li>
<li>对一些内容进行压缩，以节约带宽或为网络带宽不佳的网络提供服务</li>
<li>减速上传</li>
<li>为在私有网络下（如局域网）的服务器集群提供NAT穿透及外网发布服务</li>
<li>提供HTTP访问认证[2]</li>
<li>突破互联网封锁<br>该部分较为常见，不再叙述。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>代理服务器</li>
<li><a target="_blank" rel="noopener" href="https://www.kancloud.cn/lizhenjie1992/nginxx/2043708">https://www.kancloud.cn/lizhenjie1992/nginxx/2043708</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Docker%E6%A0%87%E5%87%86%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Docker%E6%A0%87%E5%87%86%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C.html" class="post-title-link" itemprop="url">Docker标准镜像制作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<ul>
<li>由于hub.docker.com上提供的官方镜像为open-jdk，因此和程序运行时多少会有点小问题；</li>
<li>之前使用基于alpine的基础镜像来制作应用镜像时会遇到一些小麻烦，主要是因为和linux 多有不同，并且不能直接运行Oracle jdk；<br>综上所述，因此决定使用基于CentOS来构建镜像。</li>
</ul>
</blockquote>
<h3 id="初始化镜像"><a href="#初始化镜像" class="headerlink" title="初始化镜像"></a>初始化镜像</h3><h4 id="拉取基础镜像"><a href="#拉取基础镜像" class="headerlink" title="拉取基础镜像"></a>拉取基础镜像</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull centos</span><br></pre></td></tr></table></figure>
<h4 id="自定义jdk版本"><a href="#自定义jdk版本" class="headerlink" title="自定义jdk版本"></a>自定义jdk版本</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#解压</span><br><span class="line">tar xvcf jre-8u191-linux-x64.tar.gz</span><br><span class="line">#进入目录</span><br><span class="line">cd jre1.8.0_161/</span><br><span class="line">#删除文本文件</span><br><span class="line">rm -rf COPYRIGHT LICENSE README release THIRDPARTYLICENSEREADME-JAVAFX.txtTHIRDPARTYLICENSEREADME.txt Welcome.html</span><br><span class="line">#删除其他无用文件</span><br><span class="line">rm -rf     lib/plugin.jar \</span><br><span class="line">        lib/ext/jfxrt.jar \</span><br><span class="line">        bin/javaws \</span><br><span class="line">        lib/javaws.jar \</span><br><span class="line">        lib/desktop \</span><br><span class="line">        plugin \</span><br><span class="line">        lib/deploy* \</span><br><span class="line">        lib/*javafx* \</span><br><span class="line">        lib/*jfx* \</span><br><span class="line">        lib/amd64/libdecora_sse.so \</span><br><span class="line">        lib/amd64/libprism_*.so \</span><br><span class="line">        lib/amd64/libfxplugins.so \</span><br><span class="line">        lib/amd64/libglass.so \</span><br><span class="line">        lib/amd64/libgstreamer-lite.so \</span><br><span class="line">        lib/amd64/libjavafx*.so \</span><br><span class="line">        lib/amd64/libjfx*.so</span><br></pre></td></tr></table></figure>
<p>最后再重新打包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zcvf jre-8u191-linux-x64.tar.gz jre1.8.0_191/</span><br></pre></td></tr></table></figure>

<h4 id="构建JDK"><a href="#构建JDK" class="headerlink" title="构建JDK"></a>构建JDK</h4><ul>
<li>编写Dockerfile<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; Dockerfile</span><br><span class="line"></span><br><span class="line">FROM centos:latest</span><br><span class="line">MAINTAINER by medivh</span><br><span class="line">RUN rm -f /etc/localtime  &amp;&amp; ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; mkdir  /usr/local/java &amp;&amp; useradd joy</span><br><span class="line">#相对路径jar,把java添加到容器中</span><br><span class="line">ADD jre-8u191-linux-x64.tar.gz /usr/local/java/</span><br><span class="line"></span><br><span class="line">#配置java环境变量</span><br><span class="line">ENV JAVA_HOME /usr/local/java/jdk1.8.0_91</span><br><span class="line">ENV JRE_HOME $JAVA_HOME/jre</span><br><span class="line">ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH</span><br><span class="line">ENV PATH $JAVA_HOME/bin:$PATH</span><br><span class="line"></span><br><span class="line">USER joy</span><br><span class="line">RUN mkdir /home/joy/logs &amp;&amp; mkdir /home/joy/src</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li>
<li>构建镜像<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t 192.168.1.232:5000/base/jdk:1.8.0_91_v.0.5 .</span><br></pre></td></tr></table></figure>
因为镜像需要推送到仓库，因此在构建镜像的时候直接打标签了。</li>
</ul>
<h3 id="构建服务镜像"><a href="#构建服务镜像" class="headerlink" title="构建服务镜像"></a>构建服务镜像</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Version: 0.0.1</span><br><span class="line">FROM 192.168.1.232:5000/base/jdk:1.8.0_91_v.0.5</span><br><span class="line">ENV LC_ALL en_US.UTF-8</span><br><span class="line">WORKDIR    /home/joy/src</span><br><span class="line">ADD xxxxx-SNAPSHOT.war /home/joy/src</span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;xxxxx.jar&quot;,&quot;--server.port=8080&quot;,&quot;--Djava.security.egd=file:/dev/./urandom&quot;]</span><br></pre></td></tr></table></figure>



<h4 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h4><ul>
<li>from 基于之前构建好的jdk镜像</li>
<li>修改时区</li>
<li>workdir 设定工作目录，类似于cd命令</li>
<li>ADD 添加war包或者jar包</li>
<li>EXPOSE 暴露端口，默认设置为8080</li>
<li>ENTRYPOINT 程序启动相关参数</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Elastalert%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Elastalert%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8.html" class="post-title-link" itemprop="url">Elastalert安装及使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="报警方式"><a href="#报警方式" class="headerlink" title="报警方式"></a>报警方式</h3><ul>
<li>Email</li>
<li>JIRA</li>
<li>OpsGenie</li>
<li>Commands</li>
<li>HipChat</li>
<li>MS Teams</li>
<li>Slack</li>
<li>Telegram</li>
<li>AWS SNS</li>
<li>VictorOps</li>
<li>PagerDuty</li>
<li>Exotel</li>
<li>Twilio</li>
<li>Gitter</li>
</ul>
<h3 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h3><ul>
<li>Elasticsearch</li>
<li>Python 2.7</li>
<li>pip</li>
<li>python-pip python-dev libffi-dev libssl-dev</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><ul>
<li>pip<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install elastalert</span><br></pre></td></tr></table></figure></li>
<li>github<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Yelp/elastalert.git</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install &quot;setuptools&gt;=11.3&quot;</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<h3 id="elasticsearch-py"><a href="#elasticsearch-py" class="headerlink" title="elasticsearch-py"></a>elasticsearch-py</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Elasticsearch 5.0+:</span><br><span class="line">pip install &quot;elasticsearch&gt;=5.0.0&quot;</span><br><span class="line"></span><br><span class="line">#Elasticsearch 2.X:</span><br><span class="line">pip install &quot;elasticsearch&lt;3.0.0&quot;</span><br></pre></td></tr></table></figure>
<h3 id="可能出现的问题"><a href="#可能出现的问题" class="headerlink" title="可能出现的问题"></a>可能出现的问题</h3><p>提示<code>Could not find suitable distribution for Requirement.parse(&#39;thehive4py&gt;=1.4.</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install thehive4py</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%EF%BC%88%E4%B8%80%EF%BC%89.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3StatefulSet%EF%BC%88%E4%B8%80%EF%BC%89.html" class="post-title-link" itemprop="url">深入理解StatefulSet（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>首先聊一下Deployment，一个应用的所有Pod是完全一样的。它们相互之间没有顺序，也无所谓运行在哪台宿主机上，需要的时候就创建，不需要的时候就可以中止任意一个Pod。</p>
<p>有些分布式应用，在多个实例之间存有依赖关系，比如主从、主备关系。还有些数据库存储类应用，在本地磁盘会存放一些数据，而实例一旦被杀掉，即使重建出来，实例和数据之间的对应关系都已经丢失。</p>
<p>所以实例之间有不对等关系，以及实例对外部数据有依赖关系的应用，被称为有状态应用（Stateful Appication）。</p>
<h3 id="Statefulset"><a href="#Statefulset" class="headerlink" title="Statefulset"></a>Statefulset</h3><p>StatefulSet 将应用状态抽象为两种情况：</p>
<ol>
<li>拓扑状态。意味着应用之间的多个实例之间不是对等关系。这些应用必须按照某些顺序启动，并且新创建的Pod，必须和原来的网络标识一样，这样原来的访问者才能使用同样的方法，访问到这个新的Pod。</li>
<li>存储状态。这种情况意味着，应用的多个实例分别绑定了不同的存储数据。典型例子就是一个数据库应用的多个存储实例。</li>
</ol>
<p>StatefulSet 的核心功能就是通过某种方式记录这些状态，然后在Pod被重新创建时，能够为新Pod恢复这些状态。</p>
<p>StatefulSet中每个Pod的DNS格式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">statefulSetName-&#123;0..N-1&#125;.serviceName.namespace.svc.cluster.local</span><br></pre></td></tr></table></figure>

<ul>
<li>serviceName 为Headless Service name</li>
<li>0…N-1 为Pod的序号，从0开始</li>
<li>statefulSetName 为StatefulSet name</li>
<li>namespace 为服务所在的namespace</li>
<li>cluster.local为Cluster Domain</li>
</ul>
<p>图解</p>
<p><img src="https://img.mknight.cn/medivh/1649399502095.png" alt="1649399502095.png"></p>
<h4 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h4><p><img src="https://img.mknight.cn/medivh/1649399564902.png" alt="1649399564902.png"></p>
<h4 id="收缩"><a href="#收缩" class="headerlink" title="收缩"></a>收缩</h4><p><img src="https://img.mknight.cn/medivh/1649399581462.png" alt="1649399581462.png"></p>
<h4 id="持久卷的创建和删除"><a href="#持久卷的创建和删除" class="headerlink" title="持久卷的创建和删除"></a>持久卷的创建和删除</h4><p><img src="https://img.mknight.cn/medivh/1649399652857.png" alt="1649399652857.png"></p>
<ol>
<li>增加副本时，会创建对应的pvc；</li>
<li>减少副本时，从高索引值的Pod名开始删除Pod，但是PVC不会被删除，需要手动释放；</li>
<li>当先收缩再扩容时，重建后的Pod实例会绑定到对应序号的PVC上。</li>
</ol>
<h3 id="Headless-Service"><a href="#Headless-Service" class="headerlink" title="Headless Service"></a>Headless Service</h3><p>首先聊一下Service是如何被访问的呢？</p>
<ol>
<li>以service的VIP模式。比如访问10.0.23.1 这个service的IP地址时，10.0.23.1就是一个VIP，会把请求转发到该service所代理的某一个Pod上。</li>
<li>以service的DNS方式。比如访问“my-svc.my-namspace.svc.cluster.local”这条DNS记录，就可以访问到名为my-svc的service所搭理的某一个Pod。</li>
</ol>
<p>针对于第二种方式，具体还可以分为两种处理方法：</p>
<ol>
<li>Normal Service。访问“my-svc.my-namspace.svc.cluster.local” 解析到的，正是my-svc这个service的VIP，后面的流程和VIP的方式一致</li>
<li>Headless Service。访问“my-svc.my-namspace.svc.cluster.local”解析到的，直接就是my-svc代理的某一个Pod的IP地址。这里的区别在于<strong>Headless Service 不需要分配一个VIP，而是直接以DNS记录的方式解析出被代理POD的IP地址。</strong></li>
</ol>
<p>比如<code>eureka-0.register-server.test.svc.cluster.local</code>。</p>
<p>标签规则：</p>
<ol>
<li>spec.containers.name 容器的名字，如何配置基本无影响</li>
<li>template.metadata.labels 设定的label，注意和selector保持一致。并且该标签需要和headless 中的selector，以及nodePort中的selector保持一致。</li>
</ol>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>创建一个service</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    name: web</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br></pre></td></tr></table></figure>

<p>再创建一个StatefulSet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.14.2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: web</span><br></pre></td></tr></table></figure>

<h4 id="部署eureka集群"><a href="#部署eureka集群" class="headerlink" title="部署eureka集群"></a>部署eureka集群</h4><p>eureka集群部署的主要难点在于如何指定 <code>eureka.client.service-url.defaultZone</code>的值？</p>
<p>对于上述问题可以通过headless机制，不给cluster分配IP，而是通过域名访问服务来解决。在application.yaml文件中使用环境变量，传值给eueka。</p>
<blockquote>
<p>每个eureka会注册到另外的eureka上，也就是eureka.client.serviceUrl.dafaultZone；<br>通过StatefulSet，可以知道每个eureka的name；<br>通过Headless，可以访问到每个eureka；<br>所以eureka.client.serviceUrl.defaultZone的值就是<code>http://eureka-0.eureka:8000/eureka/,http://eureka-1.eureka:8000/eureka/,http://eureka-2.eureka:8000/eureka/</code></p>
</blockquote>
<p>由于三个pod在同一个命名空间内，因此可以省略.namespace.svc.cluster.local。</p>
<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><p>application.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name:  DiscoveryServer</span><br><span class="line">info:</span><br><span class="line">  version: <span class="variable">$project</span>.version$</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8761</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: <span class="variable">$&#123;POD_HOST_NAME&#125;</span>  <span class="comment">#设置eureka hostname</span></span><br><span class="line">    prefer-ip-address: <span class="literal">false</span> <span class="comment"># 使用服务名注册到eureka server</span></span><br><span class="line">  client:</span><br><span class="line">    register-with-eureka: <span class="literal">true</span>  <span class="comment">#表示是否将自己注册在EurekaServer上，默认为true</span></span><br><span class="line">    fetch-registry: <span class="literal">true</span>  <span class="comment">#表示表示是否从EurekaServer获取注册信息，默认为true</span></span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: <span class="variable">$&#123;EUREKA_INSTANCE_LIST&#125;</span> <span class="comment">#这里在部署的时候会使用环境变量替换</span></span><br><span class="line">joy:</span><br><span class="line">    logback:</span><br><span class="line">      path: logs/EUREKA_INSTANCE_HOSTNAME</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是hostname要使用pod的主机名，否则会出现unavailable-replicas。此外还有其他可能：</p>
<ol>
<li>eureka.instance.preferIpAddress &#x3D; false</li>
<li>defaultZone 后面的eureka注册中心的地址要写成域名；</li>
<li>eureka.client.register-with-eureka的值要写为true</li>
<li>eureka.client.fetch-registry的值要写为true</li>
<li>eureka集群中多个eureka服务的spring.application.name的值要一致</li>
<li>eureka.instance.prefer-ip-address的值必须设置为false</li>
</ol>
<p>service.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">  labels:</span><br><span class="line">    service: eureka</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: None</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8761</span><br><span class="line">      targetPort: 8761</span><br><span class="line">      name: eureka</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka</span><br></pre></td></tr></table></figure>

<p>StatefulSet.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">&quot;eureka&quot;</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: eureka-pod</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: eureka-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">env</span>:</span><br><span class="line">        name: eureka</span><br><span class="line">        image: 192.168.1.232:5000/k8s/eureka:statefull</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">          - name: APP_NAME</span><br><span class="line">            value: <span class="string">&quot;eureka&quot;</span> <span class="comment"># statefulSet name</span></span><br><span class="line">          - name: POD_NAME</span><br><span class="line">            valueFrom:</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.name</span><br><span class="line">          - name: POD_HOST_NAME</span><br><span class="line">            value: <span class="string">&quot;<span class="subst">$(POD_NAME)</span>.<span class="subst">$(APP_NAME)</span>.default.svc.cluster.local&quot;</span></span><br><span class="line">          - name: EUREKA_INSTANCE_LIST</span><br><span class="line">            value: <span class="string">&quot;http://eureka-0.<span class="subst">$(APP_NAME)</span>.default.svc.cluster.local:8761/eureka/,http://eureka-1.<span class="subst">$(APP_NAME)</span>.default.svc.cluster.local:8761/eureka/,http://eureka-2.<span class="subst">$(APP_NAME)</span>.default.svc.cluster.local:8761/eureka/&quot;</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8761</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 10</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8761</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 60</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 2</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 1</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8761</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">          periodSeconds: 3</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 2</span><br></pre></td></tr></table></figure>

<p>传递三个变量：</p>
<ol>
<li>APP_NAME 取值于metadata.name</li>
<li>POD_NAME 取值于metadata.name</li>
<li>POD_HOST_NAME 拼接单个Pod的主机名</li>
<li>EUREKA_INSTANCE_LIST 由Pod的域名拼接组成</li>
</ol>
<p>创建完成后会出现三个带序号的Pod和statfulSet，这个时候请求<code>eureka.default.svc.cluster.local</code>就可以使用服务了。但是如果想在集群外访问，可以使用nodeport的方式暴露。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: eureka-node-port</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 31331</span><br><span class="line">    targetPort: 8761</span><br><span class="line">    nodePort: 31331</span><br><span class="line">  selector:</span><br><span class="line">    app: eureka-pod</span><br></pre></td></tr></table></figure>

<p><img src="https://img.mknight.cn/medivh/1649398888400.png" alt="1649398888400.png"></p>
<h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><h3 id="headless-service和普通service的区别"><a href="#headless-service和普通service的区别" class="headerlink" title="headless service和普通service的区别"></a>headless service和普通service的区别</h3><ul>
<li>headless 不分配clusterIP，配置<code>clusterIP: None</code></li>
<li>headless service可以通过解析service的DNS，返回所有Pod的地址和DNS</li>
<li>普通service，只能通过解析service的DNS返回service的CLusterIP</li>
</ul>
<h3 id="statefulSet和Deployment的区别"><a href="#statefulSet和Deployment的区别" class="headerlink" title="statefulSet和Deployment的区别"></a>statefulSet和Deployment的区别</h3><ul>
<li>statefulSet 的Pod有DNS地址，通过解析Pod的DNS可以返回Pod的IP</li>
<li>Deployment下的Pod没有DNS</li>
</ul>
<h3 id="普通service解析"><a href="#普通service解析" class="headerlink" title="普通service解析"></a>普通service解析</h3><p>Service的ClusterIP原理：<br>一个service可以对应一组endpoints，client访问ClusterIP，通过iptables或ipvs转发到real server。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取svc,clusterIP为10.105.146.146</span></span><br><span class="line">[root@uat-master ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)           AGE</span><br><span class="line">eureka-node-port   NodePort    10.105.146.146   &lt;none&gt;        31331:31331/TCP   8m7s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看svc详情</span></span><br><span class="line">[root@uat-master ~]<span class="comment"># kubectl describe svc eureka-node-port</span></span><br><span class="line">Name:                     eureka-node-port</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   &lt;none&gt;</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 app=eureka</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP Families:              &lt;none&gt;</span><br><span class="line">IP:                       10.105.146.146</span><br><span class="line">IPs:                      10.105.146.146</span><br><span class="line">Port:                     &lt;<span class="built_in">unset</span>&gt;  31331/TCP</span><br><span class="line">TargetPort:               8761/TCP</span><br><span class="line">NodePort:                 &lt;<span class="built_in">unset</span>&gt;  31331/TCP</span><br><span class="line">Endpoints:                10.200.128.133:8761,10.200.128.134:8761,10.200.128.137:8761</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试解析</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup eureka-node-port.default.svc.cluster.local</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      eureka-node-port.default.svc.cluster.local</span><br><span class="line">Address 1: 10.105.146.146 eureka-node-port.default.svc.cluster.local</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>综上所述，DNS查询时只会返回service的clusterIP，具体client访问的是哪个real server，由iptabels或者ipvs决定。</p>
<h3 id="headless-service解析"><a href="#headless-service解析" class="headerlink" title="headless service解析"></a>headless service解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取svc</span></span><br><span class="line">[root@uat-master ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)           AGE</span><br><span class="line">eureka             ClusterIP   None             &lt;none&gt;        8761/TCP          27m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详情</span></span><br><span class="line">[root@uat-master ~]<span class="comment"># kubectl describe svc eureka</span></span><br><span class="line">Name:              eureka</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            service=eureka</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app=eureka</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Families:       &lt;none&gt;</span><br><span class="line">IP:                None</span><br><span class="line">IPs:               None</span><br><span class="line">Port:              eureka  8761/TCP</span><br><span class="line">TargetPort:        8761/TCP</span><br><span class="line">Endpoints:         10.200.128.133:8761,10.200.128.134:8761,10.200.128.137:8761</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试解析</span></span><br><span class="line">/ <span class="comment"># nslookup eureka.default.svc.cluster.local</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      eureka.default.svc.cluster.local</span><br><span class="line">Address 1: 10.200.128.134 eureka-1.eureka.default.svc.cluster.local</span><br><span class="line">Address 2: 10.200.128.133 eureka-0.eureka.default.svc.cluster.local</span><br><span class="line">Address 3: 10.200.128.137 eureka-2.eureka.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析单独pod的DNS记录</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup eureka-2.eureka.default.svc.cluster.local</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      eureka-2.eureka.default.svc.cluster.local</span><br><span class="line">Address 1: 10.200.128.137 10-200-128-137.eureka-node-port.default.svc.cluster.local</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>综上所述，DNS查询会返回所有的endpoint，通过解析Pod的DNS记录，也能返回Pod的IP。</p>
<h3 id="headless-service使用场景"><a href="#headless-service使用场景" class="headerlink" title="headless service使用场景"></a>headless service使用场景</h3><ul>
<li>自助选择权，client可以自己决定使用哪个real server，可以通过DNS来获取real server信息。</li>
<li>headless service关联的每个pod，都会有对应的DNS域名，这样Pod直接可以互相访问。这样对于一些集训类型的应用就可以解决身份是吧的问题了。</li>
</ul>
<h3 id="为什么要用headless-statefulSet部署有状态应用"><a href="#为什么要用headless-statefulSet部署有状态应用" class="headerlink" title="为什么要用headless+statefulSet部署有状态应用"></a>为什么要用headless+statefulSet部署有状态应用</h3><ol>
<li>headless service会为关联的Pod分配一个域 <code>&lt;service name&gt;.$&lt;namespace name&gt;.svc.cluster.local</code></li>
<li>statefulSet 会为关联的Pod保持一个不变的Pod Name <code>$(statefulSet name)-$(pod序号)</code></li>
<li>statefulSet会为关联的Pod分配一个dnsName <code>$&lt;Pod Name&gt;.$&lt;service name&gt;.$&lt;namespace name&gt;.svc.cluster.local</code></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/kubadm%E9%AB%98%E5%8F%AF%E7%94%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/kubadm%E9%AB%98%E5%8F%AF%E7%94%A8.html" class="post-title-link" itemprop="url">kubadm 高可用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>使用kubeadm搭建一套kubernetes集群很简单，但是一个单节点的master并不能满足我们在生产环境的需求。因此必须得解决单点的问题后才能考虑在生产环境大面积推广应用。</p>
<p>实践目标</p>
<ol>
<li>至少2个以上的master节点可以同时管理集群;</li>
<li>集群的所有功能正常可用；</li>
<li>支持后续扩展；</li>
</ol>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>参考master单节点安装，此处不再具体描述。<br><strong>系统参数</strong> 修改系统内核参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 </span><br><span class="line">sed -i <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> /etc/selinux/config  </span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">swapoff -a </span><br><span class="line">sed -i <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/sysctl.conf &lt;&lt;<span class="string">eof</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">eof</span></span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line">lsmod | grep ip</span><br></pre></td></tr></table></figure>

<p><strong>docker相关</strong> 安装docker。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-selinux \</span><br><span class="line">                  docker-engine-selinux \</span><br><span class="line">                  docker-engine</span><br><span class="line">                  </span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line">docker --version</span><br></pre></td></tr></table></figure>

<p><strong>安装相关组件</strong> 安装kubeadm必须组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装其他组件</span></span><br><span class="line">yum install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以指定版本</span></span><br><span class="line">yum install -y kubelet-1.23.4 kubeadm-1.23.4 kubectl-1.23.4 --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>

<h3 id="配置NGINX代理"><a href="#配置NGINX代理" class="headerlink" title="配置NGINX代理"></a>配置NGINX代理</h3><p>kube-apiserver高可用可以直接起多个节点，很多使用keepalive，haproxy来进行高可用配置，但是在大部分的公有云上无法使用vip。公有云上可以使用公有云提供的LoadBalance,这里我们使用nginx来代替.<br>nginx stream 四层协议的转发、代理或者负载均衡.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nginx nginx-mod-stream</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">  log_format  main  <span class="string">&#x27;$remote_addr [$time_local]&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;$protocol $status $bytes_sent $bytes_received&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;$session_time&#x27;</span>;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen 16443;</span><br><span class="line">    proxy_pass kubeapi;</span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">  &#125;</span><br><span class="line">  upstream kubeapi &#123;</span><br><span class="line">    server 192.168.1.109:6443;</span><br><span class="line">    server 192.168.1.217:6443;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="部署集群"><a href="#部署集群" class="headerlink" title="部署集群"></a>部署集群</h3><p><strong>获取默认配置文件</strong> 导出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm-config.yaml</span><br></pre></td></tr></table></figure>

<p><strong>根据实际情况修改配置文件</strong> 注意修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- <span class="built_in">groups</span>:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef <span class="comment"># 自定义token</span></span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.1.109 <span class="comment"># master节点ip</span></span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  imagePullPolicy: IfNotPresent</span><br><span class="line">  name: node</span><br><span class="line">  taints: null</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: 192.168.1.109:16443 <span class="comment"># 集群apiserver地址和端口</span></span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: &#123;&#125;</span><br><span class="line">etcd: </span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd   <span class="comment"># 修改etcd数据目录，也可以修改为外部etcd</span></span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers <span class="comment"># 仓库地址</span></span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: 1.23.4 <span class="comment"># 版本</span></span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs</span><br></pre></td></tr></table></figure>

<p>配置说明：</p>
<ul>
<li>controlPlaneEndpoint：为集群apiserver监听端口16443</li>
<li>imageRepository:由于国内无法访问google镜像仓库k8s.gcr.io，这里指定为私有仓库地址  registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers</li>
<li>podSubnet:指定的IP地址段与后续部署的网络插件相匹配</li>
</ul>
<h4 id="执行初始化"><a href="#执行初始化" class="headerlink" title="执行初始化"></a>执行初始化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs | <span class="built_in">tee</span> kubeadm-init.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>该命令指定了初始化时需要使用的配置文件，其中添加–upload-certs参数可以在后续执行加入节点时自动分发证书文件。<br>低版本注意使用–experimental-upload-certs。</p>
</blockquote>
<p><img src="evernotecid://2D277EDE-88BA-4DB6-AE12-A2B952C4D28E/appyinxiangcom/3119051/ENResource/p3036" alt="c6e534cbec32dfef14cfc2bb8f027c9e.png"></p>
<p>kubeadm init主要执行了以下操作：</p>
<ol>
<li>[init]：指定版本进行初始化操作</li>
<li>[preflight] ：初始化前的检查和下载所需要的Docker镜像文件</li>
<li>[kubelet-start]：生成kubelet的配置文件”&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml”，没有这个文件kubelet无法启动，所以初始化之前的kubelet实际上启动失败。</li>
<li>[certificates]：生成Kubernetes使用的证书，存放在&#x2F;etc&#x2F;kubernetes&#x2F;pki目录中。</li>
<li>[kubeconfig] ：生成 KubeConfig 文件，存放在&#x2F;etc&#x2F;kubernetes目录中，组件之间通信需要使用对应文件。</li>
<li>[control-plane]：使用&#x2F;etc&#x2F;kubernetes&#x2F;manifest目录下的YAML文件，安装 Master 组件。</li>
<li>[etcd]：使用&#x2F;etc&#x2F;kubernetes&#x2F;manifest&#x2F;etcd.yaml安装Etcd服务。</li>
<li>[wait-control-plane]：等待control-plan部署的Master组件启动。</li>
<li>[apiclient]：检查Master组件服务状态。</li>
<li>[uploadconfig]：更新配置</li>
<li>[kubelet]：使用configMap配置kubelet。</li>
<li>[patchnode]：更新CNI信息到Node上，通过注释的方式记录。</li>
<li>[mark-control-plane]：为当前节点打标签，打了角色Master，和不可调度标签，这样默认就不会使用Master节点来运行Pod。</li>
<li>[bootstrap-token]：生成token记录下来，后边使用kubeadm join往集群中添加节点时会用到</li>
<li>[addons]：安装附加组件CoreDNS和kube-proxy</li>
</ol>
<blockquote>
<p>无论是初始化失败或者集群已经完全搭建成功，你都可以直接执行kubeadm reset命令清理集群或节点，然后重新执行kubeadm init或kubeadm join相关操作即可。<br>注意清理<code>.kube</code>目录</p>
</blockquote>
<p><strong>配置网络插件</strong> calico</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/v3.21/manifests/calico.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="其他节点加入集群"><a href="#其他节点加入集群" class="headerlink" title="其他节点加入集群"></a>其他节点加入集群</h3><p><strong>master</strong> join</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 192.168.1.109:16443 --token abcdef.0123456789abcdef \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:b9852b8ec72c5f26988763325e9da155de6136a3c3a62f48749bb4b6e09c37c0 \</span><br><span class="line">	--control-plane</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行后会自动生成相关文件和目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node-217 kubernetes]<span class="comment"># ll</span></span><br><span class="line">total 28</span><br><span class="line">-rw------- 1 root root 5638 Feb 22 17:07 admin.conf</span><br><span class="line">-rw------- 1 root root 5673 Feb 22 17:07 controller-manager.conf</span><br><span class="line">-rw------- 1 root root 1955 Feb 22 17:07 kubelet.conf</span><br><span class="line">drwx------ 2 root root   96 Feb 22 17:07 manifests</span><br><span class="line">drwxr-xr-x 2 root root  288 Feb 22 17:07 pki</span><br><span class="line">-rw------- 1 root root 5621 Feb 22 17:07 scheduler.conf</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果在某些特殊情况下需要手动上传的话，注意传输以下文件即可：<br>admin.conf<br>pki&#x2F;ca.*<br>pki&#x2F;front-proxy*<br>pki&#x2F;sa*</p>
</blockquote>
<p><strong>worker</strong> 新node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 192.168.1.109:16443 --token abcdef.0123456789abcdef \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:b9852b8ec72c5f26988763325e9da155de6136a3c3a62f48749bb4b6e09c37c0</span><br></pre></td></tr></table></figure>

<p>无论在master节点或node节点，要能够执行kubectl命令必须进行以下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p><strong>检查集群</strong><br>两台master节点展示信息一致。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@uat-109 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES                  AGE    VERSION</span><br><span class="line">k8s-node-217    Ready    control-plane,master   8m2s   v1.23.4</span><br><span class="line">master          Ready    control-plane,master   30h    v1.23.4</span><br><span class="line">test-216-tips   Ready    &lt;none&gt;                 27h    v1.23.4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-node-217 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES                  AGE    VERSION</span><br><span class="line">k8s-node-217    Ready    control-plane,master   8m9s   v1.23.4</span><br><span class="line">master          Ready    control-plane,master   30h    v1.23.4</span><br><span class="line">test-216-tips   Ready    &lt;none&gt;                 27h    v1.23.4</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><strong>删除节点</strong><br>在master节点上执行：<br><code>kubectl drain node-xxx --delete-local-data --force --ignore-daemonsets</code></p>
<p>当节点变成不可调度状态时候 SchedulingDisabled，执行<br><code>kubectl delete node node-xxx</code></p>
<p><strong>ipvs</strong></p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/89f126b241db">https://www.jianshu.com/p/89f126b241db</a></p>
</blockquote>
<p>IPVS简介：</p>
<p>尽管 Kubernetes 在版本v1.6中已经支持5000个节点，但使用 iptables 的 kube-proxy 实<br>际上是将集群扩展到5000个节点的瓶颈。 在5000节点集群中使用 NodePort 服务，如<br>果有2000个服务并且每个服务有10个 pod，这将在每个工作节点上至少产生20000个<br>iptable 记录，这可能使内核非常繁忙。</p>
<p>ipvs (IP Virtual Server) 实现了传输层负载均衡，也就是我们常说的4层LAN交换，作为<br>Linux 内核的一部分。ipvs运行在主机上，在真实服务器集群前充当负载均衡器。ipvs<br>可以将基于TCP和UDP的服务请求转发到真实服务器上，并使真实服务器的服务在单个<br>IP 地址上显示为虚拟服务。</p>
<p>我们知道kube-proxy支持 iptables 和 ipvs 两种模式， 在kubernetes v1.8 中引入了 ipvs<br>模式，在 v1.9 中处于 beta 阶段，在 v1.11 中已经正式可用了。iptables 模式在 v1.1 中<br>就添加支持了，从 v1.2版本开始 iptables 就是 kube-proxy 默认的操作模式，ipvs 和<br>iptables 都是基于netfilter的。ipvs 会使用 iptables 进行包过滤、SNAT、masquared。<br>具体来说，ipvs 将使用ipset来存储需要DROP或masquared的流量的源或目标地址，<br>以确保 iptables 规则的数量是恒定的，这样我们就不需要关心我们有多少服务了。</p>
<p>启动ipvs的要求：</p>
<p>k8s版本 &gt;&#x3D; v1.11<br>使用ipvs需要安装相应的工具来处理”yum install ipset ipvsadm -y“<br>确保 ipvs已经加载内核模块， ip_vs、ip_vs_rr、ip_vs_wrr、ip_vs_sh、<br>nf_conntrack_ipv4。如果这些内核模块不加载，当kube-proxy启动后，会退回到iptables模式。</p>
<p>先前基于iptables规则表的DNAT-&gt;SNAT方式来处理外部客户端到k8s集群pod内的流量<br>和集群内部流量(cluster-ip到pod ip)，无需在宿主机上管理cluster-ip都由iptables来进行<br>管理。</p>
<p>使用IPVS后是需要对vs(虚拟服务也就是vip)进行管理，由于IPVS的DNAT钩子挂在<br>INPUT链上，因此必须要让内核识别 VIP(cluster-ip) 是本机的 IP。k8s 通过设置将<br>service cluster ip 绑定到虚拟网卡kube-ipvs0，其中下面的10.96.x.x都是VIP，也就<br>是cluster-ip。</p>
<p><img src="evernotecid://2D277EDE-88BA-4DB6-AE12-A2B952C4D28E/appyinxiangcom/3119051/ENResource/p3037" alt="9b5302edcad44e440bbb8dbb5ccb128e.png"></p>
<p>kube-proxy 开启 ipvs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ipset ipvsadm -y</span><br></pre></td></tr></table></figure>

<p>修改ConfigMap的kube-system&#x2F;kube-proxy中的config.conf，mode: “ipvs”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@master k8s]<span class="comment"># kubectl edit cm kube-proxy -n kube-system</span></span><br><span class="line">...</span><br><span class="line">    ipvs:</span><br><span class="line">      excludeCIDRs: null</span><br><span class="line">      minSyncPeriod: 0s</span><br><span class="line">      scheduler: <span class="string">&quot;&quot;</span></span><br><span class="line">      strictARP: <span class="literal">false</span></span><br><span class="line">      syncPeriod: 30s</span><br><span class="line">    kind: KubeProxyConfiguration</span><br><span class="line">    metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">    mode: <span class="string">&quot;ipvs&quot;</span></span><br><span class="line">    nodePortAddresses: null</span><br><span class="line">    oomScoreAdj: -999</span><br><span class="line">    portRange: <span class="string">&quot;&quot;</span></span><br><span class="line">    resourceContainer: /kube-proxy</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">configmap/kube-proxy edited</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于Kubernetes来说，可以直接将这三个Pod删除之后，会自动重建。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master k8s]<span class="comment"># kubectl get pods -n kube-system|grep proxy</span></span><br><span class="line">kube-proxy-fn68r                           1/1     Running             0             75s</span><br><span class="line">kube-proxy-hrjls                           1/1     Running             0             78s</span><br><span class="line">kube-proxy-ltbqk                           1/1     Running             0             77s</span><br></pre></td></tr></table></figure>

<p>批量删除 kube-proxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system | grep kube-proxy | awk <span class="string">&#x27;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>由于你已经通过ConfigMap修改了kube-proxy的配置，所以后期增加的Node节点，会直接使用ipvs模式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment">#  kubectl logs kube-proxy-hrjls -n kube-system</span></span><br><span class="line">I0222 09:25:27.699369       1 node.go:163] Successfully retrieved node IP: 192.168.1.109</span><br><span class="line">I0222 09:25:27.699464       1 server_others.go:138] <span class="string">&quot;Detected node IP&quot;</span> address=<span class="string">&quot;192.168.1.109&quot;</span></span><br><span class="line">I0222 09:25:27.774905       1 server_others.go:269] <span class="string">&quot;Using ipvs Proxier&quot;</span></span><br><span class="line">I0222 09:25:27.774932       1 server_others.go:271] <span class="string">&quot;Creating dualStackProxier for ipvs&quot;</span></span><br><span class="line">I0222 09:25:27.775016       1 server_others.go:491] <span class="string">&quot;Detect-local-mode set to ClusterCIDR, but no IPv6 cluster CIDR defined, , defaulting to no-op detect-local for IPv6&quot;</span></span><br><span class="line">E0222 09:25:27.775284       1 proxier.go:379] <span class="string">&quot;Can&#x27;t set sysctl, kernel version doesn&#x27;t satisfy minimum version requirements&quot;</span> sysctl=<span class="string">&quot;net/ipv4/vs/conn_reuse_mode&quot;</span> minimumKernelVersion=<span class="string">&quot;4.1&quot;</span></span><br><span class="line">I0222 09:25:27.775454       1 proxier.go:438] <span class="string">&quot;IPVS scheduler not specified, use rr by default&quot;</span></span><br><span class="line">E0222 09:25:27.775637       1 proxier.go:379] <span class="string">&quot;Can&#x27;t set sysctl, kernel version doesn&#x27;t satisfy minimum version requirements&quot;</span> sysctl=<span class="string">&quot;net/ipv4/vs/conn_reuse_mode&quot;</span> minimumKernelVersion=<span class="string">&quot;4.1&quot;</span></span><br><span class="line">I0222 09:25:27.775756       1 proxier.go:438] <span class="string">&quot;IPVS scheduler not specified, use rr by default&quot;</span></span><br><span class="line">I0222 09:25:27.775850       1 ipset.go:113] <span class="string">&quot;Ipset name truncated&quot;</span> ipSetName=<span class="string">&quot;KUBE-6-LOAD-BALANCER-SOURCE-CIDR&quot;</span> truncatedName=<span class="string">&quot;KUBE-6-LOAD-BALANCER-SOURCE-CID&quot;</span></span><br><span class="line">I0222 09:25:27.775890       1 ipset.go:113] <span class="string">&quot;Ipset name truncated&quot;</span> ipSetName=<span class="string">&quot;KUBE-6-NODE-PORT-LOCAL-SCTP-HASH&quot;</span> truncatedName=<span class="string">&quot;KUBE-6-NODE-PORT-LOCAL-SCTP-HAS&quot;</span></span><br><span class="line">I0222 09:25:27.776321       1 server.go:656] <span class="string">&quot;Version info&quot;</span> version=<span class="string">&quot;v1.23.4&quot;</span></span><br><span class="line">I0222 09:25:27.783258       1 conntrack.go:52] <span class="string">&quot;Setting nf_conntrack_max&quot;</span> nf_conntrack_max=131072</span><br><span class="line">I0222 09:25:27.783815       1 config.go:317] <span class="string">&quot;Starting service config controller&quot;</span></span><br><span class="line">I0222 09:25:27.783883       1 shared_informer.go:240] Waiting <span class="keyword">for</span> caches to <span class="built_in">sync</span> <span class="keyword">for</span> service config</span><br><span class="line">I0222 09:25:27.783942       1 config.go:226] <span class="string">&quot;Starting endpoint slice config controller&quot;</span></span><br><span class="line">I0222 09:25:27.783963       1 shared_informer.go:240] Waiting <span class="keyword">for</span> caches to <span class="built_in">sync</span> <span class="keyword">for</span> endpoint slice config</span><br><span class="line">I0222 09:25:27.884501       1 shared_informer.go:247] Caches are synced <span class="keyword">for</span> endpoint slice config</span><br><span class="line">I0222 09:25:27.884570       1 shared_informer.go:247] Caches are synced <span class="keyword">for</span> service config</span><br></pre></td></tr></table></figure>

<p>日志中打印出了Using ipvs Proxier，说明ipvs模式已经开启。</p>
<p>使用ipvsadm测试，可以查看之前创建的Service已经使用LVS创建了集群。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># ipvsadm</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  master:https rr</span><br><span class="line">  -&gt; master:sun-sr-https         Masq    1      0          13</span><br><span class="line">  -&gt; master1:sun-sr-https   Masq    1      0          14</span><br><span class="line">TCP  master:domain rr</span><br><span class="line">TCP  master:9153 rr</span><br><span class="line">UDP  master:domain rr</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/mysql%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/mysql%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.html" class="post-title-link" itemprop="url">mysql基本操作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Yum-安装"><a href="#Yum-安装" class="headerlink" title="Yum 安装"></a>Yum 安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh  http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">yum install mysql-server</span><br></pre></td></tr></table></figure>
<h2 id="主从同步-读写分离"><a href="#主从同步-读写分离" class="headerlink" title="主从同步&#x2F;读写分离"></a>主从同步&#x2F;读写分离</h2><h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server-id = 1  #(标识为master库)</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog_format=mixed </span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">replicate-ignore-db=mysql</span><br><span class="line">binlog_cache_size = 1M</span><br><span class="line">binlog_format=mixed</span><br><span class="line">expire_logs_days=3</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#1.创建账号并授权</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO backup@&#x27;%&#x27; IDENTIFIED BY &#x27;backup&#x27;;</span><br><span class="line">flush privileges;</span><br><span class="line">#2.锁表</span><br><span class="line">FLUSH TABLES WITH READ LOCK;</span><br><span class="line">#3.查看当前状态</span><br><span class="line">show master status;</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1550219754792.png" />
备份导出，并将SQL文件传输给slave服务器执行导入。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot  --all-databases &gt; /tmp/mydb.sql</span><br></pre></td></tr></table></figure>


<h3 id="slave"><a href="#slave" class="headerlink" title="slave"></a>slave</h3><p>1、修改配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_id=2</span><br><span class="line">binlog-ignore-db=mysql #不记录binlog</span><br><span class="line">replicate-ignore-db=mysql #不复制test库的binlog</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog_cache_size = 1M</span><br><span class="line">binlog_format=mixed</span><br><span class="line">expire_logs_days=3</span><br></pre></td></tr></table></figure>
<p>2、导入SQL文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source mydb.sql;</span><br></pre></td></tr></table></figure>
<p>3、开启同步</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;192.168.1.228&#x27;,MASTER_USER=&#x27;backup&#x27;,MASTER_PASSWORD=&#x27;backup&#x27;,MASTER_LOG_FILE=&#x27;mysql-bin.000003&#x27;,MASTER_LOG_POS=399;</span><br></pre></td></tr></table></figure>
<p>4、设置只读<br>对于需要保证master-slave主从同步的salve库，如果要设置为只读状态，需要执行的命令为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &quot;%read_only%&quot;;</span><br><span class="line">#查看只读状态</span><br><span class="line">mysql&gt; set global read_only=1;</span><br></pre></td></tr></table></figure>
<p>将salve库从只读状态变为读写状态，需要执行的命令是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global read_only=0;</span><br></pre></td></tr></table></figure>

<ul>
<li>1.read_only&#x3D;1只读模式，不会影响slave同步复制的功能，所以在MySQL slave库中设定了read_only&#x3D;1后，通过 show slave status\G 命令查看salve状态，可以看到salve仍然会读取master上的日志，并且在slave库中应用日志，保证主从数据库同步一致；</li>
<li>2.read_only&#x3D;1只读模式，可以限定普通用户进行数据修改的操作，但不会限定具有super权限的用户的数据修改操作；在MySQL中设置read_only&#x3D;1后，普通的应用用户进行insert、update、delete等会产生数据变化的DML操作时，都会报出数据库处于只读模式不能发生数据变化的错误，但具有super权限的用户，例如在本地或远程通过root用户登录到数据库，还是可以进行数据变化的DML操作；</li>
</ul>
<p>5、检查状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>
<p>检查是否和Master状态一致，并且两个线程是否为YES。<br><img src="https://img.mknight.cn/medivh/1550219967672.png" /></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在Master上执行以下语句，解除锁表状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNLOCK TABLES</span><br></pre></td></tr></table></figure>
<h2 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h2><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">查询最新10条数据  顺序、倒序</span><br><span class="line"></span><br><span class="line">select  * from t_web_001_member LIMIT 10</span><br><span class="line">select * from t_web_001_member ORDER BY memberId  desc limit 10</span><br></pre></td></tr></table></figure>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1、update</span><br><span class="line">update table name set guarantee_id =&#x27;34&#x27; and guarantee_name = &#x27;xxxx’ where demand_id = 1567;</span><br><span class="line">2、insert into </span><br><span class="line">insert into table(field1,field2) values(value1,value2)</span><br><span class="line">3、delete</span><br><span class="line">delete from table where 范围</span><br><span class="line"></span><br><span class="line">-- select * from t_web_001_member where DATE(regtime) = &#x27;2017-09-13&#x27; and  memberId &gt; 165949;</span><br><span class="line">select * from t_web_001_member where DATE(regtime) = &#x27;2017-09-12&#x27;;</span><br><span class="line">-- select * from t_web_001_member where DATE(regtime) = &#x27;2017-09-13&#x27; and  memberId &gt; 165949;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- UPDATE  t_web_001_member  set regtime= DATE_FORMAT(ADDDATE(date_sub(&#x27;2017-09-12 07:00:00&#x27;,interval 0 day) , INTERVAL FLOOR(0 + RAND() * 120) MINUTE),&#x27;%Y-%m-%d %H:%i:%s&#x27;) where DATE(regtime) = &#x27;2017-09-13&#x27; and  memberId &gt; 165949 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into</span><br><span class="line">INSERT INTO t_web_001_member(userName, mobile, loginpwd,regtime,mobile_state, isAccountIn) SELECT username, mobile, PASSWORD, create_time,1, 1 FROM t_user;</span><br><span class="line"></span><br><span class="line">清空某列的数据</span><br><span class="line">update t_web_001_member set regtime =null;</span><br></pre></td></tr></table></figure>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">5.7设置root密码</span><br><span class="line">update mysql.user set authentication_string=password(&#x27;123qwe&#x27;) where user=&#x27;root&#x27; and Host = &#x27;localhost&#x27;;</span><br><span class="line"></span><br><span class="line">DATE_FORMAT(ADDDATE(date_sub(&#x27;2017-09-05 07:00:00&#x27;,interval -1 day) , INTERVAL FLOOR(0 + RAND() * 120) MINUTE),&#x27;%Y-%m-%d %H:%i:%s&#x27;)</span><br><span class="line">日期随机 </span><br><span class="line"></span><br><span class="line">mysqladmin -u root password &quot;newpass&quot;</span><br><span class="line">mysqladmin -u root password “ios&quot; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create database zabbix charset utf8;</span><br><span class="line">create database car charset utf8;</span><br><span class="line">grant all privileges on car.* to &#x27;car&#x27;@&#x27;%&#x27; identified by &#x27;xxxxxx&#x27;;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">#给普通用户建库的权限</span><br><span class="line">grant select,delete,update,create,drop,alter,insert on *.* to &#x27;xx&#x27;@&#x27;%&#x27; ;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">导入导出</span><br><span class="line">-d  表结构</span><br><span class="line">#导出数据和表结构</span><br><span class="line">mysqldump -uroot -p dbname &gt; dbname.sql</span><br><span class="line">#导出多张表</span><br><span class="line">mysqldump -uroot -password dbname table1 table2 &gt;db.sql</span><br><span class="line"></span><br><span class="line">#导出表结</span><br><span class="line">mysqldump -uroot -p -d     dbname &gt; dbname.sql</span><br><span class="line">#导出某张表的数据和表结构</span><br><span class="line">mysqldump -uroot -pdbpasswd  dbname &gt;db.sql;</span><br><span class="line">#导出某张表的表结构</span><br><span class="line">mysqldump -uroot -pdbpasswd dbname test&gt;db.sql;</span><br><span class="line"></span><br><span class="line">导出部分字段不为空的数据</span><br><span class="line">#select COUNT(*) from t_user where mobile !=&#x27;&#x27; and real_name !=&#x27;&#x27; and real_name !=&#x27;Null&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="binlog-查看"><a href="#binlog-查看" class="headerlink" title="binlog 查看"></a>binlog 查看</h3><blockquote>
<p>参数说明:<br>-v, –verbose 用于输出基于row模式的binlog日志，<br>-vv 为列数据类型添加注释 –base64-output&#x3D;decode-rows 解码binlog里经过base64编码的内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -vv --base64-output=decode-rows  mysql-binlog.xxxx &gt; new.sql</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/elasticsearch-dump%20%E8%BF%81%E7%A7%BBes%E6%95%B0%E6%8D%AE%20%EF%BC%88elasticdump%EF%BC%89.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/elasticsearch-dump%20%E8%BF%81%E7%A7%BBes%E6%95%B0%E6%8D%AE%20%EF%BC%88elasticdump%EF%BC%89.html" class="post-title-link" itemprop="url">elasticsearch-dump 迁移es数据 （elasticdump）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="elasticsearch-部分查询语句"><a href="#elasticsearch-部分查询语句" class="headerlink" title="elasticsearch 部分查询语句"></a>elasticsearch 部分查询语句</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 获取集群的节点列表：</span><br><span class="line">curl &#x27;localhost:9200/_cat/nodes?v&#x27;</span><br><span class="line"></span><br><span class="line"># 列出所有索引：</span><br><span class="line">curl &#x27;localhost:9200/_cat/indices?v&#x27;</span><br><span class="line"></span><br><span class="line">创建一个名为“customer”的索引，然后再查看所有的索引：</span><br><span class="line">curl -X PUT &#x27;localhost:9200/customer?pretty&#x27;</span><br><span class="line">curl &#x27;localhost:9200/_cat/indices?v&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="elasticsearch-dump"><a href="#elasticsearch-dump" class="headerlink" title="elasticsearch-dump"></a>elasticsearch-dump</h3><p><a target="_blank" rel="noopener" href="https://github.com/taskrabbit/elasticsearch-dump">https://github.com/taskrabbit/elasticsearch-dump</a></p>
<h4 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h4><h5 id="npm-环境准备"><a href="#npm-环境准备" class="headerlink" title="npm 环境准备"></a>npm 环境准备</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Installing</span><br><span class="line">(local)</span><br><span class="line">wget https://nodejs.org/dist/v8.11.2/node-v8.11.2-linux-x64.tar.xz</span><br><span class="line"></span><br><span class="line">tar xf node-v8.11.2-linux-x64.tar.xz </span><br><span class="line"></span><br><span class="line">mv node-v8.11.2-linux-x64 /usr/local</span><br><span class="line"></span><br><span class="line">ln -s /usr/local/node-v8.11.2-linux-x64/bin/npm /usr/local/bin/npm</span><br><span class="line"></span><br><span class="line">ln -s /usr/local/node-v8.11.2-linux-x64/bin/node /usr/local/bin/node</span><br></pre></td></tr></table></figure>
<h5 id="继续安装"><a href="#继续安装" class="headerlink" title="继续安装"></a>继续安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">npm init -f</span><br><span class="line"></span><br><span class="line">#全局或者局部</span><br><span class="line"></span><br><span class="line">npm install elasticdump</span><br><span class="line">./bin/elasticdump</span><br><span class="line">(global)</span><br><span class="line"></span><br><span class="line">npm install elasticdump -g</span><br><span class="line">elasticdump</span><br></pre></td></tr></table></figure>
<h3 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x27;#拷贝analyzer分词</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=http://staging.es.com:9200/my_index \</span><br><span class="line">  --type=analyzer</span><br><span class="line">&#x27;#拷贝映射</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=http://staging.es.com:9200/my_index \</span><br><span class="line">  --type=mapping</span><br><span class="line">&#x27;#拷贝数据</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=http://staging.es.com:9200/my_index \</span><br><span class="line">  --type=data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 注意 elasticdump 提供给了--httpAuthFile 参数来做认证</span><br><span class="line">--httpAuthFile      When using http auth provide credentials in ini file in form</span><br><span class="line">                    `user=&lt;username&gt;</span><br><span class="line">                    password=&lt;password&gt;`</span><br><span class="line"></span><br><span class="line"># 只需要写一个ini文件 ，文件中写入用户名和密码就可以了</span><br><span class="line"># 这里其实还有另外一个好的方法</span><br><span class="line"># 在--input参数和--output参数的的url中添加账号密码</span><br><span class="line"># 例如</span><br><span class="line"></span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://prod-username:prod-passowrd@production.es.com:9200/my_index \</span><br><span class="line">  --output=http://stage-username:stage-password@staging.es.com:9200/my_index \</span><br><span class="line">  --type=data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 备份索引数据到文件里:</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=/data/my_index_mapping.json \</span><br><span class="line">  --type=mapping</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=/data/my_index.json \</span><br><span class="line">  --type=data</span><br><span class="line"></span><br><span class="line"># 备份到标准输出，且进行压缩（这里有一个需要注意的地方，我查询索引信息有6.4G，用下面的方式备份后得到一个789M的压缩文件，这个压缩文件解压后有19G）:</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=$ \</span><br><span class="line">  | gzip &gt; /data/my_index.json.gz</span><br><span class="line"></span><br><span class="line"># 把一个查询结果备份到文件中</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=query.json \</span><br><span class="line">  --searchBody &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;username&quot;: &quot;admin&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 将备份文件的数据导入ES</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=./data.json \</span><br><span class="line">  --output=http://es.com:9200 </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Linux%20%E6%97%A5%E5%B8%B8%E6%95%B4%E7%90%86.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Linux%20%E6%97%A5%E5%B8%B8%E6%95%B4%E7%90%86.html" class="post-title-link" itemprop="url">Linux 日常整理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h3><h4 id="the-NTP-socket-is-in-use-exiting问题"><a href="#the-NTP-socket-is-in-use-exiting问题" class="headerlink" title="the NTP socket is in use, exiting问题"></a>the NTP socket is in use, exiting问题</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@esx4 ~]# ntpdate ntp.api.bz</span><br><span class="line">21 Sep 14:39:09 ntpdate[24744]: the NTP socket is in use, exiting</span><br><span class="line"></span><br><span class="line">[root@esx4 ~]# service ntpd stop</span><br><span class="line">Shutting down ntpd:                                        [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@esx4 ~]# ntpdate 0.debian.pool.ntp.org</span><br><span class="line">21 Sep 15:22:43 ntpdate[25723]: step time server 114.80.81.1 offset 2312.159684 sec</span><br></pre></td></tr></table></figure>
<h4 id="同步crontab"><a href="#同步crontab" class="headerlink" title="同步crontab"></a>同步crontab</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;59 23 * * * /usr/sbin/ntpdate 0.debian.pool.ntp.org &gt;&gt; /var/log/time.log &amp;&amp; hwclock --systohc 2&gt;&amp;1&quot; &gt;&gt; /etc/crontab</span><br></pre></td></tr></table></figure>
<h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><h4 id="大于2T的分区"><a href="#大于2T的分区" class="headerlink" title="大于2T的分区"></a>大于2T的分区</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">parted  /dev/sdb</span><br><span class="line">mklabel gpt --建立gpt标签</span><br><span class="line">mkpart primary 0% 100%  （开始和终止位置）</span><br><span class="line">print   查看结果</span><br><span class="line">quit 退出</span><br><span class="line"></span><br><span class="line">mkfs.ext4 /dev/sdb</span><br><span class="line"></span><br><span class="line">mkdir /data</span><br><span class="line">mount  /dev/sdb /data</span><br></pre></td></tr></table></figure>
<h4 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop01-bj-a src]# blk</span><br><span class="line">blkdeactivate  blkdiscard     blkid</span><br><span class="line">[root@hadoop01-bj-a src]# blkid</span><br><span class="line">/dev/vda1: UUID=&quot;976105f5-f402-456c-aadd-50de49ff88f9&quot; TYPE=&quot;ext4&quot;</span><br><span class="line">/dev/vdb1: UUID=&quot;7f7dfded-4bbd-4a38-b823-1ddf904be9db&quot; TYPE=&quot;ext4&quot;</span><br><span class="line">[root@hadoop01-bj-a src]# cat /etc/fstab</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># /etc/fstab</span><br><span class="line"># Created by anaconda on Thu Aug 17 07:38:21 2017</span><br><span class="line">#</span><br><span class="line"># Accessible filesystems, by reference, are maintained under &#x27;/dev/disk&#x27;</span><br><span class="line"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span><br><span class="line">#</span><br><span class="line">UUID=976105f5-f402-456c-aadd-50de49ff88f9 /                       ext4    defaults        1 1</span><br><span class="line">UUID=976105f5-f402-456c-aadd-50de49ff88f9 /opt                    ext4    defaults        0 0</span><br></pre></td></tr></table></figure>
<h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">cd /usr/src/ &amp;&amp; tar -zxvf ./jre-8u191-linux-x64.tar.gz -C /usr/local</span><br><span class="line">ln -s /usr/local/jdk1.8.0_91/ /usr/local/java</span><br><span class="line">echo &#x27;</span><br><span class="line">#JDK</span><br><span class="line">############################################################</span><br><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">############################################################</span><br><span class="line">&#x27; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd /usr/src/ &amp;&amp; wget 10.110.1.18/open-falcon-agnt.tar.gz &amp;&amp; tar -xvf open-falcon-agnt.tar.gz -C /usr/local &amp;&amp; chmod 755 /usr/local/open-falcon -R  &amp;&amp; cd   /usr/local/open-falcon</span><br><span class="line">./open-falcon start agent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="name-or-service-not-known"><a href="#name-or-service-not-known" class="headerlink" title="name or service not known"></a>name or service not known</h3><p>配置jumpserver发邮件的时候提示<code>name or service not known</code>。<br>检查发现能ping通<code>smtp.exmail.qq.com</code>，但是不知道为啥发不出邮件</p>
<p>使用以下命令，然后加入hosts文件,即可<br><img src="https://img.mknight.cn/medivh/1551426333101.png" /><br><img src="https://img.mknight.cn/medivh/1551426435903.png" /></p>
<h3 id="查看文件编码"><a href="#查看文件编码" class="headerlink" title="查看文件编码"></a>查看文件编码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim </span><br><span class="line"></span><br><span class="line">:set fileencoding</span><br></pre></td></tr></table></figure>
<h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#查找30天以前的文件</span><br><span class="line">find . -name &quot;*.png&quot; -ctime +1</span><br><span class="line"></span><br><span class="line">find -name april*                      在当前目录下查找以april开始的文件</span><br><span class="line">find -name april* fprint file        在当前目录下查找以april开始的文件，并把结果输出到file中</span><br><span class="line">find -name ap* -o -name may* 查找以ap或may开头的文件</span><br><span class="line">find /mnt -name tom.txt -ftype vfat 在/mnt下查找名称为tom.txt且文件系统类型为vfat的文件</span><br><span class="line">find /mnt -name t.txt ! -ftype vfat   在/mnt下查找名称为tom.txt且文件系统类型不为vfat的文件</span><br><span class="line">find /tmp -name wa* -type l           在/tmp下查找名为wa开头且类型为符号链接的文件</span><br><span class="line">find /home -mtime -2                 在/home下查最近两天内改动过的文件</span><br><span class="line">find /home   -atime -1                  查1天之内被存取过的文件</span><br><span class="line">find /home -mmin   +60                  在/home下查60分钟前改动过的文件</span><br><span class="line">find /home -amin +30                  查最近30分钟前被存取过的文件</span><br><span class="line">find /home -newer tmp.txt             在/home下查更新时间比tmp.txt近的文件或目录</span><br><span class="line">find /home -anewer tmp.txt            在/home下查存取时间比tmp.txt近的文件或目录</span><br><span class="line">find /home -used -2                  列出文件或目录被改动过之后，在2日内被存取过的文件或目录</span><br><span class="line">find /home -user cnscn                列出/home目录内属于用户cnscn的文件或目录</span><br><span class="line">find /home -uid +501                 列出/home目录内用户的识别码大于501的文件或目录</span><br><span class="line">find /home -group cnscn              列出/home内组为cnscn的文件或目录</span><br><span class="line">find /home -gid 501                   列出/home内组id为501的文件或目录</span><br><span class="line">find /home -nouser                    列出/home内不属于本地用户的文件或目录</span><br><span class="line">find /home -nogroup                   列出/home内不属于本地组的文件或目录</span><br><span class="line">find /home   -name tmp.txt   -maxdepth 4 列出/home内的tmp.txt 查时深度最多为3层</span><br><span class="line">find /home -name tmp.txt -mindepth 3 从第2层开始查</span><br><span class="line">find /home -empty                     查找大小为0的文件或空目录</span><br><span class="line">find /home -size +512k               查大于512k的文件</span><br><span class="line">find /home -size -512k               查小于512k的文件</span><br><span class="line">find /home -links +2                 查硬连接数大于2的文件或目录</span><br><span class="line">find /home -perm 0700                查权限为700的文件或目录</span><br><span class="line">find /tmp -name tmp.txt -exec cat &#123;&#125; /;</span><br><span class="line">find /tmp -name tmp.txt -ok rm &#123;&#125; /;</span><br><span class="line"></span><br><span class="line">find   / -amin   -10       # 查找在系统中最后10分钟访问的文件</span><br><span class="line">find   / -atime -2         # 查找在系统中最后48小时访问的文件</span><br><span class="line">find   / -empty              # 查找在系统中为空的文件或者文件夹</span><br><span class="line">find   / -group cat        # 查找在系统中属于 groupcat的文件</span><br><span class="line">find   / -mmin -5         # 查找在系统中最后5分钟里修改过的文件</span><br><span class="line">find   / -mtime -1        #查找在系统中最后24小时里修改过的文件</span><br><span class="line">find   / -nouser             #查找在系统中属于作废用户的文件</span><br><span class="line">find   / -user   fred       #查找在系统中属于FRED这个用户的文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-name filename             #查找名为filename的文件</span><br><span class="line">-perm                       #按执行权限来查找</span><br><span class="line">-user   username            #按文件属主来查找</span><br><span class="line">-group groupname            #按组来查找</span><br><span class="line">-mtime -n +n               #按文件更改时间来查找文件，-n指n天以内，+n指n天以前</span><br><span class="line">-atime   -n +n              #按文件访问时间来查</span><br><span class="line">-perm                        #按执行权限来查找</span><br><span class="line">-user   username            #按文件属主来查找</span><br><span class="line">-group groupname            #按组来查找</span><br><span class="line">-mtime -n +n               #按文件更改时间来查找文件，-n指n天以内，+n指n天以前</span><br><span class="line">-atime   -n +n              #按文件访问时间来查找文件，-n指n天以内，+n指n天以前 </span><br><span class="line">-ctime   -n +n              #按文件创建时间来查找文件，-n指n天以内，+n指n天以前 </span><br><span class="line">-nogroup                    #查无有效属组的文件，即文件的属组在/etc/groups中不存在</span><br><span class="line">-nouser                     #查无有效属主的文件，即文件的属主在/etc/passwd中不存</span><br><span class="line">-newer f1 !f2              找文件，-n指n天以内，+n指n天以前 </span><br><span class="line">-ctime   -n +n              #按文件创建时间来查找文件，-n指n天以内，+n指n天以前 </span><br><span class="line">-nogroup                    #查无有效属组的文件，即文件的属组在/etc/groups中不存在</span><br><span class="line">-nouser                     #查无有效属主的文件，即文件的属主在/etc/passwd中不存</span><br><span class="line">-newer f1 !f2              #查更改时间比f1新但比f2旧的文件</span><br><span class="line">-type    b/d/c/p/l/f        #查是块设备、目录、字符设备、管道、符号链接、普通文件</span><br><span class="line">-size     n[c]              #查长度为n块[或n字节]的文件</span><br><span class="line">-depth                      #使查找在进入子目录前先行查找完本目录</span><br><span class="line">-fstype                     #查更改时间比f1新但比f2旧的文件</span><br><span class="line">-type    b/d/c/p/l/f        #查是块设备、目录、字符设备、管道、符号链接、普通文件</span><br><span class="line">-size     n[c]              #查长度为n块[或n字节]的文件</span><br><span class="line">-depth                      #使查找在进入子目录前先行查找完本目录</span><br><span class="line">-fstype                     #查位于某一类型文件系统中的文件，这些文件系统类型通常可 在/etc/fstab中找到</span><br><span class="line">-mount                      #查文件时不跨越文件系统mount点</span><br><span class="line">-follow                     #如果遇到符号链接文件，就跟踪链接所指的文件</span><br><span class="line">-cpio                   #查位于某一类型文件系统中的文件，这些文件系统类型通常可 在/etc/fstab中找到</span><br><span class="line">-mount                      #查文件时不跨越文件系统mount点</span><br><span class="line">-follow                     #如果遇到符号链接文件，就跟踪链接所指的文件</span><br><span class="line">-cpio                       #对匹配的文件使用cpio命令，将他们备份到磁带设备中</span><br><span class="line">-prune                      #忽略某个目录</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 获取昨天 </span><br><span class="line">date -d &#x27;yesterday&#x27;  # 或 date -d &#x27;last day&#x27; </span><br><span class="line"># 获取明天 </span><br><span class="line">date -d &#x27;tomorrow&#x27;   # 或 date -d &#x27;next day&#x27; </span><br><span class="line"># 获取上个月 </span><br><span class="line">date -d &#x27;last month&#x27; </span><br><span class="line"># 获取下个月 </span><br><span class="line">date -d &#x27;next month&#x27; </span><br><span class="line"># 获取上一年 </span><br><span class="line">date -d ’last year&#x27; </span><br><span class="line"># 获取下一年 </span><br><span class="line">date -d &#x27;next year&#x27; </span><br><span class="line">此外你可以获取多天前，多天后，多个月前，多个月后，多年前或多年后 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 三年前 </span><br><span class="line">date -d &#x27;3 year ago&#x27; </span><br><span class="line"># 五年后 </span><br><span class="line">date -d &#x27;-5 year ago&#x27; </span><br><span class="line"># 两天后 </span><br><span class="line">date -d &#x27;-2 day ago&#x27; </span><br><span class="line"># 一个月前 </span><br><span class="line">date -d &#x27;1 month ago&#x27; </span><br></pre></td></tr></table></figure>
<h3 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#查找指定日期的内容</span><br><span class="line">sed -n &#x27;/^2019-03-14/p&#x27; xxx.info.log &gt; new.log</span><br><span class="line"></span><br><span class="line">#删除指定行</span><br><span class="line">sed -i &#x27;1,14430d&#x27; xx.info.log</span><br><span class="line"></span><br><span class="line">#删除指定行，例如第5行</span><br><span class="line">sed -i &#x27;5 d&#x27; test.txt</span><br><span class="line"></span><br><span class="line">#删除首行</span><br><span class="line">sed -i &#x27;1d&#x27; test.txt</span><br><span class="line"></span><br><span class="line">#删除末行</span><br><span class="line">sed -i &#x27;$d&#x27; test.txt</span><br><span class="line"></span><br><span class="line">#删除空行</span><br><span class="line">sed -i &#x27;/^$/d&#x27; test.txt</span><br><span class="line"></span><br><span class="line">#剔除空格</span><br><span class="line">sed -i &#x27;s/[ ]*//g&#x27; test.txt</span><br><span class="line"></span><br><span class="line">#删除车符</span><br><span class="line">sed -i &#x27;s/^M//g&#x27; test.txt</span><br><span class="line"></span><br><span class="line">#删除指定字段的下一行</span><br><span class="line">sed -i &#x27;/test/&#123;n;d&#125;&#x27; test.txt  #匹配到test字段</span><br><span class="line"></span><br><span class="line">#删除指定字段的上一行</span><br><span class="line">sed -i -e :a -e &#x27;$!N;s/.*n(.*test)/1/;ta&#x27; -e &#x27;P;d&#x27; test.txt    #匹配到test字段</span><br></pre></td></tr></table></figure>


<p>CentOS的启动出错：</p>
<p>当执行 ifup ens33</p>
<p>出现错误：Error:Connection activation failed: No suitable device found for this connection</p>
<p>解决办法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chkconfig NetworkManager off</span><br><span class="line">chkconfig network on</span><br><span class="line">service NetworkManager stop</span><br><span class="line">service network start</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="切割大文件"><a href="#切割大文件" class="headerlink" title="切割大文件"></a>切割大文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">split -b 100m 1111.log (按照字节分隔)</span><br><span class="line">split -l 1000000 1111.log(按照行数分隔)</span><br></pre></td></tr></table></figure>

<h3 id="journalctl日志文件清理"><a href="#journalctl日志文件清理" class="headerlink" title="journalctl日志文件清理"></a>journalctl日志文件清理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl --disk-usage</span><br><span class="line">Journals take up 3.8G on disk.</span><br></pre></td></tr></table></figure>

<p>手动删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl --vacuum-time=7d</span><br><span class="line">journalctl --vacuum-size=1024M</span><br></pre></td></tr></table></figure>
<p>控制目录大小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/systemd/journald.conf</span><br><span class="line">SystemMaxUse=1G</span><br></pre></td></tr></table></figure>
<p>如果不生效，重启该服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl kill --kill-who=main --signal=SIGUSR2 systemd-journald.service</span><br></pre></td></tr></table></figure>
<p>校验是否正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl --verify</span><br></pre></td></tr></table></figure>

<h3 id="安装pip"><a href="#安装pip" class="headerlink" title="安装pip"></a>安装pip</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line"></span><br><span class="line">yum -y install python-pip</span><br></pre></td></tr></table></figure>



<h3 id="Nginx-代理"><a href="#Nginx-代理" class="headerlink" title="Nginx 代理"></a>Nginx 代理</h3><p>作用：给爬虫服务器做代理服务器</p>
<p>遇到的问题：访问部分机器的时候出现少量504错误</p>
<p>解决：<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_buffers 8 128k;</span><br><span class="line">send_timeout 60;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">#user  nobody;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  65535;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    fastcgi_buffers 8 128k;</span><br><span class="line">    send_timeout 60;</span><br><span class="line">    gzip  on;</span><br><span class="line"></span><br><span class="line">   server&#123;</span><br><span class="line">        listen   2019;</span><br><span class="line">        resolver 100.100.2.136;</span><br><span class="line">        proxy_connect;</span><br><span class="line">        proxy_connect_allow            443 563;</span><br><span class="line">        proxy_connect_connect_timeout  10s;</span><br><span class="line">        proxy_connect_read_timeout     10s;</span><br><span class="line">        proxy_connect_send_timeout     10s;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_set_header Host $host;</span><br><span class="line">		        proxy_pass	http://$http_host$request_uri;</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="初试化"><a href="#初试化" class="headerlink" title="初试化"></a>初试化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chown root:root /etc/passwd /etc/shadow /etc/group /etc/gshadow</span><br><span class="line">chmod 0644 /etc/group  </span><br><span class="line">chmod 0644 /etc/passwd  </span><br><span class="line">chmod 0400 /etc/shadow  </span><br><span class="line">chmod 0400 /etc/gshadow </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/freeswitch%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/freeswitch%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3.html" class="post-title-link" itemprop="url">freeswitch部署文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="一、freeswitch"><a href="#一、freeswitch" class="headerlink" title="一、freeswitch"></a>一、freeswitch</h3><p>注意区分CentOS 6&#x2F;7，不同版本编译的时候会有些差别。比如6上不会提示opus-devel，但是7必须安装。</p>
<h3 id="二、Libshout"><a href="#二、Libshout" class="headerlink" title="二、Libshout"></a>二、Libshout</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y http://mirror.centos.org/centos/7/os/x86_64/Packages/libshout-2.2.2-11.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="三、执行命令："><a href="#三、执行命令：" class="headerlink" title="三、执行命令："></a>三、执行命令：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y http://files.freeswitch.org/freeswitch-release-1-6.noarch.rpm</span><br></pre></td></tr></table></figure>
<h3 id="四、按照依赖"><a href="#四、按照依赖" class="headerlink" title="四、按照依赖"></a>四、按照依赖</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y git alsa-lib-devel autoconf automake bison broadvoice-devel bzip2 curl-devel libmpg123-devel libmp3lame-devel db-devel e2fsprogs-devel flite-devel g722_1-devel gcc-c++ gdbm-devel gnutls-devel ilbc2-devel ldns-devel libcodec2-devel libcurl-devel libedit-devel libidn-devel libjpeg-devel libmemcached-devel libogg-devel libsilk-devel libsndfile-devel libtheora-devel libtiff-devel libtool libuuid-devel libvorbis-devel libxml2-devel lua-devel lzo-devel mongo-c-driver-devel ncurses-devel net-snmp-devel openssl-devel opus-devel pcre-devel perl perl-ExtUtils-Embed pkgconfig portaudio-devel postgresql-devel python26-devel python-devel soundtouch-devel speex-devel sqlite-devel unbound-devel unixODBC-devel wget which yasm zlib-devel opus-devel libvorbis libvorbis-devel libogg libogg-devel</span><br></pre></td></tr></table></figure>

<h3 id="五、下载"><a href="#五、下载" class="headerlink" title="五、下载"></a>五、下载</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src</span><br><span class="line">git clone -b v1.6 https://freeswitch.org/stash/scm/fs/freeswitch.git freeswitch</span><br></pre></td></tr></table></figure>

<h3 id="六、编译"><a href="#六、编译" class="headerlink" title="六、编译"></a>六、编译</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/freeswitch</span><br><span class="line">./bootstrap.sh -j</span><br><span class="line"></span><br><span class="line">./configure  --enable-core-odbc-support --enable-zrtp \</span><br><span class="line">            --enable-core-pgsql-support \</span><br><span class="line">            --enable-static-v8 --disable-parallel-build-v8</span><br><span class="line"></span><br><span class="line">#或者执行命令：</span><br><span class="line">./configure -C --enable-core-odbc-support --enable-zrtp \</span><br><span class="line">            --enable-core-pgsql-support \</span><br><span class="line">            --enable-static-v8 --disable-parallel-build-v8</span><br></pre></td></tr></table></figure>
<h3 id="七、-编辑modoul-xml"><a href="#七、-编辑modoul-xml" class="headerlink" title="七、 编辑modoul.xml"></a>七、 编辑modoul.xml</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将 #applications/mod_callcenter 、 #formats/mod_shout 、 #say/mod_say_zh  #applications/mod_curl 的&quot;#&quot;给去掉并，保存</span><br><span class="line">如果make的时候抛错，吧 #formats/mod_shout的注释重新加上。</span><br></pre></td></tr></table></figure>

<h3 id="八、继续编译安装"><a href="#八、继续编译安装" class="headerlink" title="八、继续编译安装"></a>八、继续编译安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make -j install</span><br><span class="line"></span><br><span class="line">#以下命令执行时下载文件的时间会很久</span><br><span class="line">make -j cd-sounds-install</span><br><span class="line">make -j cd-moh-install</span><br></pre></td></tr></table></figure>
<h4 id="九、相关配置文件"><a href="#九、相关配置文件" class="headerlink" title="九、相关配置文件"></a>九、相关配置文件</h4><p>线路参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">conf/sip_profiles/external/uckefu.xml</span><br><span class="line">&lt;include&gt;</span><br><span class="line">    &lt;gateway name=&quot;uckef&quot;&gt;</span><br><span class="line">        &lt;param name=&quot;proxy&quot; value=&quot;59.110.14.46:6060&quot;/&gt;</span><br><span class="line">	&lt;param name=&quot;from-user&quot; value=&quot;3000001&quot;/&gt;</span><br><span class="line">	&lt;param name=&quot;register&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">    &lt;/gateway&gt;</span><br><span class="line">&lt;/include&gt;</span><br></pre></td></tr></table></figure>
<p>电话号码</p>
<p>资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/tcscy/article/details/71169688">https://blog.csdn.net/tcscy/article/details/71169688</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E4%BD%BF%E7%94%A8nmap%E6%9D%A5%E8%BF%9B%E8%A1%8C%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%BD%BF%E7%94%A8nmap%E6%9D%A5%E8%BF%9B%E8%A1%8C%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2.html" class="post-title-link" itemprop="url">使用nmap来进行一些探索</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>很多时候需要探测局域网中存在哪些主机，或者开放了哪些端口，有一个特别好用的命令——nmap.</p>
</blockquote>
<h3 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h3><p>任何网络探测任务的最初几个步骤之一就是把一组IP范围(有时该范围是巨大的)缩小为 一列活动的或者您感兴趣的主机。扫描每个IP的每个端口很慢，通常也没必要。 当然，什么样的主机令您感兴趣主要依赖于扫描的目的。网管也许只对运行特定服务的 主机感兴趣，而从事安全的人士则可能对一个马桶都感兴趣，只要它有IP地址:-)。一个系统管理员 也许仅仅使用Ping来定位内网上的主机，而一个外部入侵测试人员则可能绞尽脑汁用各种方法试图 突破防火墙的封锁。</p>
<p>由于主机发现的需求五花八门，Nmap提供了一箩筐的选项来定制您的需求。 主机发现有时候也叫做ping扫描，但它远远超越用世人皆知的ping工具 发送简单的ICMP回声请求报文。用户完全可以通过使用列表扫描(-sL)或者 通过关闭ping (-P0)跳过ping的步骤，也可以使用多个端口把TCP SYN&#x2F;ACK，UDP和ICMP 任意组合起来玩一玩。这些探测的目的是获得响应以显示某个IP地址是否是活动的(正在被某 主机或者网络设备使用)。 在许多网络上，在给定的时间，往往只有小部分的IP地址是活动的。 这种情况在基于RFC1918的私有地址空间如10.0.0.0&#x2F;8尤其普遍。 那个网络有16,000,000个IP，但我见过一些使用它的公司连1000台机器都没有。 主机发现能够找到零星分布于IP地址海洋上的那些机器。</p>
<p>如果没有给出主机发现的选项，Nmap 就发送一个TCP ACK报文到80端口和一个ICMP回声请求到每台目标机器。 一个例外是ARP扫描用于局域网上的任何目标机器。对于非特权UNIX shell用户，使用connect()系统调用会发送一个SYN报文而不是ACK 这些默认行为和使用-PA -PE选项的效果相同。 扫描局域网时，这种主机发现一般够用了，但是对于安全审核，建议进行 更加全面的探测。</p>
<ul>
<li>-sL 列表扫描。只能列出来这个网段会有多少主机，并不能判断主机的任何状态。默认情况下还能获取主机名。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nmap -sL 192.168.1.0/24</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-09-01 16:37 CST</span><br><span class="line">Nmap scan report for 192.168.1.0</span><br><span class="line">Nmap scan report for nsys.cn (192.168.1.1)</span><br><span class="line">...</span><br><span class="line">Nmap scan report for *.demo.haha.com (192.168.1.102)</span><br><span class="line">...</span><br><span class="line">Nmap done: 256 IP addresses (0 hosts up) scanned in 11.16 seconds</span><br></pre></td></tr></table></figure>

<ul>
<li>-sP ping扫描。仅使用ping来扫描主机，然后输出对ping进行响应的主机，速度较快，但是意义并不是太大，主要是因为不能获取所有存活的主机。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nmap -sP 192.168.1.0/24</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-09-01 16:42 CST</span><br><span class="line">Nmap scan report for nsys.cn (192.168.1.1)</span><br><span class="line">Host is up (0.00078s latency).</span><br><span class="line">Nmap scan report for 192.168.1.9</span><br><span class="line">Host is up (0.086s latency).</span><br><span class="line">Nmap scan report for 192.168.1.10</span><br><span class="line">Host is up (0.00054s latency).</span><br><span class="line">...</span><br><span class="line">Nmap done: 256 IP addresses (29 hosts up) scanned in 2.64 seconds</span><br></pre></td></tr></table></figure>

<ul>
<li>-PU UDP Ping,可以绕过只过滤TCP的防火墙和过滤器。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nmap -P0 192.168.1.0/24</span><br><span class="line">Host discovery disabled (-Pn). All addresses will be marked &#x27;up&#x27; and scan times will be slower.</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-09-01 16:45 CST</span><br><span class="line">Nmap scan report for 192.168.1.0</span><br><span class="line">Host is up (0.000029s latency).</span><br><span class="line">All 1000 scanned ports on 192.168.1.0 are filtered</span><br><span class="line"></span><br><span class="line">Nmap scan report for nsys.cn (192.168.1.1)</span><br><span class="line">Host is up (0.0020s latency).</span><br><span class="line">Not shown: 998 filtered ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">80/tcp   open  http</span><br><span class="line">1723/tcp open  pptp</span><br><span class="line">...</span><br><span class="line">Nmap scan report for 192.168.1.97</span><br><span class="line">Host is up (0.000019s latency).</span><br><span class="line">Not shown: 863 closed ports, 135 filtered ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">5900/tcp open  vnc</span><br><span class="line">8086/tcp open  d-s-n</span><br></pre></td></tr></table></figure>

<h3 id="端口扫描基础"><a href="#端口扫描基础" class="headerlink" title="端口扫描基础"></a>端口扫描基础</h3><ul>
<li><p>open<br>  应用程序正在该端口接收TCP 连接或者UDP报文。</p>
</li>
<li><p>closed<br>  关闭的端口对于Nmap也是可访问的(它接受Nmap的探测报文并作出响应)， 但没有应用程序在其上监听。 它们可以显示该IP地址上(主机发现，或者ping扫描)的主机正在运行up 也对部分操作系统探测有所帮助。 因为关闭的关口是可访问的，也许过会儿值得再扫描一下，可能一些又开放了。</p>
</li>
<li><p>filtered<br>  由于包过滤阻止探测报文到达端口， Nmap无法确定该端口是否开放。过滤可能来自专业的防火墙设备，路由器规则 或者主机上的软件防火墙。这样的端口让攻击者感觉很挫折，因为它们几乎不提供 任何信息。有时候它们响应ICMP错误消息如类型3代码13 (无法到达目标: 通信被管理员禁止)，但更普遍的是过滤器只是丢弃探测帧， 不做任何响应。</p>
</li>
<li><p>unfiltered<br>  未被过滤状态意味着端口可访问，但Nmap不能确定它是开放还是关闭。 只有用于映射防火墙规则集的ACK扫描才会把端口分类到这种状态。 用其它类型的扫描如窗口扫描，SYN扫描，或者FIN扫描来扫描未被过滤的端口可以帮助确定 端口是否开放。</p>
</li>
<li><p>open|filtered(开放或者被过滤的)<br>  当无法确定端口是开放还是被过滤的，Nmap就把该端口划分成 这种状态。开放的端口不响应就是一个例子。没有响应也可能意味着报文过滤器丢弃 了探测报文或者它引发的任何响应。因此Nmap无法确定该端口是开放的还是被过滤的。 UDP，IP协议， FIN，Null，和Xmas扫描可能把端口归入此类。</p>
</li>
<li><p>closed|filtered(关闭或者被过滤的)<br>  该状态用于Nmap不能确定端口是关闭的还是被过滤的。 它只可能出现在IPID Idle扫描中。</p>
</li>
<li><p>-sS TCP SYN扫描，执行速度快，每秒可以扫描上千个端口。因为它不完成一个完全的TCP连接。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo nmap -sS  192.168.1.0/24</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-09-01 16:52 CST</span><br><span class="line">Nmap scan report for nsys.cn (192.168.1.1)</span><br><span class="line">Host is up (0.00032s latency).</span><br><span class="line">Not shown: 993 filtered ports</span><br><span class="line">PORT     STATE  SERVICE</span><br><span class="line">80/tcp   open   http</span><br><span class="line">443/tcp  closed https</span><br><span class="line">xxx</span><br><span class="line">MAC Address: xxxx</span><br><span class="line">...</span><br><span class="line">Nmap scan report for 192.168.1.97</span><br><span class="line">Host is up (0.000017s latency).</span><br><span class="line">Not shown: 499 closed ports, 499 filtered ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">5900/tcp open  vnc</span><br><span class="line">8086/tcp open  d-s-n</span><br><span class="line"></span><br><span class="line">Nmap done: 256 IP addresses (100 hosts up) scanned in 127.95 seconds</span><br></pre></td></tr></table></figure>

<ul>
<li>-sT TCP connect()扫描</li>
<li>-sU UDP 扫描</li>
<li>-sA TCP ACK扫描</li>
<li>-sw TCP窗口扫描</li>
</ul>
<h3 id="端口说明和扫描顺序"><a href="#端口说明和扫描顺序" class="headerlink" title="端口说明和扫描顺序"></a>端口说明和扫描顺序</h3><ul>
<li>-p 只扫描指定端口</li>
<li>-F 快速有限的端口</li>
<li>-r 不要按随机顺序扫描</li>
</ul>
<h3 id="服务和版本探测"><a href="#服务和版本探测" class="headerlink" title="服务和版本探测"></a>服务和版本探测</h3><ul>
<li>-v</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV 192.168.1.236</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-09-01 17:18 CST</span><br><span class="line">Nmap scan report for 192.168.1.236</span><br><span class="line">Host is up (1.0s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT      STATE SERVICE    VERSION</span><br><span class="line">22/tcp    open  ssh        OpenSSH 7.4 (protocol 2.0)</span><br><span class="line">111/tcp   open  rpcbind    2-4 (RPC #100000)</span><br><span class="line">9100/tcp  open  jetdirect?</span><br><span class="line">38292/tcp open  java-rmi   Java RMI</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 36.78 seconds</span><br></pre></td></tr></table></figure>

<ul>
<li>-O</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo nmap -O 192.168.1.236</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-09-01 17:20 CST</span><br><span class="line">Nmap scan report for 192.168.1.236</span><br><span class="line">Host is up (0.00057s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">22/tcp    open  ssh</span><br><span class="line">111/tcp   open  rpcbind</span><br><span class="line">9100/tcp  open  jetdirect</span><br><span class="line">38292/tcp open  landesk-cba</span><br><span class="line">MAC Address: 52:xxxxxxx:49 (QEMU virtual NIC)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 3.X|4.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</span><br><span class="line">OS details: Linux 3.2 - 4.9</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line"></span><br><span class="line">OS detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 1.91 seconds</span><br></pre></td></tr></table></figure>

<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><ul>
<li>指定端口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -p 22，53，110，143，4564 198.116.0-255.1-127</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>探测分为两部分，获取主机地址和端口。</p>
<ul>
<li>挖掘更多的网络服务信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap --script=discovery</span><br></pre></td></tr></table></figure>

<ul>
<li>负责检查目标主机是否有常见的漏洞<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap --script=vuln 192.168.1.xxx</span><br></pre></td></tr></table></figure></li>
</ul>
<p>其他脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">auth：负责处理鉴权证书、绕开鉴权的脚本。</span><br><span class="line"></span><br><span class="line">broadcast：处理在局域网内探查更多服务开启的状况，如 dhcp / dns / sqlserver 等服务。</span><br><span class="line"></span><br><span class="line">brute：提供暴力破解方式，针对常见的应用如 http / snmp 等。</span><br><span class="line"></span><br><span class="line">default：使用 sC 或 A 选项时默认的脚本，提供基本脚本扫描能力。</span><br><span class="line"></span><br><span class="line">discovery：挖掘更多的网络服务信息，如 smb 枚举、snmp 查询等。</span><br><span class="line"></span><br><span class="line">dos：用于进行拒绝服务攻击。</span><br><span class="line"></span><br><span class="line">exploit：利用已知的漏洞入侵系统。</span><br><span class="line"></span><br><span class="line">external：利用第三方的数据库或资源，如进行 whois 解析。</span><br><span class="line"></span><br><span class="line">fuzzer：模糊测试脚本，发送异常的包到目标主机，探测出潜在的漏洞。</span><br><span class="line"></span><br><span class="line">malware：探测目标是否感染了病毒，是否开启了后门。</span><br><span class="line"></span><br><span class="line">safe：与 fuzzer 功能相反，属于安全性脚本。</span><br><span class="line"></span><br><span class="line">version：负责增强信性服务与版本扫描功能的脚本。</span><br><span class="line"></span><br><span class="line">vuln：负责检查目标主机是否有常见的漏洞，如 ms08_067。</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
