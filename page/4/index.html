<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.econow.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.econow.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/page/4/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?21ded952ca9fc25e2b0630494a17ec7f"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Zookeeper%20%E5%AE%9E%E8%B7%B5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Zookeeper%20%E5%AE%9E%E8%B7%B5.html" class="post-title-link" itemprop="url">Zookeeper 实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/Zookeeper%20%E5%AE%9E%E8%B7%B5.html" class="post-meta-item leancloud_visitors" data-flag-title="Zookeeper 实践" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p> ZooKeeper 是一个开源的分布式协调服务，由雅虎创建，是 Google Chubby 的开源实现。<br>分布式应用程序可以基于 ZooKeeper 实现诸如数据发布&#x2F;订阅、负载均衡、命名服务、分布式协<br>调&#x2F;通知、集群管理、Master 选举、配置维护，名字服务、分布式同步、分布式锁和分布式队列<br>等功能。</p>
</blockquote>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><p>一个 ZooKeeper 集群同一时刻只会有一个 Leader，其他都是 Follower 或 Observer。</p>
<p>ZooKeeper 配置很简单，每个节点的配置文件(zoo.cfg)都是一样的，只有 myid 文件不一样。myid 的值必须是 zoo.cfg中server.{数值} 的{数值}部分。<br>在装有 ZooKeeper 的机器的终端执行 zookeeper-server status 可以看当前节点的 ZooKeeper是什么角色（Leader or Follower）。<br><img src="https://img.econow.cn/medivh/1547261347782.png" /><br>ZooKeeper 默认只有 Leader 和 Follower 两种角色，没有 Observer 角色。为了使用 Observer 模式，在任何想变成Observer的节点的配置文件中加入:peerType&#x3D;observer 并在所有 server 的配置文件中，配置成 observer 模式的 server 的那行配置追加 :observer 。</p>
<h3 id="读写分工"><a href="#读写分工" class="headerlink" title="读写分工"></a>读写分工</h3><ul>
<li>ZooKeeper 集群的所有机器通过一个 Leader 选举过程来选定一台被称为『Leader』的机器，Leader服务器为客户端提供读和写服务。</li>
<li>Follower 和 Observer 都能提供读服务，不能提供写服务。两者唯一的区别在于，Observer机器不参与 Leader 选举过程，也不参与写操作的『过半写成功』策略，因此 Observer 可以在不影响写性能的情况下提升集群的读性能</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>ZooKeeper 是一个高可用的分布式数据管理与协调框架。基于对ZAB算法的实现，该框架能够很好地保证分布式环境中数据的一致性。也是基于这样的特性，使得 ZooKeeper 成为了解决分布式一致性问题的利器。</p>
<h2 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>配置jdk</li>
<li>配置hosts</li>
<li>配置 myid</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://archive.apache.org/dist/zookeeper/">http://archive.apache.org/dist/zookeeper/</a><br>另外一家CDH版本的<br><a target="_blank" rel="noopener" href="http://archive.cloudera.com/cdh5/cdh/5/">http://archive.cloudera.com/cdh5/cdh/5/</a></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">dataDir=/opt/zookeeper/data</span><br><span class="line">dataLogDir=/opt/zookeeper/log</span><br><span class="line">clientPort=2181</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=c1:2888:3888</span><br><span class="line">server.2=c2:2888:3888</span><br><span class="line">server.3=c3:2888:3888</span><br></pre></td></tr></table></figure>

<h4 id="配置文件解读"><a href="#配置文件解读" class="headerlink" title="配置文件解读"></a>配置文件解读</h4><ul>
<li>initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 10 个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000&#x3D;10 秒</li>
<li>syncLimit：这个配置项标识 Leader 与 Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是 2*2000&#x3D;4 秒</li>
<li>server.A&#x3D;B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。</li>
</ul>
<h4 id="两台部署三台的伪集群示例"><a href="#两台部署三台的伪集群示例" class="headerlink" title="两台部署三台的伪集群示例"></a>两台部署三台的伪集群示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">### z1</span><br><span class="line"></span><br><span class="line">tickTime=2000</span><br><span class="line">dataDir=/home/joy/zookeeper/data</span><br><span class="line">dataLogDir=/home/joy/zookeeper/log</span><br><span class="line">clientPort=2181</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=10.252.1.15:2888:3888</span><br><span class="line">server.2=10.252.4.11:2888:3888</span><br><span class="line">server.3=10.252.4.11:2899:3899</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### z2</span><br><span class="line"></span><br><span class="line">tickTime=2000</span><br><span class="line">dataDir=/home/joy/zookeeper/data</span><br><span class="line">dataLogDir=/home/joy/zookeeper/log</span><br><span class="line">clientPort=2181</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=10.252.1.15:2888:3888</span><br><span class="line">server.2=10.252.4.11:2888:3888</span><br><span class="line">server.3=10.252.4.11:2899:3899</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### z3</span><br><span class="line"></span><br><span class="line">tickTime=2000</span><br><span class="line">dataDir=/home/joy/zookeeper3/data</span><br><span class="line">dataLogDir=/home/joy/zookeeper3/log</span><br><span class="line">clientPort=2182</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=10.252.1.15:2888:3888</span><br><span class="line">server.2=10.252.4.11:2888:3888</span><br><span class="line">server.3=10.252.4.11:2899:3899</span><br></pre></td></tr></table></figure>

<h3 id="myid"><a href="#myid" class="headerlink" title="myid"></a>myid</h3><p>集群模式下还要配置一个文件 myid，这个文件在 dataDir 目录下，这个文件里面就有一个数据就是 A 的值，Zookeeper 启动时会读取这个文件，拿到里面的数据与 zoo.cfg 里面的配置信息比较从而判断到底是那个 server。</p>
<h3 id="启动节点"><a href="#启动节点" class="headerlink" title="启动节点"></a>启动节点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zkServer.sh start conf/zoo.cfg</span><br></pre></td></tr></table></figure>
<h3 id="分别检查节点状态"><a href="#分别检查节点状态" class="headerlink" title="分别检查节点状态"></a>分别检查节点状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper bin/zkServer.sh status conf/zoo.cfg</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1561278792094.png"  />
<img src="https://img.econow.cn/medivh/1561278810493.png"  />
<img src="https://img.econow.cn/medivh/1561278829368.png"  />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/elasticsearch-dump%20%E8%BF%81%E7%A7%BBes%E6%95%B0%E6%8D%AE%20%EF%BC%88elasticdump%EF%BC%89.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/elasticsearch-dump%20%E8%BF%81%E7%A7%BBes%E6%95%B0%E6%8D%AE%20%EF%BC%88elasticdump%EF%BC%89.html" class="post-title-link" itemprop="url">elasticsearch-dump 迁移es数据 （elasticdump）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/elasticsearch-dump%20%E8%BF%81%E7%A7%BBes%E6%95%B0%E6%8D%AE%20%EF%BC%88elasticdump%EF%BC%89.html" class="post-meta-item leancloud_visitors" data-flag-title="elasticsearch-dump 迁移es数据 （elasticdump）" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="elasticsearch-部分查询语句"><a href="#elasticsearch-部分查询语句" class="headerlink" title="elasticsearch 部分查询语句"></a>elasticsearch 部分查询语句</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 获取集群的节点列表：</span><br><span class="line">curl &#x27;localhost:9200/_cat/nodes?v&#x27;</span><br><span class="line"></span><br><span class="line"># 列出所有索引：</span><br><span class="line">curl &#x27;localhost:9200/_cat/indices?v&#x27;</span><br><span class="line"></span><br><span class="line">创建一个名为“customer”的索引，然后再查看所有的索引：</span><br><span class="line">curl -X PUT &#x27;localhost:9200/customer?pretty&#x27;</span><br><span class="line">curl &#x27;localhost:9200/_cat/indices?v&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="elasticsearch-dump"><a href="#elasticsearch-dump" class="headerlink" title="elasticsearch-dump"></a>elasticsearch-dump</h3><p><a target="_blank" rel="noopener" href="https://github.com/taskrabbit/elasticsearch-dump">https://github.com/taskrabbit/elasticsearch-dump</a></p>
<h4 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h4><h5 id="npm-环境准备"><a href="#npm-环境准备" class="headerlink" title="npm 环境准备"></a>npm 环境准备</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Installing</span><br><span class="line">(local)</span><br><span class="line">wget https://nodejs.org/dist/v8.11.2/node-v8.11.2-linux-x64.tar.xz</span><br><span class="line"></span><br><span class="line">tar xf node-v8.11.2-linux-x64.tar.xz </span><br><span class="line"></span><br><span class="line">mv node-v8.11.2-linux-x64 /usr/local</span><br><span class="line"></span><br><span class="line">ln -s /usr/local/node-v8.11.2-linux-x64/bin/npm /usr/local/bin/npm</span><br><span class="line"></span><br><span class="line">ln -s /usr/local/node-v8.11.2-linux-x64/bin/node /usr/local/bin/node</span><br></pre></td></tr></table></figure>
<h5 id="继续安装"><a href="#继续安装" class="headerlink" title="继续安装"></a>继续安装</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">npm init -f</span><br><span class="line"></span><br><span class="line">#全局或者局部</span><br><span class="line"></span><br><span class="line">npm install elasticdump</span><br><span class="line">./bin/elasticdump</span><br><span class="line">(global)</span><br><span class="line"></span><br><span class="line">npm install elasticdump -g</span><br><span class="line">elasticdump</span><br></pre></td></tr></table></figure>
<h3 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x27;#拷贝analyzer分词</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=http://staging.es.com:9200/my_index \</span><br><span class="line">  --type=analyzer</span><br><span class="line">&#x27;#拷贝映射</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=http://staging.es.com:9200/my_index \</span><br><span class="line">  --type=mapping</span><br><span class="line">&#x27;#拷贝数据</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=http://staging.es.com:9200/my_index \</span><br><span class="line">  --type=data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 注意 elasticdump 提供给了--httpAuthFile 参数来做认证</span><br><span class="line">--httpAuthFile      When using http auth provide credentials in ini file in form</span><br><span class="line">                    `user=&lt;username&gt;</span><br><span class="line">                    password=&lt;password&gt;`</span><br><span class="line"></span><br><span class="line"># 只需要写一个ini文件 ，文件中写入用户名和密码就可以了</span><br><span class="line"># 这里其实还有另外一个好的方法</span><br><span class="line"># 在--input参数和--output参数的的url中添加账号密码</span><br><span class="line"># 例如</span><br><span class="line"></span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://prod-username:prod-passowrd@production.es.com:9200/my_index \</span><br><span class="line">  --output=http://stage-username:stage-password@staging.es.com:9200/my_index \</span><br><span class="line">  --type=data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 备份索引数据到文件里:</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=/data/my_index_mapping.json \</span><br><span class="line">  --type=mapping</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=/data/my_index.json \</span><br><span class="line">  --type=data</span><br><span class="line"></span><br><span class="line"># 备份到标准输出，且进行压缩（这里有一个需要注意的地方，我查询索引信息有6.4G，用下面的方式备份后得到一个789M的压缩文件，这个压缩文件解压后有19G）:</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=$ \</span><br><span class="line">  | gzip &gt; /data/my_index.json.gz</span><br><span class="line"></span><br><span class="line"># 把一个查询结果备份到文件中</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=http://production.es.com:9200/my_index \</span><br><span class="line">  --output=query.json \</span><br><span class="line">  --searchBody &#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;username&quot;: &quot;admin&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 将备份文件的数据导入ES</span><br><span class="line">elasticdump \</span><br><span class="line">  --input=./data.json \</span><br><span class="line">  --output=http://es.com:9200 </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/elasticsearch%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/elasticsearch%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C.html" class="post-title-link" itemprop="url">elasticsearch使用经验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/elasticsearch%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C.html" class="post-meta-item leancloud_visitors" data-flag-title="elasticsearch使用经验" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="设定副本和切片数量"><a href="#设定副本和切片数量" class="headerlink" title="设定副本和切片数量"></a>设定副本和切片数量</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">number_of_replicas 是数据备份数，如果只有一台机器，设置为0</span><br><span class="line">number_of_shards  是数据分片数，默认为5，有时候设置为3</span><br></pre></td></tr></table></figure>
<p>默认情况下每个索引都会生成5个切片，当然会占用大量磁盘空间。如果是对于安全性要求一般的情况下可以通过设置模板来改变数量。</p>
<h3 id="配置模板文件"><a href="#配置模板文件" class="headerlink" title="配置模板文件"></a>配置模板文件</h3><ul>
<li>index的名字必须要和指定的json文件中的templete名相匹配，定义的mapping才会生效。logstash的output配置的template_name名可以随便。</li>
<li>对于按照日期生成的规则解决办法，就是将template名末尾加一个*号通配符即可：<code> &quot;template&quot;:&quot;logstash-nginx_joy_app*&quot;</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/elk/logstash/config/es_nginx.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	&quot;template&quot;:&quot;logstash-nginx_joy_app*&quot;,</span><br><span class="line">	&quot;settings&quot;:</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;index.number_of_shards&quot;: 2,</span><br><span class="line">		&quot;number_of_replicas&quot;: 1</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置logstash文件"><a href="#配置logstash文件" class="headerlink" title="配置logstash文件"></a>配置logstash文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  if [fields][service] == &quot;nginx_joy_app&quot;&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;10.110.1.19:9200&quot;]</span><br><span class="line">        index =&gt; &quot;logstash-nginx_joy_app-%&#123;+YYYY.MM.dd.HH&#125;&quot;</span><br><span class="line">        document_type =&gt; &quot;logstash-nginx_joy_app&quot;</span><br><span class="line">		manage_template =&gt; true</span><br><span class="line">		template_overwrite =&gt; true</span><br><span class="line">		template_name =&gt; &quot;logstash-nginx_joy_app*&quot;</span><br><span class="line">		template =&gt; &quot;/usr/local/elk/logstash/config/es_nginx.json&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这样就按照模板规则来生成对应索引了。<br><img src="https://img.econow.cn/medivh/1562138906913.png"  /></p>
<h2 id="日常语法"><a href="#日常语法" class="headerlink" title="日常语法"></a>日常语法</h2><h3 id="按照字段搜索"><a href="#按照字段搜索" class="headerlink" title="按照字段搜索"></a>按照字段搜索</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字段名: 值</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1562139077948.png"  />

<h3 id="字符串查询"><a href="#字符串查询" class="headerlink" title="字符串查询"></a>字符串查询</h3><p>查询一个或者多个的短语</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;短语&quot;</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1562139426035.png"  />

<h3 id="正则查询"><a href="#正则查询" class="headerlink" title="正则查询"></a>正则查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status: 50*</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1562139875229.png"  />

<h3 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h3><p>允许一个字段值在某个区间。[] 包含该值，{}不包含。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status: &#123;200 TO *&#125;</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1562140194294.png"  />

<h3 id="布尔查询"><a href="#布尔查询" class="headerlink" title="布尔查询"></a>布尔查询</h3><p>布尔运算符（AND，OR，NOT）允许通过逻辑运算符组合多个子查询。</p>
<p>运算符AND&#x2F;OR&#x2F;NOT必须大写。</p>
<p>NOT type: mysql</p>
<p>mysql.method: SELECT AND mysql.size: [10000 TO *]</p>
<p>(mysql.method: INSERT OR mysql.method: UPDATE) AND responsetime: [30 TO *]</p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>Logstash中的 logstash-filter-useragent 插件可以帮助我们过滤出浏览器版本、型号以及系统版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if [user_ua] != &quot;-&quot; &#123;</span><br><span class="line">      useragent &#123;</span><br><span class="line">         target =&gt; &quot;agent&quot;   #agent将过来出的user agent的信息配置到了单独的字段中</span><br><span class="line">         source =&gt; &quot;user_ua&quot;   #这个表示对message里面的哪个字段进行分析</span><br><span class="line">       &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h2 id="跨多个es节点的负载均衡"><a href="#跨多个es节点的负载均衡" class="headerlink" title="跨多个es节点的负载均衡"></a>跨多个es节点的负载均衡</h2><p>如果想使用kibana访问es集群，那么只需要按照如下操作即可：</p>
<ul>
<li>安装Elasticsearch</li>
<li>将节点配置为仅协调节点。在配置文件中配置：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">＃3。您希望此节点既不是主节点，也不是数据节点，也不是摄取节点，但是</span><br><span class="line">＃充当“搜索负载均衡器”（从节点获取数据，</span><br><span class="line">＃聚合结果等）</span><br><span class="line">＃</span><br><span class="line">node.master：false</span><br><span class="line">node.data：false</span><br><span class="line">node.ingest：false</span><br></pre></td></tr></table></figure></li>
<li>配置es节点加入集群<code>cluster.name:xxxx</code>，注意保持一致</li>
<li>将该节点启动后使用kibana调用当前es地址</li>
<li>kibana.yml 配置多个es地址：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch.hosts：</span><br><span class="line">  -  http：// elasticsearch1：9200</span><br><span class="line">  -  http：// elasticsearch2：9200</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/_search：所有索引，所有type下的所有数据都搜索出来</span><br><span class="line">/index1/_search：指定一个index，搜索其下所有type的数据</span><br><span class="line">/index1,index2/_search：同时搜索两个index下的数据</span><br><span class="line">/*1,*2/_search：按照通配符去匹配多个索引</span><br><span class="line">/index1/type1/_search：搜索一个index下指定的type的数据</span><br><span class="line">/index1/type1,type2/_search：可以搜索一个index下多个type的数据</span><br><span class="line">/index1,index2/type1,type2/_search：搜索多个index下的多个type的数据</span><br><span class="line">/_all/type1,type2/_search：_all，可以代表搜索所有index下的指定type的数据</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="时区问题"><a href="#时区问题" class="headerlink" title="时区问题"></a>时区问题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  ruby &#123;</span><br><span class="line">       code =&gt; &quot;event.set(&#x27;index_day&#x27;, event.timestamp.time.localtime.strftime(&#x27;%Y.%m.%d.%H&#x27;))&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  ....</span><br><span class="line">  index =&gt; &quot;logstash-nginx_joy_app-%&#123;index_day&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="状态检查"><a href="#状态检查" class="headerlink" title="状态检查"></a>状态检查</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. elasticsearch启动后查看是否启动成功：</span><br><span class="line">curl -XGET&quot;http://$(hostname):9200/_cluster/health?pretty=true&quot;</span><br><span class="line">2. 停止elasticsearch应用：</span><br><span class="line">curl -XPOST &quot;http:// $(hostname):9200/_shutdown&quot;</span><br><span class="line">3. 查看集群健康：</span><br><span class="line">curl $(hostname):9200/_cluster/health?pretty</span><br><span class="line">4. 检查集群状态：</span><br><span class="line">curl $(hostname):9200/_cluster/stats?pretty</span><br><span class="line">5. 节点状态：</span><br><span class="line">curl $(hostname):9200/_nodes/process?pretty</span><br><span class="line">curl $(hostname):9200/_nodes/node1/process?pretty</span><br><span class="line">6. 当你不知道有那些属性可以查看时：</span><br><span class="line">curl &#x27;$(hostname):9200/_cat/&#x27;，会返回可以查看的属性</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="磁盘扩容流程重启节点机器的流程"><a href="#磁盘扩容流程重启节点机器的流程" class="headerlink" title="磁盘扩容流程重启节点机器的流程"></a>磁盘扩容流程重启节点机器的流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.data : /opt/data1,/opt/data2</span><br></pre></td></tr></table></figure>

<p>关闭自动平衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;http://xxxx:9200/_cluster/settings&quot; -d&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot; : &#123; </span><br><span class="line">      &quot;cluster.routing.allocation.enable&quot; : &quot;none&quot; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>重启节点</p>
<p>开启平衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT &quot;http://xxxx.52:9200/_cluster/settings&quot; -d&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot;: &quot;all&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Redis%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Redis%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98.html" class="post-title-link" itemprop="url">Redis集群技术演变</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/Redis%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98.html" class="post-meta-item leancloud_visitors" data-flag-title="Redis集群技术演变" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>按照需求来分，将实例区分为单机和集群两种类型。</p>
<ul>
<li>单机适合容量和性能要求不高的小型存储</li>
<li>集群应对性能和容量要求较高的场景</li>
</ul>
<h2 id="单机"><a href="#单机" class="headerlink" title="单机"></a>单机</h2><h3 id="安全加固"><a href="#安全加固" class="headerlink" title="安全加固"></a>安全加固</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rename-command FLUSHALL &quot;&quot;</span><br><span class="line">rename-command FLUSHDB  &quot;&quot;</span><br><span class="line">rename-command CONFIG   &quot;&quot;</span><br><span class="line">rename-command KEYS     &quot;&quot;</span><br><span class="line">rename-command SHUTDOWN &quot;&quot;</span><br><span class="line">rename-command DEL &quot;&quot;</span><br><span class="line">rename-command EVAL &quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>但是注意是否和以下故障切换是否冲突“config”</p>
<h3 id="原生主从（master-slave"><a href="#原生主从（master-slave" class="headerlink" title="原生主从（master-slave)"></a>原生主从（master-slave)</h3><p>实现高可用，暴露master节点。支持Redis所有指令。<br>使用Redis 自带的哨兵（Sentinel）集群对实例进行状态监控与 Failover。Sentinel 是 Redis 自带的高可用组件，将 Redis 注册到由多个 Sentinel 组成的 Sentinel 集群后，Sentinel 会对 Redis 实例进行健康检查，当 Redis 发生故障后，Sentinel 会通过 Gossip 协议进行故障检测，确认宕机后会通过一个简化的 Raft 协议来提升 Slave 成为新的 Master。</p>
<img src="https://img.econow.cn/medivh/1562750986206.png"  />

<p>通常情况仅使用1 个 Slave 节点进行冷备，如果有读写分离请求，可以建立多个Read only slave 来进行读写分离。</p>
<ul>
<li>只读Slave 节点可以按照需求设置 slave-priority 参数为0，防止故障切换时选择了只读节点而不是热备 Slave 节点；</li>
<li>Sentinel 进行故障切换后会执行 CONFIG REWRITE 命令将SLAVEOF 配置落地，如果 Redis 配置中禁用了 CONFIG 命令，切换时会发生错误，可以通过修改 Sentinel 代码来替换 CONFIG 命令；</li>
<li>Sentinel Group 监控的节点不宜过多，实测超过 500 个切换过程偶尔会进入 TILT 模式，导致Sentinel 工作不正常，推荐部署多个 Sentinel 集群并保证每个集群监控的实例数量小于 300 个；</li>
<li>Master 节点应与 Slave 节点跨机器部署，有能力的使用方可以跨机架部署，不推荐跨机房部署 Redis 主从实例；</li>
<li>Sentinel 切换功能主要依赖 down-after-milliseconds 和failover-timeout 两个参数，down-after-milliseconds 决定了Sentinel 判断 Redis 节点宕机的超时，知乎使用 30000 作为阈值。而 failover-timeout 则决定了两次切换之间的最短等待时间，如果对于切换成功率要求较高，可以适当缩短failover-timeout 到秒级保证切换成功，具体详见Redis 官方文档[2]；</li>
<li>单机网络故障等同于机器宕机，但如果机房全网发生大规模故障会造成主从多次切换，此时资源发现服务可能更新不够及时，需要人工介入。</li>
</ul>
<h3 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h3><p>Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：</p>
<ul>
<li>监控（Monitoring）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li>
<li>提醒（Notification）： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li>
<li>自动故障迁移（Automatic failover）： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</li>
</ul>
<p>优点：</p>
<ul>
<li>基于主从模式，所有主从的优点，sentinel都有</li>
<li>主从可以切换，故障可以转移，系统可用性好</li>
<li>是主从模式的升级，系统更健壮，可用性更高</li>
</ul>
<p>缺点：</p>
<ul>
<li>较难支持在线扩容</li>
<li>在集群容量达到上限时只能升级机器内存，而不能实现水平扩容</li>
</ul>
<p>主从同步可能会遇到的问题：</p>
<ul>
<li>端口不通</li>
<li>认证失败</li>
</ul>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>端口</th>
<th>其他</th>
</tr>
</thead>
<tbody><tr>
<td>Master,Sentinel1</td>
<td>192.168.1.233</td>
<td>6379,26379</td>
<td></td>
</tr>
<tr>
<td>slave01,Sentinel2</td>
<td>192.168.1.234</td>
<td>6379,26379</td>
<td></td>
</tr>
<tr>
<td>slave02,Sentinel3</td>
<td>192.168.1.235</td>
<td>6379,26379</td>
<td></td>
</tr>
</tbody></table>
<h4 id="配置redis文件"><a href="#配置redis文件" class="headerlink" title="配置redis文件"></a>配置redis文件</h4><ul>
<li>在3台服务器上分别安装Redis。需要注意的是，如果要给Redis设置密码，需要在3个Redis的配置文件中设置相同的密码。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#master</span><br><span class="line">requirepass &quot;Redis-Password&quot;</span><br><span class="line">#slave </span><br><span class="line">masterauth  &quot;Redis-Password&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>在2个SlaveRedis的配置文件中声明所从属的主数据库。<code>slaveof 192.168.1.233 6379</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">daemonize                   yes    </span><br><span class="line">pidfile                     /var/run/redis.pid</span><br><span class="line">port                        6379     </span><br><span class="line">bind                        192.168.1.233</span><br><span class="line">timeout                     120     </span><br><span class="line">tcp-keepalive               60     </span><br><span class="line">loglevel                    notice  </span><br><span class="line">logfile                     /var/log/redis/redis.log</span><br><span class="line">syslog-enabled              no</span><br><span class="line">databases                   16     </span><br><span class="line">stop-writes-on-bgsave-error no</span><br><span class="line">rdbcompression              yes</span><br><span class="line">rdbchecksum                 yes</span><br><span class="line">dbfilename                  dump.rdb</span><br><span class="line">dir                         /var/lib/redis</span><br><span class="line">save                        7200    100000</span><br><span class="line">maxclients                  10000    </span><br><span class="line">maxmemory                   1GB</span><br><span class="line">maxmemory-policy            volatile-lru</span><br><span class="line">maxmemory-samples           5</span><br><span class="line">appendonly                  no</span><br><span class="line">appendfilename              appendonly.aof    </span><br><span class="line">hash-max-ziplist-entries    512     </span><br><span class="line">hash-max-ziplist-value      64</span><br><span class="line">list-max-ziplist-entries    512</span><br><span class="line">list-max-ziplist-value      64</span><br><span class="line">set-max-intset-entries      512</span><br><span class="line">zset-max-ziplist-entries    128</span><br><span class="line">zset-max-ziplist-value      64</span><br><span class="line">activerehashing             yes     </span><br><span class="line">client-output-buffer-limit  normal                      0      0     0</span><br><span class="line">client-output-buffer-limit  slave                       256mb  64mb  60</span><br><span class="line">client-output-buffer-limit  pubsub                      256mb  64b   120</span><br><span class="line">hz                          10</span><br><span class="line">requirepass                 &quot;alkq2caiAmq82s&quot;</span><br><span class="line">masterauth                  &quot;alkq2caiAmq82s&quot;</span><br><span class="line">rename-command              flushall   &quot;&quot;</span><br><span class="line">rename-command              flushdb    &quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三台机器启动后检查主从状态，数量和状态对的上就没啥问题了。<br><img src="https://img.econow.cn/medivh/1562755390514.png"  /><br><img src="https://img.econow.cn/medivh/1562755494148.png"  /></p>
<h4 id="配置sentinel"><a href="#配置sentinel" class="headerlink" title="配置sentinel"></a>配置sentinel</h4><p>注意加上认证部分。<br>配置项解释：</p>
<ul>
<li><code>sentinel monitor mymaster 192.168.1.233 6379 2</code>给master取名叫mymaster，2代表集群中有两个sentinel认为master死了的时候，才能真正认为master死了。sentinel集群中通过gossip协互相通信。</li>
<li><code>down-after-milliseconds</code> sentinel会向master发送心跳PING来确认master是否存活，如果master在“一定时间范围”内不回应PONG 或者是回复了一个错误消息，那么这个sentinel会主观地(单方面地)认为这个master已经不可用了(subjectively down, 也简称为SDOWN)。而这个down-after-milliseconds就是用来指定这个“一定时间范围”的，单位是毫秒。</li>
<li><code>parallel-syncs</code>不过需要注意的是，这个时候sentinel并不会马上进行failover主备切换，这个sentinel还需要参考sentinel集群中其他sentinel的意见，如果超过某个数量的sentinel也主观地认为该master死了，那么这个master就会被客观地(注意哦，这次不是主观，是客观，与刚才的subjectively down相对，这次是objectively down，简称为ODOWN)认为已经死了。需要一起做出决定的sentinel数量在上一条配置中进行配置。</li>
<li>在发生failover主备切换时，这个选项指定了最多可以有多少个slave同时对新的master进行同步，这个数字越小，完成failover所需的时间就越长，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为 1 来保证每次只有一个slave处于不能处理命令请求的状态。</li>
</ul>
<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">bind 192.168.1.233</span><br><span class="line">logfile &quot;/var/log/redis/sentinel.log&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.1.233 6379 2</span><br><span class="line">sentinel auth-pass mymaster alkq2caiAmq82s</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">bind 192.168.1.234</span><br><span class="line">logfile &quot;/var/log/redis/sentinel.log&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.1.233 6379 2</span><br><span class="line">sentinel auth-pass mymaster alkq2caiAmq82s</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">bind 192.168.1.235</span><br><span class="line">logfile &quot;/var/log/redis/sentinel.log&quot;</span><br><span class="line">dir &quot;/var/lib/redis&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.1.233 6379 2</span><br><span class="line">sentinel auth-pass mymaster alkq2caiAmq82s</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>
<h5 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h5><p>然后依次启动，之后检查状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel.conf</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">redis-server sentinel.conf --sentinel</span><br><span class="line"></span><br><span class="line">[root@base_233 ~]# redis-cli -h 192.168.1.233 -p 26379</span><br><span class="line">192.168.1.233:26379&gt; info Sentinel</span><br><span class="line"># Sentinel</span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=192.168.1.233:6379,slaves=2,sentinels=3</span><br></pre></td></tr></table></figure>
<h5 id="检查配置文件的变化"><a href="#检查配置文件的变化" class="headerlink" title="检查配置文件的变化"></a>检查配置文件的变化</h5><img src="https://img.econow.cn/medivh/1562756643624.png"  />
<img src="https://img.econow.cn/medivh/1562756689621.png"  />

<p>发现slave机器上会自动增加其他两个节点的信息。</p>
<p>启动日志<br><img src="https://img.econow.cn/medivh/1562756729219.png"  /></p>
<h4 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h4><ul>
<li>PING ：返回 PONG 。</li>
<li>SENTINEL masters ：列出所有被监视的主服务器，以及这些主服务器的当前状态。</li>
<li>SENTINEL slaves <master name> ：列出给定主服务器的所有从服务器，以及这些从服务器的当前状态。</li>
<li>SENTINEL get-master-addr-by-name <master name> ： 返回给定名字的主服务器的 IP 地址和端口号。 如果这个主服务器正在执行故障转移操作， 或者针对这个主服务器的故障转移操作已经完成， 那么这个命令返回新的主服务器的 IP 地址和端口号。</li>
<li>SENTINEL reset <pattern> ： 重置所有名字和给定模式 pattern 相匹配的主服务器。 pattern 参数是一个 Glob 风格的模式。 重置操作清楚主服务器目前的所有状态， 包括正在执行中的故障转移， 并移除目前已经发现和关联的， 主服务器的所有从服务器和 Sentinel 。</li>
<li>SENTINEL failover <master name> ： 当主服务器失效时， 在不询问其他 Sentinel 意见的情况下， 强制开始一次自动故障迁移 （不过发起故障转移的 Sentinel 会向其他 Sentinel 发送一个新的配置，其他 Sentinel 会根据这个配置进行相应的更新）。</li>
</ul>
<h4 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h4><p>一次故障转移操作由以下步骤组成：</p>
<ul>
<li>发现主服务器已经进入客观下线状态。</li>
<li>对我们的当前纪元进行自增（详情请参考 Raft leader election ）， 并尝试在这个纪元中当选。</li>
<li>如果当选失败， 那么在设定的故障迁移超时时间的两倍之后， 重新尝试当选。 如果当选成功， 那么执行以下步骤。</li>
<li>选出一个从服务器，并将它升级为主服务器。</li>
<li>向被选中的从服务器发送 SLAVEOF NO ONE 命令，让它转变为主服务器。</li>
<li>通过发布与订阅功能， 将更新后的配置传播给所有其他 Sentinel ， 其他 Sentinel 对它们自己的配置进行更新。</li>
<li>向已下线主服务器的从服务器发送 SLAVEOF 命令， 让它们去复制新的主服务器。</li>
<li>当所有从服务器都已经开始复制新的主服务器时， 领头 Sentinel 终止这次故障迁移操作。</li>
</ul>
<blockquote>
<p>每当一个 Redis 实例被重新配置（reconfigured） —— 无论是被设置成主服务器、从服务器、又或者被设置成其他主服务器的从服务器 —— Sentinel 都会向被重新配置的实例发送一个 CONFIG REWRITE 命令， 从而确保这些配置会持久化在硬盘里。</p>
</blockquote>
<p>日志说明：</p>
<ul>
<li>+sdown 表示哨兵主观认为数据库下线</li>
<li>+odown 表示哨兵客观认为数据库下线</li>
<li>+try-failover 表示哨兵开始进行故障恢复</li>
<li>+failover-end 表示哨兵完成故障修复，其中包括了领头哨兵的选举、备选从数据库的选择等等较为复杂的过程</li>
<li>+switch-master表示主数据库从51服务器迁移到52服务器</li>
<li>+slave列出了新的主数据库的2个从数据库，而哨兵并没有彻底清除51服务器的实力信息，这是因为停止的实例有可能会在将来恢复，哨兵会让其重新加入进来</li>
</ul>
<p>故障转移过程：</p>
<ul>
<li>观察slave节点日志：master故障了<img src="https://img.econow.cn/medivh/1562816515954.png"  />
  * 发现master故障，
  * 选举出来233为master
  * 切换master
  * 更新sentinel配置文件
  * 将原来的master切换为slave，并且定义为down</li>
<li>观察sentinel配置文件，master已经切换为新的地址<img src="https://img.econow.cn/medivh/1562837169421.png"  /></li>
</ul>
<p>之前一直不成功主要的原因就是配置了<code>rename-command &quot;RENAMECONFIG&quot;</code>,导致失败的，这个要多注意一下。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ul>
<li>slave不能写<img src="https://img.econow.cn/medivh/1562837656576.png"  /></li>
</ul>
<h4 id="访问sentinel集群"><a href="#访问sentinel集群" class="headerlink" title="访问sentinel集群"></a>访问sentinel集群</h4><p>以Python为例，程序通过sentinel提供的端口进行访问，获取master地址进行写操作，读操作默认是轮询。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Python 2.6.6 (r266:84292, Jan 22 2014, 09:42:36) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; from redis.sentinel import Sentinel #加载redis模块</span><br><span class="line">&gt;&gt;&gt; sentinel = Sentinel([(&#x27;192.168.221.160&#x27;, 26379),</span><br><span class="line">...                      (&#x27;192.168.221.161&#x27;, 26379)],</span><br><span class="line">...                     socket_timeout=0.1) #连接哨兵服务器</span><br><span class="line">&gt;&gt;&gt; sentinel.discover_master(&#x27;mymaster&#x27;) #获取主redis服务器地址</span><br><span class="line">(&#x27;192.168.221.161&#x27;, 6379)</span><br><span class="line">&gt;&gt;&gt; sentinel.discover_slaves(&#x27;mymaster&#x27;)#获取从redis服务区地址</span><br><span class="line">[(&#x27;192.168.221.160&#x27;, 6379)]</span><br><span class="line">&gt;&gt;&gt; master = sentinel.master_for(&#x27;mymaster&#x27;, socket_timeout=0.1) </span><br><span class="line">&gt;&gt;&gt; master.set(&#x27;foo&#x27;,&#x27;bar&#x27;) #获取主redis服务器并进行写入</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; slave = sentinel.slave_for(&#x27;mymaster&#x27;, socket_timeout=0.1)</span><br><span class="line">&gt;&gt;&gt; slave.get(&#x27;foo&#x27;)#获取从redis服务器进行获取</span><br><span class="line">&#x27;bar&#x27;</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="集群-Cluster"><a href="#集群-Cluster" class="headerlink" title="集群(Cluster)"></a>集群(Cluster)</h2><p>cluster的出现是为了解决单机Redis容量有限的问题，将Redis的数据根据一定的规则分配到多台机器。对cluster的一些理解：</p>
<ul>
<li>cluster可以说是sentinel和主从模式的结合体，通过cluster可以实现主从和master重选功能，所以如果配置两个副本三个分片的话，就需要六个Redis实例。</li>
<li>因为Redis的数据是根据一定规则分配到cluster的不同机器的，当数据量过大时，可以新增机器进行扩容。这种模式适合数据量巨大的缓存要求，当数据量不是很大使用sentinel即可。</li>
</ul>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Redis集群是一个可以在多个Redis节点之间进行数据共享的设施。</p>
<p>Redis集群不支持需要同时处理多个键的命令，因为在执行这些命令的时候需要在多个Redis节点之间移动数据，会降低集群性能。<br>Redis集群通过分区来提供一定程度的可用性：即使集群中有一部分节点失效，集群也可以继续处理命令请求。</p>
<p>优点：</p>
<ul>
<li>将数据自动切分到多个节点的能力</li>
<li>当部分节点失效的时候，集群仍然可以继续处理命令请求</li>
</ul>
<h3 id="数据共享"><a href="#数据共享" class="headerlink" title="数据共享"></a>数据共享</h3><p>一个集群包含16384个哈希槽，数据库中的每个键都属于这16384个哈希槽的其中一个。<br>每个节点负责处理一部分哈希槽，比如一个集群有三个节点，就均分为3大块哈希槽。</p>
<p>这种哈希槽的处理方式使用处更容易或者更快的添加删除节点。比如</p>
<ul>
<li>增加节点。ABC只需要将部分哈希槽移动到新的D就可以了</li>
<li>删除节点，ABCD只需要将要删除的D节点的哈希槽移动到ABC就可以了</li>
</ul>
<h3 id="集群中的主从复制"><a href="#集群中的主从复制" class="headerlink" title="集群中的主从复制"></a>集群中的主从复制</h3><p>集群中的主从复制功能：集群中的每个节点都有N个复制品，其中一个复制品为主节点，其余的为从节点。<br>比如之前的B节点下线了，那么集群中会丢失部分哈希槽。但是如果创建集群的时候为B节点添加了从节点B1，那么在B下线的时候，B1就会为新的主节点，取代处理之前对应的哈希槽。这样集群就会正常运作了。</p>
<h3 id="集群一致性保证"><a href="#集群一致性保证" class="headerlink" title="集群一致性保证"></a>集群一致性保证</h3><p>集群不保证数据的强一致性，在特定条件下，集群可能会丢失已经被执行过的写命令。</p>
<p>使用异步复制是丢失写命令的一个原因，示例如下：</p>
<ul>
<li>客户端向主节点B发送写的命令</li>
<li>主节点B执行写命令，并向客户端放回命令回复</li>
<li>主机点B</li>
</ul>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><p>创建三个目录，然后依次修改端口，之后发送到其他节点机器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">daemonize                   yes    </span><br><span class="line">pidfile                     /var/run/redis7000.pid</span><br><span class="line">port                        6379     </span><br><span class="line">bind                        192.168.1.233</span><br><span class="line">timeout                     120     </span><br><span class="line">tcp-keepalive               60     </span><br><span class="line">loglevel                    notice  </span><br><span class="line">logfile                     /var/log/redis/redis7000.log</span><br><span class="line">syslog-enabled              no</span><br><span class="line">databases                   16     </span><br><span class="line">stop-writes-on-bgsave-error no</span><br><span class="line">rdbcompression              yes</span><br><span class="line">rdbchecksum                 yes</span><br><span class="line">dbfilename                  dump.rdb</span><br><span class="line">dir                         /usr/local/redis_cluster/7000</span><br><span class="line">save                        7200    100000</span><br><span class="line">maxclients                  10000    </span><br><span class="line">maxmemory                   1GB</span><br><span class="line">maxmemory-policy            volatile-lru</span><br><span class="line">maxmemory-samples           5</span><br><span class="line">appendonly                  no</span><br><span class="line">appendfilename              appendonly.aof    </span><br><span class="line">hash-max-ziplist-entries    512     </span><br><span class="line">hash-max-ziplist-value      64</span><br><span class="line">list-max-ziplist-entries    512</span><br><span class="line">list-max-ziplist-value      64</span><br><span class="line">set-max-intset-entries      512</span><br><span class="line">zset-max-ziplist-entries    128</span><br><span class="line">zset-max-ziplist-value      64</span><br><span class="line">activerehashing             yes     </span><br><span class="line">client-output-buffer-limit  normal                      0      0     0</span><br><span class="line">client-output-buffer-limit  slave                       256mb  64mb  60</span><br><span class="line">client-output-buffer-limit  pubsub                      256mb  64b   120</span><br><span class="line">hz                          10</span><br><span class="line"></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file  nodes.conf   </span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">7000/bin/redis-server 7000/cluster.conf</span><br><span class="line">7001/bin/redis-server 7001/cluster.conf</span><br><span class="line">7002/bin/redis-server 7002/cluster.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="1-创建集群"><a href="#1-创建集群" class="headerlink" title="1 创建集群"></a>1 创建集群</h4><p>对于5.0以前的版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis_cluster/7000/bin/redis-trib.rb create --replicas 2 192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000  192.168.1.235:7001 192.168.1.235:7002</span><br></pre></td></tr></table></figure>
<p>对于5.0的版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis_cluster/7000/bin/redis-cli --cluster  create --cluster-replicas 2   192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000  192.168.1.235:7001 192.168.1.235:7002</span><br></pre></td></tr></table></figure>

<p>如果使用了错误的版本命令，会有下面的警告信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@base_233 redis_cluster]# /usr/local/redis_cluster/7000/bin/redis-trib.rb create --replicas 2 192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000  192.168.1.235:7001 192.168.1.235:7002</span><br><span class="line">WARNING: redis-trib.rb is not longer available!</span><br><span class="line">You should use redis-cli instead.</span><br><span class="line"></span><br><span class="line">All commands and features belonging to redis-trib.rb have been moved</span><br><span class="line">to redis-cli.</span><br><span class="line">In order to use them you should call redis-cli with the --cluster</span><br><span class="line">option followed by the subcommand name, arguments and options.</span><br><span class="line"></span><br><span class="line">Use the following syntax:</span><br><span class="line">redis-cli --cluster SUBCOMMAND [ARGUMENTS] [OPTIONS]</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">redis-cli --cluster create 192.168.1.233:7000 192.168.1.233:7001 192.168.1.233:7002 192.168.1.234:7000 192.168.1.234:7001 192.168.1.234:7002 192.168.1.235:7000 192.168.1.235:7001 192.168.1.235:7002 --cluster-replicas 2</span><br><span class="line"></span><br><span class="line">To get help about all subcommands, type:</span><br><span class="line">redis-cli --cluster help</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<blockquote>
<p>redis 5.0 放弃redis-trib.rb，使用<code>redis-cli --cluster create</code>创建集群。也就是说5.0以后所有的集群操作都是通过<code>redis-cli --cluster</code> 来执行的。</p>
</blockquote>
<p>创建集群后会提示是否能更新以上的配置？选择yes</p>
<h4 id="修复集群"><a href="#修复集群" class="headerlink" title="修复集群"></a>修复集群</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis_cluster/7000/bin/redis-cli --cluster check  192.168.1.233:7001</span><br></pre></td></tr></table></figure>

<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p><a target="_blank" rel="noopener" href="https://github.com/ZhuoRoger/redismon">https://github.com/ZhuoRoger/redismon</a><br>or<br><a target="_blank" rel="noopener" href="https://github.com/iambocai/falcon-monit-scripts">https://github.com/iambocai/falcon-monit-scripts</a></p>
<h2 id="备份机制"><a href="#备份机制" class="headerlink" title="备份机制"></a>备份机制</h2><h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>每秒或者每次写操作，安全，速度不够快，也存在丢失1秒的可能。可以在从机器上开启。</p>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p>快照，定时，或者数量改变时，存储到一个二进制文件。容易恢复，文件小，但是存在不完整的可能。</p>
<p>主库开启RDB，每天<br>从库开启AOF，</p>
<p>如果只配置AOF,重启时加载AOF文件恢复数据；<br>如果同时 配置了RBD和AOF,启动是只加载AOF文件恢复数据;<br>如果只配置RBD,启动是讲加载dump文件恢复数据。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="http://doc.redisfans.com/topic/sentinel.html">http://doc.redisfans.com/topic/sentinel.html</a><br><a target="_blank" rel="noopener" href="https://redis.io/topics/sentinel-clients">sentinel客户端使用参考</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yiwangzhibujian/p/7047458.html">sentinel和cluster的对比</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Rsync+Inotify%20%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Rsync+Inotify%20%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5.html" class="post-title-link" itemprop="url">Rsync+Inotify 实时同步</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/Rsync+Inotify%20%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5.html" class="post-meta-item leancloud_visitors" data-flag-title="Rsync+Inotify 实时同步" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>需求：实时同步A机器文件到B机器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A 192.168.1.225</span><br><span class="line">B 192.168.1.226</span><br></pre></td></tr></table></figure>

<h3 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h3><img src="https://img.econow.cn/2018/1540378473281.png" width="924"/>

<h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><p>A</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install rsync</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后修改配置文件<br>&#x2F;etc&#x2F;rsyncd.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pid file = /var/run/rsync.pid</span><br><span class="line">log file = /var/log/rsync.log</span><br><span class="line">lock file=/var/run/rsync.lock</span><br><span class="line">secrets file = /etc/rsync.pwss</span><br><span class="line">transfer logging = yes</span><br><span class="line">address=192.168.1.226</span><br><span class="line">[data]</span><br><span class="line">path = /home/joy/imkefu/apache-tomcat-8.0.45/webapps/ROOT/WEB-INF/classes</span><br><span class="line">comment = data</span><br><span class="line">port = 873</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line">timeout = 600</span><br><span class="line">max connections = 200</span><br><span class="line">use chroot = no</span><br><span class="line">read only = no</span><br><span class="line">hosts allow = 192.168.1.225</span><br></pre></td></tr></table></figure>
<p>设置验证文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#/etc/rsync.pass</span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line">#chmod 600 /etc/rsync.pass</span><br></pre></td></tr></table></figure>
<p>启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rsyncd</span><br></pre></td></tr></table></figure>

<p>B</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install rsync</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>设置验证文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#/etc/rsync.pass</span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line">#chmod 600 /etc/rsync.pass</span><br></pre></td></tr></table></figure>
<h3 id="Inotify"><a href="#Inotify" class="headerlink" title="Inotify"></a>Inotify</h3><h4 id="安装inotify"><a href="#安装inotify" class="headerlink" title="安装inotify"></a>安装inotify</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src</span><br><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class="line">tar zxf inotify-tools-3.14.tar.gz</span><br><span class="line">cd inotify-tools-3.14</span><br><span class="line">./configure –prefix=/usr/local/inotify-3.14</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h4 id="同步脚本"><a href="#同步脚本" class="headerlink" title="同步脚本"></a>同步脚本</h4><p>A</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#currentdate=`date +%Y%m%d%H%M`</span><br><span class="line"></span><br><span class="line">src=/home/joy/imkefu/apache-tomcat-8.0.45/webapps/ROOT/WEB-INF/classes/</span><br><span class="line">des=data</span><br><span class="line">user=root</span><br><span class="line">host=192.168.1.226</span><br><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%d/%m/%y %H:%M&#x27; --format &#x27;%T %w%f%e&#x27; -e modify,delete,create,attrib $src | while read files</span><br><span class="line">do</span><br><span class="line">/usr/bin/rsync -vzrtopg  --progress --delete --password-file=/etc/rsyncd.pass $src $user@$host::$des</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>然后执行该脚本。。。</p>
<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><ul>
<li>可以先拿无关目录测试</li>
<li>检查pass文件权限必须是600</li>
<li>module名字必须保持一致</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/SpringBoot%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%BE%93%E5%87%BA%E5%88%B0ELK.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/SpringBoot%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%BE%93%E5%87%BA%E5%88%B0ELK.html" class="post-title-link" itemprop="url">SpringBoot日志收集输出到ELK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/SpringBoot%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%BE%93%E5%87%BA%E5%88%B0ELK.html" class="post-meta-item leancloud_visitors" data-flag-title="SpringBoot日志收集输出到ELK" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>注意logstash启动的时候有个坑，如果启动指定目录，那么必须保证该目录下都是配置文件，否则就会误以为都是配置文件。</p>
</blockquote>
<h2 id="配置pom文件"><a href="#配置pom文件" class="headerlink" title="配置pom文件"></a>配置pom文件</h2><h2 id="配置logback"><a href="#配置logback" class="headerlink" title="配置logback"></a>配置logback</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;configuration debug=&quot;false&quot;&gt; </span><br><span class="line">  &lt;springProperty scope=&quot;context&quot; name=&quot;logPath&quot; source=&quot;joy.logback.path&quot;/&gt;  </span><br><span class="line">  &lt;springProperty scope=&quot;context&quot; name=&quot;logName&quot; source=&quot;spring.application.name&quot;/&gt;  </span><br><span class="line">  &lt;property name=&quot;LOG_HOME&quot; value=&quot;$&#123;logPath&#125;/logs&quot;/&gt;  </span><br><span class="line">  &lt;property name=&quot;LOG_NAME&quot; value=&quot;$&#123;logName&#125;&quot;/&gt;  </span><br><span class="line">  &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; </span><br><span class="line">    &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt; </span><br><span class="line">      &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt; </span><br><span class="line">    &lt;/encoder&gt; </span><br><span class="line">  &lt;/appender&gt;  </span><br><span class="line"> </span><br><span class="line">  &lt;appender name=&quot;stash&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt; </span><br><span class="line">    &lt;destination&gt;172.16.16.13:4568&lt;/destination&gt;  </span><br><span class="line">    &lt;encoder charset=&quot;UTF-8&quot; class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot;/&gt; </span><br><span class="line">  &lt;/appender&gt;  </span><br><span class="line">  &lt;root level=&quot;INFO&quot;&gt; </span><br><span class="line">    &lt;appender-ref ref=&quot;stash&quot;/&gt;  </span><br><span class="line">    &lt;appender-ref ref=&quot;STDOUT&quot;/&gt; </span><br><span class="line">  &lt;/root&gt; </span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<p>此处定义的level是指程序里的INFO，代表INFO级别的日志都输出至logstash。</p>
<h2 id="配置logstash"><a href="#配置logstash" class="headerlink" title="配置logstash"></a>配置logstash</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">        tcp &#123;</span><br><span class="line">        	add_field =&gt; &#123; &quot;serverType&quot; =&gt; &quot;collect&quot;&#125;</span><br><span class="line">                mode =&gt; &quot;server&quot;</span><br><span class="line">                host =&gt; &quot;0.0.0.0&quot;</span><br><span class="line">                port =&gt; 4568</span><br><span class="line">        	codec =&gt; json &#123; charset =&gt; &quot;UTF-8&quot;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;(?&lt;datetime&gt;\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;\s\d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;.\d&#123;3&#125;)  INFO %&#123;NUMBER:thread&#125; --- %&#123;SYSLOG5424SD:task&#125; %&#123;JAVACLASS:javaclass&#125;\s*: %&#123;SYSLOG5424SD:module&#125;\s*%&#123;GREEDYDATA:msg&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        convert =&gt; [&quot;[geoip][coordinates]&quot;, &quot;float&quot;]</span><br><span class="line">        remove_field =&gt; [&quot;tags&quot;, &quot;offset&quot;, &quot;host&quot;, &quot;beat&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">    if [serverType] == &quot;collect&quot; &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;127.0.0.1:9200&quot;]</span><br><span class="line">            index =&gt; &quot;collcet-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/RabbitMQ%20%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/RabbitMQ%20%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.html" class="post-title-link" itemprop="url">RabbitMQ 集群部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/RabbitMQ%20%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.html" class="post-meta-item leancloud_visitors" data-flag-title="RabbitMQ 集群部署" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install erlang -y</span><br></pre></td></tr></table></figure>
<h3 id="安装服务"><a href="#安装服务" class="headerlink" title="安装服务"></a>安装服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/</span><br><span class="line">wget http://www.rabbitmq.com/releases/rabbitmq-server/v3.6.4/rabbitmq-server-3.6.4-1.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum install rabbitmq-server-3.6.4-1.noarch.rpm -y</span><br></pre></td></tr></table></figure>

<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#启动服务</span><br><span class="line">service rabbitmq-server start</span><br><span class="line">#查看服务状态</span><br><span class="line">service rabbitmq-server status</span><br></pre></td></tr></table></figure>

<h2 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h2><h3 id="增加账号"><a href="#增加账号" class="headerlink" title="增加账号"></a>增加账号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#增加</span><br><span class="line">rabbitmqctl  add_user  admin  &#x27;admin&#x27;</span><br><span class="line">#角色分配</span><br><span class="line">rabbitmqctl  set_user_tags admin administrator</span><br></pre></td></tr></table></figure>
<h3 id="vhost"><a href="#vhost" class="headerlink" title="vhost"></a>vhost</h3><p>运行多个vhost，以便于适用不同的业务需要，这样做既可以满足权限配置的要求，避免不同业务之间队列、交换机的命名冲突问题，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#vhost </span><br><span class="line">rabbitmqctl add_vhost personas</span><br><span class="line">rabbitmqctl set_permissions -p personas joy &#x27;.*&#x27; &#x27;.*&#x27; &#x27;.*&#x27;</span><br></pre></td></tr></table></figure>


<h3 id="管理界面"><a href="#管理界面" class="headerlink" title="管理界面"></a>管理界面</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<h2 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h2><h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><p>RabbitMQ 的 Cluster 集群模式一般分为两种，普通模式和镜像模式。</p>
<p>普通模式：默认的集群模式，以两个节点（rabbit01、rabbit02）为例来进行说明。对于 Queue 来说，消息实体只存在于其中一个节点 rabbit01（或者 rabbit02），rabbit01 和 rabbit02 两个节点仅有相同的元数据，即队列的结构。当消息进入 rabbit01 节点的 Queue 后，consumer 从 rabbit02 节点消费时，RabbitMQ 会临时在 rabbit01、rabbit02 间进行消息传输，把 A 中的消息实体取出并经过 B 发送给 consumer。所以 consumer 应尽量连接每一个节点，从中取消息。即对于同一个逻辑队列，要在多个节点建立物理 Queue。否则无论 consumer 连 rabbit01 或 rabbit02，出口总在 rabbit01，会产生瓶颈。当 rabbit01 节点故障后，rabbit02 节点无法取到 rabbit01 节点中还未消费的消息实体。如果做了消息持久化，那么得等 rabbit01 节点恢复，然后才可被消费；如果没有持久化的话，就会产生消息丢失的现象。<br>镜像模式：将需要消费的队列变为镜像队列，存在于多个节点，这样就可以实现 RabbitMQ 的 HA 高可用性。作用就是消息实体会主动在镜像节点之间实现同步，而不是像普通模式那样，在 consumer 消费数据时临时读取。缺点就是，集群内部的同步通讯会占用大量的网络带宽。</p>
<h3 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h3><ul>
<li>RAM node：内存节点将所有的队列、交换机、绑定、用户、权限和 vhost 的元数据定义存储在内存中，好处是可以使得像交换机和队列声明等操作更加的快速。</li>
<li>Disk node：将元数据存储在磁盘中，单节点系统只允许磁盘类型的节点，防止重启 RabbitMQ 的时候，丢失系统的配置信息。<blockquote>
<p>RabbitMQ 要求在集群中至少有一个磁盘节点，所有其他节点可以是内存节点，当节点加入或者离开集群时，必须要将该变更通知到至少一个磁盘节点。如果集群中唯一的一个磁盘节点崩溃的话，集群仍然可以保持运行，但是无法进行其他操作（增删改查），直到节点恢复。<br>解决方案：设置两个磁盘节点，至少有一个是可用的，可以保存元数据的更改。</p>
</blockquote>
</li>
</ul>
<h3 id="认证方式"><a href="#认证方式" class="headerlink" title="认证方式"></a>认证方式</h3><p>通过Erlang Cookie，相当于共享秘钥的概念，长度任意，只要所有节点都一致即可。rabbitmq server在启动的时候，erlang VM会自动创建一个随机的cookie文件。cookie文件的位置： &#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie 或者&#x2F;root&#x2F;.erlang.cookie。我们的为保证cookie的完全一致，采用从一个节点copy的方式，实现各个节点的cookie文件一致。</p>
<p>注意该文件默认是400权限，修改后需要还原回去400。</p>
<h3 id="集群组建"><a href="#集群组建" class="headerlink" title="集群组建"></a>集群组建</h3><p>首先保证所有节点都可以正常启动服务。</p>
<h4 id="停止服务"><a href="#停止服务" class="headerlink" title="停止服务"></a>停止服务</h4><p>在所有节点执行以下操作，停止服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rabbitmq-server stop</span><br></pre></td></tr></table></figure>
<h4 id="集群启动"><a href="#集群启动" class="headerlink" title="集群启动"></a>集群启动</h4><p>1、所有节点执行以下操作，启动集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server -detached</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-detached<br>Start the server process in the background. Note that this will cause the pid not to be written to the pid file.</p>
</blockquote>
<blockquote>
<p>For example, runs RabbitMQ AMQP server in the background:<br>rabbitmq-server -detached</p>
</blockquote>
<p>该参数简单说就是后台启动，始终没理解和<code>service rabbitmq-server sart</code>的区别</p>
<p>2、修改统一hosts文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.233 r0</span><br><span class="line">192.168.1.234 r1</span><br><span class="line">192.168.1.232 r2</span><br><span class="line">192.168.1.229 r3</span><br></pre></td></tr></table></figure>

<p>3、同步.erlang.cookie文件<br>所有节点从r0机器分发 <code>/var/lib/rabbitmq/.erlang.cookie </code>。</p>
<p>4、在其他节点服务器操作加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//默认是磁盘节点，如果是内存节点的话，需要加--ram参数</span><br><span class="line"></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl join_cluster --ram rabbit@r0</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl join_cluster rabbit@r0</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="验证集群"><a href="#验证集群" class="headerlink" title="验证集群"></a>验证集群</h4><p>1、节点加入集群，此处使用的主机名意义和hosts中一个意义。<br><img src="https://img.econow.cn/medivh/1553065925609.png" /></p>
<p>2、加入集群后，检查集群状态<br><img src="https://img.econow.cn/medivh/1553065954361.png" /></p>
<img src="https://img.econow.cn/medivh/1553069420891.png" />

<h4 id="问题整理"><a href="#问题整理" class="headerlink" title="问题整理"></a>问题整理</h4><ul>
<li><p>之前加入集群的时候总提示错误<code>rror: unable to connect to node rabbit@test_229: nodedown</code></p>
<img src="https://img.econow.cn/medivh/1553066819130.png" />
原因：在集群的所有机器都需要先执行`rabbitmq-server -detached`
</li>
<li><p>unable to connect to epmd (port 4369) on base_233: nxdomain (non-existing domain)</p>
</li>
</ul>
<p>原因：未启用管理插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<h4 id="集群节点操作"><a href="#集群节点操作" class="headerlink" title="集群节点操作"></a>集群节点操作</h4><p>节点恢复过程中把数据删掉很重要，恢复一单结点，再清数据<br>节点增加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. rabbitmq-server -detached   --- .erlang.cooike的权限，400 属主rabbitmq</span><br><span class="line">2. rabbitmqctl stop_app</span><br><span class="line">3. rabbitmqctl join_cluster --ram rabbit@rabbitmq1</span><br><span class="line">4. rabbitmqctl start_app</span><br><span class="line">5. rabbitmqctl  cluster_status</span><br></pre></td></tr></table></figure>
<p>节点删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.  rabbitmq-server -detached</span><br><span class="line">以上为基础，正常运行的mq节点直接进行2、3两步；4可省略或更改为rabbitmqctl stop</span><br><span class="line">2. rabbitmqctl stop_app</span><br><span class="line">3. rabbitmqctl reset </span><br><span class="line">4. rabbitmqctl start_app</span><br></pre></td></tr></table></figure>
<p>硬删除：<br>直接删掉集群中的某个节点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl forget_cluster_node   node_name</span><br></pre></td></tr></table></figure>
<p>由disc–&gt;ram</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.节点删除     rabbitmq-server -detached ---rabbitctl stop_app----    rabbitmqctl reset  （（--2.清除原数据（暂时备份到其他地方）--rabbitmqctl join_cluster --ram rabbit@rabbitmq1 ------------    rabbitmqctl start_app））</span><br><span class="line">2.清除原数据（暂时备份到其他地方）</span><br><span class="line">3.节点增加</span><br></pre></td></tr></table></figure>
<p>由disc–&gt;ram<br>先恢复到单结点，重启，清数据<br>加集群 </p>
<h3 id="镜像队列"><a href="#镜像队列" class="headerlink" title="镜像队列"></a>镜像队列</h3><h4 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h4><p>1、在管理界面配置<br><img src="https://img.econow.cn/medivh/1553134452790.png" /></p>
<ul>
<li><p>Virtual host： 可选参数，针对指定vhost下的queue进行设置</p>
</li>
<li><p>Name: policy的名称</p>
</li>
<li><p>Pattern: queue的匹配模式(正则表达式)</p>
</li>
<li><p>Definition：镜像定义，包括三个部分ha-mode, ha-params, ha-sync-mode</p>
<ul>
<li>ha-mode:指明镜像队列的模式，有效值为 all&#x2F;exactly&#x2F;nodes<ul>
<li>all：表示在集群中所有的节点上进行镜像</li>
<li>exactly：表示在指定个数的节点上进行镜像，节点的个数由ha-params指定</li>
<li>nodes：表示在指定的节点上进行镜像，节点名称通过ha-params指定</li>
</ul>
</li>
<li>ha-params：ha-mode模式需要用到的参数</li>
<li>ha-sync-mode：进行队列中消息的同步方式，有效值为automatic和manual</li>
</ul>
</li>
<li><p>priority：可选参数，policy的优先级</p>
</li>
</ul>
<p>2、任意节点命令行配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy ha-all &quot;^&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">// 命令行方式添加策略</span><br><span class="line">// 策略名称为ha-allqueue,策略模式为 all 即复制到所有节点，包含新增节点，策略正则表达式为 “^” 表示所有匹配所有队列名称。</span><br><span class="line">rabbitmqctl set_policy -p &lt;vhost&gt; ha-allqueue&quot;^&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这时候就变成多个节点了。<br><img src="https://img.econow.cn/medivh/1553135352884.png" /></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>AProxy 是一个免费的负载均衡软件，可以运行于大部分主流的 Linux 操作系统上。</p>
<p>HAProxy 提供了 L4(TCP) 和 L7(HTTP) 两种负载均衡能力，具备丰富的功能。HAProxy 的社区非常活跃，版本更新快速（最新稳定版 1.7.2 于 2017&#x2F;01&#x2F;13 推出）。最关键的是，HAProxy 具备媲美商用负载均衡器的性能和稳定性。它当前不仅仅是免费负载均衡软件的首选，更几乎成为了唯一选择。</p>
<p>因为 RabbitMQ 本身不提供负载均衡，下面我们就搭建 HAProxy，用作 RabbitMQ 集群的负载均衡。    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line">cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span><br><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>haproxy配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log     127.0.0.1  local0 info</span><br><span class="line">    log     127.0.0.1  local1 notice</span><br><span class="line">    daemon</span><br><span class="line">    maxconn 4096</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log     global</span><br><span class="line">    mode    tcp</span><br><span class="line">    option  tcplog</span><br><span class="line">    option  dontlognull</span><br><span class="line">    retries 3</span><br><span class="line">    option  abortonclose</span><br><span class="line">    maxconn 4096</span><br><span class="line">    timeout connect  5000ms</span><br><span class="line">    timeout client  3000ms</span><br><span class="line">    timeout server  3000ms</span><br><span class="line">    balance roundrobin</span><br><span class="line"></span><br><span class="line">listen private_monitoring</span><br><span class="line">    bind    0.0.0.0:8100</span><br><span class="line">    mode    http</span><br><span class="line">    option  httplog</span><br><span class="line">    stats   refresh  5s</span><br><span class="line">    stats   uri  /stats</span><br><span class="line">    stats   realm   Haproxy</span><br><span class="line">    stats   auth  admin:admin</span><br><span class="line"></span><br><span class="line">listen rabbitmq_admin</span><br><span class="line">    bind    0.0.0.0:8102</span><br><span class="line">    server  r0 r0:15672</span><br><span class="line">    server  r3 r3:15672</span><br><span class="line"></span><br><span class="line">listen rabbitmq_cluster</span><br><span class="line">    bind    0.0.0.0:8101</span><br><span class="line">    mode    tcp</span><br><span class="line">    option  tcplog</span><br><span class="line">    balance roundrobin</span><br><span class="line">    timeout client  3h</span><br><span class="line">    timeout server  3h</span><br><span class="line">    server  r0  r0:5672  check  inter  5000  rise  2  fall  3</span><br><span class="line">    server  r3  r3:5672  check  inter  5000  rise  2  fall  3</span><br></pre></td></tr></table></figure>

<p>启动 haproxy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">haproxy -f /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>
<p>HAProxy 配置了三个地址：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://r0:8100/stats%EF%BC%9AHAProxy">http://r0:8100/stats：HAProxy</a> 负载均衡信息地址，账号密码：admin&#x2F;admin。</li>
<li><a href="http://r0:8101：RabbitMQ">http://r0:8101：RabbitMQ</a> Server Web 管理界面（基于负载均衡）。</li>
<li><a href="http://r0:8102：RabbitMQ">http://r0:8102：RabbitMQ</a> Server 服务地址（基于负载均衡）。<br>通过访问<a target="_blank" rel="noopener" href="http://r0:8100/stats%EF%BC%8C%E6%9F%A5%E7%9C%8B">http://r0:8100/stats，查看</a> HAProxy 负载均衡信息：</li>
</ul>
<p>实际程序访问的端口为8101</p>
<p>这样，haproxy就可以使用啦。<br><img src="https://img.econow.cn/medivh/1553075635396.png" /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Python%E6%89%B9%E9%87%8F%E8%BD%AC%E6%8D%A2HTML%E4%B8%BAPDF.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Python%E6%89%B9%E9%87%8F%E8%BD%AC%E6%8D%A2HTML%E4%B8%BAPDF.html" class="post-title-link" itemprop="url">Python批量转换HTML为PDF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
    <span id="/Python%E6%89%B9%E9%87%8F%E8%BD%AC%E6%8D%A2HTML%E4%B8%BAPDF.html" class="post-meta-item leancloud_visitors" data-flag-title="Python批量转换HTML为PDF" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="wkhtmltopdf"><a href="#wkhtmltopdf" class="headerlink" title="wkhtmltopdf"></a>wkhtmltopdf</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>wkhtmltopdf and wkhtmltoimage are open source (LGPLv3) command line tools to render HTML into PDF and various image formats using the Qt WebKit rendering engine. These run entirely “headless” and do not require a display or display service.  </p>
</blockquote>
<p>wkhtmltopdf 和 wkhtmltoimage是一个开元的命令行工具，用来转换html为pdf和各种图像格式。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://wkhtmltopdf.org/downloads.html">https://wkhtmltopdf.org/downloads.html</a><br>mac的话可以直接安装了，其他系统就看着办吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install Caskroom/cask/wkhtmltopdf</span><br></pre></td></tr></table></figure>

<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><ul>
<li>Download a precompiled binary or build from source</li>
<li>Create your HTML document that you want to turn into a PDF (or image)</li>
<li>Run your HTML document through the tool.</li>
<li>For example, if I really like the treatment Google has done to their logo today and want to capture it forever as a PDF:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wkhtmltopdf http://google.com google.pdf</span><br></pre></td></tr></table></figure>
下载安装-》创建HTML文件-》命令行执行</li>
</ul>
<h2 id="Pdfkit"><a href="#Pdfkit" class="headerlink" title="Pdfkit"></a>Pdfkit</h2><p>A JavaScript PDF generation library for Node and the browser.</p>
<h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>PDFKit is a PDF document generation library for Node and the browser that makes creating complex, multi-page, printable documents easy. It’s written in CoffeeScript, but you can choose to use the API in plain ‘ol JavaScript if you like. The API embraces chainability, and includes both low level functions as well as abstractions for higher level functionality. The PDFKit API is designed to be simple, so generating complex documents is often as simple as a few function calls.</p>
</blockquote>
<p>pdfkit 是 wkhtmltopdf 的Python封装包。</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install pdfkit</span><br><span class="line">or </span><br><span class="line">pip install pdfkit</span><br></pre></td></tr></table></figure>
<h3 id="支持模块"><a href="#支持模块" class="headerlink" title="支持模块"></a>支持模块</h3><img src="https://img.econow.cn/medivh/1545302451080.png" /> 

<p>支持以下方式：</p>
<ul>
<li>URL</li>
<li>文件</li>
<li>字符串</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pdfkit.from_url(&#x27;https://www.google.com.hk&#x27;,&#x27;out1.pdf&#x27;)   </span><br><span class="line">pdfkit.from_file(&#x27;123.html&#x27;,&#x27;out2.pdf&#x27;)  </span><br><span class="line">pdfkit.from_string(&#x27;Hello!&#x27;,&#x27;out3.pdf&#x27;)</span><br></pre></td></tr></table></figure>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!usr/bin/env python</span><br><span class="line"># -*- coding:utf-8 _*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">@author:medivh</span><br><span class="line">@file: html_to_pdf.py</span><br><span class="line">@time: 2018/12/20</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import pdfkit</span><br><span class="line">import os</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">src = &#x27;/Users/medivh/Downloads/tmp/new/&#x27;</span><br><span class="line">desc = &#x27;/Users/medivh/Downloads/tmp/new-pdf/&#x27;</span><br><span class="line"># read file path and destination path</span><br><span class="line">sem = threading.Semaphore(10)</span><br><span class="line">#控制线程数量</span><br><span class="line">try:</span><br><span class="line">    os.mkdir(desc)</span><br><span class="line">except:</span><br><span class="line">    pass</span><br><span class="line">def ToPdf(filename):</span><br><span class="line">    with  sem:</span><br><span class="line">        try:</span><br><span class="line">            with open(src + filename, encoding=&quot;utf-8&quot;) as f:</span><br><span class="line">                pdf_name = desc + filename[:-6] + &#x27;.pdf&#x27;</span><br><span class="line">                #拼接文件名</span><br><span class="line">                pdfkit.from_file(f, pdf_name)</span><br><span class="line">        except:</span><br><span class="line">            print(filename)</span><br><span class="line"></span><br><span class="line">threads = list()</span><br><span class="line">for i in os.listdir(src):</span><br><span class="line">    t = threading.Thread(target=ToPdf, args=(i,))</span><br><span class="line">    threads.append(t)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    for t in threads:</span><br><span class="line">        t.setDaemon(True)</span><br><span class="line">        t.start()</span><br><span class="line">    for t in threads:</span><br><span class="line">        t.join()</span><br><span class="line">    start = len(os.listdir(src))</span><br><span class="line">    end = len(os.listdir(desc))</span><br><span class="line">    print(start,end)</span><br><span class="line">    if start == end:</span><br><span class="line">        print(&#x27;ok&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        print(&#x27;no&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><ul>
<li><code>&#39;ascii&#39; codec can&#39;t decode byte 0xb4 in position 11: ordinal not in range(128）</code><ul>
<li>解决：加上encoding,<code>with open(src + filename, encoding=&quot;utf-8&quot;)</code></li>
</ul>
</li>
<li>注意文件数量，否则数量太大而且没设置线程数的话机器会卡死<ul>
<li>解决：使用<code>threading.Semaphore(10)</code></li>
</ul>
</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="http://pdfkit.org/">http://pdfkit.org/</a><br><a target="_blank" rel="noopener" href="https://wkhtmltopdf.org/index.html">https://wkhtmltopdf.org/index.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Python%E5%B8%B8%E7%94%A8%E6%95%B4%E7%90%86.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Python%E5%B8%B8%E7%94%A8%E6%95%B4%E7%90%86.html" class="post-title-link" itemprop="url">Python常用整理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
    <span id="/Python%E5%B8%B8%E7%94%A8%E6%95%B4%E7%90%86.html" class="post-meta-item leancloud_visitors" data-flag-title="Python常用整理" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="logging-日志模块写入中文编码错误解决方法"><a href="#logging-日志模块写入中文编码错误解决方法" class="headerlink" title="logging 日志模块写入中文编码错误解决方法"></a>logging 日志模块写入中文编码错误解决方法</h3><p>在logging.FileHandler(path) 中添加指定编码方式 encoding&#x3D;’utf-8’ 即可，logging.FileHandler(path, encoding&#x3D;’utf-8’) 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 18/8/16 10:40</span><br><span class="line"># @Author  : Medivh</span><br><span class="line"></span><br><span class="line">import functools</span><br><span class="line">import logging</span><br><span class="line">import logging.handlers</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">LOG_FILE = os.path.join(os.path.dirname(os.path.realpath(__file__)), &#x27;logs&#x27;, &#x27;logger.log&#x27;)</span><br><span class="line">handler = logging.handlers.RotatingFileHandler(LOG_FILE, maxBytes=1024 * 1024, backupCount=10, encoding=&#x27;utf-8&#x27;)</span><br><span class="line">fmt = &#x27;[%(levelname)s]: %(asctime)s - %(filename)s - %(funcName)s - %(threadName)s - %(message)s&#x27;</span><br><span class="line"></span><br><span class="line">formatter = logging.Formatter(fmt)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(&#x27;logger&#x27;)</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def log(func):</span><br><span class="line">    @functools.wraps(func)</span><br><span class="line">    def wrapper(*args, **kw):</span><br><span class="line">        logging.info(&#x27;call %s():&#x27; % func.__name__)</span><br><span class="line">        return func(*args, **kw)</span><br><span class="line"></span><br><span class="line">    return wrapper</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/PPTP-VPN%20%E4%BD%BF%E7%94%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PPTP-VPN%20%E4%BD%BF%E7%94%A8.html" class="post-title-link" itemprop="url">远程办公工具配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>

  
    <span id="/PPTP-VPN%20%E4%BD%BF%E7%94%A8.html" class="post-meta-item leancloud_visitors" data-flag-title="远程办公工具配置" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>公司内网环境VPN有两种连接方式，PPTP和L2TP。其中PPTP连接较为简单，L2TP作为备用方式（OS X 系统只支持L2TP）</p>
</blockquote>
<h2 id="PPTP"><a href="#PPTP" class="headerlink" title="PPTP"></a>PPTP</h2><p>推荐使用该方式，操作简单</p>
<h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p>1 网络-》增加</p>
<img src="https://img.econow.cn/medivh/1553150666742.png" />


<p>2 选择VPN类型</p>
<img src="https://img.econow.cn/medivh/1553150619851.png" />

<p>3 填写信息<br><img src="https://img.econow.cn/medivh/1555220994661.png"  /></p>
<p>4 点击应用，选择存储配置<br><img src="https://img.econow.cn/medivh/1553150821150.png" /></p>
<p>5 点击连接</p>
<p>6 输入密码即可<br><img src="https://img.econow.cn/medivh/1553150930004.png" /></p>
<p>7 正常状态</p>
<img src="https://img.econow.cn/medivh/1555220885060.png"  />


<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>1 新建连接<br><img src="https://img.econow.cn/medivh/1553151087777.png" /><br>2 选择连接到工作区<br><img src="https://img.econow.cn/medivh/1553151118428.png" /><br>3 选择第一种<br><img src="https://img.econow.cn/medivh/1553151166006.png" /><br>4 填写IP地址，点击创建<br><img src="https://img.econow.cn/medivh/1555220947107.png"  /></p>
<p>5 连接</p>
<img src="https://img.econow.cn/medivh/1553151257736.png" />

<p>6 输入用户名和密码<br><img src="https://img.econow.cn/medivh/1553151297480.png" /></p>
<p>7 如果顺利，就会提示已连接<br><img src="https://img.econow.cn/medivh/1553151325810.png" /></p>
<h2 id="L2TP"><a href="#L2TP" class="headerlink" title="L2TP"></a>L2TP</h2><p>对于一些新款设备只支持该方式。</p>
<h3 id="Mac-1"><a href="#Mac-1" class="headerlink" title="Mac"></a>Mac</h3><p>对于windows系统来说可以直接配置，不需要修改一下文件。<br>准备工作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ppp/options</span><br><span class="line"></span><br><span class="line">#在options文件中输入：</span><br><span class="line"></span><br><span class="line">plugin L2TP.ppp</span><br><span class="line">l2tpnoipsec</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1、新建<br><img src="https://img.econow.cn/medivh/1555221072317.png"  /></p>
<p>2、填写信息<br><img src="https://img.econow.cn/medivh/1555221109294.png"  /></p>
<p>3、密码<br>该部分分为用户密码和共享密钥(123456)<br><img src="https://img.econow.cn/medivh/1555221192662.png"  /></p>
<p>4、连接</p>
<img src="https://img.econow.cn/medivh/1555221249767.png"  />


<p>5、如果出现一下情况，请检查前面的修改配置文件。<br><img src="https://img.econow.cn/medivh/1555221742632.png"  /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"g1GwilqmVAUne2tDEDncEChG-gzGzoHsz","app_key":"YB2e5dSKMmMYYCtaSzxp9fdS","server_url":null,"security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
