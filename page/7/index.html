<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.econow.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.econow.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/page/7/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?21ded952ca9fc25e2b0630494a17ec7f"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a href="/search" rel="section"><i class="fa fa-search fa-fw"></i>搜索</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%20Linux%E7%A3%81%E7%9B%98%20LVM.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%20Linux%E7%A3%81%E7%9B%98%20LVM.html" class="post-title-link" itemprop="url">Linux磁盘 LVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-31 10:15:08" itemprop="dateCreated datePublished" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/%20Linux%E7%A3%81%E7%9B%98%20LVM.html" class="post-meta-item leancloud_visitors" data-flag-title="Linux磁盘 LVM" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="GPT分区"><a href="#GPT分区" class="headerlink" title="GPT分区"></a>GPT分区</h2><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>您的Linux实例上已经安装了parted工具和e2fsprogs工具。</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>运行命令parted &#x2F;dev&#x2F;vdd开始分区。<br>运行命令mklabel gpt，将默认的MBR分区格式转为GPT分区格式。<br>运行命令mkpart primary 1 100%，划分一个主分区，并设置分区的开始位置和结束位置。<br>运行命令align-check optimal 1检查分区是否对齐。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ecshost~ ]# yum install -y parted</span><br><span class="line">[root@ecshost~ ]# yum install -y e2fsprogs</span><br></pre></td></tr></table></figure>

<img src="https://img.econow.cn/medivh/1562063734050.png"  />

<img src="https://img.econow.cn/medivh/1562063851890.png"  />


<h2 id="名词解释："><a href="#名词解释：" class="headerlink" title="名词解释："></a>名词解释：</h2><ul>
<li><p>PV（Phsical Volume，物理卷），PV是VG的组成部分，有分区构成，多块盘的时候，可以把一块盘格式化成一个主分区，然后用这个分区做成一个PV，只有一块盘的时候，可以这块盘的某一个分区做成一个PV，实际上一个PV就一个分区。</p>
</li>
<li><p>VG（Volume Group， 卷组），有若干个PV组成，作用就是将PV组成到以前，然后再重新划分空间。</p>
</li>
<li><p>LV（Logical Volume，逻辑卷），LV就是从VG中划分出来的卷，LV的使用要比PV灵活的多，可以在空间不够的情况下，增加空间。</p>
</li>
</ul>
<img src="https://img.econow.cn/medivh/1560482143355.png"  />

<p>就像图中所示，三块物理磁盘组成物理卷工170G；然后三个pv组成一个VG为170G；最后从VG里面分出多个LV。其中VG可以当成一块大盘。</p>
<h2 id="实现LVM"><a href="#实现LVM" class="headerlink" title="实现LVM"></a>实现LVM</h2><p>针对于&#x2F;dev&#x2F;vdc磁盘为例<br>###1、格式化磁盘<br><img src="https://img.econow.cn/medivh/1560484200006.png"  /><br><img src="https://img.econow.cn/medivh/1560484253384.png"  /></p>
<p>###2、创建PV<br>命令“pvcreate ＋分区”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/vdc1</span><br></pre></td></tr></table></figure>
<img src="https://img.econow.cn/medivh/1560484437686.png"  />
###3、创建VG
命令“vgcreate ＋分区号＋分区号"
<img src="https://img.econow.cn/medivh/1560484533113.png"  />
###4、创建lv
命令“lvcreate -L Size(要建的LV大小） -n LV名+VG名”，也可以用命令“lvdisplay和lvscan”来查看LV的详细信息
<img src="https://img.econow.cn/medivh/1560491383392.png"  />

<h3 id="5、调整大小"><a href="#5、调整大小" class="headerlink" title="5、调整大小"></a>5、调整大小</h3><p>建立好lV后我们还可以通过命令“lvextend -L +Size（就是增加多少空间）＋LV的绝对路径”来增加LV的空间大小。也可以通过“lvreduce -L -Size（就是减小多少空间）＋LV的绝对路径”来减少LV的空间大小</p>
<h3 id="6、操作"><a href="#6、操作" class="headerlink" title="6、操作"></a>6、操作</h3><p>以上的PV、VG、LV、都可以通过“pvremove +分区号、vgremove +VG名称、lvremove +lv的绝对路径（如lvremove &#x2F;dev&#x2F;vg_liwei&#x2F;lv_liwei）”命令来删除。这里就不截图了。</p>
<h3 id="７、使用"><a href="#７、使用" class="headerlink" title="７、使用"></a>７、使用</h3><p>做完以上的这一切以后，通过命令“mkfs.ext3 +LV的路径”来格式化分区，然后进行挂载后就可以用了。</p>
<h2 id="LVM扩容"><a href="#LVM扩容" class="headerlink" title="LVM扩容"></a>LVM扩容</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/sdc  ##创建新PV</span><br><span class="line">vgextend centos /dev/sdc   ##将新的PV加入到现有的VG</span><br><span class="line">lvextend -l +2559  /dev/centos/root  ##LV扩容lvresize或者lvextend</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 scsi_host]# df -Th</span><br><span class="line">Filesystem              Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root xfs        17G   17G  152K 100% /</span><br><span class="line">##文件系统仍未扩容</span><br><span class="line">##需要扩容的是xfs，则需要xfs_growfs命令</span><br><span class="line">xfs_growfs /dev/centos/root   ##扩容xfs文件系统</span><br><span class="line">##如果是ext3,ext4等，需要使用resizefs命令</span><br><span class="line">##再次查看df</span><br><span class="line">[root@node1 scsi_host]# df -Th</span><br><span class="line">Filesystem              Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root xfs        27G   17G   10G  63% /</span><br><span class="line">##完成文件系统扩容</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E4%BD%BF%E7%94%A8Python+Alfred-Workflow%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%BF%BB%E8%AF%91%E6%8F%92%E4%BB%B6">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%BD%BF%E7%94%A8Python+Alfred-Workflow%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%BF%BB%E8%AF%91%E6%8F%92%E4%BB%B6" class="post-title-link" itemprop="url">使用Python+Alfred-Workflow开发一个翻译插件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-07-21 15:37:37" itemprop="dateCreated datePublished" datetime="2023-07-21T15:37:37+08:00">2023-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
    <span id="/%E4%BD%BF%E7%94%A8Python+Alfred-Workflow%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E7%BF%BB%E8%AF%91%E6%8F%92%E4%BB%B6" class="post-meta-item leancloud_visitors" data-flag-title="使用Python+Alfred-Workflow开发一个翻译插件" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install Alfred-Workflow</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">pip install --target=. Alfred-Workflow</span><br></pre></td></tr></table></figure>

<blockquote>
<p>只支持Python2版本，Python3的话需要考虑兼容问题。</p>
</blockquote>
<h3 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h3><p>有个1.40.0 版本的较为新一点 <a target="_blank" rel="noopener" href="https://files.pythonhosted.org/packages/a7/65/636e999af8a5f8a9642b19a0875799629cfbdf28cba441bb2f9107816b3f/Alfred-Workflow-1.40.0.tar.gz">Alfred-Workflow-1.40.0.tar.gz</a></p>
<h3 id="兼容问题"><a href="#兼容问题" class="headerlink" title="兼容问题"></a>兼容问题</h3><p>这个库是使用 Python2 写的，直接在 Python3 上使用会有问题，如果你习惯使用 Python3，可以有一些办法做一些兼容。</p>
<p>基础准备如下：</p>
<ol>
<li>首先在使用 pip 安装时，要记得选择使用 Python2 安装</li>
<li>跟 Workflow 相关的操作放在一个文件里（称为 a.py），使用 Python2 作为解释器</li>
<li>把真正的逻辑放到另一个文件里（称为 b.py），使用 Python3 作为解释器</li>
</ol>
<p>工作过程：</p>
<ol>
<li>a.py 接收参数后，使用 subprocess 模块提供的功能，传递到 b.py 文件传输</li>
<li>b.py 可以通过文件读写、数据库或者标准输出的方式，把结果再传回</li>
<li>a.py 再读取 b.py 执行的结果，完成 Alfred 内条目的添加</li>
</ol>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Your Workflow/</span><br><span class="line">    info.plist</span><br><span class="line">    icon.png</span><br><span class="line">    workflow/</span><br><span class="line">        __init__.py</span><br><span class="line">        background.py</span><br><span class="line">        notify.py</span><br><span class="line">        Notify.tgz</span><br><span class="line">        update.py</span><br><span class="line">        version</span><br><span class="line">        web.py</span><br><span class="line">        workflow.py</span><br><span class="line">    yourscript.py</span><br><span class="line">    etc.</span><br></pre></td></tr></table></figure>

<h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><h3 id="前提调研"><a href="#前提调研" class="headerlink" title="前提调研"></a>前提调研</h3><p>起初用的是某位老哥开发的一个workflow，但是近两天发现有道的API下线了，事实上是HTTP版本的接口下线了，现在就只保留了一个新版本的API。</p>
<p>那就注册一个自己的开发者账号，填上认证信息，改改还能用。但是第二天一看，前天查俩单词就扣费了7分钱，虽说费用很低，但是架不住时间长了啊，何况认证用户只送50元的体验金，说不定哪天就用完了。</p>
<p>后来想了想还是自己开发一个新的，和有道翻译说再见了。在网上随便一搜看到了百度的通用翻译API，每个月权益如下，虽然不多但也够用了。</p>
<ul>
<li>QPS&#x3D;1</li>
<li>支持28个语种互译</li>
<li>单次最长请求1000字符</li>
<li>免费调用量5万字符&#x2F;月</li>
</ul>
<p>其实后来又看到很多其他家的产品，QPS都较高，免费额度也不错，比如腾讯云、阿里云等等。总之有一个能用就行了，就算将来再换也看文档改一下就行了。</p>
<h3 id="软件配置"><a href="#软件配置" class="headerlink" title="软件配置"></a>软件配置</h3><p>首先点击加号新建，使用hotkey的方式</p>
<p><img src="https://img.econow.cn/blog/1689923285674.png" alt="创建"></p>
<p>然后配置hotkey</p>
<p><img src="https://img.econow.cn/blog/1689923447818.png" alt="配置"></p>
<blockquote>
<p>注意箭头标识的部分不要写错，prefix的值也是唯一的，不然就冲突了。</p>
</blockquote>
<p>之后配置脚本部分</p>
<p><img src="https://img.econow.cn/blog/1689923544329.png" alt="配置脚本"></p>
<p>这里的语言选择了bash，但是脚本是单独存放的，点击下面的目录可以看到当前的workflow的存放位置，将开发脚本放在那个目录下，别忘了还有最开始下载的Alfred-Workflow。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>首先调试翻译的代码，从官网上下载稍微修改了一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line">appid = <span class="string">&#x27;xxxxxxxxx&#x27;</span></span><br><span class="line">appkey = <span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">endpoint = <span class="string">&#x27;http://api.fanyi.baidu.com/api/trans/vip/translate&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">translate_text</span>(<span class="params">query</span>):</span><br><span class="line">    salt = random.randint(<span class="number">32768</span>, <span class="number">65536</span>)</span><br><span class="line">    sign = md5((appid + query + <span class="built_in">str</span>(salt) + appkey).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line">    payload = &#123;<span class="string">&#x27;appid&#x27;</span>: appid, <span class="string">&#x27;q&#x27;</span>: query, <span class="string">&#x27;from&#x27;</span>: <span class="string">&#x27;auto&#x27;</span>, <span class="string">&#x27;to&#x27;</span>: <span class="string">&#x27;auto&#x27;</span>, <span class="string">&#x27;salt&#x27;</span>: salt, <span class="string">&#x27;sign&#x27;</span>: sign&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.post(endpoint, params=payload)</span><br><span class="line">        r.raise_for_status()  <span class="comment"># Raise an error if the request was unsuccessful</span></span><br><span class="line">        res = r.json().get(<span class="string">&#x27;trans_result&#x27;</span>, [&#123;<span class="string">&#x27;dst&#x27;</span>: r.json()&#125;])[<span class="number">0</span>][<span class="string">&#x27;dst&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Network error: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(e)&#125;</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;JSON parsing error: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    query = <span class="string">&#x27; &#x27;</span>.join(sys.argv[<span class="number">1</span>:])</span><br><span class="line">    result = translate_text(query)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>主程序中获取子进程的输出结果，可以考虑以下两种方式：</p>
<ol>
<li>使用 <code>print(result)</code> 输出，并通过 <code>subprocess.check_output()</code> 来获取子进程的输出结果。这种方式在示例代码中已经使用，并且是相对简单和直接的方式。</li>
<li>将子进程的输出写入到文件中，然后在主进程中读取文件来获取输出结果。这样可以绕过无法直接获取子进程输出的问题。</li>
</ol>
</blockquote>
<p>调试完成后会根据输入的语言翻译成对应的语言。之后再配置刚才截图中使用的vn.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> workflow <span class="keyword">import</span> Workflow3</span><br><span class="line"></span><br><span class="line">API_KEY = <span class="string">&#x27;your-pinboard-api-key&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">wf</span>):</span><br><span class="line">    args = wf.args</span><br><span class="line">    <span class="comment"># 使用 subprocess.check_output() 捕获被调用脚本的输出结果</span></span><br><span class="line">    result = subprocess.check_output([<span class="string">&#x27;python3&#x27;</span>, <span class="string">&#x27;Baidu_Text_transAPI.py&#x27;</span>] + args, universal_newlines=<span class="literal">True</span>).decode(</span><br><span class="line">        <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    wf.logger.info(<span class="string">u&quot;翻译结果：%s&quot;</span>, result)</span><br><span class="line">    wf.add_item(</span><br><span class="line">        title=args[<span class="number">0</span>],</span><br><span class="line">        subtitle=<span class="string">u&quot;翻译结果: &quot;</span> + result,</span><br><span class="line">        valid=<span class="literal">True</span>,</span><br><span class="line">        uid=<span class="string">&quot;url here&quot;</span>,</span><br><span class="line">        arg=result</span><br><span class="line">    )</span><br><span class="line">    wf.send_feedback()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">u&quot;__main__&quot;</span>:</span><br><span class="line">    wf = Workflow3()</span><br><span class="line">    sys.exit(wf.run(main))</span><br></pre></td></tr></table></figure>

<p>调试过程中很痛苦，主要是必须顾虑到Python2的写法，在中文编码和ASCII上折腾了很久，还是Python3用着爽，可惜deanise大神没这打算。</p>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p><img src="https://img.econow.cn/blog/1689924104970.png" alt="翻译结果"></p>
<blockquote>
<p>调试的时候可以点开右上角的蜘蛛，会展示debug信息。</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.deanishe.net/alfred-workflow/">https://www.deanishe.net/alfred-workflow/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/deanishe/alfred-workflow">https://github.com/deanishe/alfred-workflow</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.org/project/Alfred-Workflow/#description">https://pypi.org/project/Alfred-Workflow/#description</a></li>
<li><a target="_blank" rel="noopener" href="https://api.fanyi.baidu.com/doc/21">百度通用翻译API文档</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94frp%E7%9A%84%E5%AE%9E%E8%B7%B5">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94frp%E7%9A%84%E5%AE%9E%E8%B7%B5" class="post-title-link" itemprop="url">内网穿透工具——frp的实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-12-02 15:53:20" itemprop="dateCreated datePublished" datetime="2022-12-02T15:53:20+08:00">2022-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
    <span id="/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94frp%E7%9A%84%E5%AE%9E%E8%B7%B5" class="post-meta-item leancloud_visitors" data-flag-title="内网穿透工具——frp的实践" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>frp 是一个专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。</p>
<h3 id="frp的优点"><a href="#frp的优点" class="headerlink" title="frp的优点"></a>frp的优点</h3><ul>
<li>客户端服务端通信支持 TCP、KCP 以及 Websocket 等多种协议。</li>
<li>采用 TCP 连接流式复用，在单个连接间承载更多请求，节省连接建立时间。</li>
<li>代理组间的负载均衡。</li>
<li>端口复用，多个服务通过同一个服务端端口暴露。</li>
<li>多个原生支持的客户端插件（静态文件查看，HTTP、SOCK5 代理等），便于独立使用 frp 客户端完成某些工作。</li>
<li>高度扩展性的服务端插件系统，方便结合自身需求进行功能扩展。</li>
<li>服务端和客户端 UI 页面。</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>目前可以在 Github 的 <a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/releases">Release</a> 页面中下载到最新版本的客户端和服务端二进制文件，所有文件被打包在一个压缩包中。</p>
<p><img src="https://img.econow.cn/medivh/1669967801775.png" alt="1669967801775.png"></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>解压缩下载的压缩包，将其中的 frpc 拷贝到内网服务所在的机器上，将 frps 拷贝到具有公网 IP 的机器上，放置在任意目录。<br>编写配置文件，先通过 <code>./frps -c ./frps.ini</code> 启动服务端，再通过<code>./frpc -c ./frpc.ini</code>启动客户端。如果需要在后台长期运行，建议结合其他工具使用，例如 <code>systemd</code> 和 <code>supervisor</code>。</p>
<p>如果是 Windows 用户，需要在 cmd 终端中执行命令。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="服务端配置文件"><a href="#服务端配置文件" class="headerlink" title="服务端配置文件"></a>服务端配置文件</h3><p>以Linux服务器为例，编辑配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line"><span class="comment"># 默认7000，可以自定义</span></span><br><span class="line">bind_port =7001</span><br><span class="line"><span class="comment"># 自定义token</span></span><br><span class="line">token = xxxxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># frp管理后台端口，请按自己需求更改</span></span><br><span class="line">dashboard_port = 7002</span><br><span class="line"><span class="comment"># frp管理后台用户名和密码，请改成自己的</span></span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line">enable_prometheus = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># frp日志配置</span></span><br><span class="line">log_file = /var/log/frps.log</span><br><span class="line">log_level = info</span><br><span class="line">log_max_days = 3</span><br></pre></td></tr></table></figure>

<h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><p>创建或编辑<code>/etc/systemd/system/frps.service</code>文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"><span class="comment"># 服务名称，可自定义</span></span><br><span class="line">Description = frp server</span><br><span class="line">After = network.target syslog.target</span><br><span class="line">Wants = network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type = simple</span><br><span class="line"><span class="comment"># 启动frps的命令，需修改为您的frps的安装路径</span></span><br><span class="line">ExecStart = /opt/frp/frps -c /opt/frp/frps.ini</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy = multi-user.target</span><br></pre></td></tr></table></figure>

<p>系统命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动frp</span></span><br><span class="line">systemctl start frps</span><br><span class="line"><span class="comment"># 停止frp</span></span><br><span class="line">systemctl stop frps</span><br><span class="line"><span class="comment"># 重启frp</span></span><br><span class="line">systemctl restart frps</span><br><span class="line"><span class="comment"># 查看frp状态</span></span><br><span class="line">systemctl status frps</span><br><span class="line"><span class="comment"># 开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> frps</span><br></pre></td></tr></table></figure>

<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>下载对应平台的客户端和二进制文件，修改配置文件<code>frpc.ini</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = x.x.x.x</span><br><span class="line">server_port = 7001</span><br><span class="line"></span><br><span class="line">[ssh]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 6000</span><br></pre></td></tr></table></figure>

<p>local_ip 和 local_port 配置为本地需要暴露到公网的服务地址和端口。remote_port 表示在 frp 服务端监听的端口，访问此端口的流量将会被转发到本地服务对应的端口。</p>
<p>分别启动 frps 和 frpc。</p>
<p>通过 SSH 访问内网机器，假设用户名为 test：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh <span class="built_in">test</span>@x.x.x.x -p 6000</span><br></pre></td></tr></table></figure>

<p>frp 会将请求 x.x.x.x:6000 的流量转发到内网机器的 22 端口。</p>
<p>而此时访问服务器IP:dashboard_port 还能看到监控信息。</p>
<p><img src="https://img.econow.cn/medivh/1669969264963.png" alt="1669969264963.png"></p>
<p>frp的tcp模式相当于你的设备直接向公网暴露了一个tcp端口。任何设备都可以尝试连接这个端口。这里就会有很大的安全风险。因此，可以考虑使用stcp的模式。</p>
<h2 id="进阶使用"><a href="#进阶使用" class="headerlink" title="进阶使用"></a>进阶使用</h2><h3 id="stcp"><a href="#stcp" class="headerlink" title="stcp"></a>stcp</h3><p>对于某些服务来说如果直接暴露于公网上将会存在安全隐患。<br>首先client1向服务端注册时携带了一个sk，所有期望连接的设备访问端口时都必须先验证sk。<br><img src="https://img.econow.cn/medivh/1670392327929.png" alt="1670392327929.png"><br>然后，client2注册时也携带了通用的sk，就可以通过本机的端口间接连接client1了。<br><img src="https://img.econow.cn/medivh/1670392380127.png" alt="1670392380127.png"></p>
<p>使用 stcp(secret tcp) 类型的代理可以避免让任何人都能访问到要穿透的服务，但是访问者也需要运行另外一个 frpc 客户端。</p>
<p><strong>1.</strong> 服务端不变<br><strong>2.</strong> 在需要暴露到内网的机器上部署 frpc，且配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = x.x.x.x</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[secret_ssh]</span><br><span class="line"><span class="built_in">type</span> = stcp</span><br><span class="line"><span class="comment"># 只有 sk 一致的用户才能访问到此服务</span></span><br><span class="line">sk = abcdefg</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br></pre></td></tr></table></figure>

<p><strong>3.</strong> 在想要访问内网服务的机器上也部署 frpc，且配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = x.x.x.x</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[secret_ssh_visitor]</span><br><span class="line"><span class="built_in">type</span> = stcp</span><br><span class="line"><span class="comment"># stcp 的访问者</span></span><br><span class="line">role = visitor</span><br><span class="line"><span class="comment"># 要访问的 stcp 代理的名字</span></span><br><span class="line">server_name = secret_ssh</span><br><span class="line">sk = abcdefg</span><br><span class="line"><span class="comment"># 绑定本地端口用于访问 SSH 服务</span></span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 6000</span><br></pre></td></tr></table></figure>

<p><strong>4.</strong> 通过 SSH 访问内网机器，假设用户名为 test：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh <span class="built_in">test</span>@127.0.0.1 -p 6000</span><br></pre></td></tr></table></figure>

<p>已经验证成功了，连上了家里的服务器。需要注意的是如果frpc配置在openwrt上需要对应配置填写。</p>
<p>frp 提供了一种新的代理类型 xtcp 用于应对在希望传输大量数据且流量不经过服务器的场景。使用方式同 stcp 类似，需要在两边都部署上 frpc 用于建立直接的连接。<br>后来测试了一下xtcp的模式，虽然日志提示没啥错误，但是依然无法连接，可能还是网络环境的问题吧。配置方式和stcp差不多，唯一的区别就是需要在服务端多加一个端口，客户端type为xtcp。</p>
<h3 id="http-proxy-socks5"><a href="#http-proxy-socks5" class="headerlink" title="http_proxy&#x2F;socks5"></a>http_proxy&#x2F;socks5</h3><p>客户端插件可以被应用在任意类型的代理中，但是需要插件本身的协议能够支持。可以使用http_proxy和socks5进行代理，客户端的机器上配置代理即可访问内网。</p>
<p>Mac 终端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> goproxy=<span class="string">&#x27;export http_proxy=http://远程IP:远程端口&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> disproxy=<span class="string">&#x27;unset http_proxy https_proxy&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> goproxys5=<span class="string">&#x27;http_proxy=socks5://xxx:xxx@xxxx:6005&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[http_proxy]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 6004</span><br><span class="line">plugin = http_proxy</span><br><span class="line">plugin_http_user = abc</span><br><span class="line">plugin_http_passwd = abc</span><br><span class="line"></span><br><span class="line">[socket5proxy]</span><br><span class="line"><span class="built_in">type</span> = socks5</span><br><span class="line">remote_port = 6005</span><br><span class="line">plugin = socks5</span><br><span class="line">plugin_user = abc</span><br><span class="line">plugin_passwd = abc</span><br></pre></td></tr></table></figure>

<p>无论是浏览器访问，还是终端访问HTTP地址都可以，但是ssh无法直接访问，暂未解决。还有个不足的地方，会被端口扫描。</p>
<h3 id="static-file"><a href="#static-file" class="headerlink" title="static_file"></a>static_file</h3><p>通过 static_file 插件可以对外提供一个简单的基于 HTTP 的文件访问服务。对于这个功能，可以做成一个软件仓库来使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[test_static_file]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 6000</span><br><span class="line">plugin = static_file</span><br><span class="line"><span class="comment"># 要对外暴露的文件目录</span></span><br><span class="line">plugin_local_path = /tmp/file</span><br><span class="line"><span class="comment"># 访问 url 中会被去除的前缀，保留的内容即为要访问的文件路径</span></span><br><span class="line">plugin_strip_prefix = static</span><br><span class="line">plugin_http_user = abc</span><br><span class="line">plugin_http_passwd = abc</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问 来查看位于  &#x2F;tmp&#x2F;file  目录下的 <a target="_blank" rel="noopener" href="http://x.x.x.x:6000/static/">http://x.x.x.x:6000/static/</a>  文件，会要求输入已设置好的用户名和密码。</p>
<h3 id="域名访问"><a href="#域名访问" class="headerlink" title="域名访问"></a>域名访问</h3><p>首先设置frps：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frps.ini</span></span><br><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br><span class="line">vhost_http_port = 8080</span><br><span class="line"><span class="comment"># 用于身份验证，请自行修改，要保证服务端与客户端一致</span></span><br><span class="line">token = abcdefgh</span><br></pre></td></tr></table></figure>

<p>然后设置frpc:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[web]</span><br><span class="line"><span class="built_in">type</span> = http</span><br><span class="line">local_port = 80</span><br><span class="line">custom_domains = xx.xx.com</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://gofrp.org/">https://gofrp.org/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Kubernetes%E5%85%B3%E4%BA%8EStorageClass%E7%9A%84%E5%BA%94%E7%94%A8%E2%80%94%E2%80%94Flare">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Kubernetes%E5%85%B3%E4%BA%8EStorageClass%E7%9A%84%E5%BA%94%E7%94%A8%E2%80%94%E2%80%94Flare" class="post-title-link" itemprop="url">Kubernetes关于StorageClass的应用——Flare</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-12-01 16:30:34" itemprop="dateCreated datePublished" datetime="2022-12-01T16:30:34+08:00">2022-12-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
    <span id="/Kubernetes%E5%85%B3%E4%BA%8EStorageClass%E7%9A%84%E5%BA%94%E7%94%A8%E2%80%94%E2%80%94Flare" class="post-meta-item leancloud_visitors" data-flag-title="Kubernetes关于StorageClass的应用——Flare" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在折腾NAS和虚拟机的时候发现一个问题，部署的应用和服务太多了，有点记不住地址和端口了，所以需要一个导航页来展示这一切。</p>
<p>本想自己开发一个单页面应用呢，但是想到vue或react，对于前端的东西能不碰就不想碰，所以找到了一个开源的项目——flare。恰巧搭建了一个Kubernetes集群，正好练习一下。</p>
<h2 id="技术点"><a href="#技术点" class="headerlink" title="技术点"></a>技术点</h2><h3 id="Storage-Class"><a href="#Storage-Class" class="headerlink" title="Storage Class"></a>Storage Class</h3><h4 id="什么是Storage-Class"><a href="#什么是Storage-Class" class="headerlink" title="什么是Storage Class"></a>什么是Storage Class</h4><p>Kubernetes提供了一套可以自动创建PV的机制，即：Dynamic Provisioning。而这个机制的核心在于StorageClass这个API对象。</p>
<p>StorageClass对象会定义下面两部分内容:</p>
<ol>
<li>PV的属性。比如，存储类型，Volume的大小等。</li>
<li>创建这种PV需要用到的存储插件，即存储制备器。</li>
</ol>
<p>有了这两个信息之后，Kubernetes就能够根据用户提交的PVC，找到一个对应的StorageClass，之后Kubernetes就会调用该StorageClass声明的存储插件，进而创建出需要的PV。</p>
<h4 id="为什么用Storage-Class"><a href="#为什么用Storage-Class" class="headerlink" title="为什么用Storage Class"></a>为什么用Storage Class</h4><p>在一个大规模的Kubernetes集群里，可能有成千上万个PVC，这就意味着运维人员必须实现创建出这个多个PV，此外，随着项目的需要，会有新的PVC不断被提交，那么运维人员就需要不断的添加新的，满足要求的PV，否则新的Pod就会因为PVC绑定不到PV而导致创建失败。而且通过 PVC 请求到一定的存储空间也很有可能不足以满足应用对于存储设备的各种需求。</p>
<p>而且不同的应用程序对于存储性能的要求可能也不尽相同，比如读写速度、并发性能等，为了解决这一问题，Kubernetes 又为我们引入了一个新的资源对象：StorageClass，通过 StorageClass 的定义，管理员可以将存储资源定义为某种类型的资源，比如快速存储、慢速存储等，用户根据 StorageClass 的描述就可以非常直观的知道各种存储资源的具体特性了，这样就可以根据应用的特性去申请合适的存储资源了。</p>
<p>pvc是无法直接去向nfs-client-provisioner申请使用的存储空间的，这时，就需要通过SC这个资源对象去申请了，SC的根本作用就是根据pvc定义的来动态创建pv，不仅节省了我们管理员的时间，还可以封装不同类型的存储供pvc选用。</p>
<h4 id="Storage-Class资源"><a href="#Storage-Class资源" class="headerlink" title="Storage Class资源"></a>Storage Class资源</h4><p>每个sc都包含以下三个重要的字段，这些字段会在sc需要动态分配pv时会使用到：</p>
<ul>
<li>Provisioner（供给方）：提供了存储资源的存储系统。</li>
<li>ReclaimPolicy：pv的回收策略，可用的值有Delete（默认）和Retiain</li>
<li>Parameters（参数）：存储类使用参数描述要关联到存储卷。</li>
</ul>
<p>每个 StorageClass 都有一个制备器（Provisioner），用来决定使用哪个卷插件制备 PV。 该字段必须指定。</p>
<table>
<thead>
<tr>
<th>插件</th>
<th>内置制备器</th>
<th>配置例子</th>
</tr>
</thead>
<tbody><tr>
<td>AWSElasticBlockStore</td>
<td>✓</td>
<td>AWS EBS</td>
</tr>
<tr>
<td>AzureFile</td>
<td>✓</td>
<td>Azure File</td>
</tr>
<tr>
<td>AzureDisk</td>
<td>✓</td>
<td>Azure Disk</td>
</tr>
<tr>
<td>CephFS</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Cinder</td>
<td>✓</td>
<td>OpenStack Cinder</td>
</tr>
<tr>
<td>FC</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>FlexVolume</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Flocker</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>GCEPersistentDisk</td>
<td>✓</td>
<td>GCE PD</td>
</tr>
<tr>
<td>Glusterfs</td>
<td>✓</td>
<td>Glusterfs</td>
</tr>
<tr>
<td>iSCSI</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Quobyte</td>
<td>✓</td>
<td>Quobyte</td>
</tr>
<tr>
<td>NFS</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>RBD</td>
<td>✓</td>
<td>Ceph RBD</td>
</tr>
<tr>
<td>VsphereVolume</td>
<td>✓</td>
<td>vSphere</td>
</tr>
<tr>
<td>PortworxVolume</td>
<td>✓</td>
<td>Portworx Volume</td>
</tr>
<tr>
<td>ScaleIO</td>
<td>✓</td>
<td>ScaleIO</td>
</tr>
<tr>
<td>StorageOS</td>
<td>✓</td>
<td>StorageOS</td>
</tr>
<tr>
<td>Local</td>
<td>-</td>
<td>Local</td>
</tr>
</tbody></table>
<p>回收策略，由 StorageClass 动态创建的 PersistentVolume 会在类的 reclaimPolicy 字段中指定回收策略，可以是 Delete 或者 Retain。如果 StorageClass 对象被创建时没有指定 reclaimPolicy，它将默认为 Delete。</p>
<h3 id="flare"><a href="#flare" class="headerlink" title="flare"></a>flare</h3><p>轻量、快速、美观的个人导航页面，适用于 HomeLab 或其他注重私密的场景。<br>支持 x86 以及常见的 ARM (ARM32v6、ARM32v7、ARM64v8)设备，应用资源消耗非常低：</p>
<ul>
<li>CPU: &lt; 1%</li>
<li>MEM: &lt; 30M</li>
<li>Docker Image: &lt; 10M</li>
</ul>
<p>使用方式很简单：</p>
<ol>
<li>下载Git仓库</li>
<li>使用docker启动，注意挂载<code>/app</code>目录</li>
</ol>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="创建Storage-class"><a href="#创建Storage-class" class="headerlink" title="创建Storage class"></a>创建Storage class</h3><p>要使用 StorageClass，我们就得安装对应的自动配置程序，比如我们这里存储后端使用的是 nfs，那么我们就需要使用到一个 nfs-client 的自动配置程序，我们也叫它 Provisioner（制备器），这个程序使用我们已经配置好的 nfs 服务器，来自动创建持久卷，也就是自动帮我们创建 PV。</p>
<ol>
<li>自动创建的 PV 以${namespace}-${pvcName}-${pvName}这样的命名格式创建在 NFS 服务器上的共享数据目录中</li>
<li>而当这个 PV 被回收后会以archieved-${namespace}-${pvcName}-${pvName}这样的命名格式存在 NFS 服务器上。</li>
</ol>
<p><img src="https://img.econow.cn/medivh/1669884658926.png" alt="1669884658926.png"></p>
<p>注意在所有节点安装<code>yum -y install nfs-utils</code>.</p>
<p>创建rbac权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-provisioner</span><br><span class="line">  namespace: default</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-provisioner-runner</span><br><span class="line">  namespace: default</span><br><span class="line">rules:</span><br><span class="line">   -  apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      resources: [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">      verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">   -  apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      resources: [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">      verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">   -  apiGroups: [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">      resources: [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">      verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">   -  apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      resources: [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">      verbs: [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">   -  apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">      resources: [<span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">      verbs: [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>,<span class="string">&quot;update&quot;</span>]</span><br><span class="line">   -  apiGroups: [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">      resources: [<span class="string">&quot;podsecuritypolicies&quot;</span>]</span><br><span class="line">      resourceNames: [<span class="string">&quot;nfs-provisioner&quot;</span>]</span><br><span class="line">      verbs: [<span class="string">&quot;use&quot;</span>]</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: run-nfs-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-provisioner</span><br><span class="line">    namespace: default</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<p>执行yaml文件。我们新建的一个名为nfs-provisioner的ServiceAccount，然后绑定了一个名为nfs-provisioner-runner的ClusterRole，而该ClusterRole声明了一些权限，其中就包括对pv的增，删，改，查等权限，所以我们可以利用该serviceAccount来自动创建pv。</p>
<p>创建NFS的deployment：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nfs-client-provisioner</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccount: nfs-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath:  /persistentvolumes</span><br><span class="line">          <span class="built_in">env</span>:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: nfs-deploy    <span class="comment">#供给方的名称（自定义）</span></span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 192.168.31.98     <span class="comment">#nfs服务器的ip地址</span></span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /mnt/free/nfs      <span class="comment">#nfs共享的目录</span></span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 192.168.31.98</span><br><span class="line">            path: /mnt/free/nfs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行yaml文件，检查pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master-51 ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-7d9b557c55-9vs77   1/1     Running   0          16m</span><br></pre></td></tr></table></figure>

<p>创建storage class:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: stateful-nfs</span><br><span class="line">  namespace: default</span><br><span class="line">provisioner: nfs-deploy</span><br><span class="line">reclaimPolicy: Retain</span><br></pre></td></tr></table></figure>

<p>我们声明了一个名为statefu-nfs的sc对象，注意下面的provisioner字段对应的值一定要和上面的nfs的Deployment下面的PROVISIONER_NAME这个环境变量的值一样。</p>
<p>执行yaml文件，检查该资源对象。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master-51 ~]<span class="comment"># kubectl get storageclass</span></span><br><span class="line">NAME           PROVISIONER   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">stateful-nfs   nfs-deploy    Retain          Immediate           <span class="literal">false</span>                  1m</span><br></pre></td></tr></table></figure>

<p>动态创建PVC</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: flare</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  storageClassName: stateful-nfs</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 100Mi</span><br></pre></td></tr></table></figure>

<p>执行yaml文件，检查是否创建了对应的PVC。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master-51 flare]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME    STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">flare   Bound    pvc-ed851458-fe37-4095-a6e5-4838e46a58d0   100Mi      RWX            stateful-nfs   1m</span><br></pre></td></tr></table></figure>

<h3 id="部署flare"><a href="#部署flare" class="headerlink" title="部署flare"></a>部署flare</h3><p>编辑yaml文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: flare</span><br><span class="line">  name: flare</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: flare</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: flare</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: soulteary/flare</span><br><span class="line">        name: flare</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: flare-app</span><br><span class="line">          mountPath: /app</span><br><span class="line">      volumes:</span><br><span class="line">      - name: flare-app</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: flare</span><br></pre></td></tr></table></figure>

<p>执行yaml文件，检查pod文件nfs。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master-51 ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">flare-5c57955b54-rj6hr                    1/1     Running   0          2m</span><br><span class="line">nfs-client-provisioner-7d9b557c55-9vs77   1/1     Running   0          7m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查nfs目录</span></span><br><span class="line"></span><br><span class="line">root@truenas[...-ed851458-fe37-4095-a6e5-4838e46a58d0]<span class="comment"># ll</span></span><br><span class="line">total 39</span><br><span class="line">drwxrwxrwx 2 nobody   5 Dec  1 14:55 ./</span><br><span class="line">drwxrwxrwx 3 nfs      6 Dec  1 14:42 ../</span><br><span class="line">-rwxr-xr-x 1 nobody 418 Dec  1 15:51 apps.yml*</span><br><span class="line">-rwxr-xr-x 1 nobody 733 Dec  1 15:51 bookmarks.yml*</span><br><span class="line">-rwxr-xr-x 1 nobody 467 Dec  1 14:58 config.yml*</span><br><span class="line">root@truenas[...-ed851458-fe37-4095-a6e5-4838e46a58d0]<span class="comment"># pwd</span></span><br><span class="line">/mnt/free/nfs/default-flare-pvc-ed851458-fe37-4095-a6e5-4838e46a58d0</span><br></pre></td></tr></table></figure>

<p>临时使用nodeport的方式访问：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: flare</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 35005</span><br><span class="line">    targetPort: 5005</span><br><span class="line">    nodePort: 35005</span><br><span class="line">  selector:</span><br><span class="line">    app: flare</span><br></pre></td></tr></table></figure>

<p>之后可以考虑使用ingress或者其他方式。</p>
<p>访问页面，很美好：</p>
<p><img src="https://img.econow.cn/medivh/1669886114176.png" alt="1669886114176.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>遇到的问题：</p>
<p>**问题 1.**：unexpected error getting claim reference: selfLink was empty, can’t make reference<br><strong>解决</strong> Kubernetes 1.20及以后版本禁用了 selfLink 所致。修改 &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml，添加 - –feature-gates&#x3D;RemoveSelfLink&#x3D;false 后重新部署。</p>
<p>**问题 2.**：waiting for a volume to be created, either by external provisioner “fuseim.pri&#x2F;ifs” or manually created by system administrator<br><strong>解决</strong> Kubernetes 1.20及以后版本禁用了 selfLink 所致。修改 &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml，添加 - –feature-gates&#x3D;RemoveSelfLink&#x3D;false 后重新部署。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/soulteary/docker-flare">https://github.com/soulteary/docker-flare</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/soulteary/flare">https://hub.docker.com/r/soulteary/flare</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012069313/article/details/125264651">Kubernetes常见报错</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%89%EF%BC%89">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%89%EF%BC%89" class="post-title-link" itemprop="url">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（三）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-24 16:40:05" itemprop="dateCreated datePublished" datetime="2022-11-24T16:40:05+08:00">2022-11-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
    <span id="/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%89%EF%BC%89" class="post-meta-item leancloud_visitors" data-flag-title="基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（三）" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>NAS专栏：</p>
<ul>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（一）</a></li>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（二）</a></li>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%89%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（三）</a></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虚拟化平台搭建好了，现在开始创建一台trues的虚拟机。TruesNAS 是之前选择的系统，其中Enterprise 是付费版，Scale是要使用的系统。</p>
<p><img src="https://img.econow.cn/medivh/1669279439301.png" alt="1669279439301.png"></p>
<p>功能概览：</p>
<p><img src="https://img.econow.cn/medivh/1669280893833.png" alt="1669280893833.png"></p>
<p>路线图</p>
<p><img src="https://img.econow.cn/medivh/1669280910986.png" alt="1669280910986.png"></p>
<p>下载</p>
<p><img src="https://img.econow.cn/medivh/1669281008839.png" alt="1669281008839.png"></p>
<p><a target="_blank" rel="noopener" href="https://download.truenas.com/TrueNAS-SCALE-Angelfish/22.02.4/TrueNAS-SCALE-22.02.4.iso">下载链接</a></p>
<p>网盘目录里存放了从官网下载的系统镜像，可以直接下载<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1apBdslCrIvDhZ8ii5hGAlQ?pwd=1gtj">百度网盘</a> 提取码: 1gtj 。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>该部分很简单，在PVE创建虚拟机的时候选择镜像，基本按照默认选择安装即可。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>访问登录地址<a target="_blank" rel="noopener" href="http://ip/">http://ip</a></p>
<p><img src="https://img.econow.cn/medivh/1669281872868.png" alt="1669281872868.png"></p>
<p>登录后就会看到Dashboard</p>
<p><img src="https://img.econow.cn/medivh/1669281972621.png" alt="1669281972621.png"></p>
<p>本地化设置在 系统设置-》常规-》本地化—》选择语言和时区</p>
<h4 id="网络设置"><a href="#网络设置" class="headerlink" title="网络设置"></a>网络设置</h4><p>网络-》接口，点击</p>
<p><img src="https://img.econow.cn/medivh/1669282030229.png" alt="1669282030229.png"></p>
<p>取消勾选DHCP，添加新的IP，然后应用</p>
<p><img src="https://img.econow.cn/medivh/1669282087934.png" alt="1669282087934.png"></p>
<p>注意点击应用后要点击测试更改，然后在60s内使用新的IP访问，否则修改无效。</p>
<p><img src="https://img.econow.cn/medivh/1669282158314.png" alt="1669282158314.png"></p>
<p>根据自己需要填写DNS和网关。需要注意的是NetBIOS-NS需要勾选，否则部分设备无法发现，比如小米摄像头。</p>
<p><img src="https://img.econow.cn/medivh/1669282252379.png" alt="1669282252379.png"></p>
<h4 id="Docker源"><a href="#Docker源" class="headerlink" title="Docker源"></a>Docker源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/mnt/free/ix-applications/docker&quot;</span>, <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=cgroupfs&quot;</span>], <span class="string">&quot;iptables&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;bridge&quot;</span>: <span class="string">&quot;none&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="存储设置"><a href="#存储设置" class="headerlink" title="存储设置"></a>存储设置</h4><p>TrueNAS存储顺序为内存-&gt;缓存存储池-&gt;数据存储池。</p>
<p>一个存储池可以由多个Vdev组成，而Vdev可以有多种类型。</p>
<p><img src="https://img.econow.cn/medivh/1669604121682.png" alt="1669604121682.png"></p>
<h5 id="Vdev类型"><a href="#Vdev类型" class="headerlink" title="Vdev类型"></a>Vdev类型</h5><p>Vdev有以下六种类型：<br>参考：Creating Pools | (truenas.com)</p>
<h6 id="1、Data"><a href="#1、Data" class="headerlink" title="1、Data"></a>1、Data</h6><p>基础Vdev，用于存储数据，一个存储池至少有一个Data Vdev。</p>
<p>可以在一个池里添加多个Data Vdev，多个Data Vdev可以组成相关阵列，而一个Data Vdev又可以由多块硬盘组成的阵列构成。</p>
<h6 id="2、Cache"><a href="#2、Cache" class="headerlink" title="2、Cache"></a>2、Cache</h6><p>ZFS L2ARC读取缓存可与快速设备一起使用以加速读取操作。相当于二级缓存，保存从内存里面调出的数据，下次直接从固态硬盘中调出。建议64G内存以上的用户使用此Vdev，不要超过内存的5倍。推荐用固态硬盘当缓存Vdev，容量不需太大，64G存最好不要超过300G容量，多了反而会增加内存的消耗。</p>
<p>How Does L2ARC Work?<br>当系统收到读请求时，ZFS使用ARC (RAM)来处理这些请求。当ARC满了，并且有L2ARC驱动器分配给ZFS池时，ZFS使用L2ARC来处理从ARC溢出的读请求。这减少了使用较慢的硬盘驱动器，从而提高了系统性能。</p>
<p>更多内容可查看官方说明：L2ARC | (truenas.com)</p>
<h6 id="3、Log"><a href="#3、Log" class="headerlink" title="3、Log"></a>3、Log</h6><p>ZFS日志设备，提高同步写速度，日志设备的最小大小与池中每个设备的最小大小 (64 MB) 相同。可能存储在日志设备中的相关的数据量相对较小。提交日志事务（系统调用）时将释放日志块。日志设备的最大大小应大约为物理内存大小的 1&#x2F;2，因为这是可存储的最大潜在相关的数据量。例如，如果系统的物理内存为 16 GB，请考虑 8 GB 的最大日志设备大小。</p>
<p>ZFS intent log（ZIL）通常被称为日志，其主要目的是数据完整性。ZIL的存在是为了跟踪正在进行的同步写操作。如果系统崩溃或断电，ZIL可以重放操作。当您在电源故障时丢失一个标准的系统缓存时，一个ZIL在系统重新启动时仍然存在。</p>
<p>ZFS数据池使用一个存储在磁盘上的ZIL来记录同步写入，然后再刷新到存储中的最终位置。这意味着同步写操作以存储池的速度进行，并且必须写入存储池两次或两次以上(取决于磁盘冗余)。</p>
<p>更多内容可查看官方说明：SLOG Devices | (truenas.com)</p>
<h6 id="4、Hot-Spare"><a href="#4、Hot-Spare" class="headerlink" title="4、Hot Spare"></a>4、Hot Spare</h6><p>热备盘是指当主用磁盘故障时，预留插入Data vdev的磁盘。热备盘用于临时替换故障驱动器，以防止出现更大的池和数据丢失的情况。 当新硬盘替换故障硬盘时，热备盘恢复为非激活状态，重新作为热备盘使用。 当故障驱动器仅从池中分离时，临时热备盘将被提升为Data vdev的成员，不再作为热备盘可用。</p>
<h6 id="5、Metadata"><a href="#5、Metadata" class="headerlink" title="5、Metadata"></a>5、Metadata</h6><p>用于创建Fusion Pools的特殊分配类，以提高元数据和小块 i&#x2F;o 性能。</p>
<h6 id="6、Dedup"><a href="#6、Dedup" class="headerlink" title="6、Dedup"></a>6、Dedup</h6><p>Dedup vde用于存储ZFS池中的重复删除数据。需要为每X TiB的通用存储分配X GiB。例如，1 GiB的Dedup vdev容量对应1 TiB的Data vdev可用容量。</p>
<p>根据特定的池用例，添加到vdev中的磁盘以不同的布局排列。不支持将多个具有不同布局的vdev添加到池中。当需要不同的vdev布局时，创建一个新的池。例如，pool1中有一个镜像布局的数据vdev，新创建一个poo2，将raid-z布局的vdev添加到pool2中。</p>
<h5 id="RAID介绍"><a href="#RAID介绍" class="headerlink" title="RAID介绍"></a>RAID介绍</h5><p>条带：与RAID0类似，不过可以不同大小的硬盘组<br>镜像：与RAID1类似，磁盘镜像，至少需要两个磁盘。<br>RAIDZ1：与RAID5类似，一重奇偶校验，至少需要三块磁盘；可以坏一块硬盘不丢数据。容量和速度为N-1(N为硬盘数量)<br>RAIDZ2：与RAID6类似，双重奇偶校验，至少需要四个磁盘；可以坏2块硬盘不丢数据。容量和速度为N-2(N为硬盘数量)<br>RAIDZ3：ZFS特有的，三重奇偶校验，至少需要5个磁盘；可以坏3块盘不丢数据。容量和速度为N-3(N为硬盘数量)</p>
<p>创建新的池，选择磁盘，此处磁盘已经使用，所以显示为空。</p>
<p><img src="https://img.econow.cn/medivh/1669282473343.png" alt="1669282473343.png"></p>
<p>下面是使用了一段时间后的情况</p>
<p><img src="https://img.econow.cn/medivh/1669282672229.png" alt="1669282672229.png"></p>
<h4 id="SMB服务"><a href="#SMB服务" class="headerlink" title="SMB服务"></a>SMB服务</h4><p>首先需要创建用户，我这里是给摄像头使用的</p>
<p><img src="https://img.econow.cn/medivh/1669282731973.png" alt="1669282731973.png"></p>
<p>该部分需要注意主目录的位置，可以输入后自动创建并使用，其他保持默认即可。</p>
<p><img src="https://img.econow.cn/medivh/1669282798780.png" alt="1669282798780.png"></p>
<p>下一步需要启动服务</p>
<p><img src="https://img.econow.cn/medivh/1669282892634.png" alt="1669282892634.png"></p>
<p>对于小米摄像头来说需要启动SMB1。</p>
<p><img src="https://img.econow.cn/medivh/1669282926386.png" alt="1669282926386.png"></p>
<p>输入账号密码，很完美。</p>
<p><img src="https://img.econow.cn/medivh/1669283126821.png" alt="1669283126821.png"></p>
<h3 id="NextCloud"><a href="#NextCloud" class="headerlink" title="NextCloud"></a>NextCloud</h3><p>选择应用-》nextcloud</p>
<p><img src="https://img.econow.cn/medivh/1669284054845.png" alt="1669284054845.png"></p>
<p>账号密码和IP都可以自定义，也可以不修改</p>
<p><img src="https://img.econow.cn/medivh/1669284154262.png" alt="1669284154262.png"></p>
<p>添加两个环境变量<code>PHP_UPLOAD_LIMIT</code>和<code>PHP_MEMORY_LIMIT</code>，为了之后上传大文件</p>
<p><img src="https://img.econow.cn/medivh/1669284183021.png" alt="1669284183021.png"></p>
<p>存储这块建议使用host模式，自定义存储路径</p>
<p><img src="https://img.econow.cn/medivh/1669284272303.png" alt="1669284272303.png"></p>
<p>其余项目使用默认设置即可，保存后系统会自动部署。</p>
<p>当此处展示为ACTIVE，点击Web Portal即可</p>
<p><img src="https://img.econow.cn/medivh/1669284354369.png" alt="1669284354369.png"></p>
<h4 id="添加缓存"><a href="#添加缓存" class="headerlink" title="添加缓存"></a>添加缓存</h4><p>修改config.php文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;memcache.distributed&#x27;</span> =&gt; <span class="string">&#x27;\OC\Memcache\Redis&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;redis&#x27;</span> =&gt; array(</span><br><span class="line"><span class="string">&#x27;host&#x27;</span> =&gt; 192.168.31.82,</span><br><span class="line"><span class="string">&#x27;port&#x27;</span> =&gt; 6379,</span><br></pre></td></tr></table></figure>

<h4 id="开启上传不限速"><a href="#开启上传不限速" class="headerlink" title="开启上传不限速"></a>开启上传不限速</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> --user www-data CONTAINER_ID  php occ config:app:<span class="built_in">set</span> files max_chunk_size --value 0</span><br></pre></td></tr></table></figure>

<h4 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h4><ul>
<li>镜像下载不下来<ul>
<li>修改docker为国内源</li>
</ul>
</li>
<li>上传大文件提示服务器错误<ul>
<li>添加参数<ul>
<li>PHP_UPLOAD_LIMIT&#x3D;16G</li>
<li>PHP_MEMORY_LIMIT&#x3D;16G</li>
<li>LimitRequestBody 0 添加至html目录下的.htaccess文件</li>
</ul>
</li>
</ul>
</li>
<li>为Nextcloud手动添加文件-使后台上传的文件在Nextcloud中显示<ul>
<li>sudo -u www-data php occ files:scan –all</li>
</ul>
</li>
<li>为Nextcloud添加其他目录<ul>
<li>可以在应用添加扩展host挂载目录</li>
</ul>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>安装系统其实没什么难度，困难的是后续的应用配置。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.truenas.com/">https://www.truenas.com/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.truenas.com/truenas-scale/">https://www.truenas.com/truenas-scale/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.truenas.com/docs/">https://www.truenas.com/docs/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89" class="post-title-link" itemprop="url">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-24 14:20:08" itemprop="dateCreated datePublished" datetime="2022-11-24T14:20:08+08:00">2022-11-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
    <span id="/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89" class="post-meta-item leancloud_visitors" data-flag-title="基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（二）" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>NAS专栏：</p>
<ul>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（一）</a></li>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（二）</a></li>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%89%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（三）</a></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇文章中记录了软件和硬件的选型，这篇记录虚拟化系统安装和使用的坎坷。</p>
<h3 id="PVE简介"><a href="#PVE简介" class="headerlink" title="PVE简介"></a>PVE简介</h3><p>Proxmox VE is a complete, open-source server management platform for enterprise virtualization. It tightly integrates the KVM hypervisor and Linux Containers (LXC), software-defined storage and networking functionality, on a single platform. With the integrated web-based user interface you can manage VMs and containers, high availability for clusters, or the integrated disaster recovery tools with ease.</p>
<p>啥意思呢？就是说PVE是一个成型和开源的虚拟化管理平台。它将KVM管理程序和Linux容器（LXC）、软件定义的存储和网络功能紧密集成在一个平台上。使用集成的基于web的用户界面，您可以轻松管理VM和容器、群集的高可用性或集成的灾难恢复工具。</p>
<p><img src="https://img.econow.cn/medivh/1669274054326.png" alt="1669274054326.png"></p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li>KVM&amp;Container<ul>
<li>PVE 基于Debian系统</li>
<li>KVM是业界领先的用于完全虚拟化的Linux虚拟化技术。它是一个内核模块，被合并到主线Linux内核中，在所有支持Intel VT-x或AMD-V虚拟化的x86硬件上以接近本机的性能运行</li>
<li>Proxmox VE自2008年项目开始（即从0.9beta2版开始）就包含了KVM支持</li>
<li>基于容器的虚拟化技术是全机虚拟化的轻量级替代方案，因为它共享主机系统的内核</li>
<li>LXC是一个操作系统级虚拟化环境，用于在单个Linux控制主机上运行多个独立的Linux系统。LXC作为Linux内核包含特性的用户空间界面。用户可以使用强大的API和简单的工具轻松创建和管理系统或应用程序容器</li>
</ul>
</li>
<li>管理<ul>
<li>web页面管理</li>
<li>命令行操作</li>
<li>移动端操作（HTML5）</li>
<li>离线&#x2F;在线迁移到不同节点</li>
<li>Rest API</li>
<li>角色管理</li>
<li>认证管理</li>
</ul>
</li>
<li>HA 集群</li>
<li>网络 每个节点最多支持4094个桥接</li>
<li>存储<ul>
<li>网络存储<ul>
<li>LVM Group (network backing with iSCSI targets)</li>
<li>iSCSI target</li>
<li>NFS Share</li>
<li>SMB&#x2F;CIFS</li>
<li>Ceph RBD</li>
<li>Direct to iSCSI LUN</li>
<li>GlusterFS</li>
<li>CephFS</li>
</ul>
</li>
<li>本地存储<ul>
<li>LVM</li>
<li>Directory (storage on an existing filesystem)</li>
<li>ZFS</li>
</ul>
</li>
</ul>
</li>
<li>备份</li>
<li>防火墙</li>
</ul>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>访问官网<a target="_blank" rel="noopener" href="https://www.proxmox.com/en/downloads">下载链接</a>，注意选择的是Proxmox VE，不要选择成Proxmox Backup Server。</p>
<p><img src="https://img.econow.cn/medivh/1669272337063.png" alt="1669272337063.png"></p>
<p>网盘目录里存放了从官网下载的系统镜像，可以直接下载<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1apBdslCrIvDhZ8ii5hGAlQ?pwd=1gtj">百度网盘</a> 提取码: 1gtj 。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装最小需求：</p>
<ul>
<li>CPU: 64bit (Intel EMT64 or AMD64)</li>
<li>Intel VT&#x2F;AMD-V capable CPU&#x2F;Mainboard for KVM full virtualization support</li>
<li>RAM: 1 GB RAM, plus additional RAM needed for guests</li>
<li>Hard drive</li>
<li>One network card (NIC)</li>
</ul>
<h3 id="镜像刻录"><a href="#镜像刻录" class="headerlink" title="镜像刻录"></a>镜像刻录</h3><p>推荐使用balenaEtcher，真的很好用，极简模式。<br><img src="https://img.econow.cn/medivh/1669273791797.png" alt="1669273791797.png"></p>
<h3 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h3><blockquote>
<p>截图是从官网来的，配置信息仅供参考</p>
</blockquote>
<p>选择install</p>
<p><img src="https://img.econow.cn/medivh/1669274996097.png" alt="1669274996097.png"></p>
<p>选择时区</p>
<p><img src="https://img.econow.cn/medivh/1669275081131.png" alt="1669275081131.png"></p>
<p>输入密码和邮箱</p>
<p><img src="https://img.econow.cn/medivh/1669275107625.png" alt="1669275107625.png"></p>
<p>配置网络</p>
<p><img src="https://img.econow.cn/medivh/1669275182405.png" alt="1669275182405.png"></p>
<p>继续安装</p>
<p><img src="https://img.econow.cn/medivh/1669275132232.png" alt="1669275132232.png"></p>
<p>确认信息</p>
<p><img src="https://img.econow.cn/medivh/1669275233980.png" alt="1669275233980.png"></p>
<p>安装完成后重启即可，访问地址为<a target="_blank" rel="noopener" href="https://ip:8006/">https://IP:8006</a></p>
<p><img src="https://img.econow.cn/medivh/1669275401416.png" alt="1669275401416.png"></p>
<p>上面是我已经运行了一段时间的截图。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>首先在登录界面可以先把语言设置成简体中文，输入用户名和密码登录，用户名为root，密码就是安装时设置的密码。</p>
<p><img src="https://img.econow.cn/medivh/1669278628372.png" alt="1669278628372.png"></p>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><h4 id="cpu模式"><a href="#cpu模式" class="headerlink" title="cpu模式"></a>cpu模式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apt-get install cpufrequtils  <span class="comment">#安装驱动</span></span><br><span class="line"></span><br><span class="line">ondemand：系统默认的超频模式，按需调节，内核提供的功能，不是很强大，但有效实现了动态频率调节，平时以低速方式运行，当系统负载提高时候自动提高频率。以这种模式运行不会因为降频造成性能降低，同时也能节约电能和降低温度。一般官方内核默认的方式都是ondemand。</span><br><span class="line"> </span><br><span class="line">interactive：交互模式，直接上最高频率，然后看CPU负荷慢慢降低，比较耗电。Interactive 是以 CPU 排程数量而调整频率，从而实现省电。InteractiveX 是以 CPU 负载来调整 CPU 频率，不会过度把频率调低。所以比 Interactive 反应好些，但是省电的效果一般。</span><br><span class="line"> </span><br><span class="line">conservative：保守模式，类似于ondemand，但调整相对较缓，想省电就用他吧。Google官方内核，kang内核默认模式。</span><br><span class="line"> </span><br><span class="line">smartass：聪明模式，是I和C模式的升级，该模式在比interactive 模式不差的响应的前提下会做到了更加省电。</span><br><span class="line"> </span><br><span class="line">performance：性能模式！只有最高频率，从来不考虑消耗的电量，性能没得说，但是耗电量。</span><br><span class="line"> </span><br><span class="line">powersave 省电模式，通常以最低频率运行。</span><br><span class="line"> </span><br><span class="line">userspace：用户自定义模式，系统将变频策略的决策权交给了用户态应用程序，并提供了相应的接口供用户态应用程序调节CPU 运行频率使用。也就是长期以来都在用的那个模式。可以通过手动编辑配置文件进行配置</span><br><span class="line"> </span><br><span class="line">Hotplug：类似于ondemand, 但是cpu会在关屏下尝试关掉一个cpu，并且带有deep <span class="built_in">sleep</span>，比较省电。</span><br></pre></td></tr></table></figure>

<h4 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpufreq-info <span class="comment"># 查看信息</span></span><br></pre></td></tr></table></figure>

<h4 id="设定"><a href="#设定" class="headerlink" title="设定"></a>设定</h4><p>配置文件位置 &#x2F;etc&#x2F;init.d&#x2F;cpufrequtils  查找GOVERNOR内容替换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/init.d/cpufrequtils</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">ENABLE=<span class="string">&quot;true&quot;</span>   </span><br><span class="line">GOVERNOR=<span class="string">&quot;conservative&quot;</span>  <span class="comment">#运行模式,依照需求调整</span></span><br><span class="line">MAX_SPEED=<span class="string">&quot;2800&quot;</span>         <span class="comment">#上限</span></span><br><span class="line">MIN_SPEED=<span class="string">&quot;1200&quot;</span>         <span class="comment">#下限</span></span><br><span class="line"> </span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br></pre></td></tr></table></figure>

<h3 id="解除弹窗"><a href="#解除弹窗" class="headerlink" title="解除弹窗"></a>解除弹窗</h3><p>登陆后会弹出一个恼人的提示，不会有什么影响但是每次登录都弹窗也是很烦的，还有在概要里面看不到CPU的温度也很不方便，接下来用大佬的一个脚本来解决这两个问题。</p>
<p><img src="https://img.econow.cn/medivh/1669278673588.png" alt="1669278673588.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 JS 源码</span></span><br><span class="line">sed -Ezi.bak <span class="string">&quot;s/(Ext.Msg.show\(\&#123;\s+title: gettext\(&#x27;No valid sub)/void\(\&#123; \/\/\1/g&quot;</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 PVE 服务</span></span><br><span class="line">systemctl restart pveproxy.service</span><br></pre></td></tr></table></figure>

<h3 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注释企业源</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;#deb https://enterprise.proxmox.com/debian/pve bullseye pve-enterprise&quot;</span> &gt; /etc/apt/sources.list.d/pve-enterprise.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># PVE 软件源更换</span></span><br><span class="line">wget https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bullseye.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bullseye.gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://mirrors.ustc.edu.cn/proxmox/debian/pve bullseye pve-no-subscription&quot;</span> &gt; /etc/apt/sources.list.d/pve-no-subscription.list</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-pacific bullseye main&quot;</span> &gt; /etc/apt/sources.list.d/ceph.list</span><br><span class="line"></span><br><span class="line">sed -i.bak <span class="string">&quot;s#http://download.proxmox.com/debian#https://mirrors.ustc.edu.cn/proxmox/debian#g&quot;</span> /usr/share/perl5/PVE/CLI/pveceph.pm</span><br><span class="line"></span><br><span class="line"><span class="comment"># Debian 系统源更换</span></span><br><span class="line">sed -i.bak <span class="string">&quot;s#ftp.debian.org/debian#mirrors.aliyun.com/debian#g&quot;</span> /etc/apt/sources.list</span><br><span class="line">sed -i <span class="string">&quot;s#security.debian.org#mirrors.aliyun.com/debian-security#g&quot;</span> /etc/apt/sources.list</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription&quot;</span> &gt;&gt;  /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新测试一下</span></span><br><span class="line">apt update</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h3><p>首先需要系统镜像，可以上传，也可以从URL下载：<br><img src="https://img.econow.cn/medivh/1669275824568.png" alt="1669275824568.png"></p>
<p>名称是必填的，VM ID 是按照从100开始按照顺序来的，如果创建后删除再创建，那么ID还是100.开机启动，自己来决定是否需要。</p>
<p><img src="https://img.econow.cn/medivh/1669276037929.png" alt="1669276037929.png"></p>
<p>点击下拉选择镜像，如果是Linux 系统的话，默认即可。但是如果是Windows系统，则需要注意选择正确的系统版本，否则会报无法引导的错误。</p>
<p><img src="https://img.econow.cn/medivh/1669276255434.png" alt="1669276255434.png"></p>
<p>磁盘可以填写合适的大小。</p>
<p><img src="https://img.econow.cn/medivh/1669276343155.png" alt="1669276343155.png"></p>
<p>下一步选择CPU类别，注意选择host，以及核心数。</p>
<p><img src="https://img.econow.cn/medivh/1669277576600.png" alt="1669277576600.png"></p>
<p>内存就正常写就可以了。</p>
<p><img src="https://img.econow.cn/medivh/1669277606801.png" alt="1669277606801.png"></p>
<p>网络模式默认即可。</p>
<p><img src="https://img.econow.cn/medivh/1669277629216.png" alt="1669277629216.png"></p>
<p>最后确认启动就可以了。</p>
<p><img src="https://img.econow.cn/medivh/1669277652385.png" alt="1669277652385.png"></p>
<h3 id="虚拟机的使用"><a href="#虚拟机的使用" class="headerlink" title="虚拟机的使用"></a>虚拟机的使用</h3><p>以105这台机器举例：</p>
<ul>
<li>概要 展示虚拟机的监控，比如CPU、内存、网络和磁盘</li>
<li>控制台</li>
<li>硬件  展示硬件的详情</li>
</ul>
<p><img src="https://img.econow.cn/medivh/1669277751784.png" alt="1669277751784.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到此为止，成功的创建了虚拟机，为后续的NAS系统安装打下了基础。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://pve.proxmox.com/pve-docs/pve-admin-guide.html">https://pve.proxmox.com/pve-docs/pve-admin-guide.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.proxmox.com/en/proxmox-ve">https://www.proxmox.com/en/proxmox-ve</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89" class="post-title-link" itemprop="url">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-23 15:15:40" itemprop="dateCreated datePublished" datetime="2022-11-23T15:15:40+08:00">2022-11-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
    <span id="/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89" class="post-meta-item leancloud_visitors" data-flag-title="基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（一）" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>NAS专栏：</p>
<ul>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（一）</a></li>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（二）</a></li>
<li><a href="https://econow.cn/%E5%9F%BA%E4%BA%8EPVE%E5%B9%B3%E5%8F%B0%E7%9A%84TrueNAS_Scale+NextCloud%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%89%EF%BC%89.html#more">基于PVE平台的TrueNAS_Scale+NextCloud的实践总结（三）</a></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>接触到 NAS 这种硬件设备还是在工作以后开始使用的，只不过当时的定义就等于存储，用来扩展服务器的存储空间。随着工作年限的增长，接触NAS的几乎越来越多，从低端的组装 NAS 到高端的企业存储，无外乎最终最主要的功能——存储。</p>
<p>随着工作和生活的变化，意识到自己可能需要拥有一台自己的NAS，虽然折腾组装 NAS 的终点是成品 NAS 。首先工作上会经常遇到一些容器的问题，有了一个 all in one 的平台后就可以创建N台虚拟机来实现一些技术的模拟，比当初刚入行的时候条件好多了。其次一些云盘会和谐一些照片，并且说不定什么时候可能就关门歇业了，虽然只是为了记录大崽的成长，所以除了iCloud以外增加一份保险也是很好的。</p>
<p>综上所述，于公于私有了理由搞个 NAS 。陆续折腾了半个月，终于有个大概的样子，其中的也遇到了一些坎坷，在此记录下来。</p>
<h2 id="系统选型"><a href="#系统选型" class="headerlink" title="系统选型"></a>系统选型</h2><p>首先来聊一下架构，我的目的很简单，就是用最少的成本组装成一台PC，PC上运行虚拟化平台可以创建虚拟机。但最重要的一点是这台PC必须有可扩展性，比如增加硬盘盘位或者多个网卡直通。</p>
<h3 id="软件选型"><a href="#软件选型" class="headerlink" title="软件选型"></a>软件选型</h3><h4 id="虚拟化"><a href="#虚拟化" class="headerlink" title="虚拟化"></a>虚拟化</h4><p>对 All in One 来说最主要的就是底层的虚拟化平台，该平台会决定以后用的舒不舒服或者挖不挖坑。</p>
<p>常见的虚拟化平台有 hype-v、ESXi 、unRaid 和 PVE .其中 hype-v 是微软平台的虚拟化技术，对微软的产品不太感冒也不擅长，因此不做考虑。</p>
<p>ESXi，注重企业支持，界面简单易用，自身功能较强，对硬件要求较高，扩展性较低，但是性能损耗最小。<br>适合初学者、不想太折腾的、有服务器主板的（例如Gen8这种家用服务器）。迷茫的时候，优选ESXi吧。但是需要注意的是该产品面向企业，默认有60天的免费期限，多个节点的话需要考虑付费的问题。</p>
<p>PVE，兼容性最好，扩展性好，界面友善度欠佳，需要一定Linux基础，性能损耗略高于ESXI。<br>适合低端机型、懂Linux的、爱折腾的。PVE玩得溜了之后，看其它的系统都像是弟弟。而且该平台是基于kvm的，这个我用的较多，好感倍增。</p>
<p>unRaid，Docker、磁盘阵列、显卡直通、虚拟U盘等都是亮点。必须U盘引导有点麻烦（廉价U盘7x24工作，心还是很慌）。特色功能多，出新快，因此问题也多。<br>适合直接做NAS、玩PT，尤其适合做家庭影视库、HTPC，玩一拖二也是个不错的选择。比较有可玩性，又不会难度特别高。需要注意该平台是需要付费的。</p>
<p>综上所述，虚拟化平台最终选择了擅长的PVE。</p>
<h4 id="NAS系统"><a href="#NAS系统" class="headerlink" title="NAS系统"></a>NAS系统</h4><h5 id="黑群晖-Xpenology"><a href="#黑群晖-Xpenology" class="headerlink" title="黑群晖&#x2F;Xpenology"></a>黑群晖&#x2F;Xpenology</h5><p>对于新手，DSM永远是最推荐的系统。对于我来说，真的不想考虑破解的问题，谁愿意谁干。而且不知道对虚拟机支持的是否友好，之后扩展硬件可能也没那么容易。</p>
<h5 id="unRaid"><a href="#unRaid" class="headerlink" title="unRaid"></a>unRaid</h5><p>UNRAID是少有的对新手、老手都比较友好的系统。</p>
<p>它有最完善的VM&#x2F;Docker&#x2F;APP支持，活跃的社区。它拥有灵活的拓展性（新增硬盘直接插），更加适合没法一次性购置完全硬盘的家庭用户。 但是它需要付费！</p>
<h5 id="OpenMediaVault-OMV"><a href="#OpenMediaVault-OMV" class="headerlink" title="OpenMediaVault&#x2F;OMV"></a>OpenMediaVault&#x2F;OMV</h5><p>这个系统完全免费开源，基于Debian，并且可以直接装在Debian上面，无需middleware，只要加个Source就行。真纯粹。加了Extras还支持ZFS w&#x2F;WEBUI。但缺点也是纯粹。实际上，它就是一个打包了一堆services和webui的Debian。这就决定了，它的功能很少，或者说需要折腾。对新、老手完全不友好，只推荐给喜欢原生Debian、喜欢折腾的人。总之不推荐。</p>
<h4 id="TrueNas-FreeNas"><a href="#TrueNas-FreeNas" class="headerlink" title="TrueNas&#x2F;FreeNas"></a>TrueNas&#x2F;FreeNas</h4><p>TrueNas Core 基于freebed，稳定并且性能强大，但是由于freebed系统本身趋于没落，所以很多硬件不能得到第一时间支持，且jail的管理方式也不太适合扩展.安装了几个插件，尝试了N次，几乎都没有成功的，要么是网络问题，要么就是各种错误，从官方市场上获取的还能这么多错误，真的有点对不起自己的身份。所以最终选择了TrueNas Scale。</p>
<p>TrueNAS Scale拥有TrueNAS Core的所有优势。包括ZFS等等，在此基础上增加了原生Docker支持，虚拟机也是基于QEMU Kvm，支持功能与性能与PVE相同。</p>
<p>缺点是上手成本高（仍比PVE&#x2F;OMV低）；硬件利用效率比Core略低（等待优化）；Docker是K3S(K8S简化版)，默认禁用iptables，你需要Portainer或者Docker in Docker。</p>
<p>综上所述，NAS系统我最终选择了 TrueNAS Scale 。</p>
<h3 id="电脑硬件知识普及"><a href="#电脑硬件知识普及" class="headerlink" title="电脑硬件知识普及"></a>电脑硬件知识普及</h3><p>在组装PC的过程中遇到了很多问题，因此总结记录一下。</p>
<h4 id="主板分类"><a href="#主板分类" class="headerlink" title="主板分类"></a>主板分类</h4><p>首先聊一下主板规格，只有确定主板尺寸才能确定机箱。</p>
<h5 id="标准型主板ATX-30-5×24-4cm"><a href="#标准型主板ATX-30-5×24-4cm" class="headerlink" title="标准型主板ATX 30.5×24.4cm"></a>标准型主板ATX 30.5×24.4cm</h5><p>标准型主板一般适用于常规尺寸的主机，接口丰富，价格也略高</p>
<h5 id="紧凑型主板M-ATX-24-4x-22-6cm"><a href="#紧凑型主板M-ATX-24-4x-22-6cm" class="headerlink" title="紧凑型主板M-ATX 24.4x 22.6cm"></a>紧凑型主板M-ATX 24.4x 22.6cm</h5><p>M-ATX主板，俗称紧凑型主板，也叫小板，其结构为方形，尺寸大约24.4x 22.6cm，适合小机型用户推荐。紧凑型主板正如其名，接口紧凑、物件够用。</p>
<h5 id="迷你型主板MINI-ITX-17-0×17-0cm"><a href="#迷你型主板MINI-ITX-17-0×17-0cm" class="headerlink" title="迷你型主板MINI-ITX 17.0×17.0cm"></a>迷你型主板MINI-ITX 17.0×17.0cm</h5><p>体积迷你且设计难度大，因此骨架虽小的mini主板，价格往往比很多大号主板还贵，mini型主板并非主流装机之选。</p>
<p>下图是一张包含大部分规格的示意图：</p>
<p><img src="https://img.econow.cn/medivh/1669255122079.png" alt="1669255122079.png"></p>
<p>而我已经拥有的主板种，其中华擎的这块属于M-ATX，但比一般的该标准的主板略小一点点。</p>
<h4 id="主板接口"><a href="#主板接口" class="headerlink" title="主板接口"></a>主板接口</h4><p>下面是一块常规主板的展示图片。</p>
<p><img src="https://img.econow.cn/medivh/1669213876000.png" alt="1669213876000.png"></p>
<p>其中cpu插槽和cpu是一一对应的，英特尔和amd的cpu不能共用同一张主板，所以刚才介绍H310的时候注明了Intel。</p>
<p>sata接口都是扁L形状的，装3.5寸的sata硬盘需要用两根线，分别是电源线和数据线。但是2.5寸硬盘或固态硬盘就不需要供电了，至于为什么，以后再聊。</p>
<p><img src="https://img.econow.cn/medivh/1669214072351.png" alt="1669214072351.png"></p>
<p>重要的接口就这几种，其余的也没啥可聊的，或者遇到了再说吧。</p>
<h4 id="机箱电源"><a href="#机箱电源" class="headerlink" title="机箱电源"></a>机箱电源</h4><p>ATX电源，目前市面上销售的家用电脑电源，一般都遵循 ATX 规范。标准尺寸为 150x140x86mm。</p>
<p>SFX电源，100×125×63.5mm。</p>
<p>1U&#x2F;FLEX电源，150×81.5×40.5mm。</p>
<p>按转换效率的大小层级进行划分，主要分为钛金牌（94%）、白金牌（92%）、金牌（90%）、银牌（88%）、铜牌（85%）、白牌（80%）而低于80%的则属于其它。</p>
<h4 id="硬盘分类"><a href="#硬盘分类" class="headerlink" title="硬盘分类"></a>硬盘分类</h4><p>按原理分类：</p>
<ul>
<li>机械硬盘 HDD 传统硬盘，成本相对较低，读写速度较慢</li>
</ul>
<p><img src="https://img.econow.cn/medivh/1669252647401.png" alt="1669252647401.png"></p>
<ul>
<li>固态硬盘 SDD 相对机械硬盘，读取速度更快，寻道时间更小，可加快操作系统启动速度和软件启动速度</li>
</ul>
<p><img src="https://img.econow.cn/medivh/1669252659142.png" alt="1669252659142.png"></p>
<ul>
<li>混合硬盘 SSHD 机械硬盘与固态硬盘的结合体，采用容量较小的闪存颗粒用来存储常用常用文件，而磁盘才是最重要的存储介质，闪存仅起到了缓冲作用，将更多的常用文件保存到闪存内减小寻道时间，从而提升效率</li>
</ul>
<p><img src="https://img.econow.cn/medivh/1669252671070.png" alt="1669252671070.png"></p>
<p>按接口分类：</p>
<ul>
<li>IDE 并口，以前的服务器用的较多，现在的使用范围极少</li>
</ul>
<p><img src="https://img.econow.cn/medivh/1669253256765.png" alt="1669253256765.png"></p>
<ul>
<li>SATA 串口，主流硬盘，传输速度大约是并口的30倍，PC和服务器使用场景较多</li>
</ul>
<p><img src="https://img.econow.cn/medivh/1669253265935.png" alt="1669253265935.png"></p>
<ul>
<li>SAS 是并行SCSI接口之后开发出的全新接口。此接口的设计是为了改善存储系统的效能、可用性和扩充性，并且提供与SATA硬盘的兼容性，主要应用场景在服务器。</li>
</ul>
<p>SATA硬盘数据和供电接口都是一样的，3.5英寸一般用于尺寸较大的台式机主机，笔记本也不是说不能用，只不过放不下而已。</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>2.5寸</th>
<th>3.5寸</th>
</tr>
</thead>
<tbody><tr>
<td>尺寸</td>
<td>70mm（宽）<em>100mm（长）</em> 9.5mm或7mm（厚）</td>
<td>147mm（长）<em>102mm（宽）</em>26mm（厚）</td>
</tr>
<tr>
<td>转速</td>
<td>5400</td>
<td>7200</td>
</tr>
<tr>
<td>缓存</td>
<td>较小</td>
<td>较大</td>
</tr>
<tr>
<td>性价比</td>
<td>较低</td>
<td>较高</td>
</tr>
</tbody></table>
<h4 id="为什么有的硬盘盒需要单独供电？"><a href="#为什么有的硬盘盒需要单独供电？" class="headerlink" title="为什么有的硬盘盒需要单独供电？"></a>为什么有的硬盘盒需要单独供电？</h4><p>常见的2.5寸硬盘需要0.5~0.9A的5V供电启动。现在的主板一般都有USB 3.0接口，可以提供0.9A的5V供电，过了启动阶段，这个电源需求更低。就算是插在USB 2.0的接口上，一般主板也都支持提供比标准USB 2.0约定的0.5A 5V更大的电流——USB 3.0能给。</p>
<p>3.5寸硬盘，同时要求12V和5V供电，并且启动瞬时功率需要30W以上，12V还可以用变压电路实现，但功率方面，现在的主板都无法提供这么高的功率，自然就需要额外供电了。</p>
<h3 id="硬件选型"><a href="#硬件选型" class="headerlink" title="硬件选型"></a>硬件选型</h3><p>基本原则是利用手上已经拥有的一切硬件，比如：</p>
<ul>
<li>一台J1900平台小机箱<ul>
<li>1 * 128G的SSD</li>
<li>1 * 4G笔记本内存条</li>
<li>1 * mini pcie</li>
<li>1 * msata</li>
<li>1 * 无线网卡</li>
<li>DC电源 12v&#x2F;1A</li>
</ul>
</li>
<li>华擎 H310CM-HDV 主板<ul>
<li>1 * 1T 3.5寸硬盘</li>
<li>1 * 8G DDR4 内存条</li>
<li>1 * 4G DDR4 内存条</li>
<li>1 * 6 x Intel(R) Core(TM) i5-8400 CPU @ 2.80GHz</li>
<li>1 * TFX电源 200W</li>
</ul>
</li>
</ul>
<h4 id="J1900"><a href="#J1900" class="headerlink" title="J1900"></a>J1900</h4><p>这是一台多年前年少无知高价买的小主机，很久没用过了。</p>
<p><img src="https://img.econow.cn/medivh/1669194302147.png" alt="1669194302147.png"></p>
<p>该主机功耗很小，大约只有10W。但是这个机箱实在太小了，只适合安装2~3块2.5寸硬盘或者固态硬盘，并且只有一个内存插槽。这样就导致扩展能力很弱，虽然还有一个msata接口，但是整体来说磁盘和内存扩容的成本很高。所以，这台小主机就有点鸡肋了，索性就放在一边需要的时候再拆零件吧。</p>
<h4 id="华擎-H310CM-HDV"><a href="#华擎-H310CM-HDV" class="headerlink" title="华擎 H310CM-HDV"></a>华擎 H310CM-HDV</h4><p>这块主板不错，对于组装NAS来说，提供的接口：</p>
<ul>
<li>支持第九代与第八代 Intel® 酷睿™ 处理器 (1151 插槽)</li>
<li>支持 DDR4 2666 &#x2F; 2400 &#x2F; 2133，最大32G</li>
<li>1 PCIe 3.0 x16, 1 PCIe 2.0 x1</li>
<li>显示输出选项: DVI-D, D-Sub, HDMI，对我来说HDMI是最重要的</li>
<li>4 x SATA3 6.0 Gb&#x2F;s 接口，满足了基本的硬盘扩展能力，何况之后还可以使用转接头来扩容</li>
<li>1 x Realtek RTL8111H 千兆网卡，支持网络唤醒</li>
<li>4 USB 3.1 Gen1 (2 前置, 2 后置)</li>
</ul>
<p>主板规格Micro ATX 规格: 7.5-in x 7.4-in, 19.1 cm x 18.8 cm，选择机箱的时候需要注意尺寸。</p>
<p>可惜H310的这块板的机箱也比较小，只适合放1块3.5寸硬盘+1块2.5寸硬盘，无法容纳多块3.5寸硬盘，这就很难受。</p>
<p>综上所述，基本硬件都满足，但是机箱是必须要买一个新的。</p>
<h4 id="机箱选型"><a href="#机箱选型" class="headerlink" title="机箱选型"></a>机箱选型</h4><p>有了主板规格：7.5-in x 7.4-in, 19.1 cm x 18.8 cm，现在可以确定机箱尺寸了，必须得容纳M-ATX的机箱。</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>蜗牛星际A</th>
<th>乔伯斯</th>
<th>金河田N1</th>
</tr>
</thead>
<tbody><tr>
<td>主板</td>
<td>ITX</td>
<td>ITX</td>
<td>M-ATX</td>
</tr>
<tr>
<td>电源</td>
<td>1U</td>
<td>SFX</td>
<td>SFX</td>
</tr>
<tr>
<td>硬盘位</td>
<td>4</td>
<td>1~4</td>
<td>2~6</td>
</tr>
<tr>
<td>价格</td>
<td>100~500</td>
<td>100~400</td>
<td>100~200</td>
</tr>
</tbody></table>
<p>特别漂亮的一款机箱，乔伯斯N1支持1+5盘位，就是价格有点不美丽，得6百多左右。</p>
<p>其实对于机箱来说只要主板放的下，硬盘的摆放位置并不局限于机箱的硬盘位，完全可以使用硬盘支架等方式来灵活摆放。</p>
<p><img src="https://img.econow.cn/medivh/1669259101960.png" alt="1669259101960.png"></p>
<p>最终选择的是金河田N1一番魔改后，装上6~8块盘不成问题。小黄鱼上虽然价格低，但基本都得自提，快递不合适。PDD上的价格还行，到手100出头。</p>
<p><img src="https://img.econow.cn/medivh/1669259440233.png" alt="1669259440233.png"></p>
<p><img src="https://img.econow.cn/medivh/1669259453509.png" alt="1669259453509.png"></p>
<p><img src="https://img.econow.cn/medivh/1669259478218.png" alt="1669259478218.png"></p>
<h2 id="装机"><a href="#装机" class="headerlink" title="装机"></a>装机</h2><p><img src="https://img.econow.cn/medivh/1669259885359.png" alt="1669259885359.png"></p>
<p>电源的规格其实不太适合手头上有的这个STX电源，没办法，只能找东西在下面撑住。</p>
<p><img src="https://img.econow.cn/medivh/1669259893408.png" alt="1669259893408.png"></p>
<p>手里暂时只有一块硬盘，之后有了新的再装上。</p>
<p><img src="https://img.econow.cn/medivh/1669259903256.png" alt="1669259903256.png"></p>
<p>走线有点凌乱，但是先点亮再说吧。</p>
<p>安装完成的背板。</p>
<p><img src="https://img.econow.cn/medivh/1669259910747.png" alt="1669259910747.png"></p>
<p>接线的时候大部分接口都没啥问题，但是机箱的电源线就有点复杂了，可以参考说明书。好在主板上会有说明：</p>
<p><img src="https://img.econow.cn/medivh/1669260754443.png" alt="1669260754443.png"></p>
<p>对照着上下两张图接线即可，如果一次失败就检查一下是哪部分的问题。</p>
<p><img src="https://img.econow.cn/medivh/1669260764163.png" alt="1669260764163.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从开始到点亮用了挺长一段时间，大部分时间用来查找资料，小部分时间用来等快递了。纠结了挺长一段时间的机箱选型，最终才决定了金河田N1.</p>
<p>下一篇具体记录一下系统的安装和配置，以及避坑操作。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.asrockchina.com.cn/mb/Intel/H310CM-HDV/index.cn.asp#Specification">华擎 H310CM-HDV主板的详细资料</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/333489243">主板接口科普</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E6%96%B0%E5%8F%91%E5%9C%B0%E8%8F%9C%E4%BB%B7">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E6%96%B0%E5%8F%91%E5%9C%B0%E8%8F%9C%E4%BB%B7" class="post-title-link" itemprop="url">批量抓取新发地菜价</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-30 11:00:03" itemprop="dateCreated datePublished" datetime="2022-09-30T11:00:03+08:00">2022-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
    <span id="/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E6%96%B0%E5%8F%91%E5%9C%B0%E8%8F%9C%E4%BB%B7" class="post-meta-item leancloud_visitors" data-flag-title="批量抓取新发地菜价" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>此篇是之前写的另外一个爬虫项目，只不过后来又了若干版本的演变，因此记录下来。</p>
<h2 id="技术点"><a href="#技术点" class="headerlink" title="技术点"></a>技术点</h2><ul>
<li>多线程</li>
<li>asyncio</li>
<li>aiohttp</li>
<li>aiofiles</li>
</ul>
<h2 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h2><p>该项目抓取的逻辑比较简单，直接根据api获取数据后存储即可，无需从源代码上筛选节点。</p>
<h2 id="多线程的方式"><a href="#多线程的方式" class="headerlink" title="多线程的方式"></a>多线程的方式</h2><blockquote>
<p>需要注意线程数量和limit值，否则容易把网站搞崩！</p>
</blockquote>
<p>下列代码实现两种功能，全量和增量，适用flag来标识：</p>
<ul>
<li>全量数据，抓取全部，如果出现失败的会最终进行重试，直到指定list为空；</li>
<li>增量数据，默认抓取今天，但是如果没有今天的则抓取前一天的，并和已有文件进行比对，不存在对应日期则存储。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@time:2022/09/26</span></span><br><span class="line"><span class="string">@file:xinfadi.py</span></span><br><span class="line"><span class="string">@author:medivh</span></span><br><span class="line"><span class="string">@IDE:PyCharm </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> random_useragent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page_total</span>():</span><br><span class="line">    url = <span class="string">&quot;http://xinfadi.com.cn/getPriceData.html&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(</span><br><span class="line">            url,</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>: random_useragent(),</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        )</span><br><span class="line">        content = response.json()</span><br><span class="line">        <span class="keyword">return</span> content[<span class="string">&#x27;count&#x27;</span>]</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_data</span>(<span class="params">cols</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;xfd.csv&#x27;</span>, <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">&quot;&quot;</span>.join(cols))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_data</span>(<span class="params">pages, current_num, limit_num, flag</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param current_num: 当前页</span></span><br><span class="line"><span class="string">    :param limit_num: 限制返回数量</span></span><br><span class="line"><span class="string">    :param flag: True 全量，False 增量</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> flag:</span><br><span class="line">        data = download_one_page(current_num, limit_num)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">and</span> save_data(data):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;完成第&#123;&#125;页&#x27;</span>.<span class="built_in">format</span>(current_num))</span><br><span class="line">            pages.remove(current_num)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;执行增量逻辑&#x27;</span>)</span><br><span class="line">        data = download_one_page(<span class="number">1</span>, <span class="number">300</span>)</span><br><span class="line">        <span class="comment"># 获得当前时间</span></span><br><span class="line">        now = datetime.datetime.now()</span><br><span class="line">        <span class="comment"># 转换为指定的格式:</span></span><br><span class="line">        days = now.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)</span><br><span class="line">        new_data = [col <span class="keyword">for</span> col <span class="keyword">in</span> data <span class="keyword">if</span> days <span class="keyword">in</span> col]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> new_data:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;没有今天的数据，重新拉取昨天的数据&#x27;</span>)</span><br><span class="line">            one_day_ago = (datetime.datetime.now() - datetime.timedelta(days=<span class="number">1</span>))</span><br><span class="line">            days = one_day_ago.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)</span><br><span class="line">            new_data = [col <span class="keyword">for</span> col <span class="keyword">in</span> data <span class="keyword">if</span> days <span class="keyword">in</span> col]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&#x27;xfd.csv&#x27;</span>) <span class="keyword">or</span> <span class="keyword">not</span> os.path.getsize(<span class="string">&#x27;xfd.csv&#x27;</span>):</span><br><span class="line">                <span class="comment"># 如果文件不存在或者文件为空，则全部存储</span></span><br><span class="line">                save_data(new_data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;xfd.csv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    1. 如果查询到的第一行不为空不包含指定日期，则存储</span></span><br><span class="line"><span class="string">                    2. 如果查询到的第一行为空，则存储</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">if</span> days <span class="keyword">not</span> <span class="keyword">in</span> f.readline():</span><br><span class="line">                        save_data(new_data)</span><br><span class="line">                    <span class="keyword">elif</span> days <span class="keyword">not</span> <span class="keyword">in</span> f.readline():</span><br><span class="line">                        save_data(new_data)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_one_page</span>(<span class="params">current_num, limit_num</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param current_num: 当前页</span></span><br><span class="line"><span class="string">    :param limit_num: 总数</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&quot;http://xinfadi.com.cn/getPriceData.html&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(</span><br><span class="line">            url,</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&quot;User-Agent&quot;</span>: random_useragent(),</span><br><span class="line">                <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            data=&#123;</span><br><span class="line">                <span class="string">&quot;current&quot;</span>: current_num,</span><br><span class="line">                <span class="string">&quot;limit&quot;</span>: limit_num</span><br><span class="line">            &#125;,</span><br><span class="line">            timeout=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line">        content = response.json()</span><br><span class="line">        cols = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> content[<span class="string">&#x27;list&#x27;</span>]:</span><br><span class="line">            col = <span class="string">&#x27;&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125; \n&#x27;</span>.<span class="built_in">format</span>(i[<span class="string">&#x27;id&#x27;</span>], i[<span class="string">&#x27;prodName&#x27;</span>], i[<span class="string">&#x27;prodCatid&#x27;</span>], i[<span class="string">&#x27;prodCat&#x27;</span>],</span><br><span class="line">                                                            i[<span class="string">&#x27;lowPrice&#x27;</span>],</span><br><span class="line">                                                            i[<span class="string">&#x27;highPrice&#x27;</span>], i[<span class="string">&#x27;avgPrice&#x27;</span>], i[<span class="string">&#x27;place&#x27;</span>],</span><br><span class="line">                                                            i[<span class="string">&#x27;unitInfo&#x27;</span>],</span><br><span class="line">                                                            i[<span class="string">&#x27;pubDate&#x27;</span>])</span><br><span class="line">            cols.append(col)</span><br><span class="line">        response.close()</span><br><span class="line">        <span class="keyword">return</span> cols</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">replace_price</span>(<span class="params">nums, limit_num</span>):</span><br><span class="line">    <span class="comment"># time.sleep(30) # 重试数据，可等待30秒，也可以不等</span></span><br><span class="line">    r_sleep = [<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>]</span><br><span class="line">    <span class="keyword">while</span> nums:</span><br><span class="line">        <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">10</span>) <span class="keyword">as</span> rp_t:</span><br><span class="line">            <span class="keyword">for</span> page_num <span class="keyword">in</span> nums:</span><br><span class="line">                rp_args = [page_num, limit_num]</span><br><span class="line">                rp_t.submit(<span class="keyword">lambda</span> p: download_one_page(*p), rp_args)</span><br><span class="line">                time.sleep(random.choice(r_sleep))</span><br><span class="line">    rp_end = <span class="built_in">int</span>(time.time())</span><br><span class="line">    <span class="built_in">print</span>(rp_end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;最终耗时：&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(rp_end - start))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">all_data</span>():</span><br><span class="line">    limit_num = <span class="number">1000</span></span><br><span class="line">    page_nums = <span class="built_in">int</span>(count / <span class="number">1500</span>) + <span class="number">1</span> + <span class="number">1</span>  <span class="comment"># 此处为页面总数，+1为无法整除的情况，第二个+1为range范围终止位置需要再+1</span></span><br><span class="line">    pages = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">10</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, page_nums):</span><br><span class="line">            args = [pages, i, limit_num, <span class="literal">True</span>]</span><br><span class="line">            pages.append(i)</span><br><span class="line">            t.submit(<span class="keyword">lambda</span> p: get_data(*p), args)</span><br><span class="line">    end = <span class="built_in">int</span>(time.time())</span><br><span class="line">    <span class="built_in">print</span>(end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;初次抓取耗时：&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(end - start))</span><br><span class="line">    <span class="keyword">if</span> pages:</span><br><span class="line">        replace_price(pages, limit_num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">last_day_data</span>():</span><br><span class="line">    <span class="comment"># TODO 增量数据放在文首</span></span><br><span class="line">    limit_num = <span class="number">1000</span></span><br><span class="line">    page_nums = <span class="number">1</span> + <span class="number">1</span></span><br><span class="line">    pages = <span class="built_in">list</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;初始化page &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(pages))</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">10</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, page_nums):</span><br><span class="line">            args = [pages, i, limit_num, <span class="literal">False</span>]</span><br><span class="line">            pages.append(i)</span><br><span class="line">            t.submit(<span class="keyword">lambda</span> p: get_data(*p), args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = <span class="built_in">int</span>(time.time())</span><br><span class="line">    <span class="built_in">print</span>(start)</span><br><span class="line">    count = get_page_total()</span><br><span class="line">    <span class="keyword">if</span> count:</span><br><span class="line">        <span class="comment"># all_data() # 全量数据</span></span><br><span class="line">        last_day_data() <span class="comment"># 增量数据</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;无法获取总数&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>最终使用了10个线程正常跑完。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E5%85%8D%E8%B4%B9%E5%B0%8F%E8%AF%B4">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E5%85%8D%E8%B4%B9%E5%B0%8F%E8%AF%B4" class="post-title-link" itemprop="url">批量抓取免费小说</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-29 17:36:12" itemprop="dateCreated datePublished" datetime="2022-09-29T17:36:12+08:00">2022-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
    <span id="/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E5%85%8D%E8%B4%B9%E5%B0%8F%E8%AF%B4" class="post-meta-item leancloud_visitors" data-flag-title="批量抓取免费小说" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>之前尝试过用scrapy抓取过一些网站，实在有点杀鸡焉用牛刀。现在用asyncio的方式再来一遍。</p>
</blockquote>
<h2 id="技术点"><a href="#技术点" class="headerlink" title="技术点"></a>技术点</h2><p>任务使用到的技术点：</p>
<ul>
<li>asyncio</li>
<li>aiohttp</li>
<li>lxml</li>
<li>shutil</li>
</ul>
<p>所使用的技术点基本和之前的文章差不多，此处不再过多介绍。</p>
<h2 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h2><p>起初是想抓取一本小说，后来决定就选择整个专栏吧，其实技术难度也没增加多少。下面先从一本小说开始分析。</p>
<p>首先要获取章节目录的URL。<br><img src="https://img.econow.cn/medivh/1664444705074.png" alt="1664444705074.png"></p>
<p>根据源代码获取章节的URL<br><img src="https://img.econow.cn/medivh/1664444768654.png" alt="1664444768654.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_page_urls</span>(<span class="params">url, sem</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:</span><br><span class="line">                html = etree.HTML(<span class="keyword">await</span> resp.content.read())</span><br><span class="line">                urls = []</span><br><span class="line">                title_of_book = html.xpath(<span class="string">&#x27;//div[@class=&quot;Main List&quot;]/h1/text()&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="built_in">print</span>(title_of_book)</span><br><span class="line">                td_html = html.xpath(<span class="string">&#x27;//div[@class=&quot;Main List&quot;]/dl[1]/dd[1]/a/@href&#x27;</span>)</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> td_html:</span><br><span class="line">                    url = <span class="string">&#x27;https://www.17k.com&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">                    urls.append(url)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;共获取 &#123;&#125; 章节&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(urls)))</span><br><span class="line">                book_info = &#123;</span><br><span class="line">                    <span class="string">&#x27;title&#x27;</span>: title_of_book,</span><br><span class="line">                    <span class="string">&#x27;urls&#x27;</span>: urls</span><br><span class="line">                &#125;</span><br><span class="line">                all_book_list.append(book_info)</span><br></pre></td></tr></table></figure>

<p>代码中将书籍信息设置为dict()，方便之后调用。</p>
<p>然后根据章节URL进行下载小说内容。<br><img src="https://img.econow.cn/medivh/1664444937905.png" alt="1664444937905.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_target</span>(<span class="params">url, i, book_title, sem</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:  <span class="comment"># requests.get()</span></span><br><span class="line">                html = etree.HTML(<span class="keyword">await</span> resp.content.read())</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    body_html = html.xpath(<span class="string">&#x27;//div[@class=&quot;readAreaBox content&quot;]&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;body获取失败&#x27;</span>, e, url)</span><br><span class="line">                title = body_html.xpath(<span class="string">&#x27;./h1/text()&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> i &lt; <span class="number">10</span>:</span><br><span class="line">                    num = <span class="string">&#x27;000&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">                <span class="keyword">elif</span> i &lt; <span class="number">100</span>:</span><br><span class="line">                    num = <span class="string">&#x27;00&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">                <span class="keyword">elif</span> i &lt; <span class="number">1000</span>:</span><br><span class="line">                    num = <span class="string">&#x27;0&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">                file_name = <span class="string">&#x27;./novel/&#123;&#125;/&#123;&#125;.txt&#x27;</span>.<span class="built_in">format</span>(book_title, num)</span><br><span class="line">                content_html = body_html.xpath(<span class="string">&#x27;./div[@class=&quot;p&quot;]/p&#x27;</span>)</span><br><span class="line">                content = [i.xpath(<span class="string">&#x27;./text()&#x27;</span>)[<span class="number">0</span>] <span class="keyword">for</span> i <span class="keyword">in</span> content_html <span class="keyword">if</span> i.xpath(<span class="string">&#x27;./text()&#x27;</span>)]</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    content.remove(content[-<span class="number">1</span>])</span><br><span class="line">                    <span class="comment"># 大部分情况是因为该章节被锁定，暂时无法查看，忽略即可</span></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(e, url)</span><br><span class="line">                content.insert(<span class="number">0</span>, title)</span><br><span class="line">                content.append(<span class="string">&#x27;该章节存在问题，已经被锁定，暂时无法查看&#x27;</span>) <span class="keyword">if</span> <span class="built_in">len</span>(content) == <span class="number">1</span> <span class="keyword">else</span> content.append(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(file_name, <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">await</span> f.write(<span class="string">&quot;\n&quot;</span>.join(content))  <span class="comment"># 读写内容异步需要挂起</span></span><br></pre></td></tr></table></figure>

<p>下面的代码是为了合并文件排序的目的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> i &lt; <span class="number">10</span>:</span><br><span class="line">    num = <span class="string">&#x27;000&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line"><span class="keyword">elif</span> i &lt; <span class="number">100</span>:</span><br><span class="line">    num = <span class="string">&#x27;00&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line"><span class="keyword">elif</span> i &lt; <span class="number">1000</span>:</span><br><span class="line">    num = <span class="string">&#x27;0&#x27;</span> + <span class="built_in">str</span>(i)</span><br></pre></td></tr></table></figure>

<p>经过以上步骤就可以实现抓取一本小说并保存为文件了。</p>
<p>下面聊一下抓取整个专栏的小说的流程。首先获取专栏的所有链接，并且可以从页面可以获取最大页数。</p>
<p><img src="https://img.econow.cn/medivh/1664445213703.png" alt="1664445213703.png"></p>
<p>然后从页面获取每一部书籍的章节入口的URL<br><img src="https://img.econow.cn/medivh/1664445432003.png" alt="1664445432003.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获取所有书籍的URL</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">35</span>):</span><br><span class="line">    url = <span class="string">&#x27;https://www.17k.com/all/book/3_0_0__3__1__&#123;&#125;.html&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">    task = asyncio.create_task(get_book_url(url, sem))</span><br><span class="line">    tasks.append(task)</span><br><span class="line"><span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(all_book_url))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_book_url</span>(<span class="params">url, sem</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:  <span class="comment"># requests.get()</span></span><br><span class="line">                html = etree.HTML(<span class="keyword">await</span> resp.content.read())</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    table_html = html.xpath(<span class="string">&#x27;//tbody/tr[position()&gt;2]&#x27;</span>)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> table_html:</span><br><span class="line">                        url = i.xpath(<span class="string">&#x27;./td[3]/span/a/@href&#x27;</span>)[<span class="number">0</span>].replace(<span class="string">&#x27;book&#x27;</span>, <span class="string">&#x27;list&#x27;</span>)  <span class="comment"># 处理为书籍的章节页面链接</span></span><br><span class="line">                        url = <span class="string">&#x27;https:&#x27;</span> + url</span><br><span class="line">                        all_book_url.append(url)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;body获取失败&#x27;</span>, e, url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取书籍的所有目录的URL</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> all_book_url:</span><br><span class="line">    task = asyncio.create_task(get_page_urls(i, sem))</span><br><span class="line">    tasks.append(task)</span><br><span class="line"><span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(all_book_list))</span><br></pre></td></tr></table></figure>

<p>到此为止，我们已经拿到了专栏里所有的书籍的章节URL，然后调用之前的内容下载函数就可以了。</p>
<p>此外还有一步需要处理，合并章节为一本小说。逻辑很简单，适用<code>os.listdir()</code>遍历每个目录下的章节，然后写入到新的文件里即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_file</span>(<span class="params">path</span>):</span><br><span class="line">    top_file_list = os.listdir(path)</span><br><span class="line">    <span class="built_in">print</span>(top_file_list)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> top_file_list:</span><br><span class="line">            file_list = os.listdir(path + <span class="string">&#x27;/&#x27;</span> + book)</span><br><span class="line">            file_list.sort()</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> file_list:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./book/&#123;&#125;.txt&#x27;</span>.<span class="built_in">format</span>(book), <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./novel/&#123;&#125;/&#x27;</span>.<span class="built_in">format</span>(book) + file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file_f:</span><br><span class="line">                        f.write(file_f.read())</span><br><span class="line">            shutil.rmtree(path + <span class="string">&#x27;/&#x27;</span> + book)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@time:2022/09/29</span></span><br><span class="line"><span class="string">@file:17k.com.py</span></span><br><span class="line"><span class="string">@author:medivh</span></span><br><span class="line"><span class="string">@IDE:PyCharm </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> random_useragent</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"></span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: random_useragent(),</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_target</span>(<span class="params">url, i, book_title, sem</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:  <span class="comment"># requests.get()</span></span><br><span class="line">                html = etree.HTML(<span class="keyword">await</span> resp.content.read())</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    body_html = html.xpath(<span class="string">&#x27;//div[@class=&quot;readAreaBox content&quot;]&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;body获取失败&#x27;</span>, e, url)</span><br><span class="line">                title = body_html.xpath(<span class="string">&#x27;./h1/text()&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> i &lt; <span class="number">10</span>:</span><br><span class="line">                    num = <span class="string">&#x27;000&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">                <span class="keyword">elif</span> i &lt; <span class="number">100</span>:</span><br><span class="line">                    num = <span class="string">&#x27;00&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">                <span class="keyword">elif</span> i &lt; <span class="number">1000</span>:</span><br><span class="line">                    num = <span class="string">&#x27;0&#x27;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">                file_name = <span class="string">&#x27;./novel/&#123;&#125;/&#123;&#125;.txt&#x27;</span>.<span class="built_in">format</span>(book_title, num)</span><br><span class="line">                content_html = body_html.xpath(<span class="string">&#x27;./div[@class=&quot;p&quot;]/p&#x27;</span>)</span><br><span class="line">                content = [i.xpath(<span class="string">&#x27;./text()&#x27;</span>)[<span class="number">0</span>] <span class="keyword">for</span> i <span class="keyword">in</span> content_html <span class="keyword">if</span> i.xpath(<span class="string">&#x27;./text()&#x27;</span>)]</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    content.remove(content[-<span class="number">1</span>])</span><br><span class="line">                    <span class="comment"># 大部分情况是因为该章节被锁定，暂时无法查看，忽略即可</span></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(e, url)</span><br><span class="line">                content.insert(<span class="number">0</span>, title)</span><br><span class="line">                content.append(<span class="string">&#x27;该章节存在问题，已经被锁定，暂时无法查看&#x27;</span>) <span class="keyword">if</span> <span class="built_in">len</span>(content) == <span class="number">1</span> <span class="keyword">else</span> content.append(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(file_name, <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">await</span> f.write(<span class="string">&quot;\n&quot;</span>.join(content))  <span class="comment"># 读写内容异步需要挂起</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">all_book_list = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_page_urls</span>(<span class="params">url, sem</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:</span><br><span class="line">                html = etree.HTML(<span class="keyword">await</span> resp.content.read())</span><br><span class="line">                urls = []</span><br><span class="line">                title_of_book = html.xpath(<span class="string">&#x27;//div[@class=&quot;Main List&quot;]/h1/text()&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="built_in">print</span>(title_of_book)</span><br><span class="line">                td_html = html.xpath(<span class="string">&#x27;//div[@class=&quot;Main List&quot;]/dl[1]/dd[1]/a/@href&#x27;</span>)</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> td_html:</span><br><span class="line">                    url = <span class="string">&#x27;https://www.17k.com&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">                    urls.append(url)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;共获取 &#123;&#125; 章节&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(urls)))</span><br><span class="line">                book_info = &#123;</span><br><span class="line">                    <span class="string">&#x27;title&#x27;</span>: title_of_book,</span><br><span class="line">                    <span class="string">&#x27;urls&#x27;</span>: urls</span><br><span class="line">                &#125;</span><br><span class="line">                all_book_list.append(book_info)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">all_book_url = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_book_url</span>(<span class="params">url, sem</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:  <span class="comment"># requests.get()</span></span><br><span class="line">                html = etree.HTML(<span class="keyword">await</span> resp.content.read())</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    table_html = html.xpath(<span class="string">&#x27;//tbody/tr[position()&gt;2]&#x27;</span>)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> table_html:</span><br><span class="line">                        url = i.xpath(<span class="string">&#x27;./td[3]/span/a/@href&#x27;</span>)[<span class="number">0</span>].replace(<span class="string">&#x27;book&#x27;</span>, <span class="string">&#x27;list&#x27;</span>)  <span class="comment"># 处理为书籍的章节页面链接</span></span><br><span class="line">                        url = <span class="string">&#x27;https:&#x27;</span> + url</span><br><span class="line">                        all_book_url.append(url)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;body获取失败&#x27;</span>, e, url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = []</span><br><span class="line">    sem = asyncio.Semaphore(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取所有书籍的URL</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">35</span>):</span><br><span class="line">        url = <span class="string">&#x27;https://www.17k.com/all/book/3_0_0__3__1__&#123;&#125;.html&#x27;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">        task = asyncio.create_task(get_book_url(url, sem))</span><br><span class="line">        tasks.append(task)</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(all_book_url))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取书籍的所有目录的URL</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> all_book_url:</span><br><span class="line">        task = asyncio.create_task(get_page_urls(i, sem))</span><br><span class="line">        tasks.append(task)</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(all_book_list))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> all_book_list:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&#x27;./novel/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(book[<span class="string">&#x27;title&#x27;</span>])):</span><br><span class="line">            os.mkdir(<span class="string">&#x27;./novel/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(book[<span class="string">&#x27;title&#x27;</span>]))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;处理 &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(book[<span class="string">&#x27;title&#x27;</span>]))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(book[<span class="string">&#x27;urls&#x27;</span>])):</span><br><span class="line">            task = asyncio.create_task(download_target(book[<span class="string">&#x27;urls&#x27;</span>][i], i, book[<span class="string">&#x27;title&#x27;</span>], sem))</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_file</span>(<span class="params">path</span>):</span><br><span class="line">    top_file_list = os.listdir(path)</span><br><span class="line">    <span class="built_in">print</span>(top_file_list)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> top_file_list:</span><br><span class="line">            file_list = os.listdir(path + <span class="string">&#x27;/&#x27;</span> + book)</span><br><span class="line">            file_list.sort()</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> file_list:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./book/&#123;&#125;.txt&#x27;</span>.<span class="built_in">format</span>(book), <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./novel/&#123;&#125;/&#x27;</span>.<span class="built_in">format</span>(book) + file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file_f:</span><br><span class="line">                        f.write(file_f.read())</span><br><span class="line">            shutil.rmtree(path + <span class="string">&#x27;/&#x27;</span> + book)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    version 1.0:</span></span><br><span class="line"><span class="string">    1. 获取章节URL</span></span><br><span class="line"><span class="string">    2. 从URL获取章节内容</span></span><br><span class="line"><span class="string">    3. 存储</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    version 1.5:</span></span><br><span class="line"><span class="string">    1. 获取所有免费小说的URL</span></span><br><span class="line"><span class="string">    2. 从URL获取章节内容</span></span><br><span class="line"><span class="string">    3. 存储</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    start = <span class="built_in">int</span>(time.time())</span><br><span class="line">    <span class="built_in">print</span>(start)</span><br><span class="line">    asyncio.run(main())</span><br><span class="line"></span><br><span class="line">    merge_file(<span class="string">&#x27;./novel&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    end = <span class="built_in">int</span>(time.time())</span><br><span class="line">    <span class="built_in">print</span>(end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;抓取耗时：&#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(end - start))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>此项任务中遇到了几次<code>nodename nor servname provided, or not known</code>的问题，可能是由于大量并发造成DNS解析出现的问题，适用gevent来解决。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"></span><br><span class="line">monkey.patch_all()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E4%BC%98%E7%BE%8E%E5%9B%BE%E5%BA%93">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E4%BC%98%E7%BE%8E%E5%9B%BE%E5%BA%93" class="post-title-link" itemprop="url">批量抓取优美图库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-29 10:28:47" itemprop="dateCreated datePublished" datetime="2022-09-29T10:28:47+08:00">2022-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-31 10:15:08" itemprop="dateModified" datetime="2023-10-31T10:15:08+08:00">2023-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
    <span id="/%E6%89%B9%E9%87%8F%E6%8A%93%E5%8F%96%E4%BC%98%E7%BE%8E%E5%9B%BE%E5%BA%93" class="post-meta-item leancloud_visitors" data-flag-title="批量抓取优美图库" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>以前尝试过一些多线程的方式进行爬虫，现在体验一下协程的方式。</p>
</blockquote>
<h2 id="技术点"><a href="#技术点" class="headerlink" title="技术点"></a>技术点</h2><h3 id="协程的概念"><a href="#协程的概念" class="headerlink" title="协程的概念"></a>协程的概念</h3><p>协程，Coroutine，又称微线程，是一种用户态的轻量级线程。协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复之前保存的寄存器上下文和栈。因此协程能保留上一次调用时的状态，即局部状态的一个特定组合，每次过程重入时，就相当于进入上一次调用的状态。协程本质上是个单线程，相对于多进程来说，无需线程的上下文切换的开销，无需原子操作锁定及同步的开销。可以使用的场景，比如在网络爬虫的场景，发出一个请求之后，需要等待一定的实际才能得到响应。但是在等待过程中，程序可以做一些其他的事情，等到响应后再切回来继续处理，这样可以充分利用CPU和其他资源，也就是协程的优势所在。</p>
<p><img src="https://img.econow.cn/medivh/1664418664734.png" alt="1664418664734.png"></p>
<h3 id="协程的用法"><a href="#协程的用法" class="headerlink" title="协程的用法"></a>协程的用法</h3><p>协程相关的概念:</p>
<ul>
<li>event_loop 事件循环，相当于一个无限循环，可以把一些函数注册到这个事件循环上，当满足条件时，就会调用对应的处理方法。</li>
<li>coroutine 协程，在 Python 中常指代为协程对象类型，可以将协程对象注册到事件循环中，会被事件循环调用。使用 async 关键字来定义一个方法，在调用时不会立即被执行，而是先放回一个协程对象。</li>
<li>task 任务，是对协程对象的进一步封装，包含了任务的所有状态。<br>future 代表将来执行或没有执行任务的任务的结果，和task没有本质的区别。</li>
</ul>
<p>详细讲解参考 <a href="https://econow.cn/%E5%85%B3%E4%BA%8E%E5%8D%8F%E7%A8%8B%E7%9A%84%E8%AE%A4%E7%9F%A5.html">关于协程的认知</a></p>
<h3 id="xpath"><a href="#xpath" class="headerlink" title="xpath"></a>xpath</h3><p>XPath 使用路径表达式来选取 XML 文档中的节点或节点集。节点是通过沿着路径 (path) 或者步 (steps) 来选取的。</p>
<h4 id="选取节点"><a href="#选取节点" class="headerlink" title="选取节点"></a>选取节点</h4><p>XPath 使用路径表达式在 XML 文档中选取节点。节点是通过沿着路径或者 step 来选取的。</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>nodename</td>
<td>选取此节点的所有子节点。</td>
</tr>
<tr>
<td>&#x2F;</td>
<td>从根节点选取（取子节点）。</td>
</tr>
<tr>
<td>&#x2F;&#x2F;</td>
<td>从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置（取子孙节点）。</td>
</tr>
<tr>
<td>.</td>
<td>选取当前节点.</td>
</tr>
<tr>
<td>..</td>
<td>选取当前节点的父节点。</td>
</tr>
<tr>
<td>@</td>
<td>选取属性</td>
</tr>
</tbody></table>
<p>谓语用来查找某个特定的节点或者包含某个指定的值的节点。</p>
<table>
<thead>
<tr>
<th>路径表达式</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;bookstore&#x2F;book[1]</td>
<td>选取属于 bookstore 子元素的第一个 book 元素。</td>
</tr>
<tr>
<td>&#x2F;bookstore&#x2F;book[last()]</td>
<td>选取属于 bookstore 子元素的最后一个 book 元素。</td>
</tr>
<tr>
<td>&#x2F;bookstore&#x2F;book[last()-1]</td>
<td>选取属于 bookstore 子元素的倒数第二个 book 元素。</td>
</tr>
<tr>
<td>&#x2F;bookstore&#x2F;book[position()&lt;4]</td>
<td>选取最前面的3个属于 bookstore 元素的子元素的 book 元素。</td>
</tr>
<tr>
<td>&#x2F;&#x2F;title[@lang]</td>
<td>选取所有拥有名为 lang 的属性的 title 元素。</td>
</tr>
<tr>
<td>&#x2F;&#x2F;title[@lang&#x3D;’eng’]</td>
<td>选取所有 title 元素，且这些元素拥有值为 eng 的 lang 属性。</td>
</tr>
<tr>
<td>&#x2F;bookstore&#x2F;book[price&gt;35.00]</td>
<td>选取 bookstore 元素的所有 book 元素，且其中的 price 元素的值须大于 35.00。</td>
</tr>
<tr>
<td>&#x2F;bookstore&#x2F;book[price&gt;35.00]&#x2F;&#x2F;title选取 bookstore 元素中的 book 元素的所有</td>
<td>title 元素，且其中的 price 元素的值须大于 35.00</td>
</tr>
</tbody></table>
<h2 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h2><p>首先需要先分析一下要爬取的目标是什么？当然是所有的图片。<br>那么图片是怎么展示的呢？通过各个专栏，每个专栏有N页，每页上N个链接，访问链接后就会展示目标图片的链接。</p>
<p>综上所述，流程如下：</p>
<ol>
<li>获取专栏所有页面链接</li>
<li>获取每页上所有图片所属页面的链接</li>
<li>根据图片的链接进行下载和存储</li>
</ol>
<h3 id="获取专栏所有页面链接"><a href="#获取专栏所有页面链接" class="headerlink" title="获取专栏所有页面链接"></a>获取专栏所有页面链接</h3><p><img src="https://img.econow.cn/medivh/1664419499404.png" alt="1664419499404.png"></p>
<p>本次示例目标是电脑壁纸专栏。</p>
<p>根据页面按钮获取第一页和最后一页的URL。其中第一页需要单独处理，之后的任意页都是递增的逻辑。而尾页直接提示767，直接使用即可，也可以复杂点使用xpath提取。<br><img src="https://img.econow.cn/medivh/1664419554458.png" alt="1664419554458.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">page_urls = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page_urls1</span>(<span class="params">page_num</span>):</span><br><span class="line">    <span class="keyword">if</span> page_num == <span class="number">1</span>:</span><br><span class="line">        url = <span class="string">&#x27;https://www.umei.cc/bizhitupian/diannaobizhi&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        url = <span class="string">&#x27;https://www.umei.cc/bizhitupian/diannaobizhi/index_&#123;&#125;.htm&#x27;</span>.<span class="built_in">format</span>(page_num)</span><br><span class="line">    resp = requests.get(url)</span><br><span class="line">    html = etree.HTML(resp.text)</span><br><span class="line">    table = html.xpath(<span class="string">&#x27;//div[contains(@class,&quot;item masonry_brick&quot;)]&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> table:</span><br><span class="line">        url_list = table[<span class="number">0</span>].xpath(<span class="string">&#x27;//div[contains(@class,&quot;img&quot;)]/a/@href&#x27;</span>)</span><br><span class="line">        page_urls.extend(url_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page_urls</span>():</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">100</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>): <span class="comment"># 此处的6为最大页面数，可以自行决定修改，最大值为767</span></span><br><span class="line">            args = [i]</span><br><span class="line">            t.submit(<span class="keyword">lambda</span> p: get_page_urls1(*p), args)</span><br></pre></td></tr></table></figure>

<p>最终获取到了所有页面的链接。</p>
<h3 id="获取每页上所有图片所属页面的链接"><a href="#获取每页上所有图片所属页面的链接" class="headerlink" title="获取每页上所有图片所属页面的链接"></a>获取每页上所有图片所属页面的链接</h3><p><img src="https://img.econow.cn/medivh/1664419837995.png" alt="1664419837995.png"><br>根据源代码获取了图片的链接。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">clean_urls = <span class="built_in">list</span>()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_pic_url1</span>(<span class="params">url</span>):</span><br><span class="line">    url = <span class="string">&#x27;https://www.umei.cc&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">    resp = requests.get(url)</span><br><span class="line">    html = etree.HTML(resp.text)</span><br><span class="line">    pic_link = html.xpath(<span class="string">&#x27;//div[contains(@class,&quot;big-pic&quot;)]/a/img/@src&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    clean_urls.append(pic_link)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_pic_url</span>():</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">100</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> page_urls:</span><br><span class="line">            args = [i]</span><br><span class="line">            t.submit(<span class="keyword">lambda</span> p: get_pic_url1(*p), args)</span><br></pre></td></tr></table></figure>

<p>最终获取了所有图片的URL。</p>
<h3 id="异步下载"><a href="#异步下载" class="headerlink" title="异步下载"></a>异步下载</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = []</span><br><span class="line">    get_page_urls()</span><br><span class="line">    get_pic_url()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;即将下载的文件总数&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(clean_urls)))</span><br><span class="line">    sem = asyncio.Semaphore(<span class="number">15</span>)</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> clean_urls:</span><br><span class="line">        task = asyncio.create_task(download_pic(url, sem))</span><br><span class="line">        tasks.append(task)</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_pic</span>(<span class="params">url, sem</span>):</span><br><span class="line">    name = <span class="string">&#x27;../pic/&#x27;</span> + url.rsplit(<span class="string">&#x27;/&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>]  <span class="comment"># 右切</span></span><br><span class="line">    timeout = aiohttp.ClientTimeout(total=<span class="number">300</span>)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: random_useragent(),</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    conn = aiohttp.TCPConnector(limit=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=conn, timeout=timeout) <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:  <span class="comment"># requests.get()</span></span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">await</span> f.write(<span class="keyword">await</span> resp.content.read())  <span class="comment"># 读取内容异步需要挂起</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;下载完成&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name))</span><br></pre></td></tr></table></figure>

<p>在处理这一步的时候遇到了一些问题，可能是并发太高，导致经常遇到链接断开或者超时的情况，因此使用了Semaphore来控制协程的并发。</p>
<h2 id="整体代码"><a href="#整体代码" class="headerlink" title="整体代码"></a>整体代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@time:2022/09/28</span></span><br><span class="line"><span class="string">@file:aiohttp_umei.cc.py</span></span><br><span class="line"><span class="string">@author:medivh</span></span><br><span class="line"><span class="string">@IDE:PyCharm </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> random_useragent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_pic</span>(<span class="params">url, sem</span>):</span><br><span class="line">    name = <span class="string">&#x27;../pic/&#x27;</span> + url.rsplit(<span class="string">&#x27;/&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>]  <span class="comment"># 右切</span></span><br><span class="line">    timeout = aiohttp.ClientTimeout(total=<span class="number">300</span>)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: random_useragent(),</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    conn = aiohttp.TCPConnector(limit=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=conn, timeout=timeout) <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, headers=headers) <span class="keyword">as</span> resp:  <span class="comment"># requests.get()</span></span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">await</span> f.write(<span class="keyword">await</span> resp.content.read())  <span class="comment"># 读取内容异步需要挂起</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;下载完成&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page_url</span>():</span><br><span class="line">    urls = []</span><br><span class="line">    <span class="keyword">for</span> page_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> page_num == <span class="number">1</span>:</span><br><span class="line">            url = <span class="string">&#x27;https://www.umei.cc/bizhitupian/diannaobizhi&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            url = <span class="string">&#x27;https://www.umei.cc/bizhitupian/diannaobizhi/index_&#123;&#125;.htm&#x27;</span>.<span class="built_in">format</span>(page_num)</span><br><span class="line">        resp = requests.get(url)</span><br><span class="line">        html = etree.HTML(resp.text)</span><br><span class="line">        table = html.xpath(<span class="string">&#x27;//div[contains(@class,&quot;item masonry_brick&quot;)]&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> table:</span><br><span class="line">            url_list = table[<span class="number">0</span>].xpath(<span class="string">&#x27;//div[contains(@class,&quot;img&quot;)]//@href&#x27;</span>)</span><br><span class="line">            urls.extend(url_list)</span><br><span class="line">    <span class="keyword">return</span> urls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">page_urls = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page_urls1</span>(<span class="params">page_num</span>):</span><br><span class="line">    <span class="keyword">if</span> page_num == <span class="number">1</span>:</span><br><span class="line">        url = <span class="string">&#x27;https://www.umei.cc/bizhitupian/diannaobizhi&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        url = <span class="string">&#x27;https://www.umei.cc/bizhitupian/diannaobizhi/index_&#123;&#125;.htm&#x27;</span>.<span class="built_in">format</span>(page_num)</span><br><span class="line">    resp = requests.get(url)</span><br><span class="line">    html = etree.HTML(resp.text)</span><br><span class="line">    table = html.xpath(<span class="string">&#x27;//div[contains(@class,&quot;item masonry_brick&quot;)]&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> table:</span><br><span class="line">        url_list = table[<span class="number">0</span>].xpath(<span class="string">&#x27;//div[contains(@class,&quot;img&quot;)]/a/@href&#x27;</span>)</span><br><span class="line">        page_urls.extend(url_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page_urls</span>():</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">100</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>):</span><br><span class="line">            args = [i]</span><br><span class="line">            t.submit(<span class="keyword">lambda</span> p: get_page_urls1(*p), args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">clean_urls = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_pic_url1</span>(<span class="params">url</span>):</span><br><span class="line">    url = <span class="string">&#x27;https://www.umei.cc&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">    resp = requests.get(url)</span><br><span class="line">    html = etree.HTML(resp.text)</span><br><span class="line">    pic_link = html.xpath(<span class="string">&#x27;//div[contains(@class,&quot;big-pic&quot;)]/a/img/@src&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    clean_urls.append(pic_link)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_pic_url</span>():</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">100</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> page_urls:</span><br><span class="line">            args = [i]</span><br><span class="line">            t.submit(<span class="keyword">lambda</span> p: get_pic_url1(*p), args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = []</span><br><span class="line">    get_page_urls()</span><br><span class="line">    get_pic_url()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;即将下载的文件总数&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(clean_urls)))</span><br><span class="line">    sem = asyncio.Semaphore(<span class="number">15</span>)</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> clean_urls:</span><br><span class="line">        task = asyncio.create_task(download_pic(url, sem))</span><br><span class="line">        tasks.append(task)</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    1. 拼接URL 1-767</span></span><br><span class="line"><span class="string">    2. 从URL获取图片链接</span></span><br><span class="line"><span class="string">    3. 下载图片</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    start = <span class="built_in">int</span>(time.time())</span><br><span class="line">    <span class="built_in">print</span>(start)</span><br><span class="line">    asyncio.run(main())</span><br><span class="line">    end = <span class="built_in">int</span>(time.time())</span><br><span class="line">    <span class="built_in">print</span>(end)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;抓取耗时：&#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(end - start))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>user-agent 可以自定义<br>Semaphore 数值可以根据实际情况来决定，比如带宽</p>
</blockquote>
<p>最终下载了5页图片，149张。<br><img src="https://img.econow.cn/medivh/1664420426755.png" alt="1664420426755.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.51cto.com/article/675758.html">https://www.51cto.com/article/675758.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"g1GwilqmVAUne2tDEDncEChG-gzGzoHsz","app_key":"YB2e5dSKMmMYYCtaSzxp9fdS","server_url":null,"security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>



</body>
</html>
