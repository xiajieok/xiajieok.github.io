<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/page/5/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Docker%20%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Docker%20%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%BA%8C%EF%BC%89.html" class="post-title-link" itemprop="url">Docker 实践总结（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="集群简介"><a href="#集群简介" class="headerlink" title="集群简介"></a>集群简介</h2><h2 id="Swarm"><a href="#Swarm" class="headerlink" title="Swarm"></a>Swarm</h2><h3 id="初始化swarm"><a href="#初始化swarm" class="headerlink" title="初始化swarm"></a>初始化swarm</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull swarm</span><br></pre></td></tr></table></figure>
<p>创建集群token，获取全球唯一的 token，作为集群唯一标识</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm swarm create</span><br><span class="line">a253407f93a759e7b1d69a49cf669732</span><br></pre></td></tr></table></figure>
<p>加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d swarm join -addr=192.168.1.228:2379  token://a253407f93a759e7b1d69a49cf669732</span><br></pre></td></tr></table></figure>
<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 192.168.1.228</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546500467791.png" />
使用下面一段，在其它节点上执行加入集群
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-1g17yyrfepskeffufewmgfiewffqemcc8kjsy9x1zbjucqu4ms-dcp6ub8tjc2yq6bh7qbhs926e 192.168.1.228:2377</span><br></pre></td></tr></table></figure>
### 检查
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546500808458.png" />

<h2 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h2><p>离开集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm leave</span><br></pre></td></tr></table></figure>
<p>部署</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stack deploy -c ws.yml  sys01</span><br><span class="line"></span><br><span class="line">-c 指定yaml文件</span><br><span class="line">name stack 名称</span><br></pre></td></tr></table></figure>
<p>检查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack ls</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546933824902.png" />

<p>stack 详细信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack ps sys01</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546933878894.png" />

<p>检查service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service ls</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546933935686.png" />

<p>删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stack rm sys01</span><br><span class="line">docker service rm xxxx</span><br></pre></td></tr></table></figure>
<h3 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h3><h4 id="AVAILABILITY-的三种状态："><a href="#AVAILABILITY-的三种状态：" class="headerlink" title="AVAILABILITY 的三种状态："></a>AVAILABILITY 的三种状态：</h4><ul>
<li><p>Active：调度器能够安排任务到该节点</p>
</li>
<li><p>Pause：调度器不能够安排任务到该节点，但是已经存在的任务会继续运行</p>
</li>
<li><p>Drain：调度器不能够安排任务到该节点，而且会停止已存在的任务，并将这些任务分配到其他 Active 状态的节点</p>
</li>
</ul>
<h4 id="MANAGER-STATUS-的三种状态"><a href="#MANAGER-STATUS-的三种状态" class="headerlink" title="MANAGER STATUS 的三种状态"></a>MANAGER STATUS 的三种状态</h4><ul>
<li><p>Leader：为群体做出所有群管理和编排决策的主要管理者节点</p>
</li>
<li><p>Reachable：如果 Leader 节点变为不可用，该节点有资格被选举为新的 Leader</p>
</li>
<li><p>Unavailable：该节点不能和其他 Manager 节点产生任何联系，这种情况下，应该添加一个新的 Manager 节点到集群，或者将一个 Worker  节点提升为 Manager 节点</p>
</li>
</ul>
<h3 id="更新节点"><a href="#更新节点" class="headerlink" title="更新节点"></a>更新节点</h3><h4 id="改变节点的可用性-availability"><a href="#改变节点的可用性-availability" class="headerlink" title="改变节点的可用性(availability)"></a>改变节点的可用性(availability)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node update --availability drain WorkerA</span><br></pre></td></tr></table></figure>
<h4 id="添加-移除标签元数据"><a href="#添加-移除标签元数据" class="headerlink" title="添加&#x2F;移除标签元数据"></a>添加&#x2F;移除标签元数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node update --label-add foo --label-add bar=baz WorkerA</span><br></pre></td></tr></table></figure>

<p>类型一：–label-add <key></p>
<p>类型二：–label-add <key>&#x3D;<value></p>
<h4 id="升级-降级节点"><a href="#升级-降级节点" class="headerlink" title="升级&#x2F;降级节点"></a>升级&#x2F;降级节点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[升级] docker node promote WorkerA</span><br><span class="line"></span><br><span class="line">[降级] docker node demote WorkerA</span><br></pre></td></tr></table></figure>


<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker swarm init               #初始化集群</span><br><span class="line">docker swarm join-token worker  #查看工作节点的 token</span><br><span class="line">docker swarm join-token manager #查看管理节点的 token</span><br><span class="line">docker swarm join               #加入集群中</span><br><span class="line"></span><br><span class="line">docker node ls      #查看所有集群节点</span><br><span class="line">docker node rm      #删除某个节点（-f强制删除）</span><br><span class="line">docker node inspect ##查看节点详情</span><br><span class="line">docker node demote  #节点降级，由管理节点降级为工作节点</span><br><span class="line">docker node promote #节点升级，由工作节点升级为管理节点</span><br><span class="line">docker node update  #更新节点</span><br><span class="line">docker node ps      #查看节点中的 Task 任务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker service create   #部署服务</span><br><span class="line">docker service inspect  #查看服务详情</span><br><span class="line">docker service logs     #产看某个服务日志</span><br><span class="line">docker service ls       #查看所有服务详情</span><br><span class="line">docker service rm       #删除某个服务（-f强制删除）</span><br><span class="line">docker service scale    #设置某个服务个数</span><br><span class="line">docker service update   #更新某个服务</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/MacBook%20Pro%20m1%E8%BF%81%E7%A7%BB%E8%AE%B0%E5%BD%95.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/MacBook%20Pro%20m1%E8%BF%81%E7%A7%BB%E8%AE%B0%E5%BD%95.html" class="post-title-link" itemprop="url">MacBook Pro m1迁移记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h2><p>从旧的笔记本迁移到新笔记本上一般有两种方式：</p>
<ul>
<li>第一种是最简单的迁移助理APP；</li>
<li>第二种是使用TimeMachine。</li>
</ul>
<h3 id="迁移助理"><a href="#迁移助理" class="headerlink" title="迁移助理"></a>迁移助理</h3><p>“迁移助理”可将您的所有文件从旧 Mac 拷贝到新 Mac 上，让您不必手动拷贝这些文件。</p>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ol>
<li>两台笔记本的系统版本注意不要差距太大，否则会出现迁移后很多设置比较乱的情况或者其他异常情况。</li>
<li>如果两台电脑使用的都是 macOS Sierra 或更高版本，那么请将它们彼此靠近放置并打开 Wi-Fi 。如果其中有一台电脑使用的是 OS X El Capitan 或更低版本，请确保两者位于同一网络上。</li>
<li>在旧 Mac 上，选取苹果菜单  &gt;“系统偏好设置”，然后点按“共享”。确保“电脑名称”栏中显示一个名称。</li>
</ol>
<h4 id="执行步骤"><a href="#执行步骤" class="headerlink" title="执行步骤"></a>执行步骤</h4><p>在新Mac上</p>
<ol>
<li>打开“迁移助理”，它位于“应用程序”文件夹的“实用工具”文件夹内。然后，点按“继续”。</li>
<li>当“迁移助理”就做出更改而征求您的许可时，输入您的管理员密码，然后点按“好”。</li>
<li>当系统询问您要怎样传输信息时，请选择从 Mac、“时间机器”备份或启动磁盘进行传输的方式。然后，点按“继续”。</li>
</ol>
<p><img src="https://img.mknight.cn/medivh/1636891253812.png" alt="1636891253812.png"></p>
<p>在旧Mac上</p>
<ol>
<li>打开“迁移助理”，然后点按“继续”。</li>
<li>当系统询问您想要怎样传输信息时，请选择“至另一台 Mac”这一传输选项。然后，点按“继续”。</li>
</ol>
<p>在新 Mac 上<br>当系统提示您选择 Mac、“时间机器”备份或其他启动磁盘时，请选择另一台 Mac。然后，点按“继续”。</p>
<p><img src="https://img.mknight.cn/medivh/1636891321526.png" alt="1636891321526.png"></p>
<p>在旧 Mac 上<br>如果看到安全码，请确保其与新 Mac 上显示的安全码相同。然后，点按“继续”。</p>
<p>在新 Mac 上<br>1.选择要传输的信息。</p>
<blockquote>
<p>在这个示例中，John Appleseed 是一个 macOS 用户帐户。如果这个帐户与新 Mac 上已有的帐户同名，则系统会提示您重命名这个旧帐户或替换新 Mac 上的帐户。如果进行重命名，则这个旧帐户会作为单独的用户出现在新 Mac 上，并且拥有单独的个人文件夹和登录名。如果进行替换，则这个旧帐户会删除并随后替换新 Mac 上的帐户，包括相应个人文件夹中的所有内容。</p>
</blockquote>
<p><img src="https://img.mknight.cn/medivh/1636891361313.png" alt="1636891361313.png"></p>
<p>2.点按“继续”以开始传输。大型传输可能需要几个小时才能完成。<br>3.“迁移助理”完成操作后，在两台电脑上退出“迁移助理”，然后在新 Mac 上登录迁移的帐户以查看它的文件。</p>
<h4 id="问题整理"><a href="#问题整理" class="headerlink" title="问题整理"></a>问题整理</h4><ol>
<li><p>迁移助理一直显示正在启动中<br>原因是没有等新的Mac计算为每个项目的大小就点击了继续，解决方式就是重启笔记本，再来一遍。之后等笔记本计算完文件大小，之后再点击继续就可以传输了。</p>
</li>
<li><p>其他</p>
</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>我使用的就是这种方式，简单，但是略微费时。执行过程中基本没有出现什么问题，大体比较顺利，加上摸索的时间全程大约2小时内。</p>
<h3 id="全盘恢复"><a href="#全盘恢复" class="headerlink" title="全盘恢复"></a>全盘恢复</h3><p>所谓的全盘恢复就是使用时间机器的备份恢复到新的笔记本中。</p>
<h4 id="执行步骤-1"><a href="#执行步骤-1" class="headerlink" title="执行步骤"></a>执行步骤</h4><ol>
<li><p>如果需要重新安装 macOS，请先完成这一操作，然后再继续。例如，如果 Mac 启动时显示闪烁的问号，则您需要先重新安装 macOS。</p>
</li>
<li><p>确保您的“时间机器”备份磁盘已连接到 Mac，并处于打开状态。</p>
</li>
<li><p>在 Mac 上打开“迁移助理”。它位于“应用程序”文件夹的“实用工具”文件夹中。</p>
<blockquote>
<p>如果 Mac 启动时显示设置助理，要求提供您所在的国家或地区和您的网络等详细信息，请继续前往下一步，因为设置助理包含了迁移助理。</p>
</blockquote>
</li>
<li><p>当系统询问您要怎样传输信息时，请选择从 Mac、“时间机器”备份或启动磁盘进行传输的方式。然后，点按“继续”。</p>
</li>
</ol>
<p><img src="https://img.mknight.cn/medivh/1636893548067.png" alt="1636893548067.png"></p>
<ol start="5">
<li>选择您的“时间机器”备份，然后点按“继续”。</li>
</ol>
<p><img src="https://img.mknight.cn/medivh/1636893570556.png" alt="1636893570556.png"></p>
<ol>
<li>选取一个备份，然后点按“继续”。</li>
</ol>
<p><img src="https://img.mknight.cn/medivh/1636893593127.png" alt="1636893593127.png"></p>
<ol start="7">
<li>选择要传输的信息</li>
</ol>
<blockquote>
<p>在这个示例中，John Appleseed 是一个 macOS 用户帐户。如果这个旧帐户与 Mac 上已有的帐户同名，则系统会提示您重命名这个旧帐户或替换 Mac 上的帐户。如果进行重命名，则这个旧帐户会作为单独的用户出现在 Mac 上，并且拥有单独的个人文件夹和登录名。如果进行替换，则这个旧帐户会删除并随后替换 Mac 上的帐户，包括相应个人文件夹中的所有内容。</p>
</blockquote>
<p><img src="https://img.mknight.cn/medivh/1636893631865.png" alt="1636893631865.png"></p>
<ol start="8">
<li>点按“继续”以开始传输。大型传输可能需要几个小时才能完成。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://support.apple.com/zh-cn/HT204350">https://support.apple.com/zh-cn/HT204350</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/SpringBoot%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%BE%93%E5%87%BA%E5%88%B0ELK.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/SpringBoot%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%BE%93%E5%87%BA%E5%88%B0ELK.html" class="post-title-link" itemprop="url">SpringBoot日志收集输出到ELK</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>注意logstash启动的时候有个坑，如果启动指定目录，那么必须保证该目录下都是配置文件，否则就会误以为都是配置文件。</p>
</blockquote>
<h2 id="配置pom文件"><a href="#配置pom文件" class="headerlink" title="配置pom文件"></a>配置pom文件</h2><h2 id="配置logback"><a href="#配置logback" class="headerlink" title="配置logback"></a>配置logback</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;configuration debug=&quot;false&quot;&gt; </span><br><span class="line">  &lt;springProperty scope=&quot;context&quot; name=&quot;logPath&quot; source=&quot;joy.logback.path&quot;/&gt;  </span><br><span class="line">  &lt;springProperty scope=&quot;context&quot; name=&quot;logName&quot; source=&quot;spring.application.name&quot;/&gt;  </span><br><span class="line">  &lt;property name=&quot;LOG_HOME&quot; value=&quot;$&#123;logPath&#125;/logs&quot;/&gt;  </span><br><span class="line">  &lt;property name=&quot;LOG_NAME&quot; value=&quot;$&#123;logName&#125;&quot;/&gt;  </span><br><span class="line">  &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt; </span><br><span class="line">    &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt; </span><br><span class="line">      &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt; </span><br><span class="line">    &lt;/encoder&gt; </span><br><span class="line">  &lt;/appender&gt;  </span><br><span class="line"> </span><br><span class="line">  &lt;appender name=&quot;stash&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt; </span><br><span class="line">    &lt;destination&gt;172.16.16.13:4568&lt;/destination&gt;  </span><br><span class="line">    &lt;encoder charset=&quot;UTF-8&quot; class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot;/&gt; </span><br><span class="line">  &lt;/appender&gt;  </span><br><span class="line">  &lt;root level=&quot;INFO&quot;&gt; </span><br><span class="line">    &lt;appender-ref ref=&quot;stash&quot;/&gt;  </span><br><span class="line">    &lt;appender-ref ref=&quot;STDOUT&quot;/&gt; </span><br><span class="line">  &lt;/root&gt; </span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<p>此处定义的level是指程序里的INFO，代表INFO级别的日志都输出至logstash。</p>
<h2 id="配置logstash"><a href="#配置logstash" class="headerlink" title="配置logstash"></a>配置logstash</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">        tcp &#123;</span><br><span class="line">        	add_field =&gt; &#123; &quot;serverType&quot; =&gt; &quot;collect&quot;&#125;</span><br><span class="line">                mode =&gt; &quot;server&quot;</span><br><span class="line">                host =&gt; &quot;0.0.0.0&quot;</span><br><span class="line">                port =&gt; 4568</span><br><span class="line">        	codec =&gt; json &#123; charset =&gt; &quot;UTF-8&quot;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;(?&lt;datetime&gt;\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;\s\d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;.\d&#123;3&#125;)  INFO %&#123;NUMBER:thread&#125; --- %&#123;SYSLOG5424SD:task&#125; %&#123;JAVACLASS:javaclass&#125;\s*: %&#123;SYSLOG5424SD:module&#125;\s*%&#123;GREEDYDATA:msg&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        convert =&gt; [&quot;[geoip][coordinates]&quot;, &quot;float&quot;]</span><br><span class="line">        remove_field =&gt; [&quot;tags&quot;, &quot;offset&quot;, &quot;host&quot;, &quot;beat&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">    if [serverType] == &quot;collect&quot; &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [&quot;127.0.0.1:9200&quot;]</span><br><span class="line">            index =&gt; &quot;collcet-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%88%9B%E5%BB%BAKubernetes%20manifest%20%E6%8C%87%E5%8D%97.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%88%9B%E5%BB%BAKubernetes%20manifest%20%E6%8C%87%E5%8D%97.html" class="post-title-link" itemprop="url">创建Kubernetes manifest 指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>创建编排文件，是一件复杂的事情，很多时候可能没有头绪该如何开始。所以此篇文章提供一些创建的思路。</p>
<p>在定义资源时，将包含以下字段：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  ... </span><br></pre></td></tr></table></figure>

<blockquote>
<p>以下操作均在1.20.0版本，其他版本命令或结果有所不同。</p>
</blockquote>
<h2 id="字段详解"><a href="#字段详解" class="headerlink" title="字段详解"></a>字段详解</h2><h3 id="apiVersion"><a href="#apiVersion" class="headerlink" title="apiVersion"></a>apiVersion</h3><p>该字段指用于创建资源的API组和药使用的API版本。Kubernetes API被聚合到API组中，v1是要使用的apps API版本。如果想列出可用的API组及其版本，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl api-versions </span><br><span class="line">admissionregistration.k8s.io/v1</span><br><span class="line">admissionregistration.k8s.io/v1beta1</span><br><span class="line">apiextensions.k8s.io/v1</span><br><span class="line">apiextensions.k8s.io/v1beta1</span><br><span class="line">apiregistration.k8s.io/v1</span><br><span class="line">apiregistration.k8s.io/v1beta1</span><br><span class="line">apps/v1</span><br><span class="line">authentication.k8s.io/v1</span><br><span class="line">authentication.k8s.io/v1beta1</span><br><span class="line">authorization.k8s.io/v1</span><br><span class="line">authorization.k8s.io/v1beta1</span><br><span class="line">autoscaling/v1</span><br><span class="line">autoscaling/v2beta1</span><br><span class="line">autoscaling/v2beta2</span><br><span class="line">batch/v1</span><br><span class="line">batch/v1beta1</span><br><span class="line">certificates.k8s.io/v1</span><br><span class="line">certificates.k8s.io/v1beta1</span><br><span class="line">coordination.k8s.io/v1</span><br><span class="line">coordination.k8s.io/v1beta1</span><br><span class="line">crd.projectcalico.org/v1</span><br><span class="line">discovery.k8s.io/v1beta1</span><br><span class="line">events.k8s.io/v1</span><br><span class="line">events.k8s.io/v1beta1</span><br><span class="line">extensions/v1beta1</span><br><span class="line">flowcontrol.apiserver.k8s.io/v1beta1</span><br><span class="line">networking.k8s.io/v1</span><br><span class="line">networking.k8s.io/v1beta1</span><br><span class="line">node.k8s.io/v1</span><br><span class="line">node.k8s.io/v1beta1</span><br><span class="line">policy/v1beta1</span><br><span class="line">rbac.authorization.k8s.io/v1</span><br><span class="line">rbac.authorization.k8s.io/v1beta1</span><br><span class="line">scheduling.k8s.io/v1</span><br><span class="line">scheduling.k8s.io/v1beta1</span><br><span class="line">storage.k8s.io/v1</span><br><span class="line">storage.k8s.io/v1beta1</span><br><span class="line">v1</span><br></pre></td></tr></table></figure>

<h3 id="kind"><a href="#kind" class="headerlink" title="kind"></a>kind</h3><p>指定要创建的资源类型，比如Deployment、Pod和ReplicaSet等，可以使用以下命令查看可用的资源类型以及关联的API组：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl api-resources | more</span><br><span class="line">NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND</span><br><span class="line">bindings                                       v1                                     <span class="literal">true</span>         Binding</span><br><span class="line">componentstatuses                 cs           v1                                     <span class="literal">false</span>        ComponentStatus</span><br><span class="line">configmaps                        cm           v1                                     <span class="literal">true</span>         ConfigMap</span><br><span class="line">endpoints                         ep           v1                                     <span class="literal">true</span>         Endpoints</span><br><span class="line">events                            ev           v1                                     <span class="literal">true</span>         Event</span><br><span class="line">limitranges                       limits       v1                                     <span class="literal">true</span>         LimitRange</span><br><span class="line">namespaces                        ns           v1                                     <span class="literal">false</span>        Namespace</span><br><span class="line">nodes                             no           v1                                     <span class="literal">false</span>        Node</span><br><span class="line">persistentvolumeclaims            pvc          v1                                     <span class="literal">true</span>         PersistentVolum</span><br><span class="line">eClaim</span><br><span class="line">persistentvolumes                 pv           v1                                     <span class="literal">false</span>        PersistentVolum</span><br><span class="line">e</span><br><span class="line">pods                              po           v1                                     <span class="literal">true</span>         Pod</span><br><span class="line">podtemplates                                   v1                                     <span class="literal">true</span>         PodTemplate</span><br><span class="line">replicationcontrollers            rc           v1                                     <span class="literal">true</span>         ReplicationCont</span><br><span class="line">roller</span><br><span class="line">resourcequotas                    quota        v1                                     <span class="literal">true</span>         ResourceQuota</span><br><span class="line">secrets                                        v1                                     <span class="literal">true</span>         Secret</span><br><span class="line">serviceaccounts                   sa           v1                                     <span class="literal">true</span>         ServiceAccount</span><br><span class="line">services                          svc          v1                                     <span class="literal">true</span>         Service</span><br><span class="line">mutatingwebhookconfigurations                  admissionregistration.k8s.io/v1        <span class="literal">false</span>        MutatingWebhook</span><br><span class="line">Configuration</span><br><span class="line">validatingwebhookconfigurations                admissionregistration.k8s.io/v1        <span class="literal">false</span>        ValidatingWebho</span><br><span class="line">okConfiguration</span><br><span class="line">customresourcedefinitions         crd,crds     apiextensions.k8s.io/v1                <span class="literal">false</span>        CustomResourceD</span><br><span class="line">efinition</span><br><span class="line">apiservices                                    apiregistration.k8s.io/v1              <span class="literal">false</span>        APIService</span><br><span class="line">controllerrevisions                            apps/v1                                <span class="literal">true</span>         ControllerRevis</span><br><span class="line">ion</span><br><span class="line">daemonsets                        ds           apps/v1                                <span class="literal">true</span>         DaemonSet</span><br><span class="line">deployments                       deploy       apps/v1                                <span class="literal">true</span>         Deployment</span><br><span class="line">replicasets                       rs           apps/v1                                <span class="literal">true</span>         ReplicaSet</span><br><span class="line">statefulsets                      sts          apps/v1                                <span class="literal">true</span>         StatefulSet</span><br><span class="line">tokenreviews                                   authentication.k8s.io/v1               <span class="literal">false</span>        TokenReview</span><br><span class="line">localsubjectaccessreviews                      authorization.k8s.io/v1                <span class="literal">true</span>         LocalSubjectAcc</span><br><span class="line">essReview</span><br><span class="line">selfsubjectaccessreviews                       authorization.k8s.io/v1                <span class="literal">false</span>        SelfSubjectAcce</span><br><span class="line">ssReview</span><br><span class="line">selfsubjectrulesreviews                        authorization.k8s.io/v1                <span class="literal">false</span>        SelfSubjectRule</span><br><span class="line">sReview</span><br><span class="line">subjectaccessreviews                           authorization.k8s.io/v1                <span class="literal">false</span>        SubjectAccessRe</span><br><span class="line">view</span><br><span class="line">horizontalpodautoscalers          hpa          autoscaling/v1                         <span class="literal">true</span>         HorizontalPodAu</span><br><span class="line">toscaler</span><br><span class="line">cronjobs                          cj           batch/v1beta1                          <span class="literal">true</span>         CronJob</span><br><span class="line"><span class="built_in">jobs</span>                                           batch/v1                               <span class="literal">true</span>         Job</span><br><span class="line">certificatesigningrequests        csr          certificates.k8s.io/v1                 <span class="literal">false</span>        CertificateSign</span><br><span class="line">ingRequest</span><br><span class="line">leases                                         coordination.k8s.io/v1                 <span class="literal">true</span>         Lease</span><br><span class="line">bgpconfigurations                              crd.projectcalico.org/v1               <span class="literal">false</span>        BGPConfiguratio</span><br><span class="line">n</span><br><span class="line">bgppeers                                       crd.projectcalico.org/v1               <span class="literal">false</span>        BGPPeer</span><br><span class="line">blockaffinities                                crd.projectcalico.org/v1               <span class="literal">false</span>        BlockAffinity</span><br><span class="line">caliconodestatuses                             crd.projectcalico.org/v1               <span class="literal">false</span>        CalicoNodeStatu</span><br><span class="line">s</span><br><span class="line">clusterinformations                            crd.projectcalico.org/v1               <span class="literal">false</span>        ClusterInformat</span><br><span class="line">ion</span><br><span class="line">felixconfigurations                            crd.projectcalico.org/v1               <span class="literal">false</span>        FelixConfigurat</span><br><span class="line">ion</span><br><span class="line">globalnetworkpolicies                          crd.projectcalico.org/v1               <span class="literal">false</span>        GlobalNetworkPo</span><br><span class="line">licy</span><br><span class="line">globalnetworksets                              crd.projectcalico.org/v1               <span class="literal">false</span>        GlobalNetworkSe</span><br><span class="line">t</span><br><span class="line">hostendpoints                                  crd.projectcalico.org/v1               <span class="literal">false</span>        HostEndpoint</span><br><span class="line">ipamblocks                                     crd.projectcalico.org/v1               <span class="literal">false</span>        IPAMBlock</span><br><span class="line">ipamconfigs                                    crd.projectcalico.org/v1               <span class="literal">false</span>        IPAMConfig</span><br><span class="line">ipamhandles                                    crd.projectcalico.org/v1               <span class="literal">false</span>        IPAMHandle</span><br><span class="line">ippools                                        crd.projectcalico.org/v1               <span class="literal">false</span>        IPPool</span><br><span class="line">ipreservations                                 crd.projectcalico.org/v1               <span class="literal">false</span>        IPReservation</span><br><span class="line">kubecontrollersconfigurations                  crd.projectcalico.org/v1               <span class="literal">false</span>        KubeControllers</span><br><span class="line">Configuration</span><br><span class="line">networkpolicies                                crd.projectcalico.org/v1               <span class="literal">true</span>         NetworkPolicy</span><br><span class="line">networksets                                    crd.projectcalico.org/v1               <span class="literal">true</span>         NetworkSet</span><br><span class="line">endpointslices                                 discovery.k8s.io/v1beta1               <span class="literal">true</span>         EndpointSlice</span><br><span class="line">events                            ev           events.k8s.io/v1                       <span class="literal">true</span>         Event</span><br><span class="line">ingresses                         ing          extensions/v1beta1                     <span class="literal">true</span>         Ingress</span><br><span class="line">flowschemas                                    flowcontrol.apiserver.k8s.io/v1beta1   <span class="literal">false</span>        FlowSchema</span><br><span class="line">prioritylevelconfigurations                    flowcontrol.apiserver.k8s.io/v1beta1   <span class="literal">false</span>        PriorityLevelCo</span><br><span class="line">nfiguration</span><br><span class="line">ingressclasses                                 networking.k8s.io/v1                   <span class="literal">false</span>        IngressClass</span><br><span class="line">ingresses                         ing          networking.k8s.io/v1                   <span class="literal">true</span>         Ingress</span><br><span class="line">networkpolicies                   netpol       networking.k8s.io/v1                   <span class="literal">true</span>         NetworkPolicy</span><br><span class="line">runtimeclasses                                 node.k8s.io/v1                         <span class="literal">false</span>        RuntimeClass</span><br><span class="line">poddisruptionbudgets              pdb          policy/v1beta1                         <span class="literal">true</span>         PodDisruptionBu</span><br><span class="line">dget</span><br><span class="line">podsecuritypolicies               psp          policy/v1beta1                         <span class="literal">false</span>        PodSecurityPoli</span><br><span class="line">cy</span><br><span class="line">clusterrolebindings                            rbac.authorization.k8s.io/v1           <span class="literal">false</span>        ClusterRoleBind</span><br><span class="line">ing</span><br><span class="line">clusterroles                                   rbac.authorization.k8s.io/v1           <span class="literal">false</span>        ClusterRole</span><br><span class="line">rolebindings                                   rbac.authorization.k8s.io/v1           <span class="literal">true</span>         RoleBinding</span><br><span class="line">roles                                          rbac.authorization.k8s.io/v1           <span class="literal">true</span>         Role</span><br><span class="line">priorityclasses                   pc           scheduling.k8s.io/v1                   <span class="literal">false</span>        PriorityClass</span><br><span class="line">csidrivers                                     storage.k8s.io/v1                      <span class="literal">false</span>        CSIDriver</span><br><span class="line">csinodes                                       storage.k8s.io/v1                      <span class="literal">false</span>        CSINode</span><br><span class="line">storageclasses                    sc           storage.k8s.io/v1                      <span class="literal">false</span>        StorageClass</span><br><span class="line">volumeattachments                              storage.k8s.io/v1                      <span class="literal">false</span>        VolumeAttachmen</span><br><span class="line">t</span><br></pre></td></tr></table></figure>

<p>使用<code>api-version</code>和<code>api-resources</code>命令可以找到可用资源与资源类型关联的API组以及API组版本。根据此信息填写<code>apiVersion:</code>和<code>kind:</code>字段。</p>
<p>如果想了解某种资源类型的用途，可以使用<code>kubectl explain</code>命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl explain --api-version=apps/v1 deployment</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Deployment enables declarative updates <span class="keyword">for</span> Pods and ReplicaSets.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">     APIVersion defines the versioned schema of this representation of an</span><br><span class="line">     object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">     value, and may reject unrecognized values. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#resources</span></span><br><span class="line"></span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">     Kind is a string value representing the REST resource this object</span><br><span class="line">     represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">     requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#types-kinds</span></span><br><span class="line"></span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">     Standard object metadata.</span><br><span class="line"></span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line"></span><br><span class="line">   status	&lt;Object&gt;</span><br><span class="line">     Most recently observed status of the Deployment.</span><br></pre></td></tr></table></figure>

<h3 id="metadata"><a href="#metadata" class="headerlink" title="metadata"></a>metadata</h3><p>用于唯一标识Kubernetes集群中的资源，可以为资源命名、分配标签、注解和指定命名空间等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain deployment.metadata | more</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: metadata &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Standard object metadata.</span><br><span class="line">                                                                                                                                             </span><br><span class="line">     ObjectMeta is metadata that all persisted resources must have, <span class="built_in">which</span></span><br><span class="line">     includes all objects <span class="built_in">users</span> must create.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   annotations  &lt;map[string]string&gt;</span><br><span class="line">     Annotations is an unstructured key value map stored with a resource that</span><br><span class="line">     may be <span class="built_in">set</span> by external tools to store and retrieve arbitrary metadata. They</span><br><span class="line">     are not queryable and should be preserved when modifying objects. More</span><br><span class="line">     info: http://kubernetes.io/docs/user-guide/annotations</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="spec"><a href="#spec" class="headerlink" title="spec"></a>spec</h3><p>可以定义要使用的容器镜像、副本数量、selector条件、存活或就绪探针的定义等。查看具体信息可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl explain deployment.spec | more</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Specification of the desired behavior of the Deployment.</span><br><span class="line"></span><br><span class="line">     DeploymentSpec is the specification of the desired behavior of the</span><br><span class="line">     Deployment.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   minReadySeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     Minimum number of seconds <span class="keyword">for</span> <span class="built_in">which</span> a newly created pod should be ready</span><br><span class="line">     without any of its container crashing, <span class="keyword">for</span> it to be considered available.</span><br><span class="line">     Defaults to 0 (pod will be considered available as soon as it is ready)</span><br><span class="line"></span><br><span class="line">   paused	&lt;boolean&gt;</span><br><span class="line">     Indicates that the deployment is paused.</span><br><span class="line"></span><br><span class="line">   progressDeadlineSeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     The maximum time <span class="keyword">in</span> seconds <span class="keyword">for</span> a deployment to make progress before it is</span><br><span class="line">     considered to be failed. The deployment controller will <span class="built_in">continue</span> to process</span><br><span class="line">     failed deployments and a condition with a ProgressDeadlineExceeded reason</span><br><span class="line">     will be surfaced <span class="keyword">in</span> the deployment status. Note that progress will not be</span><br><span class="line">     estimated during the time a deployment is paused. Defaults to 600s.</span><br><span class="line"></span><br><span class="line">   replicas	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     Number of desired pods. This is a pointer to distinguish between explicit</span><br><span class="line">     zero and not specified. Defaults to 1.</span><br><span class="line"></span><br><span class="line">   revisionHistoryLimit	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">     The number of old ReplicaSets to retain to allow rollback. This is a</span><br><span class="line">     pointer to distinguish between explicit zero and not specified. Defaults to</span><br><span class="line">     10.</span><br><span class="line"></span><br><span class="line">   selector	&lt;Object&gt; -required-</span><br><span class="line">     Label selector <span class="keyword">for</span> pods. Existing ReplicaSets whose pods are selected by</span><br><span class="line">     this will be the ones affected by this deployment. It must match the pod</span><br><span class="line">     template<span class="string">&#x27;s labels.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   strategy	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     The deployment strategy to use to replace existin</span></span><br></pre></td></tr></table></figure>

<h4 id="获取模板"><a href="#获取模板" class="headerlink" title="获取模板"></a>获取模板</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl create deployment nginx --image=nginx -o yaml --dry-run=client</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>或者ingress</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl create ingress my-ingress --rule=host/path=app1:80 -o yaml --dry-run=client</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: null</span><br><span class="line">  name: my-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: host</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          service:</span><br><span class="line">            name: app1</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">        path: /path</span><br><span class="line">        pathType: Exact</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>还可以使用 <code>kubectl explain</code> 添加<code>--rescursive</code>参数，可以获取各个字段的分层视图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~ kubectl explain deployment.spec.template.spec.containers.livenessProbe --recursive | more</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: livenessProbe &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Periodic probe of container liveness. Container will be restarted <span class="keyword">if</span> the</span><br><span class="line">     probe fails. Cannot be updated. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle<span class="comment">#container-probes</span></span><br><span class="line"></span><br><span class="line">     Probe describes a health check to be performed against a container to</span><br><span class="line">     determine whether it is alive or ready to receive traffic.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   <span class="built_in">exec</span>	&lt;Object&gt;</span><br><span class="line">      <span class="built_in">command</span>	&lt;[]string&gt;</span><br><span class="line">   failureThreshold	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   httpGet	&lt;Object&gt;</span><br><span class="line">      host	&lt;string&gt;</span><br><span class="line">      httpHeaders	&lt;[]Object&gt;</span><br><span class="line">         name	&lt;string&gt;</span><br><span class="line">         value	&lt;string&gt;</span><br><span class="line">      path	&lt;string&gt;</span><br><span class="line">      port	&lt;string&gt;</span><br><span class="line">      scheme	&lt;string&gt;</span><br><span class="line">   initialDelaySeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   periodSeconds	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   successThreshold	&lt;<span class="built_in">integer</span>&gt;</span><br><span class="line">   tcpSocket	&lt;Object&gt;</span><br><span class="line">      host	&lt;string&gt;</span><br><span class="line">      port	&lt;string&gt;</span><br><span class="line">   timeoutSeconds	&lt;<span class="built_in">integer</span>&gt;</span><br></pre></td></tr></table></figure>

<p>如果想进一步了解更详细的信息，可以继续拼接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node-217 ~]<span class="comment"># kubectl explain deployment.spec.template.spec.containers.lifecycle</span></span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: lifecycle &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Actions that the management system should take <span class="keyword">in</span> response to container</span><br><span class="line">     lifecycle events. Cannot be updated.</span><br><span class="line"></span><br><span class="line">     Lifecycle describes actions that the management system should take <span class="keyword">in</span></span><br><span class="line">     response to container lifecycle events. For the PostStart and PreStop</span><br><span class="line">     lifecycle handlers, management of the container blocks <span class="keyword">until</span> the action is</span><br><span class="line">     complete, unless the container process fails, <span class="keyword">in</span> <span class="built_in">which</span> <span class="keyword">case</span> the handler is</span><br><span class="line">     aborted.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   postStart	&lt;Object&gt;</span><br><span class="line">     PostStart is called immediately after a container is created. If the</span><br><span class="line">     handler fails, the container is terminated and restarted according to its</span><br><span class="line">     restart policy. Other management of the container blocks <span class="keyword">until</span> the hook</span><br><span class="line">     completes. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/<span class="comment">#container-hooks</span></span><br><span class="line"></span><br><span class="line">   preStop	&lt;Object&gt;</span><br><span class="line">     PreStop is called immediately before a container is terminated due to an</span><br><span class="line">     API request or management event such as liveness/startup probe failure,</span><br><span class="line">     preemption, resource contention, etc. The handler is not called <span class="keyword">if</span> the</span><br><span class="line">     container crashes or exits. The reason <span class="keyword">for</span> termination is passed to the</span><br><span class="line">     handler. The Pod<span class="string">&#x27;s termination grace period countdown begins before the</span></span><br><span class="line"><span class="string">     PreStop hooked is executed. Regardless of the outcome of the handler, the</span></span><br><span class="line"><span class="string">     container will eventually terminate within the Pod&#x27;</span>s termination grace</span><br><span class="line">     period. Other management of the container blocks <span class="keyword">until</span> the hook completes</span><br><span class="line">     or <span class="keyword">until</span> the termination grace period is reached. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/<span class="comment">#container-hooks</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><p>整个编排文件分为四个字段或者四部分：</p>
<ol>
<li>apiVersion API组及版本</li>
<li>kind  资源类型</li>
<li>metadata 资源注解</li>
<li>spec 定义和管理资源</li>
</ol>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取API 版本</span></span><br><span class="line">kubectl api-versions</span><br><span class="line"><span class="comment"># 获取资源类型和API版本</span></span><br><span class="line">kubectl api-resources</span><br><span class="line"><span class="comment"># 获取资源详情</span></span><br><span class="line">kubectl explain --api-version=apps/v1 replicaset</span><br><span class="line"><span class="comment"># 根据资源创建基础模板</span></span><br><span class="line">kubectl create deployment nginx --image=nginx -o yaml --dry-run=client</span><br><span class="line"><span class="comment"># 获取资源详情</span></span><br><span class="line">kubectl explain deployment.spec.selector.matchExpressions.operator</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/pptp%20vpn%20%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/pptp%20vpn%20%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC.html" class="post-title-link" itemprop="url">pptp vpn 部署脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>时间久远，不建议直接使用，仅供参考。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Interactive pptp vpn  install script for an OpenVZ VPS</span><br><span class="line"># surport  : Cenost ,Fedora  6.x </span><br><span class="line"># Augest 24, 2014 v1.00</span><br><span class="line">#url ：   http://www.dabu.info/?p=2178</span><br><span class="line"></span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Interactive PoPToP Install Script for an OpenVZ VPS&quot;</span><br><span class="line">echo</span><br><span class="line">echo &quot;Make sure to contact your provider and have them enable&quot;</span><br><span class="line">echo &quot;IPtables and ppp modules prior to setting up PoPToP.&quot;</span><br><span class="line">echo &quot;PPP can also be enabled from SolusVM.&quot;</span><br><span class="line">echo</span><br><span class="line">echo &quot;You need to set up the server before creating more users.&quot;</span><br><span class="line">echo &quot;A separate user is required per connection or machine.&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo</span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Select on option:&quot;</span><br><span class="line">echo &quot;1) Set up new PoPToP server AND create one user&quot;</span><br><span class="line">echo &quot;2) Create additional users&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">read x</span><br><span class="line">if test $x -eq 1; then</span><br><span class="line">echo &quot;Enter username that you want to create (eg. client1 or john):&quot;</span><br><span class="line">read u</span><br><span class="line">echo &quot;Specify password that you want the server to use:&quot;</span><br><span class="line">read p</span><br><span class="line"></span><br><span class="line">## get the VPS IP</span><br><span class="line">#ip=`ifconfig venet0:0 | grep &#x27;inet addr&#x27; | awk &#123;&#x27;print $2&#x27;&#125; | sed s/.*://`</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Downloading and Installing ppp  and   pptpd  &quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">yum   install  ppp   -y</span><br><span class="line">rpm -q|grep epel || rpm -Uvh http://poptop.sourceforge.net/yum/stable/rhel6/pptp-release-current.noarch.rpm</span><br><span class="line">yum    install  pptpd  -y</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Creating Server Config&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">cp /etc/ppp/options.pptpd /etc/ppp/options.pptpd.bak</span><br><span class="line">sed -i &#x27;70a ms-dns 10.202.72.116&#x27;    /etc/ppp/options.pptpd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># setting up pptpd.conf</span><br><span class="line">sed -i &#x27;101a localip 192.168.9.1&#x27;    /etc/pptpd.conf</span><br><span class="line">sed -i &#x27;102a  remoteip 192.168.9.11-30&#x27;    /etc/pptpd.conf</span><br><span class="line"></span><br><span class="line"># adding new user</span><br><span class="line">echo &quot;$u * $p *&quot; &gt;&gt; /etc/ppp/chap-secrets</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Forwarding IPv4 and Enabling it on boot&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt;END</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">END</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Updating IPtables Routing and Enabling it on boot&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">iptables -t nat -A POSTROUTING -o eth1 -j  MASQUERADE</span><br><span class="line"># saves iptables routing rules and enables them on-boot</span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/network/if-pre-up.d/iptables &lt;&lt;END</span><br><span class="line">#!/bin/sh</span><br><span class="line">iptables-restore &lt; /etc/sysconfig/iptables</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">chmod +x /etc/network/if-pre-up.d/iptables</span><br><span class="line">cat &gt;&gt; /etc/ppp/ip-up &lt;&lt;END</span><br><span class="line">ifconfig ppp0 mtu 1400</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Restarting PoPToP&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">sleep 5</span><br><span class="line">/etc/init.d/pptpd restart</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Server setup complete!&quot;</span><br><span class="line">echo &quot;Connect to your VPS at $ip with these credentials:&quot;</span><br><span class="line">echo &quot;Username:$u ##### Password: $p&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line"></span><br><span class="line"># runs this if option 2 is selected</span><br><span class="line">elif test $x -eq 2; then</span><br><span class="line">echo &quot;Enter username that you want to create (eg. client1 or john):&quot;</span><br><span class="line">read u</span><br><span class="line">echo &quot;Specify password that you want the server to use:&quot;</span><br><span class="line">read p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># adding new user</span><br><span class="line">echo &quot;$u * $p *&quot; &gt;&gt; /etc/ppp/chap-secrets</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line">echo &quot;Addtional user added!&quot;</span><br><span class="line">echo &quot;Connect to your VPS at $ip with these credentials:&quot;</span><br><span class="line">echo &quot;Username:$u ##### Password: $p&quot;</span><br><span class="line">echo &quot;######################################################&quot;</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line">echo &quot;Invalid selection, quitting.&quot;</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Kubernetes%20job%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Kubernetes%20job%E7%9A%84%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3.html" class="post-title-link" itemprop="url">Kubernetes job的深入理解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Deployment、StatefulSet以及DeamonSet这三种编排概念都有一些共同点，实际上编排的对象都是在线业务。一般的在线业务是一种长时间的作业，比如NGINX、Tomcat，这些应用一旦运行起来，除非出错或者停止，否则容器进程会一直保持在Running状态。</p>
<p>还有一类是离线业务，或者叫做Batch Job。这种业务在计算完成后就直接退出了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Zookeeper%20%E5%AE%9E%E8%B7%B5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Zookeeper%20%E5%AE%9E%E8%B7%B5.html" class="post-title-link" itemprop="url">Zookeeper 实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p> ZooKeeper 是一个开源的分布式协调服务，由雅虎创建，是 Google Chubby 的开源实现。<br>分布式应用程序可以基于 ZooKeeper 实现诸如数据发布&#x2F;订阅、负载均衡、命名服务、分布式协<br>调&#x2F;通知、集群管理、Master 选举、配置维护，名字服务、分布式同步、分布式锁和分布式队列<br>等功能。</p>
</blockquote>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><p>一个 ZooKeeper 集群同一时刻只会有一个 Leader，其他都是 Follower 或 Observer。</p>
<p>ZooKeeper 配置很简单，每个节点的配置文件(zoo.cfg)都是一样的，只有 myid 文件不一样。myid 的值必须是 zoo.cfg中server.{数值} 的{数值}部分。<br>在装有 ZooKeeper 的机器的终端执行 zookeeper-server status 可以看当前节点的 ZooKeeper是什么角色（Leader or Follower）。<br><img src="https://img.mknight.cn/medivh/1547261347782.png" /><br>ZooKeeper 默认只有 Leader 和 Follower 两种角色，没有 Observer 角色。为了使用 Observer 模式，在任何想变成Observer的节点的配置文件中加入:peerType&#x3D;observer 并在所有 server 的配置文件中，配置成 observer 模式的 server 的那行配置追加 :observer 。</p>
<h3 id="读写分工"><a href="#读写分工" class="headerlink" title="读写分工"></a>读写分工</h3><ul>
<li>ZooKeeper 集群的所有机器通过一个 Leader 选举过程来选定一台被称为『Leader』的机器，Leader服务器为客户端提供读和写服务。</li>
<li>Follower 和 Observer 都能提供读服务，不能提供写服务。两者唯一的区别在于，Observer机器不参与 Leader 选举过程，也不参与写操作的『过半写成功』策略，因此 Observer 可以在不影响写性能的情况下提升集群的读性能</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>ZooKeeper 是一个高可用的分布式数据管理与协调框架。基于对ZAB算法的实现，该框架能够很好地保证分布式环境中数据的一致性。也是基于这样的特性，使得 ZooKeeper 成为了解决分布式一致性问题的利器。</p>
<h2 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>配置jdk</li>
<li>配置hosts</li>
<li>配置 myid</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://archive.apache.org/dist/zookeeper/">http://archive.apache.org/dist/zookeeper/</a><br>另外一家CDH版本的<br><a target="_blank" rel="noopener" href="http://archive.cloudera.com/cdh5/cdh/5/">http://archive.cloudera.com/cdh5/cdh/5/</a></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">dataDir=/opt/zookeeper/data</span><br><span class="line">dataLogDir=/opt/zookeeper/log</span><br><span class="line">clientPort=2181</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=c1:2888:3888</span><br><span class="line">server.2=c2:2888:3888</span><br><span class="line">server.3=c3:2888:3888</span><br></pre></td></tr></table></figure>

<h4 id="配置文件解读"><a href="#配置文件解读" class="headerlink" title="配置文件解读"></a>配置文件解读</h4><ul>
<li>initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 10 个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000&#x3D;10 秒</li>
<li>syncLimit：这个配置项标识 Leader 与 Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是 2*2000&#x3D;4 秒</li>
<li>server.A&#x3D;B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。</li>
</ul>
<h4 id="两台部署三台的伪集群示例"><a href="#两台部署三台的伪集群示例" class="headerlink" title="两台部署三台的伪集群示例"></a>两台部署三台的伪集群示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">### z1</span><br><span class="line"></span><br><span class="line">tickTime=2000</span><br><span class="line">dataDir=/home/joy/zookeeper/data</span><br><span class="line">dataLogDir=/home/joy/zookeeper/log</span><br><span class="line">clientPort=2181</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=10.252.1.15:2888:3888</span><br><span class="line">server.2=10.252.4.11:2888:3888</span><br><span class="line">server.3=10.252.4.11:2899:3899</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### z2</span><br><span class="line"></span><br><span class="line">tickTime=2000</span><br><span class="line">dataDir=/home/joy/zookeeper/data</span><br><span class="line">dataLogDir=/home/joy/zookeeper/log</span><br><span class="line">clientPort=2181</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=10.252.1.15:2888:3888</span><br><span class="line">server.2=10.252.4.11:2888:3888</span><br><span class="line">server.3=10.252.4.11:2899:3899</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### z3</span><br><span class="line"></span><br><span class="line">tickTime=2000</span><br><span class="line">dataDir=/home/joy/zookeeper3/data</span><br><span class="line">dataLogDir=/home/joy/zookeeper3/log</span><br><span class="line">clientPort=2182</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">server.1=10.252.1.15:2888:3888</span><br><span class="line">server.2=10.252.4.11:2888:3888</span><br><span class="line">server.3=10.252.4.11:2899:3899</span><br></pre></td></tr></table></figure>

<h3 id="myid"><a href="#myid" class="headerlink" title="myid"></a>myid</h3><p>集群模式下还要配置一个文件 myid，这个文件在 dataDir 目录下，这个文件里面就有一个数据就是 A 的值，Zookeeper 启动时会读取这个文件，拿到里面的数据与 zoo.cfg 里面的配置信息比较从而判断到底是那个 server。</p>
<h3 id="启动节点"><a href="#启动节点" class="headerlink" title="启动节点"></a>启动节点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zkServer.sh start conf/zoo.cfg</span><br></pre></td></tr></table></figure>
<h3 id="分别检查节点状态"><a href="#分别检查节点状态" class="headerlink" title="分别检查节点状态"></a>分别检查节点状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper bin/zkServer.sh status conf/zoo.cfg</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1561278792094.png"  />
<img src="https://img.mknight.cn/medivh/1561278810493.png"  />
<img src="https://img.mknight.cn/medivh/1561278829368.png"  />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8ENginx%E5%9C%A8%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8ENginx%E5%9C%A8%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C.html" class="post-title-link" itemprop="url">关于Nginx在日常工作中的一些经验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="负载均衡参数"><a href="#负载均衡参数" class="headerlink" title="负载均衡参数"></a>负载均衡参数</h3><p>在Nginx的负载均衡检查模块中，对于负载均衡的节点可以配置如下可选参数参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_fails=1fail_timeout=10s</span><br></pre></td></tr></table></figure>

<p>这个是Nginx在负载均衡功能中，用于判断后端节点状态，所用到两个参数。</p>
<p>Nginx基于连接探测，如果发现后端异常，在单位周期为fail_timeout设置的时间，中达到max_fails次数，这个周期次数内，如果后端同一个节点不可用，那么接将把节点标记为不可用，并等待下一个周期（同样时常为fail_timeout）再一次去请求，判断是否连接是否成功。如果成功，将恢复之前的轮询方式，如果不可用将在下一个周期(fail_timeout)再试一次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认：fail_timeout为10s,max_fails为1次。</span></span><br></pre></td></tr></table></figure>

<h3 id="proxy-next-upstream"><a href="#proxy-next-upstream" class="headerlink" title="proxy_next_upstream"></a>proxy_next_upstream</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_next_upstream http_500 | http_502 | http_503 | http_504 |http_404;</span><br></pre></td></tr></table></figure>

<p>当其中一台返回错误码404,500…等错误时，可以分配到下一台服务器程序继续处理，提高平台访问成功率，多可运用于前台程序负载。</p>
<p>场景:当访问A时，A返回error timeout时，访问会继续分配到下一台服务器处理，就等于一个请求分发到多台服务器，就可能出现多次处理的情况，<br>如果涉及到充值，就有可能充值多次的情况，这种情况下就要把proxy_next_upstream关掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_next_upstream off</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8E%E5%8D%8F%E7%A8%8B%E7%9A%84%E8%AE%A4%E7%9F%A5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8E%E5%8D%8F%E7%A8%8B%E7%9A%84%E8%AE%A4%E7%9F%A5.html" class="post-title-link" itemprop="url">关于协程的认知</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在执行IO密集型任务的时候，程序经常会因为等待IO而阻塞。比如平时使用的requests库来进行请求接口，如果响应过慢，程序会一直等待响应，最后导致抓取数据的效率低下。为了解决这一问题，来研究一下异步协程加速的方法。</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li>阻塞。阻塞状态是指程序未得到所需计算资源被挂起的状态。程序在等待某操作期间，自身无法继续干别的事。常见的阻塞形式：网络I&#x2F;O阻塞、磁盘IO&#x2F;阻塞、用户输入阻塞等。</li>
<li>非阻塞。程序在等待某操作过程中，自身不被阻塞，可以继续运行干别的事，则成该程序在该操作上非阻塞的。 非阻塞的存在是因为阻塞存在，正因为某个操作阻塞导致的耗时和效率低下，因此我们才要把它变味非阻塞的。</li>
<li>同步。不同的程序为了完成某个任务，在执行过程中需要依靠某种同喜方式协调一致，称这些程序单元是同步执行的，比如商品库存。</li>
<li>异步。为了完成某个任务，不同程序之间过程无需通信协调，也能完成任务的方式，不相关的程序单元之间是可以异步的。比如爬虫网页。</li>
<li>多进程。就是利用CPU多核的优势，在同一时间并行的执行多个任务，可以极大的提高效率。</li>
<li>协程，Coroutine，又称微线程，是一种用户态的轻量级线程。协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复之前保存的寄存器上下文和栈。因此协程能保留上一次调用时的状态，即局部状态的一个特定组合，每次过程重入时，就相当于进入上一次调用的状态。协程本质上是个单线程，相对于多进程来说，无需线程的上下文切换的开销，无需原子操作锁定及同步的开销。可以使用的场景，比如在网络爬虫的场景，发出一个请求之后，需要等待一定的实际才能得到响应。但是在等待过程中，程序可以做一些其他的事情，等到响应后再切回来继续处理，这样可以充分利用CPU和其他资源，也就是协程的优势所在。</li>
</ul>
<h3 id="执行顺序的对比"><a href="#执行顺序的对比" class="headerlink" title="执行顺序的对比"></a>执行顺序的对比</h3><p><img src="https://img.mknight.cn/medivh/1658742421514.png" alt="1658742421514.png"><br><img src="https://img.mknight.cn/medivh/1658742437775.png" alt="1658742437775.png"></p>
<h2 id="协程的用法"><a href="#协程的用法" class="headerlink" title="协程的用法"></a>协程的用法</h2><p>协程相关的概念:  </p>
<ul>
<li>event_loop 事件循环，相当于一个无限循环，可以把一些函数注册到这个事件循环上，当满足条件时，就会调用对应的处理方法。</li>
<li>coroutine 协程，在 Python 中常指代为协程对象类型，可以将协程对象注册到事件循环中，会被事件循环调用。使用 async 关键字来定义一个方法，在调用时不会立即被执行，而是先放回一个协程对象。</li>
<li>task 任务，是对协程对象的进一步封装，包含了任务的所有状态。</li>
<li>future 代表将来执行或没有执行任务的任务的结果，和task没有本质的区别。</li>
</ul>
<h3 id="定义协程"><a href="#定义协程" class="headerlink" title="定义协程"></a>定义协程</h3><p>代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_number</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Number:&#x27;</span>, x)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    coroutine = get_number(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Coroutine:&#x27;</span>, coroutine)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(coroutine)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行结果</span></span><br><span class="line"></span><br><span class="line"><span class="type">Coroutine</span>: &lt;coroutine <span class="built_in">object</span> get_number at <span class="number">0x10e049f40</span>&gt;</span><br><span class="line">After calling execute</span><br><span class="line">Number: <span class="number">1</span></span><br><span class="line">After calling loop</span><br></pre></td></tr></table></figure>

<p>执行过程的分析：</p>
<ol>
<li>引入 asyncio ，这样才可以使用 async 和 await；</li>
<li>然后使用async定义一个方法，方法接收一个数字的参数，该方法执行后会打印数字；</li>
<li>随后调用这个方法，但是并没有执行，而是返回一个coroutine 协程对象；</li>
<li>之后我们使用get_event_loop方法创建一个事件循环loop，并调用了loop对象的run_until_complate方法将协程注册到事件循环loop中，然后启动；</li>
<li>最后看到了输出结果。</li>
</ol>
<p>可见，async 定义的方法机会变成一个无法直接运行的coroutine对象，必须注册到事件循环中才可以执行。上文中提到的task，是对coroutine对象的进一步封装，比coroutine对象多了允许状态，比如running、fiished等，可以通过这些状态来获取协程对象的执行情况。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_number</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Number:&#x27;</span>, x)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    coroutine = get_number(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Coroutine:&#x27;</span>, coroutine)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    task = loop.create_task(coroutine)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">    loop.run_until_complete(task)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="type">Coroutine</span>: &lt;coroutine <span class="built_in">object</span> get_number at <span class="number">0x10e38df40</span>&gt;</span><br><span class="line">After calling execute</span><br><span class="line">Task: &lt;Task pending name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;get_number() running at /Users/medivh/tools/test_async.py:<span class="number">45</span>&gt;&gt;</span><br><span class="line">Number: <span class="number">1</span></span><br><span class="line">Task: &lt;Task finished name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;get_number() done, defined at /Users/medivh/tools/test_async.py:<span class="number">45</span>&gt; result=<span class="number">1</span>&gt;</span><br><span class="line">After calling loop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里定义loop对象后，接着调用了create_task方法将coroutine对象转化为了task对象，随后的输出发现是pending状态。接着将task对象添加到事件循环中得到执行，随后再输出，就变成了finished。并且同时result变成了1，也就是get_number方法的返回结果。</p>
<p>另外，还有一种定义task对象的方式，直接通过asyncio的ensure_future()方法，返回的也是task对象，就不需要借助loop来定义。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_number</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Number:&#x27;</span>, x)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    coroutine = get_number(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Coroutine:&#x27;</span>, coroutine)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    task = asyncio.ensure_future(coroutine)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(task)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="type">Coroutine</span>: &lt;coroutine <span class="built_in">object</span> get_number at <span class="number">0x10c19ff40</span>&gt;</span><br><span class="line">After calling execute</span><br><span class="line">Task: &lt;Task pending name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;get_number() running at /Users/medivh/tools/test_async.py:<span class="number">48</span>&gt;&gt;</span><br><span class="line">Number: <span class="number">1</span></span><br><span class="line">Task: &lt;Task finished name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;get_number() done, defined at /Users/medivh/tools/test_async.py:<span class="number">48</span>&gt; result=<span class="number">1</span>&gt;</span><br><span class="line">After calling loop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="绑定回调"><a href="#绑定回调" class="headerlink" title="绑定回调"></a>绑定回调</h3><p>可以给某个task搬到回调方法，示例如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_status</span>():</span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    status = requests.get(url).status_code</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">callback</span>(<span class="params">task</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Status:&#x27;</span>, task.result())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    coroutine_obj = get_status()</span><br><span class="line">    task = asyncio.ensure_future(coroutine_obj)  <span class="comment"># 定义task</span></span><br><span class="line">    task.add_done_callback(callback)    <span class="comment"># 将callback() 传递给封装好的task对象</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(task)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Task: &lt;Task pending name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;request() running at /Users/medivh/github/mercury/tools/test_async.py:<span class="number">69</span>&gt; cb=[callback() at /Users/medivh/tools/test_async.py:<span class="number">75</span>]&gt;</span><br><span class="line">Status: <span class="number">200</span></span><br><span class="line">Task: &lt;Task finished name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;request() done, defined at /Users/medivh/tools/test_async.py:<span class="number">69</span>&gt; result=<span class="number">200</span>&gt;</span><br></pre></td></tr></table></figure>

<p>代码说明：</p>
<ol>
<li>调用add_done_callback方法，将callback方法传递给封装好的task对象；</li>
<li>task执行完毕后调用callback方法；</li>
<li>task对象同时作为参数传递给callback方法，调用task对象的result方法就可以获取返回结果。</li>
</ol>
<p>其实，不用回方法，直接在task运行完毕后也可以直接调用result方法获取结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_status</span>():</span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    status = requests.get(url).status_code</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    coroutine_obj = get_status()</span><br><span class="line">    task = asyncio.ensure_future(coroutine_obj)  <span class="comment"># 定义task</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(task)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task Result:&#x27;</span>, task.result())</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Task: &lt;Task pending name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;get_status() running at /Users/medivh/tools/test_async.py:<span class="number">69</span>&gt;&gt;</span><br><span class="line">Task: &lt;Task finished name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;get_status() done, defined at /Users/medivh/tools/test_async.py:<span class="number">69</span>&gt; result=<span class="number">200</span>&gt;</span><br><span class="line">Task Result: <span class="number">200</span></span><br></pre></td></tr></table></figure>

<h3 id="多任务协程"><a href="#多任务协程" class="headerlink" title="多任务协程"></a>多任务协程</h3><p>对于想执行多次请求的方案，可以定义一个task列表，然后使用asyncio的wait方法即可执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_status</span>():</span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    status = requests.get(url).status_code</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    tasks = [asyncio.ensure_future(get_status()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Tasks: &quot;</span>, tasks)</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Task Result:&quot;</span>, task.result())</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Tasks:  [&lt;Task pending name=<span class="string">&#x27;Task-1&#x27;</span> coro=&lt;get_status() running at /Users/medivh/github/mercury/tools/test_async.py:<span class="number">69</span>&gt;&gt;, &lt;Task pending name=<span class="string">&#x27;Task-2&#x27;</span> coro=&lt;get_status() running at /Users/medivh/github/mercury/tools/test_async.py:<span class="number">69</span>&gt;&gt;, &lt;Task pending name=<span class="string">&#x27;Task-3&#x27;</span> coro=&lt;get_status() running at /Users/medivh/github/mercury/tools/test_async.py:<span class="number">69</span>&gt;&gt;, &lt;Task pending name=<span class="string">&#x27;Task-4&#x27;</span> coro=&lt;get_status() running at /Users/medivh/github/mercury/tools/test_async.py:<span class="number">69</span>&gt;&gt;, &lt;Task pending name=<span class="string">&#x27;Task-5&#x27;</span> coro=&lt;get_status() running at /Users/medivh/github/mercury/tools/test_async.py:<span class="number">69</span>&gt;&gt;]</span><br><span class="line">Task Result: <span class="number">200</span></span><br><span class="line">Task Result: <span class="number">200</span></span><br><span class="line">Task Result: <span class="number">200</span></span><br><span class="line">Task Result: <span class="number">200</span></span><br><span class="line">Task Result: <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p>代码说明：</p>
<ol>
<li>for循环创建5个task，组成list；</li>
<li>把list首先传给asyncio的wait方法，然后注册到事件循环中；</li>
<li>发起5个任务；</li>
<li>输出任务结果。</li>
</ol>
<h3 id="协程实现"><a href="#协程实现" class="headerlink" title="协程实现"></a>协程实现</h3><p>前面的代码都是以网络请求为例，都是耗时的等待的操作，因为在请求网页后需要等待页面响应并返回结果。耗时的等待操作一般都是IO操作，比如文件读写、网络请求等，而协程对于处理这种操作具有很大优势。往往可以在需要等待的时候，程序可以暂时挂起，转而执行其他的操作，从而避免等待一个程序而耗费过多的时间，达到充分利用资源的目的。</p>
<p>代码示例如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_status</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/welcome&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;waiting for &#123;&#125; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(url,time.time()))</span><br><span class="line">    status = requests.get(url).status_code</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    tasks = [asyncio.ensure_future(get_status()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Cost time:&#x27;</span>, end - start)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658818769.805218</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658818770.0085208</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658818770.101907</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658818770.1906009</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658818770.262319</span></span><br><span class="line">Cost time: <span class="number">0.5311617851257324</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>事实上和正常的请求耗时相差不大，几乎是依次执行的。其实出现这种情况是因为要实现异步处理，必须得有挂起的操作，当一个任务需要等待IO结果的时候，可以挂起当前任务，转而去执行其他任务。</p>
<p>接下来了解一下await的用法，使用await可以将耗时等待的操作挂起，让出控制权。当协程执行的时候遇到await，事件循环就会将本协程挂起，转而执行其他的协程，知道其他的协程挂起或执行完毕。然后，将代码改造一下。</p>
<blockquote>
<p>如果直接改造上文代码，会出现以下提示<code>Class &#39;int&#39; does not define &#39;__await__&#39;, so the &#39;await&#39; operator cannot be used on its instances </code>。这是因为await后必须符合以下对象：</p>
<ul>
<li>一个原生coroutine对象</li>
<li>一个有types.coroutine（）修饰的生成器，这个生成器可以返回coroutine对象</li>
<li>一个包含await方法的对象返回的一个迭代器</li>
</ul>
</blockquote>
<p>接下来进行一次尝试，用async把请求的方法改造成coroutine对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_status</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">return</span> requests.get(url).status_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_result</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/welcome&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;waiting for &#123;&#125; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(url, time.time()))</span><br><span class="line">    status = <span class="keyword">await</span> get_status(url)</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    tasks = [asyncio.ensure_future(get_result()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>)]</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Cost time:&#x27;</span>, end - start)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658819455.563387</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658819455.612329</span></span><br><span class="line">waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/welcome <span class="number">1658819455.662548</span></span><br><span class="line">Cost time: <span class="number">3.005825996398926</span></span><br></pre></td></tr></table></figure>

<p>输出的结果证明这种方式不可行，并没有达到真正的异步。这里使用一个支持异步请求的库——aiohttp，利用它和asyncio配合可以方便的实现异步请求操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pip install apiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_status</span>(<span class="params">url</span>):</span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    response = <span class="keyword">await</span> session.get(url)</span><br><span class="line">    result = <span class="keyword">await</span> response.text()</span><br><span class="line">    <span class="keyword">await</span> session.close()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_result</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/api/afk/pod?current=1&amp;pageSize=100&#x27;</span></span><br><span class="line">    status = <span class="keyword">await</span> get_status(url)</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    tasks = [asyncio.ensure_future(get_result()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Cost time:&#x27;</span>, end - start)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Cost time: <span class="number">1.1510028839111328</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>请求耗时直接缩短到1秒左右。</p>
<ol>
<li>使用await，后面跟get方法，在执行10个协程的时候，遇到了await，就会将当前协程挂起，转而执行其他协程，直到其他协程也挂起或执行完毕，再进行下一个协程的执行；</li>
<li>开始运行的时候，事件循环会运行第一个task，第一个task执行遇到await跟着的get方法后，被挂起。但这个get方法第一步的执行是非阻塞的，挂起后立刻被环行，创建了ClientSession对象，接着遇到第二个await，调用了session.get()请求方法，然后就被挂起。由于请求耗时较久，所以一直没有被唤醒；</li>
<li>事件循环会寻找当前为被挂起的协程继续执行，于是转而执行第二个task。之后，依次执行了第10个task的session.get()方法后，全部的task被挂起。</li>
<li>所有task处于挂起状态，等待响应。1秒后，所有请求几乎同时有了响应，然后这10个task都被唤醒继续执行，输出请求结果。</li>
</ol>
<p>接下来尝试不同量级的task，输出结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1</span></span><br><span class="line">Cost time: 1.0380501747131348</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10</span></span><br><span class="line">Cost time: 1.143162727355957</span><br><span class="line"></span><br><span class="line"><span class="comment"># 50</span></span><br><span class="line">Cost time: 3.379934787750244</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100</span></span><br><span class="line">Cost time: 5.655962705612183</span><br><span class="line"></span><br><span class="line"><span class="comment"># 200 </span></span><br><span class="line">Cost time: 9.78205680847168</span><br><span class="line"></span><br><span class="line"><span class="comment"># 300</span></span><br><span class="line">Cost time: 9.797142028808594</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后的运行时间基本都在10秒内，200个task开始就会出现502情况，当然这个完全在于后端服务的问题。但是100个task以内的时候，时间都是很接近的。</p>
<h3 id="和单进程、多进程对比"><a href="#和单进程、多进程对比" class="headerlink" title="和单进程、多进程对比"></a>和单进程、多进程对比</h3><p>单进程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/api/afk/pod?current=1&amp;pageSize=100&#x27;</span></span><br><span class="line">    result = requests.get(url).status_code</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        get_page()</span><br><span class="line"></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Cost time:&#x27;</span>, end - start)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Cost time: <span class="number">106.35312700271606</span></span><br></pre></td></tr></table></figure>

<p>多进程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page</span>(<span class="params">_</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/api/afk/pod?current=1&amp;pageSize=100&#x27;</span></span><br><span class="line">    result = requests.get(url).status_code</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    pool = multiprocessing.Pool(<span class="number">8</span>)</span><br><span class="line">    pool.<span class="built_in">map</span>(get_page, <span class="built_in">range</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Cost time:&#x27;</span>, end - start)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Cost time: <span class="number">16.823662996292114</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>8核CPU执行时间为16.8秒，远大于协程的5.6秒。</p>
<p>多线程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1/api/afk/pod?current=1&amp;pageSize=100&#x27;</span></span><br><span class="line">    result = requests.get(url).status_code</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">200</span>):</span><br><span class="line">        t = threading.Thread(target=get_page)</span><br><span class="line">        threads.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Cost time:&#x27;</span>, end - start)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"></span><br><span class="line">Cost time: <span class="number">10.563114881515503</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>多线程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cost time: 1.160654067993164</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>前面讲了那么多，是不是有些内容值得思考一下呢？现在回过头来再总结一下。</p>
<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>进程是操作系统对一个正在运行的程序的一种抽象，进程是资源分配的最小单位。<br>那么为什么会有进程这个事物呢？主要目的是为了合理压榨CPU性能和分配运行的时间片。在计算机系统中，其计算核心是CPU，负责所有计算相关的工作和资源。单个CPU一次只能运行一个任务。如果一个进程运行着就完全占用一个CPU，是非常不合理的。</p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>有了多进程，为什么还要线程？原因如下：</p>
<ol>
<li>进程直接的信息难以共享，父子进程并未共享内存，需要进程间通信，性能开销大</li>
<li>创建进程的性能开销较大。</li>
</ol>
<p>进程由多个线程组成，一个进程可以由多个线程的执行单元组成。每个线程都在运行进程的上下文中，共享着同样的代码和全局数据。多个线程比多进程之间更容易共享数据，在上下文切换中一般比进程更高效，原因如下： </p>
<ol>
<li>线程间能够快速、方便共享数据</li>
<li>创建线程的速度比创建进程快10倍以上</li>
</ol>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>协程是用户态的线程。协程的优势：</p>
<ol>
<li>节省CPU。避免系统内核级的线程频繁切换，造成CPU的浪费。协程是用户态的线程，用户可以自行控制协程的创建和销毁，极大程度上避免了系统级线程上下文切换造成的资源浪费。</li>
<li>节约内存。64位的Linux系统中，一个线程需要分配8MB栈内存和64MB堆内存。系统内存的制约导致无法开启更多线程的并发。而协程只需要KB级别，可以轻松达到几十万。</li>
<li>稳定性。线程之间通过内存来共享数据，这就会导致一个问题，比如一个线程出错时，进程中的所有线程都会跟着崩溃。</li>
<li>开发效率。开发过程中，可以方便的把一些耗时的IO操作异步化，比如些写文件、耗时IO请求等。</li>
</ol>
<p>总之，协程的本质是用户态下的线程.</p>
<p>用一个形象的例子：</p>
<ul>
<li>进程就像一家餐馆，餐馆有多个服务员，每个餐桌是要完成的任务。单进程，对应一家餐馆；</li>
<li>多进程，增加了N家餐馆，接待的客人多了，成本也上去了；</li>
<li>多线程。一家餐馆，来一桌客人安排一个服务员；</li>
<li>协程。一家餐馆只安排一个服务员，A点菜，就去B服务，A点完了就再回到A这。B还没点完就去C那，依次类推，直到所有人都吃上饭。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Python%20%E6%96%87%E4%BB%B6:%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Python%20%E6%96%87%E4%BB%B6:%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C.html" class="post-title-link" itemprop="url">Python 文件/目录操作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="OS模块"><a href="#OS模块" class="headerlink" title="OS模块"></a>OS模块</h2><h2 id="sqlite-日期"><a href="#sqlite-日期" class="headerlink" title="sqlite 日期"></a>sqlite 日期</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">----昨天</span><br><span class="line">select * from 表 where Time&gt;=datetime(&#x27;now&#x27;,&#x27;start of day&#x27;,&#x27;-1 day&#x27;) and Time&lt;datetime(&#x27;now&#x27;,&#x27;start of day&#x27;,&#x27;+0 day&#x27;)</span><br><span class="line"></span><br><span class="line">----当天</span><br><span class="line">select * from 表 where Time&gt;=datetime(&#x27;now&#x27;,&#x27;start of day&#x27;,&#x27;+0 day&#x27;) and Time&lt;datetime(&#x27;now&#x27;,&#x27;start of day&#x27;,&#x27;+1 day&#x27;)</span><br><span class="line"></span><br><span class="line">----当周</span><br><span class="line">select  * from 表 where Time&gt;=datetime(&#x27;now&#x27;,&#x27;start of day&#x27;,&#x27;-7 day&#x27;,&#x27;weekday 1&#x27;) AND Time&lt;datetime(&#x27;now&#x27;,&#x27;start of day&#x27;,&#x27;+0 day&#x27;,&#x27;weekday 1&#x27;)</span><br><span class="line"></span><br><span class="line">----当月</span><br><span class="line">select * from 表 where Time&gt;=datetime(&#x27;now&#x27;,&#x27;start of month&#x27;,&#x27;+0 month&#x27;,&#x27;-0 day&#x27;) AND Time &lt; datetime(&#x27;now&#x27;,&#x27;start of month&#x27;,&#x27;+1 month&#x27;,&#x27;0 day&#x27;)</span><br><span class="line"></span><br><span class="line">----上月</span><br><span class="line">select * from 表 where Time&gt;=datetime(&#x27;now&#x27;,&#x27;start of month&#x27;,&#x27;-1 month&#x27;,&#x27;-0 day&#x27;) AND Time &lt;datetime(&#x27;now&#x27;,&#x27;start of month&#x27;,&#x27;+0 month&#x27;,&#x27;-1 day&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
