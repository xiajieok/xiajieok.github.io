<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/page/6/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/matplotlib%20%E5%AD%A6%E4%B9%A0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/matplotlib%20%E5%AD%A6%E4%B9%A0.html" class="post-title-link" itemprop="url">matplotlib 学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="matplotlib-有乱码"><a href="#matplotlib-有乱码" class="headerlink" title="matplotlib 有乱码"></a>matplotlib 有乱码</h3><p>1、下载中文字体（黑体，看准系统版本）<br>2、找到matplotlib字体文件夹，例如：matplotlib&#x2F;mpl-data&#x2F;fonts&#x2F;ttf，将SimHei.ttf拷贝到ttf文件夹下面<br>3、修改matplotlib配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/lib/python3.5/dist-packages/matplotlib/mpl-data/matplotlibrc</span><br><span class="line"># 删除font.family和font.sans-serif两行前的#，并在font.sans-serif后添加中文字体Microsoft YaHei, ...(其余不变)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4、下面代码检查可使用的字体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from matplotlib.font_manager import FontManager</span><br><span class="line">import subprocess</span><br><span class="line"></span><br><span class="line">fm = FontManager()</span><br><span class="line">mat_fonts = set(f.name for f in fm.ttflist)</span><br><span class="line">#print(mat_fonts)</span><br><span class="line">output = subprocess.check_output(&#x27;fc-list :lang=zh -f &quot;%&#123;family&#125;\n&quot;&#x27;, shell=True)</span><br><span class="line">#print( &#x27;*&#x27; * 10, &#x27;系统可用的中文字体&#x27;, &#x27;*&#x27; * 10)</span><br><span class="line">#print (output)</span><br><span class="line">zh_fonts = set(f.split(&#x27;,&#x27;, 1)[0] for f in output.decode(&#x27;utf-8&#x27;).split(&#x27;\n&#x27;))</span><br><span class="line">available = mat_fonts &amp; zh_fonts</span><br><span class="line">print (&#x27;*&#x27; * 10, &#x27;可用的字体&#x27;, &#x27;*&#x27; * 10)</span><br><span class="line">for f in available:</span><br><span class="line">     print (f)</span><br></pre></td></tr></table></figure>

<img src="https://img.mknight.cn/medivh/1555251933809.png"  />


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import matplotlib</span><br><span class="line">from matplotlib.font_manager import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plt.rcParams[&#x27;font.sans-serif&#x27;]=[&#x27;Arial Unicode MS&#x27;]</span><br><span class="line">plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False #解决保存图像是负号&#x27;-&#x27;显示为方块的问题</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">price = [39.5, 39.9, 45.4, 38.9, 33.34]</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">绘制水平条形图方法barh</span><br><span class="line">参数一：y轴</span><br><span class="line">参数二：x轴</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">plt.barh(range(5), price, height=0.7, color=&#x27;steelblue&#x27;, alpha=0.8)      # 从下往上画</span><br><span class="line">plt.yticks(range(5), [&#x27;tom&#x27;, &#x27;当当网&#x27;, &#x27;中国图书网&#x27;, &#x27;京东&#x27;, &#x27;天猫&#x27;])</span><br><span class="line">plt.xlim(30,47)</span><br><span class="line">plt.xlabel(&quot;价格&quot;)</span><br><span class="line">plt.title(&quot;不同平台图书价格&quot;)</span><br><span class="line">for x, y in enumerate(price):</span><br><span class="line">    plt.text(y + 0.2, x - 0.1, &#x27;%s&#x27; % y)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者直接指定字体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import matplotlib</span><br><span class="line">from matplotlib.font_manager import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">myfont = FontProperties(fname=&#x27;/System/Library/Fonts/PingFang.ttc&#x27;)</span><br><span class="line">matplotlib.rcParams[&#x27;axes.unicode_minus&#x27;]=False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">price = [39.5, 39.9, 45.4, 38.9, 33.34]</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">绘制水平条形图方法barh</span><br><span class="line">参数一：y轴</span><br><span class="line">参数二：x轴</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">plt.barh(range(5), price, height=0.7, color=&#x27;steelblue&#x27;, alpha=0.8)      # 从下往上画</span><br><span class="line">plt.yticks(range(5), [&#x27;tom&#x27;, &#x27;当当网&#x27;, &#x27;中国图书网&#x27;, &#x27;京东&#x27;, &#x27;天猫&#x27;],fontproperties=myfont)</span><br><span class="line">plt.xlim(30,47)</span><br><span class="line">plt.xlabel(&quot;价格&quot;,fontproperties=myfont)</span><br><span class="line">plt.title(&quot;不同平台图书价格&quot;,fontproperties=myfont)</span><br><span class="line">for x, y in enumerate(price):</span><br><span class="line">    plt.text(y + 0.2, x - 0.1, &#x27;%s&#x27; % y)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%9F%BA%E4%BA%8Eregistry%E7%9A%84Harbor%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%9F%BA%E4%BA%8Eregistry%E7%9A%84Harbor%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2.html" class="post-title-link" itemprop="url">基于registry的Harbor镜像仓库部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Harbor 是 Vmwar 公司开源的 企业级的 Docker Registry 管理项目 它主要 提供 Dcoker Registry 管理UI，可基于角色访问控制, AD&#x2F;LDAP 集成，日志审核等功能，完全的支持中文。 Harbor 的所有组件都在 Dcoker 中部署，所以 Harbor 可使用 Docker Compose 快速部署。</p>
</blockquote>
<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>Harbor，是一个英文单词，意思是港湾，港湾是干什么的呢，就是停放货物的，而货物呢，是装在集装箱中的，说到集装箱，就不得不提到Docker容器，因为docker容器的技术正是借鉴了集装箱的原理。所以，Harbor正是一个用于存储Docker镜像的企业级Registry服务。</p>
<p>Registry是Dcoker官方的一个私有仓库镜像，可以将本地的镜像打标签进行标记然后push到以Registry起的容器的私有仓库中。企业可以根据自己的需求，使用Dokcerfile生成自己的镜像，并推到私有仓库中，这样可以大大提高拉取镜像的效率。</p>
<h3 id="1、优点"><a href="#1、优点" class="headerlink" title="1、优点"></a>1、优点</h3><p>Harbor和Registry都是Docker的镜像仓库，但是Harbor作为更多企业的选择，是因为相比较于Regisrty来说，它具有很多的优势。</p>
<ul>
<li>1.提供分层传输机制，优化网络传输<br>Docker镜像是是分层的，而如果每次传输都使用全量文件(所以用FTP的方式并不适合)，显然不经济。必须提供识别分层传输的机制，以层的UUID为标识，确定传输的对象。</li>
<li>2.提供WEB界面，优化用户体验<br>只用镜像的名字来进行上传下载显然很不方便，需要有一个用户界面可以支持登陆、搜索功能，包括区分公有、私有镜像。</li>
<li>3.支持水平扩展集群<br>当有用户对镜像的上传下载操作集中在某服务器，需要对相应的访问压力作分解。</li>
<li>4.良好的安全机制<br>企业中的开发团队有很多不同的职位，对于不同的职位人员，分配不同的权限，具有更好的安全性。</li>
<li>5.Harbor提供了基于角色的访问控制机制，并通过项目来对镜像进行组织和访问权限的控制。kubernetes中通过namespace来对资源进行隔离，在企业级应用场景中，通过将两者进行结合可以有效将kubernetes使用的镜像资源进行管理和访问控制，增强镜像使用的安全性。尤其是在多租户场景下，可以通过租户、namespace和项目相结合的方式来实现对多租户镜像资源的管理和访问控制。</li>
</ul>
<h3 id="2、核心组件"><a href="#2、核心组件" class="headerlink" title="2、核心组件"></a>2、核心组件</h3><ul>
<li>Proxy：他是一个nginx的前端代理，代理Harbor的registry,UI, token等服务。</li>
<li>db：负责储存用户权限、审计日志、Dockerimage分组信息等数据。</li>
<li>UI：提供图形化界面，帮助用户管理registry上的镜像, 并对用户进行授权。</li>
<li>jobsevice：jobsevice是负责镜像复制工作的，他和registry通信，从一个registry pull镜像然后push到另一个registry，并记录job_log。</li>
<li>Adminserver：是系统的配置管理中心附带检查存储用量，ui和jobserver启动时候回需要加载adminserver的配置。</li>
<li>Registry：镜像仓库，负责存储镜像文件。</li>
<li>Log：为了帮助监控Harbor运行，负责收集其他组件的log，供日后进行分析。</li>
</ul>
<h2 id="二、安装部署"><a href="#二、安装部署" class="headerlink" title="二、安装部署"></a>二、安装部署</h2><h3 id="1、环境要求"><a href="#1、环境要求" class="headerlink" title="1、环境要求"></a>1、环境要求</h3><h4 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h4><table>
<thead>
<tr>
<th>Resource</th>
<th>Capacity</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>CPU</td>
<td>minimal 2 CPU</td>
<td>4 CPU is preferred</td>
</tr>
<tr>
<td>Mem</td>
<td>minimal 4GB</td>
<td>8GB is preferred</td>
</tr>
<tr>
<td>Disk</td>
<td>minimal 40GB</td>
<td>160GB is preferred</td>
</tr>
</tbody></table>
<h4 id="Software"><a href="#Software" class="headerlink" title="Software"></a>Software</h4><table>
<thead>
<tr>
<th>Software</th>
<th>Version</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Python</td>
<td>version 2.7 or higher</td>
<td>Note that you may have to install Python on Linux distributions (Gentoo, Arch) that do not come with a Python interpreter installed by default</td>
</tr>
<tr>
<td>Docker engine</td>
<td>version 1.10 or higher</td>
<td>For installation instructions, please refer to: <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/installation/">https://docs.docker.com/engine/installation/</a></td>
</tr>
<tr>
<td>Docker Compose</td>
<td>version 1.6.0 or higher</td>
<td>For installation instructions, please refer to: <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></td>
</tr>
<tr>
<td>Openssl</td>
<td>latest is preferred</td>
<td>Generate certificate and keys for Harbor</td>
</tr>
</tbody></table>
<h4 id="Network-ports"><a href="#Network-ports" class="headerlink" title="Network ports"></a>Network ports</h4><table>
<thead>
<tr>
<th>Port</th>
<th>Protocol</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>443</td>
<td>HTTPS</td>
<td>Harbor portal and core API will accept requests on this port for https protocol</td>
</tr>
<tr>
<td>4443</td>
<td>HTTPS</td>
<td>Connections to the Docker Content Trust service for Harbor, only needed when Notary is enabled</td>
</tr>
<tr>
<td>80</td>
<td>HTTP</td>
<td>Harbor portal and core API will accept requests on this port for http protocol</td>
</tr>
</tbody></table>
<h4 id="Docker-相关"><a href="#Docker-相关" class="headerlink" title="Docker 相关"></a>Docker 相关</h4><p>安装docker-compose</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip</span><br><span class="line">pip install docker-compose</span><br></pre></td></tr></table></figure>

<h3 id="2、安装方式"><a href="#2、安装方式" class="headerlink" title="2、安装方式"></a>2、安装方式</h3><h4 id="在线安装"><a href="#在线安装" class="headerlink" title="在线安装"></a>在线安装</h4><p>该方式从Docker hub下载Harbor相关镜像，安装包较小。</p>
<h4 id="离线安装"><a href="#离线安装" class="headerlink" title="离线安装"></a>离线安装</h4><ul>
<li>正常安装版 <a target="_blank" rel="noopener" href="https://img.mknight.cn/harbor-offline-installer-v1.2.2.tgz">https://img.mknight.cn/harbor-offline-installer-v1.2.2.tgz</a> 推荐使用此方式靠谱。</li>
<li>github下载最新版 <a target="_blank" rel="noopener" href="https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.5.tgz">Harbor offline installer</a></li>
</ul>
<h3 id="3、安装"><a href="#3、安装" class="headerlink" title="3、安装"></a>3、安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/src</span><br><span class="line">wget https://img.mknight.cn/harbor-offline-installer-v1.2.2.tgz](https://img.mknight.cn/harbor-offline-installer-v1.2.2.tgz</span><br><span class="line">tar -zxvf  harbor-offline-installer-v1.2.2.tgz -C /opt/harbor</span><br></pre></td></tr></table></figure>

<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>vim harbor.cfg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Configuration file of Harbor</span></span><br><span class="line"><span class="comment"># hostname 设置访问地址，支持IP，域名，主机名，禁止设置127.0.0.1</span></span><br><span class="line"><span class="comment"># 必须修改！！！</span></span><br><span class="line">hostname = 内网ip</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 访问协议，可设置 http,https</span></span><br><span class="line">ui_url_protocol = http</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 邮件通知, 配置邮件通知。</span></span><br><span class="line">email_server = smtp.mydomain.com</span><br><span class="line">email_server_port = 25</span><br><span class="line">email_username = sample_admin@mydomain.com</span><br><span class="line">email_password = abc</span><br><span class="line">email_from = admin &lt;sample_admin@mydomain.com&gt;</span><br><span class="line">email_ssl = <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># harbor WEB UI登陆使用的密码</span></span><br><span class="line">harbor_admin_password = Harbor12345</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 认证方式，这里支持多种认证方式，默认是 db_auth ，既mysql数据库存储认证。</span></span><br><span class="line"><span class="comment"># 这里还支持 ldap 以及 本地文件存储方式。</span></span><br><span class="line">auth_mode = db_auth</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql root 账户的 密码</span></span><br><span class="line">db_password = root123</span><br><span class="line"><span class="comment"># 默认密码应该是root，反正root123的时候我登不进去</span></span><br><span class="line">self_registration = on</span><br><span class="line">use_compressed_js = on</span><br><span class="line">max_job_workers = 3</span><br><span class="line">verify_remote_cert = on</span><br><span class="line">customize_crt = on</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 一些显示的设置.</span></span><br><span class="line">crt_country = CN</span><br><span class="line">crt_state = State</span><br><span class="line">crt_location = CN</span><br><span class="line">crt_organization = organization</span><br><span class="line">crt_organizationalunit = organizational unit</span><br><span class="line">crt_commonname = example.com</span><br><span class="line">crt_email = example@example.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="1、修改80端口为5000"><a href="#1、修改80端口为5000" class="headerlink" title="1、修改80端口为5000"></a>1、修改80端口为5000</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim docker-compose.yml</span></span><br><span class="line">proxy:</span><br><span class="line">image: vmware/nginx-photon:1.11.13</span><br><span class="line">container_name: nginx</span><br><span class="line">restart: always</span><br><span class="line">volumes:</span><br><span class="line">- ./common/config/nginx:/etc/nginx:z</span><br><span class="line">networks:</span><br><span class="line">- harbor</span><br><span class="line">ports:</span><br><span class="line">- 5000:80</span><br><span class="line">- 443:443</span><br><span class="line">- 4443:4443</span><br><span class="line">depends_on:</span><br><span class="line">- mysql</span><br><span class="line">- registry</span><br><span class="line">- ui</span><br><span class="line">- <span class="built_in">log</span></span><br><span class="line">logging:</span><br><span class="line">driver: <span class="string">&quot;syslog&quot;</span></span><br><span class="line">options:</span><br><span class="line">syslog-address: <span class="string">&quot;tcp://127.0.0.1:1514&quot;</span></span><br><span class="line">tag: <span class="string">&quot;proxy&quot;</span></span><br></pre></td></tr></table></figure>

<p>处理模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim common/templates/registry/config.yml</span></span><br><span class="line">auth:</span><br><span class="line">token:</span><br><span class="line">issuer: registry-token-issuer</span><br><span class="line">realm: <span class="variable">$ui_url</span>:5000/service/token</span><br><span class="line">rootcertbundle: /etc/registry/root.crt</span><br><span class="line">service: token-service</span><br></pre></td></tr></table></figure>

<p>启动，执行安装，加载镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure>

<p>更改配置后执行 prepare 脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./prepare</span><br><span class="line"></span><br><span class="line">Generated configuration file: ./config/ui/env</span><br><span class="line">Generated configuration file: ./config/ui/app.conf</span><br><span class="line">Generated configuration file: ./config/registry/config.yml</span><br><span class="line">Generated configuration file: ./config/db/env</span><br><span class="line">Generated configuration file: ./config/jobservice/env</span><br><span class="line">Clearing the configuration file: ./config/ui/private_key.pem</span><br><span class="line">Clearing the configuration file: ./config/registry/root.crt</span><br><span class="line">Generated configuration file: ./config/ui/private_key.pem</span><br><span class="line">Generated configuration file: ./config/registry/root.crt</span><br><span class="line">The configuration files are ready, please use docker-compose to start the service.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose up -d 启动</span></span><br><span class="line"><span class="comment"># docker-compose ps 查看信息</span></span><br><span class="line"></span><br><span class="line">Name Command State Ports</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-adminserver /harbor/harbor_adminserver Up</span><br><span class="line">harbor-db docker-entrypoint.sh mysqld Up 3306/tcp</span><br><span class="line">harbor-jobservice /harbor/harbor_jobservice Up</span><br><span class="line">harbor-log /bin/sh -c crond &amp;&amp; <span class="built_in">rm</span> -f ... Up 127.0.0.1:1514-&gt;514/tcp</span><br><span class="line">harbor-ui /harbor/harbor_ui Up</span><br><span class="line">nginx nginx -g daemon off; Up 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:5000-&gt;80/tcp</span><br><span class="line">registry /entrypoint.sh serve /etc/ ... Up 5000/tcp</span><br></pre></td></tr></table></figure>

<p>访问ip:5000 就可以了<br>默认帐号密码admin&#x2F;Harbor12345<br>然后创建用户和项目，注意区分公开还是私有。</p>
<h4 id="2、修改存储目录"><a href="#2、修改存储目录" class="headerlink" title="2、修改存储目录"></a>2、修改存储目录</h4><p>默认情况下存在在&#x2F;data目录，很多时候还是需要修改一下目录的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">registry:</span><br><span class="line">    image: vmware/registry:2.6.2-photon</span><br><span class="line">    container_name: registry</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - /joyfs/oam/harbor/registry:/storage:z</span><br><span class="line">      - ./common/config/registry/:/etc/registry/:z</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">adminserver:</span><br><span class="line">    image: vmware/harbor-adminserver:v1.2.2</span><br><span class="line">    container_name: harbor-adminserver</span><br><span class="line">    env_file:</span><br><span class="line">      - ./common/config/adminserver/env</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/config/:/etc/adminserver/config/:z</span><br><span class="line">      - /data/secretkey:/etc/adminserver/key:z</span><br><span class="line">      - /joyfs/oam/harbor/data/:/data/:z</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3、修改数据库为外置MySQL"><a href="#3、修改数据库为外置MySQL" class="headerlink" title="3、修改数据库为外置MySQL"></a>3、修改数据库为外置MySQL</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker exec -i -t 6e1e4b576315 bash</span></span><br><span class="line">在db container中：</span><br><span class="line"><span class="comment"># mysqldump -u root -p --databases registry &gt; registry.dump</span></span><br><span class="line">回到node，将dump文件从container中copy出来：</span><br><span class="line"><span class="comment">#docker cp 6e1e4b576315:/root/registry.dump ./</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> common/templates/adminserver</span><br><span class="line"><span class="built_in">cp</span> <span class="built_in">env</span> env.bak</span><br><span class="line">vim <span class="built_in">env</span></span><br><span class="line"><span class="comment">#修改以下内容</span></span><br><span class="line">MYSQL_HOST=x.x.x.x</span><br><span class="line">MYSQL_PORT=3306</span><br><span class="line">MYSQL_USR=new name</span><br><span class="line">MYSQL_PWD=new password</span><br><span class="line">MYSQL_DATABASE=registry</span><br><span class="line">....</span><br><span class="line">RESET=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>docker-compose.yml删除 MySQL部分配置，包括proxy里面的- mysql。<br>不过需要注意需要删除 &#x2F;data&#x2F;config&#x2F;config.json 文件。</p>
<p>重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br><span class="line">./prepare</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>验证登录正常，OK！！！</p>
<img src="https://img.mknight.cn/medivh/1555837828882.png"  />

<h2 id="三、推送镜像"><a href="#三、推送镜像" class="headerlink" title="三、推送镜像"></a>三、推送镜像</h2><p>1、检查是否包含镜像地址，如果不包含则执行第2步<br><img src="https://img.mknight.cn/medivh/1555838409977.png"  /></p>
<p>2、增加仓库地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry x.x.x.x:5000</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br></pre></td></tr></table></figure>

<p>部分低版本的则是修改其他文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim  /etc/docker/daemon.json</span></span><br><span class="line">&#123; <span class="string">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;ip:5000&quot;</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>3、构建并推送</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker build -t ip:5000/base/jdk .</span><br><span class="line">docker login ip:5000 </span><br><span class="line"><span class="comment"># 输入账号密码</span></span><br><span class="line">docker push ip:5000/base/jdk </span><br></pre></td></tr></table></figure>

<p>之后在浏览器检查是否正常即可。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md">github</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/RabbitMQ%20%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/RabbitMQ%20%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.html" class="post-title-link" itemprop="url">RabbitMQ 集群部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install erlang -y</span><br></pre></td></tr></table></figure>
<h3 id="安装服务"><a href="#安装服务" class="headerlink" title="安装服务"></a>安装服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/</span><br><span class="line">wget http://www.rabbitmq.com/releases/rabbitmq-server/v3.6.4/rabbitmq-server-3.6.4-1.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum install rabbitmq-server-3.6.4-1.noarch.rpm -y</span><br></pre></td></tr></table></figure>

<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#启动服务</span><br><span class="line">service rabbitmq-server start</span><br><span class="line">#查看服务状态</span><br><span class="line">service rabbitmq-server status</span><br></pre></td></tr></table></figure>

<h2 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h2><h3 id="增加账号"><a href="#增加账号" class="headerlink" title="增加账号"></a>增加账号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#增加</span><br><span class="line">rabbitmqctl  add_user  admin  &#x27;admin&#x27;</span><br><span class="line">#角色分配</span><br><span class="line">rabbitmqctl  set_user_tags admin administrator</span><br></pre></td></tr></table></figure>
<h3 id="vhost"><a href="#vhost" class="headerlink" title="vhost"></a>vhost</h3><p>运行多个vhost，以便于适用不同的业务需要，这样做既可以满足权限配置的要求，避免不同业务之间队列、交换机的命名冲突问题，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#vhost </span><br><span class="line">rabbitmqctl add_vhost personas</span><br><span class="line">rabbitmqctl set_permissions -p personas joy &#x27;.*&#x27; &#x27;.*&#x27; &#x27;.*&#x27;</span><br></pre></td></tr></table></figure>


<h3 id="管理界面"><a href="#管理界面" class="headerlink" title="管理界面"></a>管理界面</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<h2 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h2><h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><p>RabbitMQ 的 Cluster 集群模式一般分为两种，普通模式和镜像模式。</p>
<p>普通模式：默认的集群模式，以两个节点（rabbit01、rabbit02）为例来进行说明。对于 Queue 来说，消息实体只存在于其中一个节点 rabbit01（或者 rabbit02），rabbit01 和 rabbit02 两个节点仅有相同的元数据，即队列的结构。当消息进入 rabbit01 节点的 Queue 后，consumer 从 rabbit02 节点消费时，RabbitMQ 会临时在 rabbit01、rabbit02 间进行消息传输，把 A 中的消息实体取出并经过 B 发送给 consumer。所以 consumer 应尽量连接每一个节点，从中取消息。即对于同一个逻辑队列，要在多个节点建立物理 Queue。否则无论 consumer 连 rabbit01 或 rabbit02，出口总在 rabbit01，会产生瓶颈。当 rabbit01 节点故障后，rabbit02 节点无法取到 rabbit01 节点中还未消费的消息实体。如果做了消息持久化，那么得等 rabbit01 节点恢复，然后才可被消费；如果没有持久化的话，就会产生消息丢失的现象。<br>镜像模式：将需要消费的队列变为镜像队列，存在于多个节点，这样就可以实现 RabbitMQ 的 HA 高可用性。作用就是消息实体会主动在镜像节点之间实现同步，而不是像普通模式那样，在 consumer 消费数据时临时读取。缺点就是，集群内部的同步通讯会占用大量的网络带宽。</p>
<h3 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h3><ul>
<li>RAM node：内存节点将所有的队列、交换机、绑定、用户、权限和 vhost 的元数据定义存储在内存中，好处是可以使得像交换机和队列声明等操作更加的快速。</li>
<li>Disk node：将元数据存储在磁盘中，单节点系统只允许磁盘类型的节点，防止重启 RabbitMQ 的时候，丢失系统的配置信息。<blockquote>
<p>RabbitMQ 要求在集群中至少有一个磁盘节点，所有其他节点可以是内存节点，当节点加入或者离开集群时，必须要将该变更通知到至少一个磁盘节点。如果集群中唯一的一个磁盘节点崩溃的话，集群仍然可以保持运行，但是无法进行其他操作（增删改查），直到节点恢复。<br>解决方案：设置两个磁盘节点，至少有一个是可用的，可以保存元数据的更改。</p>
</blockquote>
</li>
</ul>
<h3 id="认证方式"><a href="#认证方式" class="headerlink" title="认证方式"></a>认证方式</h3><p>通过Erlang Cookie，相当于共享秘钥的概念，长度任意，只要所有节点都一致即可。rabbitmq server在启动的时候，erlang VM会自动创建一个随机的cookie文件。cookie文件的位置： &#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie 或者&#x2F;root&#x2F;.erlang.cookie。我们的为保证cookie的完全一致，采用从一个节点copy的方式，实现各个节点的cookie文件一致。</p>
<p>注意该文件默认是400权限，修改后需要还原回去400。</p>
<h3 id="集群组建"><a href="#集群组建" class="headerlink" title="集群组建"></a>集群组建</h3><p>首先保证所有节点都可以正常启动服务。</p>
<h4 id="停止服务"><a href="#停止服务" class="headerlink" title="停止服务"></a>停止服务</h4><p>在所有节点执行以下操作，停止服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rabbitmq-server stop</span><br></pre></td></tr></table></figure>
<h4 id="集群启动"><a href="#集群启动" class="headerlink" title="集群启动"></a>集群启动</h4><p>1、所有节点执行以下操作，启动集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server -detached</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-detached<br>Start the server process in the background. Note that this will cause the pid not to be written to the pid file.</p>
</blockquote>
<blockquote>
<p>For example, runs RabbitMQ AMQP server in the background:<br>rabbitmq-server -detached</p>
</blockquote>
<p>该参数简单说就是后台启动，始终没理解和<code>service rabbitmq-server sart</code>的区别</p>
<p>2、修改统一hosts文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.233 r0</span><br><span class="line">192.168.1.234 r1</span><br><span class="line">192.168.1.232 r2</span><br><span class="line">192.168.1.229 r3</span><br></pre></td></tr></table></figure>

<p>3、同步.erlang.cookie文件<br>所有节点从r0机器分发 <code>/var/lib/rabbitmq/.erlang.cookie </code>。</p>
<p>4、在其他节点服务器操作加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//默认是磁盘节点，如果是内存节点的话，需要加--ram参数</span><br><span class="line"></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl join_cluster --ram rabbit@r0</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl join_cluster rabbit@r0</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="验证集群"><a href="#验证集群" class="headerlink" title="验证集群"></a>验证集群</h4><p>1、节点加入集群，此处使用的主机名意义和hosts中一个意义。<br><img src="https://img.mknight.cn/medivh/1553065925609.png" /></p>
<p>2、加入集群后，检查集群状态<br><img src="https://img.mknight.cn/medivh/1553065954361.png" /></p>
<img src="https://img.mknight.cn/medivh/1553069420891.png" />

<h4 id="问题整理"><a href="#问题整理" class="headerlink" title="问题整理"></a>问题整理</h4><ul>
<li><p>之前加入集群的时候总提示错误<code>rror: unable to connect to node rabbit@test_229: nodedown</code></p>
<img src="https://img.mknight.cn/medivh/1553066819130.png" />
原因：在集群的所有机器都需要先执行`rabbitmq-server -detached`
</li>
<li><p>unable to connect to epmd (port 4369) on base_233: nxdomain (non-existing domain)</p>
</li>
</ul>
<p>原因：未启用管理插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<h4 id="集群节点操作"><a href="#集群节点操作" class="headerlink" title="集群节点操作"></a>集群节点操作</h4><p>节点恢复过程中把数据删掉很重要，恢复一单结点，再清数据<br>节点增加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. rabbitmq-server -detached   --- .erlang.cooike的权限，400 属主rabbitmq</span><br><span class="line">2. rabbitmqctl stop_app</span><br><span class="line">3. rabbitmqctl join_cluster --ram rabbit@rabbitmq1</span><br><span class="line">4. rabbitmqctl start_app</span><br><span class="line">5. rabbitmqctl  cluster_status</span><br></pre></td></tr></table></figure>
<p>节点删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.  rabbitmq-server -detached</span><br><span class="line">以上为基础，正常运行的mq节点直接进行2、3两步；4可省略或更改为rabbitmqctl stop</span><br><span class="line">2. rabbitmqctl stop_app</span><br><span class="line">3. rabbitmqctl reset </span><br><span class="line">4. rabbitmqctl start_app</span><br></pre></td></tr></table></figure>
<p>硬删除：<br>直接删掉集群中的某个节点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl forget_cluster_node   node_name</span><br></pre></td></tr></table></figure>
<p>由disc–&gt;ram</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.节点删除     rabbitmq-server -detached ---rabbitctl stop_app----    rabbitmqctl reset  （（--2.清除原数据（暂时备份到其他地方）--rabbitmqctl join_cluster --ram rabbit@rabbitmq1 ------------    rabbitmqctl start_app））</span><br><span class="line">2.清除原数据（暂时备份到其他地方）</span><br><span class="line">3.节点增加</span><br></pre></td></tr></table></figure>
<p>由disc–&gt;ram<br>先恢复到单结点，重启，清数据<br>加集群 </p>
<h3 id="镜像队列"><a href="#镜像队列" class="headerlink" title="镜像队列"></a>镜像队列</h3><h4 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h4><p>1、在管理界面配置<br><img src="https://img.mknight.cn/medivh/1553134452790.png" /></p>
<ul>
<li><p>Virtual host： 可选参数，针对指定vhost下的queue进行设置</p>
</li>
<li><p>Name: policy的名称</p>
</li>
<li><p>Pattern: queue的匹配模式(正则表达式)</p>
</li>
<li><p>Definition：镜像定义，包括三个部分ha-mode, ha-params, ha-sync-mode</p>
<ul>
<li>ha-mode:指明镜像队列的模式，有效值为 all&#x2F;exactly&#x2F;nodes<ul>
<li>all：表示在集群中所有的节点上进行镜像</li>
<li>exactly：表示在指定个数的节点上进行镜像，节点的个数由ha-params指定</li>
<li>nodes：表示在指定的节点上进行镜像，节点名称通过ha-params指定</li>
</ul>
</li>
<li>ha-params：ha-mode模式需要用到的参数</li>
<li>ha-sync-mode：进行队列中消息的同步方式，有效值为automatic和manual</li>
</ul>
</li>
<li><p>priority：可选参数，policy的优先级</p>
</li>
</ul>
<p>2、任意节点命令行配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy ha-all &quot;^&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">// 命令行方式添加策略</span><br><span class="line">// 策略名称为ha-allqueue,策略模式为 all 即复制到所有节点，包含新增节点，策略正则表达式为 “^” 表示所有匹配所有队列名称。</span><br><span class="line">rabbitmqctl set_policy -p &lt;vhost&gt; ha-allqueue&quot;^&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这时候就变成多个节点了。<br><img src="https://img.mknight.cn/medivh/1553135352884.png" /></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>AProxy 是一个免费的负载均衡软件，可以运行于大部分主流的 Linux 操作系统上。</p>
<p>HAProxy 提供了 L4(TCP) 和 L7(HTTP) 两种负载均衡能力，具备丰富的功能。HAProxy 的社区非常活跃，版本更新快速（最新稳定版 1.7.2 于 2017&#x2F;01&#x2F;13 推出）。最关键的是，HAProxy 具备媲美商用负载均衡器的性能和稳定性。它当前不仅仅是免费负载均衡软件的首选，更几乎成为了唯一选择。</p>
<p>因为 RabbitMQ 本身不提供负载均衡，下面我们就搭建 HAProxy，用作 RabbitMQ 集群的负载均衡。    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line">cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span><br><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>haproxy配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log     127.0.0.1  local0 info</span><br><span class="line">    log     127.0.0.1  local1 notice</span><br><span class="line">    daemon</span><br><span class="line">    maxconn 4096</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    log     global</span><br><span class="line">    mode    tcp</span><br><span class="line">    option  tcplog</span><br><span class="line">    option  dontlognull</span><br><span class="line">    retries 3</span><br><span class="line">    option  abortonclose</span><br><span class="line">    maxconn 4096</span><br><span class="line">    timeout connect  5000ms</span><br><span class="line">    timeout client  3000ms</span><br><span class="line">    timeout server  3000ms</span><br><span class="line">    balance roundrobin</span><br><span class="line"></span><br><span class="line">listen private_monitoring</span><br><span class="line">    bind    0.0.0.0:8100</span><br><span class="line">    mode    http</span><br><span class="line">    option  httplog</span><br><span class="line">    stats   refresh  5s</span><br><span class="line">    stats   uri  /stats</span><br><span class="line">    stats   realm   Haproxy</span><br><span class="line">    stats   auth  admin:admin</span><br><span class="line"></span><br><span class="line">listen rabbitmq_admin</span><br><span class="line">    bind    0.0.0.0:8102</span><br><span class="line">    server  r0 r0:15672</span><br><span class="line">    server  r3 r3:15672</span><br><span class="line"></span><br><span class="line">listen rabbitmq_cluster</span><br><span class="line">    bind    0.0.0.0:8101</span><br><span class="line">    mode    tcp</span><br><span class="line">    option  tcplog</span><br><span class="line">    balance roundrobin</span><br><span class="line">    timeout client  3h</span><br><span class="line">    timeout server  3h</span><br><span class="line">    server  r0  r0:5672  check  inter  5000  rise  2  fall  3</span><br><span class="line">    server  r3  r3:5672  check  inter  5000  rise  2  fall  3</span><br></pre></td></tr></table></figure>

<p>启动 haproxy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">haproxy -f /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>
<p>HAProxy 配置了三个地址：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://r0:8100/stats%EF%BC%9AHAProxy">http://r0:8100/stats：HAProxy</a> 负载均衡信息地址，账号密码：admin&#x2F;admin。</li>
<li><a href="http://r0:8101：RabbitMQ">http://r0:8101：RabbitMQ</a> Server Web 管理界面（基于负载均衡）。</li>
<li><a href="http://r0:8102：RabbitMQ">http://r0:8102：RabbitMQ</a> Server 服务地址（基于负载均衡）。<br>通过访问<a target="_blank" rel="noopener" href="http://r0:8100/stats%EF%BC%8C%E6%9F%A5%E7%9C%8B">http://r0:8100/stats，查看</a> HAProxy 负载均衡信息：</li>
</ul>
<p>实际程序访问的端口为8101</p>
<p>这样，haproxy就可以使用啦。<br><img src="https://img.mknight.cn/medivh/1553075635396.png" /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%B0%8F%E7%86%8A%E5%8A%A0%E6%B9%BF%E5%99%A8%E7%9A%84%E5%A4%8D%E6%B4%BB.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%B0%8F%E7%86%8A%E5%8A%A0%E6%B9%BF%E5%99%A8%E7%9A%84%E5%A4%8D%E6%B4%BB.html" class="post-title-link" itemprop="url">小熊加湿器的复活</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>上周空气有点干燥，打算把加湿器拿出来用上，但是它不出雾了！<br>明明上个月的时候还用过呢，咋就不行了呢？</p>
</blockquote>
<h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><p><strong>推测</strong><br>根据以往和查阅资料得出的经验：</p>
<ol>
<li>缺水</li>
<li>有雾气但是出不来，风扇故障</li>
<li>无雾，像喷泉，雾化片存留过多水碱或者雾化片故障</li>
</ol>
<blockquote>
<p>大部分情况都是由于雾化片的缘故，极少数是因为电路板或者其他组件的问题</p>
</blockquote>
<p><strong>原理</strong><br>基本原理主要由两部分组成：</p>
<ul>
<li>陶瓷振荡器通电振荡，产生水雾</li>
<li>风扇转动，送出水雾</li>
</ul>
<p><strong>排查</strong><br>根据当前的现象进行逐一排除：</p>
<ol>
<li>出水正常，不缺水，无效</li>
<li>用醋和食盐混合后擦拭雾化片，依然像喷泉一样，无效</li>
</ol>
<p>最终经过各方面检查，判断雾化片故障。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>推测是雾化片的问题后，查询京东订单，发现之前买的时候只有60多，而现在90多，这个反差！真恶心！</p>
<p>买一个雾化片吧，也就十块钱左右，总比再花90块钱强，咨询一下客服看看需要多大尺寸的。经过一系列咨询，客服的意思是集成的，无法更换零部件，总之就是坏了就买新的吧。再花90块钱，我不同意，那就自己拆下来量一下尺寸吧。</p>
<p>想象中的雾化片是这个样子的，基本都是在10块钱左右。</p>
<p><img src="https://img.mknight.cn/medivh/1638155846311.png" alt="1638155846311.png"></p>
<ol>
<li><p>拆开底座。拿掉胶垫，就能看到螺丝，拧下来，这个螺丝的洞很深，螺丝刀需要长一点。而且需要注意的是小熊加湿器的螺丝在底部的四个缓冲垫下面藏着的。最开始的时候没找到螺丝，怎么也打不开底座。</p>
</li>
<li><p>拆卸雾化片。实际上小熊的雾化片真是集成的，螺丝都快拧坏了也没拆下来。雾化片的集成板上有很多连接线和卡扣，可以直接拆下来，不用担心还原的问题。因为每种卡扣基本都是独立的颜色，按照颜色插就可以了。</p>
<p> <img src="https://img.mknight.cn/medivh/1638155925408.png" alt="1638155925408.png"></p>
<p> 这个是反面，基本和我的这一款一致</p>
<p> <img src="https://img.mknight.cn/medivh/1638155962363.png" alt="1638155962363.png"></p>
<p> 另外一块是电源板，应该没有什么问题。<br> <img src="https://img.mknight.cn/medivh/1638156032131.png" alt="1638156032131.png"></p>
<p> 最后是我拆下来的废弃的雾化片集成板，暂时先留着就当个纪念吧，虽然知道以后也不会用得到。</p>
<p> <img src="https://img.mknight.cn/medivh/1638156097228.png" alt="1638156097228.png"></p>
</li>
<li><p>把所有的零件都插回去，注意雾化片集成板的方向一定要插对，否则是无法正常装上底座的</p>
</li>
<li><p>加水，通电。最开始的十几秒内并没有出现很多雾，当时一度担心不是雾化片的原因，可能是水温低吧，很快大股水雾就出来了。完美！</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>很多东西都要先了解一下原理，如果有的话。其次，如果能了解到更多的前因后果，那就更好了。<br>在很多场景下下会遇到维修成本的问题，如果可以接受那么久去做，就算没做好也当学习的经验了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/ELK%E9%83%A8%E7%BD%B2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/ELK%E9%83%A8%E7%BD%B2.html" class="post-title-link" itemprop="url">ELK 部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="基本组件"><a href="#基本组件" class="headerlink" title="基本组件"></a>基本组件</h3><ul>
<li>Elasticsearch 作为存储和索引这些数据;</li>
<li>Filebeat 日志文件托运,传送给Logstash;</li>
<li>Logstash 去插入数据到elasticsearch;</li>
<li>Kibana 作为展示平台。</li>
</ul>
<h3 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h3><img src="https://img.mknight.cn/2018/1539223733259.png" width="870"/>

<p>其中filebeat是作为轻量级的logstash来工作。每台机器上只需要部署filebeat,然后向1台logstash传输即可。</p>
<h3 id="实际相关"><a href="#实际相关" class="headerlink" title="实际相关"></a>实际相关</h3><p>服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.110.1.18 Filebeat+Logstash+Elasticsearch+Kibana</span><br></pre></td></tr></table></figure>
<p>路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/elk</span><br><span class="line">/etc/filebeat</span><br></pre></td></tr></table></figure>
<p>版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-6.4.2</span><br><span class="line">kibana-6.4.2</span><br><span class="line">logstash-6.4.2</span><br><span class="line">filebeat-6.4.2</span><br></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="依赖环境"><a href="#依赖环境" class="headerlink" title="依赖环境"></a>依赖环境</h3><p>Elasticsearch requires at least Java 8. Specifically as of this writing, it is recommended that you use the Oracle JDK version 1.8.0_131. Java installation varies from platform to platform so we won’t go into those details here. Oracle’s recommended installation documentation can be found on Oracle’s website. Suffice to say, before you install Elasticsearch, please check your Java version first by running (and then install&#x2F;upgrade accordingly if needed):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java version &quot;1.8.0_91&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_91-b14)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)</span><br></pre></td></tr></table></figure>
<p>简单说jdk版本必须为1.8以上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src/ &amp;&amp; tar -zxvf ./jdk1.8.0_91.tar.gz -C /usr/local</span><br><span class="line">ln -s /usr/local/jdk1.8.0_91 /usr/local/java</span><br><span class="line">echo &#x27;</span><br><span class="line">#JDK</span><br><span class="line">############################################################</span><br><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">############################################################</span><br><span class="line">&#x27; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>
<h3 id="系统参数设定"><a href="#系统参数设定" class="headerlink" title="系统参数设定"></a>系统参数设定</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;vm.max_map_count=262144&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo &quot;</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536&quot; &gt;&gt; /etc/security/limits.conf &amp;&amp; \</span><br><span class="line">   echo &quot;ulimit -c unlimited&quot; &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure>
<p>如果es启动的时候不生效，可以关闭当前窗口，重新打开。</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.4.2.tar.gz</span><br><span class="line">wget https://artifacts.elastic.co/downloads/kibana/kibana-6.4.2-linux-x86_64.tar.gz</span><br><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-6.4.2.tar.gz</span><br><span class="line">mkdir /usr/local/elk</span><br><span class="line">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.6.1-x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum install filebeat-6.6.1-x86_64.rpm</span><br><span class="line">tar -zxvf elasticsearch-6.4.2.tar.gz -C /usr/local/elk/</span><br><span class="line">tar -zxvf kibana-6.4.2-linux-x86_64.tar.gz -C /usr/local/elk/</span><br><span class="line">tar -zxvf logstash-6.4.2.tar.gz -C /usr/local/elk/</span><br><span class="line">cd /usr/local/elk</span><br><span class="line">ln -s elasticsearch-6.4.2/ elasticsearch</span><br><span class="line">ln -s filebeat-6.4.2-linux-x86_64/ filebeat</span><br><span class="line">ln -s logstash-6.4.2/ logstash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中filebeat有些特殊，如果需要读取&#x2F;var&#x2F;log下的日志，注意启用用户的权限问题。至于安装方式可以选择RPM方式，启动更为简单，毕竟启动后基本就不会再动。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>需要修改的地方，重点是data目录，注意磁盘空间，时间久了会爆满的！！！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#vim /usr/local/elk/elasticsearch/config/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">cluster.name: es</span><br><span class="line">node.name: elk-1</span><br><span class="line">path.data: /joyfs/oam/elk/es-data</span><br><span class="line">path.logs: /joyfs/oam/elk/es-logs</span><br><span class="line">network.host: 0.0.0.0</span><br></pre></td></tr></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/elk/elasticsearch/./bin/elasticsearch -d</span><br></pre></td></tr></table></figure>
<h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><p>访问9200端口或者浏览器也可以。出现下面信息表示运行正常。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9200</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/2018/1539164622896.png" width="387"/>

<h3 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h3><h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><p>基本没有什么需要配置的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#vim /usr/local/elk/kibana/config/kibana.yml</span><br><span class="line"></span><br><span class="line">server.host: &quot;10.110.1.18&quot;</span><br><span class="line">#切换地图高德，最后加上这一段</span><br><span class="line">tilemap.url: &#x27;http://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&amp;size=1&amp;scale=1&amp;style=7&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;&#x27;</span><br><span class="line">tilemap.options.minZoom: &quot;1&quot;</span><br><span class="line">tilemap.options.maxZoom: &quot;10&quot;</span><br></pre></td></tr></table></figure>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/kibana &amp;</span><br></pre></td></tr></table></figure>
<p>访问默认5601端口</p>
<img src="https://img.mknight.cn/2018/1539167701059.png" width="317"/>



<h3 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h3><h4 id="配置文件-2"><a href="#配置文件-2" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#=========================== Filebeat inputs =============================</span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">#按照以下示例增加多个日志类型</span><br><span class="line">- input_type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /joyfs/logs/nginx/9011/c1/logs/access.log</span><br><span class="line">    - /joyfs/logs/nginx/9011/c1/logs/error.log</span><br><span class="line">    - /joyfs/logs/nginx/9011/a1/logs/access.log</span><br><span class="line">    - /joyfs/logs/nginx/9011/a1/logs/error.log</span><br><span class="line">  fields:</span><br><span class="line">    service: nginx_joy_app</span><br><span class="line"></span><br><span class="line">#----------------------------- Logstash output --------------------------------</span><br><span class="line">output.logstash:</span><br><span class="line">  #该地址为filebeat =&gt; logstash 地址端口</span><br><span class="line">  hosts: [&quot;10.110.1.18:5044&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果需要配置logstash的负载均衡，就需要增加下面的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;localhost:5044&quot;, &quot;localhost:5045&quot;]</span><br><span class="line">  loadbalance: true</span><br></pre></td></tr></table></figure>


<h4 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/filebeat &amp;</span><br></pre></td></tr></table></figure>
<p>检查日志如果不报错就可以。</p>
<h3 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h3><h4 id="配置文件-3"><a href="#配置文件-3" class="headerlink" title="配置文件"></a>配置文件</h4><p>没啥可修改的，如果愿意的话修改一下日志目录和data目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#vim /usr/local/elk/logstash/config/logstash.yml</span><br><span class="line"></span><br><span class="line">path.data: /joyfs/oam/elk/logstash-data</span><br><span class="line">path.logs: /joyfs/oam/elk/logstash-logs</span><br></pre></td></tr></table></figure>
<h4 id="过滤执行文件"><a href="#过滤执行文件" class="headerlink" title="过滤执行文件"></a>过滤执行文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#vim /usr/local/elk/logstash/config/conf.d/joy.conf</span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">     beats &#123;</span><br><span class="line">           port =&gt; 5044</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    if [fields][service] == &quot;nginx_joy_app&quot; &#123;</span><br><span class="line">      grok &#123;</span><br><span class="line">            match =&gt; &#123; &quot;message&quot; =&gt; &#x27;%&#123;IP&#125; - %&#123;NGUSER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;%&#123;WORD:verb&#125; %&#123;URIPATHPARAM:request&#125; HTTP/%&#123;NUMBER:httpversion&#125;&quot; %&#123;NUMBER:response&#125; (?:%&#123;NUMBER:bytes&#125;|-) (?:%&#123;NOTSPACE:request&#125;|-) (?:&quot;(?:%&#123;URI:referrer&#125;|-)&quot;|%&#123;QS:referrer&#125;) %&#123;QS:agent&#125; %&#123;IPORHOST:clientip&#125; %&#123;URIHOST&#125; %&#123;BASE10NUM:request_duration&#125;&#x27; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      useragent &#123;</span><br><span class="line">        source =&gt; &quot;agent&quot;</span><br><span class="line">        target =&gt; &quot;device&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      date &#123;</span><br><span class="line">         match =&gt; [ &quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">      geoip &#123;</span><br><span class="line"></span><br><span class="line">        source =&gt; &quot;clientip&quot;</span><br><span class="line">        target =&gt; &quot;geoip&quot;</span><br><span class="line">        database =&gt; &quot;/usr/local/elk/logstash/GeoLite/GeoLite2-City.mmdb&quot;</span><br><span class="line">        add_field =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][longitude]&#125;&quot; ]</span><br><span class="line">        add_field =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;%&#123;[geoip][latitude]&#125;&quot;  ]</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      mutate &#123;</span><br><span class="line">        convert =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;float&quot;]</span><br><span class="line">        remove_field =&gt; [</span><br><span class="line">                &quot;tags&quot;,</span><br><span class="line">                &quot;offset&quot;,</span><br><span class="line">                &quot;host&quot;,</span><br><span class="line">                &quot;beat&quot;</span><br><span class="line">            ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if [fields][service] == &quot;system&quot; &#123;</span><br><span class="line">      grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      mutate &#123;</span><br><span class="line">            remove_field =&gt; [</span><br><span class="line">                &quot;tags&quot;,</span><br><span class="line">                &quot;offset&quot;,</span><br><span class="line">                &quot;host&quot;,</span><br><span class="line">                &quot;beat&quot;</span><br><span class="line">            ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  if [fields][service] == &quot;nginx_joy_app&quot;&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;127.0.0.1:9200&quot;]</span><br><span class="line">        index =&gt; &quot;logstash-nginx_joy_app-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [fields][service] == &quot;system&quot;&#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;127.0.0.1:9200&quot;]</span><br><span class="line">        index =&gt; &quot;system_oam-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意nginx日志索引必须为”logstash-xxxx”,否则地图会找不到字段。</p>
<h4 id="配置地图"><a href="#配置地图" class="headerlink" title="配置地图"></a>配置地图</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/elk/logstash</span><br><span class="line">mkdir GeoLite</span><br><span class="line">cd GeoLite</span><br><span class="line">wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz</span><br><span class="line">gunzip GeoLite2-City.mmdb.gz</span><br></pre></td></tr></table></figure>
<p>注意和配置文件里的GeoLite2-City.mmdb路径保持一致！！！</p>
<h4 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/logstash &amp;</span><br></pre></td></tr></table></figure>


<h2 id="kibana画图"><a href="#kibana画图" class="headerlink" title="kibana画图"></a>kibana画图</h2><p>visualize-&gt;Maps-&gt;Coordinate Map</p>
<img src="https://img.mknight.cn/2018/1539169330458.png" width="346"/>

<img src="https://img.mknight.cn/2018/1539169363305.png" width="192"/>

<h2 id="问题整理"><a href="#问题整理" class="headerlink" title="问题整理"></a>问题整理</h2><h3 id="1、创建地图时找不到字段"><a href="#1、创建地图时找不到字段" class="headerlink" title="1、创建地图时找不到字段"></a>1、创建地图时找不到字段</h3><img src="https://img.mknight.cn/2018/1539222082965.png" width="348"/>

<p>**问题分析：  **</p>
<blockquote>
<p>索引格式为[nginx-xxx-]YYYY-MM的日志文件由logstash输出到Elasticsearch；在 elasticsearch 中，所有的数据都有一个类型，什么样的类型，就可以在其上做一些对应类型的特殊操作。geo信息中的location字段是经纬度，我们需要使用经纬度来定位地理位置；在 elasticsearch 中，对于经纬度来说，要想使用 elasticsearch 提供的地理位置查询相关的功能，就需要构造一个结构，并且将其类型属性设置为geo_point，此错误明显是由于我们的geo的location字段类型不是geo_point。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET nginx_joy_app-2018.10.11/_mapping</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/2018/1539222419814.png" width="579"/>
说明创建的index中location字段类型和要求的geo_point不一致。

<p><strong>解决方案:</strong></p>
<ul>
<li>修改ES模板</li>
<li>logstash配置文件中的output,命名设置为logstash-xxx的index</li>
</ul>
<img src="https://img.mknight.cn/2018/1539222688909.png" width="422"/>


<p>如果以上方式还是不能解决geo_point的问题，那就碰上事了。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">GET _all/_mapping</span><br><span class="line">&quot;properties&quot;: &#123;</span><br><span class="line">          &quot;@timestamp&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;@version&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;geoip&quot;: &#123;</span><br><span class="line">            &quot;dynamic&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">              &quot;ip&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;ip&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;latitude&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;half_float&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;location&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;geo_point&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;longitude&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;half_float&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; </span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">如果检查发现找不到任何geo_point相关字段，说明这个模板就有问题。我的理解是es启动后才会依据内置模板&quot;logstash-xxxx&quot;,这样就有了geo_point这个字段。</span><br><span class="line"></span><br><span class="line">但是如果logstash在es之前启动就会造成es没有来得及匹配内置模板，这样就把所有的索引都认为是应用自定义模板。这样logstash是什么数据，es展示的就是什么数据了。</span><br><span class="line"></span><br><span class="line">### 2、配置完logstash，但是kibana或者es不显示index</span><br><span class="line">**分析**</span><br><span class="line">* 检查filebeat配置文件中搜集的日志路径是否正确,相关日志是否真的存在。</span><br><span class="line">&lt;img src=&quot;https://img.mknight.cn/2018/1539223116186.png&quot; width=&quot;374&quot;/&gt;</span><br><span class="line"></span><br><span class="line">* 检查logstash中的filter是否和filebeat中的service保持一致</span><br><span class="line">&lt;img src=&quot;https://img.mknight.cn/2018/1539223223935.png&quot; width=&quot;415&quot;/&gt;</span><br><span class="line"></span><br><span class="line">* 检查logstash中的output，service是否一致</span><br><span class="line">&lt;img src=&quot;https://img.mknight.cn/2018/1539223282424.png&quot; width=&quot;434&quot;/&gt;</span><br><span class="line"></span><br><span class="line">### logstash时区问题</span><br><span class="line"></span><br><span class="line">2.x</span><br></pre></td></tr></table></figure>

<p>input { stdin {} }<br>output { stdout { codec &#x3D;&gt; rubydebug } }<br>filter {<br>  date {<br>    match &#x3D;&gt; [“message”,”UNIX_MS”]#message在实际应用中修改为自己的字段<br>    target &#x3D;&gt; “@timestamp”<br>  }<br> ruby {<br>   code &#x3D;&gt; “event[‘timestamp’] &#x3D; LogStash::Timestamp.new(event[‘@timestamp’]+ 8<em>60</em>60)”<br> }<br> ruby {<br>   code &#x3D;&gt; “event[‘@timestamp’]&#x3D; event[‘timestamp’]”<br> }<br> mutate {<br>   remove_field &#x3D;&gt; [“timestamp”]<br> }</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5.x</span><br></pre></td></tr></table></figure>

<p>input { stdin {} }<br>output { stdout { codec &#x3D;&gt; rubydebug } }<br>filter {<br>  date {<br>    match &#x3D;&gt; [“message”,”UNIX_MS”]<br>    target &#x3D;&gt; “@timestamp”<br>  }<br> ruby {<br>   code &#x3D;&gt; “event.set(‘timestamp’, event.get(‘@timestamp’).time.localtime + 8<em>60</em>60)”<br> }<br> ruby {<br>   code &#x3D;&gt; “event.set(‘@timestamp’,event.get(‘timestamp’))”<br> }<br> mutate {<br>   remove_field &#x3D;&gt; [“timestamp”]<br> }</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">**解决**</span><br><span class="line">如果保证以上配置文件service字段一致，那么基本就没问题了。</span><br><span class="line"></span><br><span class="line">3. logstash 调试</span><br><span class="line"></span><br><span class="line">先上一段配置代码,关于很多文章里面都提到了rubydebug.一看其实也清楚,就是调试的,但是怎么生效能,怎么查看日志呢</span><br><span class="line">需要后面使用--verbose --debug</span><br></pre></td></tr></table></figure>
<p>output {<br>    stdout {<br>        codec &#x3D;&gt; rubydebug<br>    }<br>}</p>
<p> bin&#x2F;logstash -f test_grok.conf –verbose –debug</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这样直接在前台启动,便可以看到日志输出到终端.</span><br><span class="line"></span><br><span class="line">4. logstash Nginx 代理</span><br></pre></td></tr></table></figure>
<p>stream {<br>    upstream logstash {<br>        hash $remote_addr consistent;<br>        server A:4560;<br>        server B:4560;<br>    }<br>    server {<br>        listen       5560;<br>        proxy_pass   logstash;<br>        proxy_protocol on;<br>    }<br>}</p>
<pre><code>
## 相关资料
[http://grokdebug.herokuapp.com/](http://grokdebug.herokuapp.com/)
[https://www.elastic.co/products/beats/filebeat](https://www.elastic.co/products/beats/filebeat)
[https://www.elastic.co/products/elasticsearch](https://www.elastic.co/products/elasticsearch)
[https://www.elastic.co/products/logstash](https://www.elastic.co/products/logstash)
[https://www.elastic.co/products/kibana](https://www.elastic.co/products/kibana)
[http://bbotte.com/logs-service/elasticsearch-template-and-mapping/](http://bbotte.com/logs-service/elasticsearch-template-and-mapping/)
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8E%E5%AF%B9Flask%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E8%AE%B0%E5%BD%95.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8E%E5%AF%B9Flask%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E8%AE%B0%E5%BD%95.html" class="post-title-link" itemprop="url">Flask 学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>常用的架构有以下两种方式：</p>
<ul>
<li>功能式</li>
<li>分布式</li>
</ul>
<h3 id="功能式"><a href="#功能式" class="headerlink" title="功能式"></a>功能式</h3><p>简单来讲就是以功能来归类文件，比如静态文件放一个目录，模块文件放一个目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yourapp/</span><br><span class="line">    __init__.py</span><br><span class="line">    static/</span><br><span class="line">    templates/</span><br><span class="line">        home/</span><br><span class="line">        control_panel/</span><br><span class="line">        admin/</span><br><span class="line">    views/</span><br><span class="line">        __init__.py</span><br><span class="line">        home.py</span><br><span class="line">        control_panel.py</span><br><span class="line">        admin.py</span><br><span class="line">    models.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>除了 <code>yourapp/views/__init__.py</code>，在<code>yourapp/views/</code>文件夹中的每一个.py文件都是一个蓝图。在<code>yourapp/__init__.py</code> 中，我们将加载这些蓝图并在我们的Flask()对象中注册它们。</p>
<p>特点：</p>
<ul>
<li>分类明确，很明显就知道去哪找哪种文件；</li>
<li>适合小型项目；</li>
<li>各功能之间联系紧密；</li>
</ul>
<h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><p>按照每一部分所属的蓝图来组织你的应用。比如A功能的静态文件、模块、视图都放在A的这一个大的目录下。就像一个国家有N个诸侯，每个诸侯管理自己的地盘，互不打扰。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yourapp/</span><br><span class="line">    __init__.py</span><br><span class="line">    admin/</span><br><span class="line">        __init__.py</span><br><span class="line">        views.py</span><br><span class="line">        static/</span><br><span class="line">        templates/</span><br><span class="line">    home/</span><br><span class="line">        __init__.py</span><br><span class="line">        views.py</span><br><span class="line">        static/</span><br><span class="line">        templates/</span><br><span class="line">    control_panel/</span><br><span class="line">        __init__.py</span><br><span class="line">        views.py</span><br><span class="line">        static/</span><br><span class="line">        templates/</span><br><span class="line">    models.py</span><br></pre></td></tr></table></figure>

<p>在像上面列举的分区式结构，每一个yourapp&#x2F;之下的文件夹都是一个独立的蓝图。所有的蓝图通过顶级的__init__.py注册到Flask()中。</p>
<p>特点：</p>
<ul>
<li>应用较为独立，仅共享配置和模型等等；</li>
<li>更为灵活</li>
</ul>
<p>综上所述一般绝大部分的项目就用功能式的架构就会满足需要了。</p>
<h2 id="如何使用蓝图重构一个项目"><a href="#如何使用蓝图重构一个项目" class="headerlink" title="如何使用蓝图重构一个项目"></a>如何使用蓝图重构一个项目</h2><p>Step 1：分区式还是功能式？<br>这个应用由关联较小的各部分构成。模板和静态文件不太可能在蓝图间共享，所以我们将使用分区式结构。<br>Step 2：分而治之<br>注意 在你对你的应用大刀阔斧之前，把一切提交到版本控制。你不会接受对任何有用的东西的意外删除。</p>
<p>接下来我们将继续前进，为我们的新应用创建目录树。从为每一个蓝图创建一个目录开始吧。然后整体复制views.py，static&#x2F;和templates&#x2F;到每一个蓝图文件夹。接着你可以从顶级目录删除掉它们了。</p>
<p>Step 3：大扫除<br>现在我们可以到每一个蓝图中，移除无关的视图，静态文件和模板。你在这一阶段的处境很大程度上取决于一开始你是怎么组织你的应用的。</p>
<p>最终结果应该是：每个蓝图有一个views.py包括了蓝图里的所有视图，没有两个蓝图对同一个路由定义了视图；每一个templates&#x2F;文件夹应该只包括该蓝图所需的模板；每一个static&#x2F;文件夹应该只包括该蓝图所需的静态文件。</p>
<p>注意 趁此机会消除所有不必要的import。很容易忽略掉他们的存在，但他们会拥塞你的代码，甚至拖慢你的应用。</p>
<p>Step 4：蓝图<br>在这一部分我们把文件夹转换成蓝图。关键在于__init__.py文件。作为开始，让我们看一下API蓝图的定义。</p>
<p>Step 5：大功告成<br>现在我们的应用已经比只有单个臃肿的views.py的时候更加模块化了。</p>
<p>总结:</p>
<ul>
<li>一个蓝图包括了可以作为独立应用的视图，模板，静态文件和其他插件。</li>
<li>蓝图是组织你的应用的好办法。</li>
<li>在分区式架构下，每个蓝图对应你的应用的一个部分。</li>
<li>在功能式架构下，每个蓝图就只是视图的集合。所有的模板和静态文件都放在一块。</li>
<li>要使用蓝图，你需要定义它，并在应用中用Flask.register_blueprint()注册它。</li>
<li>你可以给一个蓝图中的所有路由定义一个动态URL前缀。</li>
<li>你也可以给蓝图中的所有路由定义一个动态子域名。</li>
<li>仅需五步走，你可以用蓝图重构一个应用。</li>
</ul>
<h2 id="一些有意思的事情"><a href="#一些有意思的事情" class="headerlink" title="一些有意思的事情"></a>一些有意思的事情</h2><h3 id="json和jsonify的差异"><a href="#json和jsonify的差异" class="headerlink" title="json和jsonify的差异"></a>json和jsonify的差异</h3><p>字符串转json对象，使用json.loads()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="comment"># 字符串转json，注意（key与value必须是双引号）</span></span><br><span class="line">str1 = <span class="string">&#x27;&#123;&quot;a&quot;:1, &quot;b&quot;:&quot;2&quot;&#125;&#x27;</span></span><br><span class="line">j1 = json.loads(str1)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(j1), j1)  <span class="comment"># &lt;class &#x27;dict&#x27;&gt; &#123;&#x27;a&#x27;: 1, &#x27;b&#x27;: &#x27;2&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">str2 = <span class="string">&#x27;[&#123;&quot;a&quot;:1&#125;,&#123;&quot;a&quot;:&quot;2&quot;&#125;]&#x27;</span></span><br><span class="line">j2 = json.loads(str2)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(j2), j2)  <span class="comment"># &lt;class &#x27;list&#x27;&gt; [&#123;&#x27;a&#x27;: 1&#125;, &#123;&#x27;a&#x27;: &#x27;2&#x27;&#125;]</span></span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> j2:</span><br><span class="line">    <span class="built_in">print</span>(obj[<span class="string">&quot;a&quot;</span>])  <span class="comment"># 1  2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可见通过json的loads方法可将标准json字符串转成字典对象或字典集合</span></span><br><span class="line"><span class="comment"># 下面是嵌套组合的字符串也可以通过loads方法转换</span></span><br><span class="line">f = <span class="string">&#x27;&#123;&quot;a&quot;:1, &quot;b&quot;: [&#123;&quot;b_1&quot;: &quot;b1&quot;&#125;, &#123;&quot;b_1&quot;: &quot;b1&quot;&#125;]&#125;&#x27;</span></span><br><span class="line">l = json.loads(f)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(l), l)  <span class="comment"># &lt;class &#x27;dict&#x27;&gt; &#123;&#x27;a&#x27;: 1, &#x27;b&#x27;: [&#123;&#x27;b_1&#x27;: &#x27;b1&#x27;&#125;, &#123;&#x27;b_1&#x27;: &#x27;b1&#x27;&#125;]&#125;</span></span><br><span class="line"><span class="built_in">print</span>(l[<span class="string">&quot;b&quot;</span>], <span class="built_in">type</span>(l[<span class="string">&quot;b&quot;</span>]))  <span class="comment"># [&#123;&#x27;b_1&#x27;: &#x27;b1&#x27;&#125;, &#123;&#x27;b_1&#x27;: &#x27;b1&#x27;&#125;] &lt;class &#x27;list&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt; &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;2&#x27;</span>&#125;</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;list&#x27;</span>&gt; [&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>&#125;, &#123;<span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;2&#x27;</span>&#125;]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt; &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: [&#123;<span class="string">&#x27;b_1&#x27;</span>: <span class="string">&#x27;b1&#x27;</span>&#125;, &#123;<span class="string">&#x27;b_1&#x27;</span>: <span class="string">&#x27;b1&#x27;</span>&#125;]&#125;</span><br><span class="line">[&#123;<span class="string">&#x27;b_1&#x27;</span>: <span class="string">&#x27;b1&#x27;</span>&#125;, &#123;<span class="string">&#x27;b_1&#x27;</span>: <span class="string">&#x27;b1&#x27;</span>&#125;] &lt;<span class="keyword">class</span> <span class="string">&#x27;list&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>json对象转字符串，使用json.dumps()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">obj = &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: <span class="string">&quot;2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">objStr = json.dumps(obj)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(objStr), objStr)  <span class="comment"># &lt;class &#x27;str&#x27;&gt; &#123;&quot;a&quot;: 1, &quot;b&quot;: &quot;2&quot;&#125;</span></span><br><span class="line">arr = [</span><br><span class="line">    &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;a&quot;</span>: <span class="string">&quot;2&quot;</span>&#125;</span><br><span class="line">]</span><br><span class="line">arrStr = json.dumps(arr)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(arrStr), arrStr)  <span class="comment"># &lt;class &#x27;str&#x27;&gt; [&#123;&quot;a&quot;: 1&#125;, &#123;&quot;a&quot;: &quot;2&quot;&#125;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt; &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>, <span class="string">&quot;b&quot;</span>: <span class="string">&quot;2&quot;</span>&#125;</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt; [&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;, &#123;<span class="string">&quot;a&quot;</span>: <span class="string">&quot;2&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>通过jsonify()将dict转为json字符串</p>
<p>简单，快速是Flask自带的模块jsonify。 功能类似于<code>json.dumps()</code>，但是会把返回的<code>Content-Type从text/html</code>转换成带json特征的 <code>application/json</code>。</p>
<p><img src="https://img.mknight.cn/medivh/1659598907405.png" alt="1659598907405.png"></p>
<p>总结：</p>
<ul>
<li>json.loads() 把 json 字符串 转成 python 数据类型</li>
<li>json.load(python数据类型,文件句柄) 把 json 文件 转成 python 数据类型</li>
<li>json.dumps() 把 python 数据类型 转成 json 字符串</li>
<li>json.dump(文件句柄) 把 python 数据类型 写入到 json 文件中</li>
</ul>
<p>个人倾向在flask项目中使用jsonify()，简捷。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E5%85%B3%E4%BA%8E%E6%B7%B7%E5%90%88%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88%E7%9A%84%E8%AE%BE%E6%83%B3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%85%B3%E4%BA%8E%E6%B7%B7%E5%90%88%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88%E7%9A%84%E8%AE%BE%E6%83%B3.html" class="post-title-link" itemprop="url">关于混合部署方案的设想</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="理论依据"><a href="#理论依据" class="headerlink" title="理论依据"></a>理论依据</h2><p>在时效性上来区分任务，常规的任务一般分为在线任务和离线任务。其中在线任务消耗的资源相对较少，但是要求相应时间较短，比如web服务；而离线任务则对时效性要求不高，但是任务量大，需要的资源更多。因此把两种项目混合部署在一起就叫做混合部署。</p>
<p>大多数进程可以分为I&#x2F;O密集型和CPU密集型。I&#x2F;O密集型程序将大多数时间都花在了I&#x2F;O操作而不是运算上，而CPU密集型程序正好相反，将大多数时间花在了运算上，而很少产生I&#x2F;O操作。选出一个I&#x2F;O密集型和CPU密集型程序的良好组合，对于长期调度器是非常重要的。否则，假如所有的程序都是CPU密集型的，那么I&#x2F;O队列将会几乎永远都是空的，这样就会导致一些设备从来没被使用过，系统资源分配就是不均衡的。显然，性能极佳的系统必然是CPU密集型和I&#x2F;O密集型程序的组合。在现代操作系统中，这被用来保证实时进程能获得足够的CPU时间来完成任务。但我们的当前绝大部分项目并不能做到资源的和谐组合——cpu使用率远低于内存使用率。这样的特点也方便混合部署的时候只需要考虑内存的瓶颈即可。</p>
<h2 id="资源使用率现状"><a href="#资源使用率现状" class="headerlink" title="资源使用率现状"></a>资源使用率现状</h2><p>通俗来讲，我们希望使用提高资源使用率的同时降低成本。任务类型的分类是提高资源利用率的理论依据，只不过迫于现实，实践过程中会有些偏差。<br>当前的现状，大部分CPU平均使用率长期在30%以内徘徊，极大的浪费资源。<br><img src="https://img.mknight.cn/medivh/1630553329133.png"  /></p>
<p>而对于内存调整的空间较为有限，个别实例有操作空间。<br><img src="https://img.mknight.cn/medivh/1630553335430.png"  /></p>
<p>当前的实例用途类型基本分为三类：</p>
<ul>
<li>大数据集群<ul>
<li>夜间使用率高，白天使用率低</li>
<li>CPU和内存需求较高</li>
</ul>
</li>
<li>微服务<ul>
<li>白天使用率微高，夜间极低</li>
<li>CPU使用率较低，内存使用率微高</li>
</ul>
</li>
<li>中间件<ul>
<li>波动较小<br>自2021年起始，累计增加了约8~10个微服务项目，关停1台主机但并没有增加新的实例主机。单纯的微服务集群内存使用率峰值只增加了不到5个百分点。这些数字说明了一些可能的现象：</li>
</ul>
</li>
<li>业务量有降低</li>
<li>代码性能更好<br>当前保有实例45台，每年的开支大约在32万，是不是有可能降低10%~15%？</li>
</ul>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>现有ECS基本可以分为2种类型的实例，离线型和在线型。其中离线型的实例配置较高，常规配置为16核32G，近期保有量为3~5台。因此之后一段时间可以将部分微服务部署在相应的节点。</p>
<h3 id="规划节点"><a href="#规划节点" class="headerlink" title="规划节点"></a>规划节点</h3><p>节点角色</p>
<ul>
<li>003~005 轻量级节点</li>
<li>006~007 常规级节点</li>
<li></li>
</ul>
<h4 id="潜在问题"><a href="#潜在问题" class="headerlink" title="潜在问题"></a>潜在问题</h4><p>轻量级的实例部署了多种大数据相关的服务，因此只可部署少量的微服务，避免极端情况下微服务和大数据服务资源的抢夺。常规级的节点可以部署更多pod。。同时，两类服务共存会带来一些潜在的问题：</p>
<ol>
<li>极端调度；</li>
<li>抢夺资源；</li>
<li>网络关系.</li>
</ol>
<p>以上三个问题中最重要的是第一个问题，第一个问题处理好后，第二个问题就会很好处理。而第三个则是永远无法避免的，能做的只能是选择网络依赖最小的微服务。因此，重点解决调度的问题。</p>
<ol>
<li>节点选择。在默认情况下，pod的调度是由scheduler-crontroller根据节点资源和有限制来自动完成的。但是在目前的情况下我们希望微服务部署在某些节点和少量部署在另一部分节点上。对于指定节点部署可以使用NodeSelector设定的标签来选择节点，原理是给node设置标签，scheduler就会把pod调度到具有该标签的node上。</li>
<li>资源限制。每个pod都会有cpu和memory的limits限制，因此再加上pod的数量限制，就可以避免服务间的资源抢夺了。设置–max-pods较为简单，修改各node kubelet启动参数即可，较容易实现。</li>
<li>均匀调度。每个微服务默认期望部署在至少两个节点，常规实例和大数据实例。对于这个问题需要用节点亲和性和pod亲和性来处理。节点亲和性指定了将pod调度到节点的权重或其他规则。pod亲和性基于已经在节点上运行的pod的标签来约束pod可以调度到的节点，而不是基于节点的标签。但是这这两种方式不适合当前版本的kubernetes，只能在高版本的集群上使用。<br>综上所述，潜在问题可以大部分通过参数调整达到期望的状态，基本满足正常使用。如果期望达到更好的状态，则必须升级kubernetes集群。</li>
</ol>
<h3 id="部署节点"><a href="#部署节点" class="headerlink" title="部署节点"></a>部署节点</h3><h4 id="部署kubelete-client"><a href="#部署kubelete-client" class="headerlink" title="部署kubelete client"></a>部署kubelete client</h4><p>常规部署，无特殊处理，修改<code>--max-pods</code>。</p>
<h4 id="网络安全"><a href="#网络安全" class="headerlink" title="网络安全"></a>网络安全</h4><ul>
<li>需注意大数据集群和业务服务的网络互通，重点在安全组的配置</li>
</ul>
<h4 id="预期目标"><a href="#预期目标" class="headerlink" title="预期目标"></a>预期目标</h4><p>目前保有143个pod，加上部分服务的编排处理，预计全部的pod会到达160个。通过混合部署，预计能释放20~30个pod的资源潜力，约至少32G内存。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当年内预期目标ECS部分的开支控制在30万内，去年约31万。当前阶段通过资源混部来实现资源的错位运用可以提高一些资源利用率。接下来通过pod的资源利用率监控可以更合理的进行资源限制，释放过剩资源。之后kubernetes的版本升级之后带来的亲和性功能和hpa、vpa、ca则会带来更多的想象空间。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Docker%20%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Docker%20%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93%EF%BC%88%E4%B8%80%EF%BC%89.html" class="post-title-link" itemprop="url">Docker 实践总结（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="关于版本"><a href="#关于版本" class="headerlink" title="关于版本"></a>关于版本</h2><h3 id="版本概述"><a href="#版本概述" class="headerlink" title="版本概述"></a>版本概述</h3><p>Docker从1.13版本之后采用时间线的方式作为版本号，分为社区版CE和企业版EE。而在此之前CentOS官方自带的版本是这样的：</p>
<p>社区版是免费提供给个人开发者和小型团体使用的，企业版会提供额外的收费服务，比如经过官方测试认证过的基础设施、容器、插件等。社区版按照stable和edge两种方式发布，每个季度更新stable版本，如17.06，17.09；每个月份更新edge版本，如17.09，17.10。  </p>
<img src="https://img.mknight.cn/2018/1545117093997.png" />

<h3 id="版本比较"><a href="#版本比较" class="headerlink" title="版本比较"></a>版本比较</h3><img src="https://img.mknight.cn/2018/1545117979095.png" />
### 防火墙
关闭firewall
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-selinux \</span><br><span class="line">                  docker-engine-selinux \</span><br><span class="line">                  docker-engine</span><br><span class="line">                  </span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<h3 id="使用普通用户"><a href="#使用普通用户" class="headerlink" title="使用普通用户"></a>使用普通用户</h3><ul>
<li><p>1、 首先创建docker用户组，如果docker用户组存在可以忽略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd docker</span><br></pre></td></tr></table></figure></li>
<li><p>2、把用户添加进docker组中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -a $&#123;USER&#125; docker</span><br></pre></td></tr></table></figure></li>
<li><p>3、重启docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>4、如果普通用户执行docker命令，如果提示<code>get …… dial unix /var/run/docker.sock</code>权限不够，则修改<code>/var/run/docker.sock</code>权限<br>使用root用户执行如下命令，即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod a+rw /var/run/docker.sock</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="配置仓库"><a href="#配置仓库" class="headerlink" title="配置仓库"></a>配置仓库</h3><p>18.03</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/multi-user.target.wants/docker.service</span><br><span class="line">#加入</span><br><span class="line">ExecStart=/usr/bin/dockerd -H unix:// --registry-mirror=http://192.168.1.232:5000</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546486336192.png" />

<p>19.03</p>
<p>修改daemon.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;&quot;insecure-registries&quot;:[&quot;192.168.1.232:5000&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以使用自己的镜像仓库啦。如果没有配置这些，会提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get https://192.168.1.232:5000/v1/users/: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>

<h3 id="镜像示例"><a href="#镜像示例" class="headerlink" title="镜像示例"></a>镜像示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM 10.110.1.18:5000/base/jdk:1.8.0</span><br><span class="line">ENV LC_ALL en_US.UTF-8</span><br><span class="line">WORKDIR    /home/joy/src</span><br><span class="line">COPY  	xxx.war	 /home/joy/src</span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;xxx.war&quot;,&quot;--server.port=8080&quot;,&quot;--Djava.security.egd=file:/dev/./urandom&quot;]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-Xms2g -Xmx2g -Xmn512m -XX:PermSize=128M -XX:MaxPermSize=128m -XX:SurvivorRatio=6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d -m 2g  -e JAVA_OPTIONS=&#x27;-Xmx1g -Xms1g -Xmn512m  -XX:PermSize=64m -XX:MaxPermSize=256m&#x27;   10.110.1.18:5000/base/xxxx:latest  /bin/bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-Xms：java Heap初始大小， 默认是物理内存的1/64。</span><br><span class="line">-Xmx：java Heap最大值，不可超过物理内存。</span><br><span class="line">-Xmn：young generation的heap大小，一般设置为Xmx的3、4分之一 。增大年轻代后，将会减小年老代大小，可以根据监控合理设置。</span><br><span class="line">-Xss：每个线程的Stack大小，而最佳值应该是128K,默认值好像是512k。</span><br><span class="line">-XX:PermSize：设定内存的永久保存区初始大小，缺省值为64M。</span><br><span class="line">-XX:MaxPermSize：设定内存的永久保存区最大大小，缺省值为64M。</span><br><span class="line">-XX:SurvivorRatio：Eden区与Survivor区的大小比值，设置为8，则两个Survivor区与一个Eden区的比值为2:8，一个Survivor区占整个年轻代的1/10。</span><br><span class="line">-XX:+UseParallelGC：F年轻代使用并发收集，而年老代仍旧使用串行收集。</span><br><span class="line">-XX:+UseParNewGC：设置年轻代为并行收集，JDK5.0以上，JVM会根据系统配置自行设置，所无需再设置此值。</span><br><span class="line">-XX:ParallelGCThreads：并行收集器的线程数，值最好配置与处理器数目相等 同样适用于CMS。</span><br><span class="line">-XX:+UseParallelOldGC：年老代垃圾收集方式为并行收集(Parallel Compacting)。</span><br><span class="line">-XX:MaxGCPauseMillis：每次年轻代垃圾回收的最长时间(最大暂停时间)，如果无法满足此时间，JVM会自动调整年轻代大小，以满足此值。</span><br><span class="line">-XX:+ScavengeBeforeFullGC：Full GC前调用YGC,默认是true。</span><br></pre></td></tr></table></figure>


<h2 id="镜像库"><a href="#镜像库" class="headerlink" title="镜像库"></a>镜像库</h2><h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">docker search centos                                       # 查找源中镜像</span><br><span class="line">docker pull centos:6                                       # 从官方下载centos的docker镜像</span><br><span class="line"></span><br><span class="line">docker images                                              # 查看docker镜像</span><br><span class="line">docker ps                                                  # 查看docker启动的容器</span><br><span class="line">docker ps -a                                               # 查看docker所有容器 包括未启动的</span><br><span class="line">docker rm $(docker ps -a -q)                    #删除所有停止的容器</span><br><span class="line"></span><br><span class="line">docker run -d -t -i centos:6 /bin/bash          # 启动docker隔离的容器 -t 让Docker分配一个伪终端,并绑定到容器的标准输入上. -i 则让容器的标准输入保持打开. -d 守护进程</span><br><span class="line">docker attach ID                                           # 进入后台的容器 指定容器ID   # util-linux 也可以进入容器</span><br><span class="line">docker logs ID                                             # 获取容器内输出信息</span><br><span class="line"></span><br><span class="line">docker stop ID                                             # 停止已启动的容器</span><br><span class="line">docker start ID                                            # 启动已停止的容器</span><br><span class="line">docker restart ID                                          # 重启容器</span><br><span class="line"></span><br><span class="line">docker export 7691a814370e &gt; centos_a.tar                  # 导出容器快照到本地</span><br><span class="line">cat centos_a.tar | docker import - test/centos_a:v1.0      # 从容器快照文件中再导入为镜像</span><br><span class="line"></span><br><span class="line">docker save -o centos.6.tar centos:6                       # 保存镜像到文件</span><br><span class="line">docker load --input centos.6.tar                           # 载入镜像文件</span><br><span class="line"></span><br><span class="line">docker rm 容器ID                                           # 删除终止状态的容器   加-f强制终止运行中的容器</span><br><span class="line">docker rmi test/centos_a:v1.0                              # 移除本地镜像   在删除镜像之前要先用 docker rm 删掉依赖于这个镜像的所有容器</span><br><span class="line">docker commit -m &#x27;nginx from centos7&#x27; 12bf9d3e4d94  medivh/nginx:v1          提交更改到一个镜像</span><br><span class="line">docker rm `docker ps -a|grep Exited|awk &#x27;&#123;print $1&#125;&#x27;`      # 删除所有退出的容器</span><br><span class="line">brctl show                                                 # 查看网桥</span><br><span class="line"></span><br><span class="line">docker pull library/nginx</span><br><span class="line"></span><br><span class="line">docker run --name some-nginx -v /some/content:/usr/share/nginx/html:ro -d nginx</span><br><span class="line"></span><br><span class="line">mkdir testa                            # 创建静态资源目录</span><br><span class="line">vim testa/a.txt</span><br><span class="line">aaaaaa</span><br><span class="line"></span><br><span class="line">vim Dockerfile                         # 创建 Dockerfile 文件</span><br><span class="line">FROM nginx</span><br><span class="line">COPY testa /usr/share/nginx/html       # 拷贝前面创建的静态资源目录</span><br><span class="line"></span><br><span class="line"># Dockerfile用来创建一个自定义的image,包含了用户指定的软件依赖等。当前目录下包含Dockerfile,使用命令build来创建新的image,并命名为 some-content-nginx</span><br><span class="line">docker build -t some-content-nginx .</span><br><span class="line"></span><br><span class="line">docker run --name some-nginx -d some-content-nginx</span><br><span class="line"></span><br><span class="line">docker run --name XXX -d -p 8080:80 XXX-nginx             # 暴漏端口的方式，将容器80端口映射到主机8080端口，可以直接访问</span><br><span class="line">docker run --name XXX -d -p 127.0.0.1::80 XXX-nginx     #将容器80端口映射到主机某个端口，访问主机该端口</span><br><span class="line">docker run --name XXX -d -P  XXX-nginx     #将容器80端口映射到主机某个端口，访问主机该端口</span><br><span class="line">docker run -d --name db training/postgres</span><br><span class="line">docker run -d -P --name web --link db:db training/webapp python app.py          # 新建立容器,并连接db容器   --link name:alias    </span><br><span class="line"></span><br><span class="line"># 启动仓库容器</span><br><span class="line">docker run -d -p 5000:5000 -v /data/registry:/tmp/registry registry</span><br><span class="line"></span><br><span class="line"># 可以拉取一个比较小的images做测试</span><br><span class="line">docker pull ubuntu</span><br><span class="line"></span><br><span class="line"># 更改images的tag</span><br><span class="line">sudo docker tag ubuntu 192.168.11.247:5000/ubuntu</span><br><span class="line"></span><br><span class="line"># Push images</span><br><span class="line">sudo docker push 192.168.11.247:5000/ubuntu</span><br><span class="line"></span><br><span class="line"># Pull images</span><br><span class="line">sudo docker pull 192.168.11.247:5000/ubuntu</span><br><span class="line"></span><br><span class="line"># 通过API查看</span><br><span class="line">curl http://192.168.11.247:5000/v1/search</span><br><span class="line"></span><br><span class="line"># 在私有仓库搜索</span><br><span class="line">docker search 192.168.11.247:5000/ubuntu</span><br><span class="line"></span><br><span class="line">导入</span><br><span class="line">cd CentOS-6.6_Base</span><br><span class="line">tar -c .|docker import - &quot;centos-6.6/base&quot;</span><br><span class="line"></span><br><span class="line">创建一个带ssh的images</span><br><span class="line">docker build -t &quot;CentOS-6.6/sshd&quot; .</span><br><span class="line"></span><br><span class="line">启动一个实例:</span><br><span class="line">docker run -d -p 127.0.0.1:1994:22 CentOS-6.6/sshd</span><br><span class="line"></span><br><span class="line">导出镜像    </span><br><span class="line">docker save IMAGENAME | bzip2 -9 -c&gt;img.tar.bz2</span><br><span class="line"></span><br><span class="line">导入镜像(换一台机器)</span><br><span class="line">bzip2 -d -c &lt;img.tar.bz2 | docker load</span><br><span class="line">curl http://localhost:8080/a.txt</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="进入容器脚本"><a href="#进入容器脚本" class="headerlink" title="进入容器脚本"></a>进入容器脚本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">CNAME=$1</span><br><span class="line">CPID=$(docker inspect --format &quot;&#123;&#123;.State.Pid&#125;&#125;&quot; $CNAME)</span><br><span class="line">nsenter --target &quot;$CPID&quot; --mount --uts  --ipc --net --pid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">go XXX($cname)</span><br></pre></td></tr></table></figure>
<p>使用的时候直接 脚本+容器ID。</p>
<h3 id="文件互传"><a href="#文件互传" class="headerlink" title="文件互传"></a>文件互传</h3><p>文件传输</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp foo.txt mycontainer:/foo.txt</span><br><span class="line">docker cp mycontainer:/foo.txt foo.txt</span><br></pre></td></tr></table></figure>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>精简Docker镜像尺寸的好处：</p>
<ol>
<li>减少构建时间</li>
<li>减少磁盘使用量</li>
<li>减少下载时间</li>
<li>因为包含文件少，攻击面减小，提高了安全性</li>
<li>提高部署速度</li>
</ol>
<h3 id="镜像优化"><a href="#镜像优化" class="headerlink" title="镜像优化"></a>镜像优化</h3><h4 id="优化基础镜像"><a href="#优化基础镜像" class="headerlink" title="优化基础镜像"></a>优化基础镜像</h4><p>推荐使用alpine&#x2F;busybox，实在不行就只能用CentOS了。</p>
<h4 id="串联-Dockerfile-指令"><a href="#串联-Dockerfile-指令" class="headerlink" title="串联 Dockerfile 指令"></a>串联 Dockerfile 指令</h4><p>大家在定义Dockerfile时，如果太多的使用RUN指令，经常会导致镜像有特别多的层，镜像很臃肿，而且甚至会碰到超出最大层数（127层）限制的问题，遵循 Dockerfile 最佳实践，我们应该把多个命令串联合并为一个 RUN（通过运算符&amp;&amp;和&#x2F; 来实现），每一个 RUN 要精心设计，确保安装构建最后进行清理，这样才可以降低镜像体积，以及最大化的利用构建缓存。<br>将多条RUN命令串联起来构建的镜像大小是每条命令分别RUN的三分之一。</p>
<h4 id="使用多阶段构建"><a href="#使用多阶段构建" class="headerlink" title="使用多阶段构建"></a>使用多阶段构建</h4><p>Dockerfile中每条指令都会为镜像增加一个镜像层，并且你需要在移动到下一个镜像层之前清理不需要的组件。实际上，有一个Dockerfile用于开发（其中包含构建应用程序所需的所有内容）以及一个用于生产的瘦客户端，它只包含你的应用程序以及运行它所需的内容。这被称为“建造者模式”。Docker 17.05.0-ce版本以后支持多阶段构建。使用多阶段构建，你可以在Dockerfile中使用多个FROM语句，每条FROM指令可以使用不同的基础镜像，这样您可以选择性地将服务组件从一个阶段COPY到另一个阶段，在最终镜像中只保留需要的内容。</p>
<p>下面是一个使用COPY –from 和 FROM … AS … 的Dockerfile：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Compile</span><br><span class="line">FROM golang:1.9.0 AS builder</span><br><span class="line">WORKDIR /go/src/v9.git...com/.../k8s-monitor</span><br><span class="line">COPY . .</span><br><span class="line">WORKDIR /go/src/v9.git...com/.../k8s-monitor</span><br><span class="line">RUN make build</span><br><span class="line">RUN mv k8s-monitor /root</span><br><span class="line"></span><br><span class="line"># Package</span><br><span class="line"># Use scratch image</span><br><span class="line">FROM scratch</span><br><span class="line">WORKDIR /root/</span><br><span class="line">COPY --from=builder /root .</span><br><span class="line">EXPOSE 8080</span><br><span class="line">CMD [&quot;/root/k8s-monitor&quot;]</span><br></pre></td></tr></table></figure>
<p>构建镜像，你会发现生成的镜像只有上面COPY 指令指定的内容，镜像大小只有2M。这样在以前使用两个Dockerfile（一个Dockerfile用于开发和一个用于生产的瘦客户端），现在使用多阶段构建就可以搞定。</p>
<h4 id="修改docker0"><a href="#修改docker0" class="headerlink" title="修改docker0"></a>修改docker0</h4><p>在此文件中添加如下一行，然后重启服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">&quot;bip&quot;: &quot;192.168.102.1/24&quot;</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<h4 id="构建业务服务镜像技巧"><a href="#构建业务服务镜像技巧" class="headerlink" title="构建业务服务镜像技巧"></a>构建业务服务镜像技巧</h4><ul>
<li>不变或者变化很少的体积较大的依赖库和经常修改的自有代码分开；</li>
<li>因为cache缓存在运行Docker build命令的本地机器上，建议固定使用某台机器来进行Docker build，以便利用cache。</li>
</ul>
<h4 id="其他优化技巧"><a href="#其他优化技巧" class="headerlink" title="其他优化技巧"></a>其他优化技巧</h4><p>如果在RUN命令中执行apt、apk或者yum类工具，可以借助这些工具提供的一些小技巧来减少镜像层数量及镜像大小。举几个例子：</p>
<p>（1）在执行<code>apt-get install -y</code> 时增加选项<code>— no-install-recommends </code>，可以不用安装建议性（非必须）的依赖，也可以在执行<code>apk add </code>时添加选项<code>--no-cache</code> 达到同样效果；</p>
<p>（2）执行yum install -y 时候， 可以同时安装多个工具，比如<code>yum install -y gcc gcc-c++ make …</code>。将所有<code>yum install</code> 任务放在一条RUN命令上执行，从而减少镜像层的数量；</p>
<p>（3）组件的安装和清理要串联在一条指令里面，如<code>apk --update add php7 &amp;&amp; rm -rf /var/cache/apk/*</code>，因为Dockerfile的每条指令都会产生一个文件层，如果将<code>apk add …</code> 和<code> rm -rf …</code> 命令分开，清理无法减小apk命令产生的文件层的大小。清理镜像中缓存文件；CentOS等系统使用yum clean all 命令清理。</p>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><h2 id="疑难杂症"><a href="#疑难杂症" class="headerlink" title="疑难杂症"></a>疑难杂症</h2><ul>
<li><p>1、docker dead 无法删除</p>
<ul>
<li>1、检查挂载信息  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep docker /proc/*/mountinfo &gt; x.log</span><br></pre></td></tr></table></figure></li>
<li>2、 获取进程ID  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -nr &#x27;/var/lib/docker/overlay2/bd47a216d1bc2e72ba3155169faee246b2352fe919c8fb4708891ad31d1d31c7/diff&#x27; x.log | awk -F &#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|awk -F &#x27;/&#x27; &#x27;&#123;print $3&#125;’</span><br></pre></td></tr></table></figure></li>
<li>3、杀死所有相关进程</li>
</ul>
</li>
<li><p>2、故障</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/kubernetes%20%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E7%9A%84%E6%8E%A2%E8%AE%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/kubernetes%20%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E7%9A%84%E6%8E%A2%E8%AE%A8.html" class="post-title-link" itemprop="url">kubernetes 常见问题的探讨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>关于kubernetes 部署复杂是其特点之一，而网络问题则是最为常见的类型之一。</p>
<h3 id="场景-a-b-c-node上的pod互通，但是对d-node无法访问"><a href="#场景-a-b-c-node上的pod互通，但是对d-node无法访问" class="headerlink" title="场景 a&#x2F;b&#x2F;c node上的pod互通，但是对d node无法访问"></a>场景 a&#x2F;b&#x2F;c node上的pod互通，但是对d node无法访问</h3><blockquote>
<ul>
<li>个别服务出现无法访问另一个服务的情况；</li>
<li>测试判断无法ping通;</li>
<li>080端口无法访问;</li>
<li>经测试其他node上的pod均无法访问该node上的pod。</li>
</ul>
</blockquote>
<p>根据以上背景，初步断定是网络问题。</p>
<h4 id="通讯链路"><a href="#通讯链路" class="headerlink" title="通讯链路"></a>通讯链路</h4><img src="https://img.mknight.cn/medivh/1630319238909.png"  />

<p>详细示例</p>
<img src="https://img.mknight.cn/medivh/1630319277207.png"  />

<ul>
<li><p>数据从源容器中发出，经所在主机的docker0网卡转发到flannel网卡；</p>
</li>
<li><p>flannel通过etcd维护的路由表将数据发送给目的主机；</p>
</li>
<li><p>源主机的flanneld服务将原数据内容UDP封装和根据自己的路由表传递给目的地节点的flanneld服务；</p>
</li>
<li><p>数据到达后解包，然后直接进入目的节点的flannel网卡；</p>
</li>
<li><p>之后转发到目的主机的docker0网卡；</p>
</li>
<li><p>最后docker0路由到目标容器。</p>
</li>
</ul>
<h4 id="检查网卡"><a href="#检查网卡" class="headerlink" title="检查网卡"></a>检查网卡</h4><p>首先查看a&#x2F;b&#x2F;c网卡，检查docker0和flannel是否在同一网段。<br><img src="https://img.mknight.cn/medivh/1630317106237.png"  /><br>检查结果正常。<br>检查d节点网卡<br><img src="https://img.mknight.cn/medivh/1630317240889.png"  /><br>检查结果正常。</p>
<h4 id="检查路由表"><a href="#检查路由表" class="headerlink" title="检查路由表"></a>检查路由表</h4><p>查看a&#x2F;b&#x2F;c路由表<br><img src="https://img.mknight.cn/medivh/1630317434299.png"/></p>
<blockquote>
<p>10.100.0.0 指向flannel<br>10.100.54.0 指向docker0<br>192.168.1.0 指向 ens3，局域网地址</p>
</blockquote>
<p>查看d路由表<br><img src="https://img.mknight.cn/medivh/1630317458997.png"  /></p>
<blockquote>
<p>10.100.0.0 指向flannel<br>10.100.41.0 指向docker0<br>192.168.1.0 指向 ens3，局域网地址</p>
</blockquote>
<p>路由表无异常。<br>也可以使用下列命令，效果一样：<code>route -n</code></p>
<h4 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>

<h4 id="ip-forwad"><a href="#ip-forwad" class="headerlink" title="ip forwad"></a>ip forwad</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test_243 ~]#  sysctl -a|grep ip_forward</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.ip_forward_use_pmtu = 0</span><br></pre></td></tr></table></figure>
<p>如果没有打开转发，则使用以下方式。</p>
<h5 id="临时"><a href="#临时" class="headerlink" title="临时"></a>临时</h5><blockquote>
<p>临时生效的配置方式，在系统重启，或对系统的网络服务进行重启后都会失效。这种方式可用于临时测试、或做实验时使用。</p>
</blockquote>
<p>方案一<br>sysctl 命令的 -w 参数可以实时修改Linux的内核参数，并生效。所以使用如下命令可以开发Linux的路由转发功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure>
<p>方案二<br>内核参数在Linux文件系统中的映射出的文件：&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward中记录了Linux系统当前对路由转发功能的支持情况。文件中的值为0,说明禁止进行IP转发；如果是1,则说明IP转发功能已经打开。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>


<h5 id="永久"><a href="#永久" class="headerlink" title="永久"></a>永久</h5><p>在sysctl.conf配置文件中有一项名为<code>net.ipv4.ip_forward</code>的配置项，用于配置Linux内核中的<code>net.ipv4.ip_forward</code>参数。其值为0,说明禁止进行IP转发；如果是1,则说明IP转发功能已经打开。</p>
<p>需要注意的是，修改sysctl.conf文件后需要执行指令<code>sysctl -p </code>后新的配置才会生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.d/99-sysctl.conf </span><br><span class="line">...</span><br><span class="line"># 结尾添加：</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">:wq</span><br><span class="line">[root@CentOS ~]# sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1   //查看修改结果.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><blockquote>
<p>检查etcd数据是否正常</p>
</blockquote>
<img src="https://img.mknight.cn/medivh/1630321077720.png"  />
核对网段和Mac地址是否一致。
<img src="https://img.mknight.cn/medivh/1630321154640.png"  />
事实证明`10.100.41.0`的网卡和实际的网卡Mac地址并不一致，所以导致源主机没有找到真实的目的主机。

<img src="https://img.mknight.cn/medivh/1630321352642.png"  />

<p>最后发现，原<code>10.100.41.0</code>的网卡对应的是另外一台历史机器，造成的网卡冲突导致的这一后果。</p>
<h5 id="etcd的基本使用"><a href="#etcd的基本使用" class="headerlink" title="etcd的基本使用"></a>etcd的基本使用</h5><p>etcd是一个分布式的、可靠的k-v存储系统，它用于存储分布式系统中的关键数据。在kubernetes中保存集群所有的网络配置和对象的状态信息。在集群中共有两个服务需要用到etcd来协同和存储配置：</p>
<ul>
<li>flannel，对于其他网络差价也需要用到etcd;</li>
<li>kubernetes本身，包括各种对象的状态和元信息配置</li>
</ul>
<p>获取 集群网络配置<br><img src="https://img.mknight.cn/medivh/1630462961875.png"  /></p>
<p>获取子网列表<br><img src="https://img.mknight.cn/medivh/1630463028275.png"  /></p>
<p>获取主机网卡信息<br><img src="https://img.mknight.cn/medivh/1630463053579.png"  /></p>
<p>帮助信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">NAME:</span><br><span class="line">   etcdctl - A simple command line client for etcd.</span><br><span class="line"></span><br><span class="line">WARNING:</span><br><span class="line">   Environment variable ETCDCTL_API is not set; defaults to etcdctl v2.</span><br><span class="line">   Set environment variable ETCDCTL_API=3 to use v3 API or ETCDCTL_API=2 to use v2 API.</span><br><span class="line"></span><br><span class="line">USAGE:</span><br><span class="line">   etcdctl [global options] command [command options] [arguments...]</span><br><span class="line"></span><br><span class="line">VERSION:</span><br><span class="line">   3.2.22</span><br><span class="line"></span><br><span class="line">COMMANDS:</span><br><span class="line">     backup          backup an etcd directory</span><br><span class="line">     cluster-health  check the health of the etcd cluster</span><br><span class="line">     mk              make a new key with a given value</span><br><span class="line">     mkdir           make a new directory</span><br><span class="line">     rm              remove a key or a directory</span><br><span class="line">     rmdir           removes the key if it is an empty directory or a key-value pair</span><br><span class="line">     get             retrieve the value of a key</span><br><span class="line">     ls              retrieve a directory</span><br><span class="line">     set             set the value of a key</span><br><span class="line">     setdir          create a new directory or update an existing directory TTL</span><br><span class="line">     update          update an existing key with a given value</span><br><span class="line">     updatedir       update an existing directory</span><br><span class="line">     watch           watch a key for changes</span><br><span class="line">     exec-watch      watch a key for changes and exec an executable</span><br><span class="line">     member          member add, remove and list subcommands</span><br><span class="line">     user            user add, grant and revoke subcommands</span><br><span class="line">     role            role add, grant and revoke subcommands</span><br><span class="line">     auth            overall auth controls</span><br><span class="line">     help, h         Shows a list of commands or help for one command</span><br><span class="line"></span><br><span class="line">GLOBAL OPTIONS:</span><br><span class="line">   --debug                          output cURL commands which can be used to reproduce the request</span><br><span class="line">   --no-sync                        don&#x27;t synchronize cluster information before sending request</span><br><span class="line">   --output simple, -o simple       output response in the given format (simple, `extended` or `json`) (default: &quot;simple&quot;)</span><br><span class="line">   --discovery-srv value, -D value  domain name to query for SRV records describing cluster endpoints</span><br><span class="line">   --insecure-discovery             accept insecure SRV records describing cluster endpoints</span><br><span class="line">   --peers value, -C value          DEPRECATED - &quot;--endpoints&quot; should be used instead</span><br><span class="line">   --endpoint value                 DEPRECATED - &quot;--endpoints&quot; should be used instead</span><br><span class="line">   --endpoints value                a comma-delimited list of machine addresses in the cluster (default: &quot;http://127.0.0.1:2379,http://127.0.0.1:4001&quot;)</span><br><span class="line">   --cert-file value                identify HTTPS client using this SSL certificate file</span><br><span class="line">   --key-file value                 identify HTTPS client using this SSL key file</span><br><span class="line">   --ca-file value                  verify certificates of HTTPS-enabled servers using this CA bundle</span><br><span class="line">   --username value, -u value       provide username[:password] and prompt if password is not supplied.</span><br><span class="line">   --timeout value                  connection timeout per request (default: 2s)</span><br><span class="line">   --total-timeout value            timeout for the command execution (except watch) (default: 5s)</span><br><span class="line">   --help, -h                       show help</span><br><span class="line">   --version, -v                    print the version</span><br></pre></td></tr></table></figure>

<h5 id="常见操作"><a href="#常见操作" class="headerlink" title="常见操作"></a>常见操作</h5><ul>
<li>set 指定某个键的值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xxx ~]# etcdctl set t1 &quot;v1&quot;</span><br><span class="line">v1</span><br><span class="line">[root@xxx ~]# etcdctl ls /</span><br><span class="line">/t1</span><br></pre></td></tr></table></figure>

<ul>
<li>get获取指定键的值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xxx ~]# etcdctl get t1</span><br><span class="line">v1</span><br></pre></td></tr></table></figure>

<ul>
<li>rm&#x2F;rmdir  删除键</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@scm ~]# etcdctl rm t1</span><br><span class="line">PrevNode.Value: v1</span><br><span class="line">[root@scm ~]# etcdctl get t1</span><br><span class="line">Error:  100: Key not found (/t1) [127844346]</span><br></pre></td></tr></table></figure>

<h3 id="网卡地址不在一个网段"><a href="#网卡地址不在一个网段" class="headerlink" title="网卡地址不在一个网段"></a>网卡地址不在一个网段</h3><p>在kubernetes集群中某些服务启动顺序是特定的，必须是先启动flannel然后再启动docker。</p>
<p>flannel服务启动时主要做了以下几步的工作：</p>
<ul>
<li>从etcd中获取network的配置信息；</li>
<li>划分subnet，并在etcd中进行注册；</li>
<li>将子网信息记录到&#x2F;run&#x2F;flannel&#x2F;subnet.env中。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@xxx ~]# cat /run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=10.100.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.100.28.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=false</span><br></pre></td></tr></table></figure>
<p>之后将会有一个脚本将subnet.env转写成一个docker的环境变量文件&#x2F;run&#x2F;flannel&#x2F;docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@xxx ~]# cat /run/flannel/docker</span><br><span class="line">DOCKER_OPT_BIP=&quot;--bip=10.100.28.1/24&quot;</span><br><span class="line">DOCKER_OPT_IPMASQ=&quot;--ip-masq=true&quot;</span><br><span class="line">DOCKER_OPT_MTU=&quot;--mtu=1450&quot;</span><br><span class="line">DOCKER_NETWORK_OPTIONS=&quot; --bip=10.100.28.1/24 --ip-masq=true --mtu=1450&quot;</span><br></pre></td></tr></table></figure>

<p>然后是Docker服务</p>
<p>Docker服务会根据flannel拿到的网段然后把pod启动在这些网段，这样kubernetes在寻址pod的时候就会找到相应的宿主机，进行通讯。如果Docker服务和Flannel服务没有这种关联关系的化，很可能Docker先用原来的ip段启动，而这个段并没有写到etcd中，导致寻址失败。</p>
<h3 id="kubernetes的高可用"><a href="#kubernetes的高可用" class="headerlink" title="kubernetes的高可用"></a>kubernetes的高可用</h3><p>首先简单介绍一下常见的负载均衡类型，主要分为两类：四层和七层。<br>四层负载均衡是指负载均衡器用IP+Port的方式接收请求，再直接转发到后端对应的服务器上。工作在传输层。客户端和服务器之间建立一次TCP连接，而负载均衡设备至少起类似路由器的转发动作。常见的软件比如LVS。<br>七层负载均衡是根据虚拟的URL或者主机名来接收请求，经过处理后再转向响应的后端服务器上。工作在应用层，且建立两次连接。</p>
<ul>
<li>客户端到负载均衡器，负载均衡根据消息中的内容来做出负载均衡的决定；</li>
<li>然后建立负载均衡器到后端服务器的连接；</li>
</ul>
<p>负载均衡器需要先代理最终的服务器和客户端建立TCP连接后，才可能接收到客户端发送的真正应用层内容的保温，再根据报文中的特定字段，再加上负载均衡设备的服务器选择方式，决定最终选的服务器。常见的软件比如NGINX。</p>
<p>kubernetes部署架构</p>
<img src="https://img.mknight.cn/medivh/1630476462885.png"  />

<p>kubernetes集群的高可用实际是各个核心组件的高可用。<br><img src="https://img.mknight.cn/medivh/1630476228212.png"  /></p>
<ul>
<li>apiserver 通过 keepalived+haproxy 实现高可用，当某个节点故障时触发 keepalived vip 转移，haproxy 负责将流量负载到 apiserver 节点；</li>
<li>controller-manager k8s 内部通过选举方式产生领导者(由 –leader-elect 选型控制，默认为 true)，同一时刻集群内只有一个 controller-manager 组件运行，其余处于 backup 状态；</li>
<li>scheduler k8s 内部通过选举方式产生领导者(由 –leader-elect 选型控制，默认为 true)，同一时刻集群内只有一个scheduler组件运行，其余处于 backup 状态；</li>
<li>etcd 通过运行 kubeadm 方式自动创建集群来实现高可用，部署的节点数为奇数，3节点方式最多容忍一台机器宕机。</li>
</ul>
<p>多节点的核心点就是需要指向一个核心的地址或者VIP。node请求apiserver时不时直接指向master服务器，而是通过一个虚拟地址来分发到某个master。</p>
<h4 id="常规高可用"><a href="#常规高可用" class="headerlink" title="常规高可用"></a>常规高可用</h4><p>方案一、</p>
<ul>
<li>haproxy，提供高可用性，负载均衡，基于 TCP 和 HTTP 的代理，支持数以万记的并发连接</li>
<li>keepalived，是以 VRRP(虚拟路由冗余协议)协议为基础, 包括一个 master 和多个 backup。 master 劫持 vip 对外提供服务。master 发送组播，backup 节点收不到 vrrp 包时认为 master 宕机，此时选出剩余优先级最高的节点作为新的 master, 劫持 vip。keepalived 是保证高可用的重要组件。</li>
</ul>
<p>haproxy 提供代理后端apiserver的功能，keepalived提供健康检查和切换IP的用途。</p>
<p>方案二、</p>
<ul>
<li>nginx</li>
<li>keepalived</li>
</ul>
<p>该方案和方案一类似，也是使用代理功能，只不过使用的是NGINX提供的四层转发。</p>
<h4 id="阿里云环境的负载均衡"><a href="#阿里云环境的负载均衡" class="headerlink" title="阿里云环境的负载均衡"></a>阿里云环境的负载均衡</h4><p>阿里云云服务器不支持再单独购买 IP，无法安装配置 keepalived，进行负载均衡。如果需要配置负载均衡，可以直接购买负载均衡，进行负载均衡配置。这样就可以省略代理和keepalived的配置，只需要使用slb即可，注意后端服务指向的是master的apiserver的地址和端口。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/H3C%20wap712c%20Fit%20to%20Fat.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/H3C%20wap712c%20Fit%20to%20Fat.html" class="post-title-link" itemprop="url">H3C wap712c Fit to Fat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>fat转fit简单，直接在web界面操作即可。但是fit转fat就困难多了。</p>
</blockquote>
<h2 id="TFTP服务器"><a href="#TFTP服务器" class="headerlink" title="TFTP服务器"></a>TFTP服务器</h2><p>MAC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">brew install tftp</span><br><span class="line"></span><br><span class="line">chmod -R 777 /private/tftpboot</span><br><span class="line">#/private/tftpboot是默认路径，需要改变其读写权限(非常重要)</span><br><span class="line">#开启</span><br><span class="line">sudo launchctl load -F /System/Library/LaunchDaemons/tftp.plist</span><br><span class="line">sudo launchctl start com.apple.tftpd</span><br><span class="line"></span><br><span class="line">#关闭</span><br><span class="line">sudo launchctl unload -F /System/Library/LaunchDaemons/tftp.plist</span><br><span class="line">sudo launchctl stop com.apple.tftpd</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">***:~ ***$ tftp</span><br><span class="line">tftp&gt; connect localhost</span><br><span class="line">tftp&gt; status</span><br><span class="line">Connected to localhost.</span><br><span class="line">Mode: netascii Verbose: off Tracing: off</span><br><span class="line">Rexmt-interval: 5 seconds, Max-timeout: 25 seconds</span><br><span class="line">tftp&gt; verbose</span><br><span class="line">Verbose mode on.</span><br><span class="line">tftp&gt; get 1.txt</span><br><span class="line">getting from localhost:1.txt to 1.txt [netascii]</span><br><span class="line">Received 9 bytes in 0.0 seconds [inf bits/sec]</span><br><span class="line">tftp&gt; quit</span><br></pre></td></tr></table></figure>
<p>准备固件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://img.mknight.cn/network/apwtu430_v1.06.btw</span><br><span class="line">wget https://img.mknight.cn/network/wa4300s_fat.bin</span><br></pre></td></tr></table></figure>
<h2 id="版本降级"><a href="#版本降级" class="headerlink" title="版本降级"></a>版本降级</h2><ul>
<li><p>检查设备信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;H3C&gt;display device manuinfo</span><br><span class="line">DEVICE_NAME:WAP712C</span><br><span class="line">DEVICE_SERIAL_NUMBER:2198  01A0 X491 7CG0 04F8</span><br><span class="line">MAC_ADDRESS:307B-ACB2-5800</span><br><span class="line">MANUFACTURING_DATE:2017-12-20</span><br><span class="line">VENDOR_NAME:H3C</span><br></pre></td></tr></table></figure></li>
<li><p>开机启动检查软件版本信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">System is starting...</span><br><span class="line"></span><br><span class="line">Press Ctrl+D to access BASIC-BOOTWARE MENU</span><br><span class="line"></span><br><span class="line">Booting Normal Extended BootWare</span><br><span class="line"></span><br><span class="line">The Extended BootWare is self-decompressing.................................</span><br><span class="line"></span><br><span class="line">...Done.  </span><br><span class="line"></span><br><span class="line">****************************************************************************</span><br><span class="line"></span><br><span class="line">*                                                                          *</span><br><span class="line"></span><br><span class="line">*                   H3C WA5530 BootWare, Version 7.09                      *</span><br><span class="line"></span><br><span class="line">*                                                                          *</span><br><span class="line"></span><br><span class="line">****************************************************************************</span><br><span class="line"></span><br><span class="line">Copyright (c) 2004-2017 New H3C Technologies Co., Ltd.</span><br></pre></td></tr></table></figure>
<p>注意此处的BootWare版本为7.09，要切换Fat模式必须降级。</p>
</li>
<li><p>降级</p>
</li>
</ul>
<p>第一步 格式化文件系统 Control + F</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">==========================&lt;EXTENDED-BOOTWARE MENU&gt;=============</span><br><span class="line"></span><br><span class="line">|&lt;1&gt; Boot System                                                           |</span><br><span class="line"></span><br><span class="line">|&lt;2&gt; Enter Serial SubMenu                                                  |</span><br><span class="line"></span><br><span class="line">|&lt;3&gt; Enter Ethernet SubMenu                                                |</span><br><span class="line"></span><br><span class="line">|&lt;4&gt; File Control                                                          |</span><br><span class="line"></span><br><span class="line">|&lt;5&gt; Restore to Factory Default Configuration                              |</span><br><span class="line"></span><br><span class="line">|&lt;6&gt; Skip Current System Configuration                                     |</span><br><span class="line"></span><br><span class="line">|&lt;7&gt; BootWare Operation Menu                                               |</span><br><span class="line"></span><br><span class="line">|&lt;8&gt; Skip Authentication for Console Login                                 |</span><br><span class="line"></span><br><span class="line">|&lt;9&gt; Storage Device Operation                                              |</span><br><span class="line"></span><br><span class="line">|&lt;0&gt; Reboot                                                                |</span><br></pre></td></tr></table></figure>
<p>第二步：进入V7boot 通过网卡口，传入V6 AP bin文件，提示更新boot版本的时候选择Y</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">进入V7boot 通过网卡口，传入V6 AP bin文件，提示更新boot版本的时候选择Y</span><br><span class="line"></span><br><span class="line">Enter your choice(0-5): 5</span><br><span class="line"></span><br><span class="line">==========================&lt;ETHERNET PARAMETER SET&gt;==========================</span><br><span class="line">|Note:       &#x27;.&#x27; = Clear field.                                            |</span><br><span class="line">|            &#x27;-&#x27; = Go to previous field.                                   |</span><br><span class="line">|         Ctrl+D = Quit.                                                   |</span><br><span class="line">============================================================================</span><br><span class="line">Protocol (FTP or TFTP) :tftp</span><br><span class="line">Load File Name         :apwtu430_v1.06.btw</span><br><span class="line">                       :</span><br><span class="line">Target File Name       :apwtu430_v1.06.btw</span><br><span class="line">                       :</span><br><span class="line">Server IP Address      :192.168.21.1</span><br><span class="line">Local IP Address       :192.168.21.2</span><br><span class="line">Subnet Mask            :255.255.255.0</span><br><span class="line">Gateway IP Address     :0.0.0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>第三步：导入V6 AP版本</p>
<p>简单来说和之前的部分一样，tftp导入</p>
<p>第四步：重启，降级完成</p>
<h2 id="切换模式"><a href="#切换模式" class="headerlink" title="切换模式"></a>切换模式</h2><p>重启完成后，展示以下界面，可以选择FAT模式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">| &lt;1&gt; Display Current Device Model                          |</span><br><span class="line"></span><br><span class="line">| &lt;2&gt; Set The Device Into FIT AP Model                      |</span><br><span class="line"></span><br><span class="line">| &lt;3&gt; Set The Device Into FAT AP Model                      |</span><br><span class="line"></span><br><span class="line">| &lt;0&gt; Exit To Main Menu     </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://kms2.h3c.com/View.aspx?id=57788">http://kms2.h3c.com/View.aspx?id=57788</a></p>
<ul>
<li>h3c 公共账号 yx800&#x2F;01230123</li>
<li><a target="_blank" rel="noopener" href="https://img.mknight.cn/network/wa4300s_fit.bin">https://img.mknight.cn/network/wa4300s_fit.bin</a></li>
</ul>
<p>降级boot<br><img src="https://img.mknight.cn/medivh/1561364179876.png"  /><br>重启，再次格式化<br>切换模式，导入fat镜像文件</p>
<img src="https://img.mknight.cn/medivh/1561362961838.png"  />


<p>初始化ip</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
