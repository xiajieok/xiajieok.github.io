<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.mknight.cn/2018/1545104669394.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"econow.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Medivh&#39;s castle">
<meta property="og:url" content="https://econow.cn/page/3/index.html">
<meta property="og:site_name" content="Medivh&#39;s castle">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="medivh">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://econow.cn/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Medivh's castle</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Medivh's castle</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">数据蜘蛛工作室</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">medivh</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E4%BD%BF%E7%94%A8Python%20smtplib%20%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%BD%BF%E7%94%A8Python%20smtplib%20%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6.html" class="post-title-link" itemprop="url">使用Python smtplib 发送邮件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>SMTP是发送邮件的协议，Python内置对SMTP的支持，可以发送纯文本邮件、HTML邮件以及带附件的邮件。<br>Python对SMTP支持有smtplib和email两个模块，email负责构造邮件，smtplib负责发送邮件。</p>
<h3 id="sample-1-发送文本邮件"><a href="#sample-1-发送文本邮件" class="headerlink" title="sample 1.发送文本邮件"></a>sample 1.发送文本邮件</h3><h4 id="构造MIMEText"><a href="#构造MIMEText" class="headerlink" title="构造MIMEText"></a>构造MIMEText</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">msg = MIMEText(&#x27;hello, send by Python...&#x27;, &#x27;plain&#x27;, &#x27;utf-8&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意到构造MIMEText对象时，第一个参数就是邮件正文，第二个参数是MIME的subtype，传入’plain’表示纯文本，最终的MIME就是’text&#x2F;plain’，最后一定要用utf-8编码保证多语言兼容性。</p>
<h4 id="使用smtp发送"><a href="#使用smtp发送" class="headerlink" title="使用smtp发送"></a>使用smtp发送</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 输入Email地址和口令:</span><br><span class="line">from_addr = xxx@x.com</span><br><span class="line">password = xxxxxxx</span><br><span class="line"># 输入收件人地址:</span><br><span class="line">to_addr = xxx@xx.com</span><br><span class="line"># 输入SMTP服务器地址，以QQ企业邮箱为例</span><br><span class="line">smtp_server = smtp.exmail.qq.com</span><br><span class="line">def _format_addr(s):</span><br><span class="line">    name, addr = parseaddr(s)</span><br><span class="line">    return formataddr((Header(name, &#x27;utf-8&#x27;).encode(), addr))</span><br><span class="line"></span><br><span class="line">msg = MIMEText(&#x27;hello, send by Python...&#x27;, &#x27;plain&#x27;, &#x27;utf-8&#x27;)</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Cc&#x27;] = _format_addr(&#x27;其他成员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line"></span><br><span class="line">server = smtplib.SMTP_SSL(smtp_server, 465)  # SMTP SSL协议默认端口是465，注意使用SMTP_SSL</span><br><span class="line">#server = smtplib.SMTP(smtp_server, 25)  # 25端口的话注意使用SMTP</span><br><span class="line">server.set_debuglevel(1)</span><br><span class="line">try:</span><br><span class="line">    server.login(from_addr, password)</span><br><span class="line">    print(&#x27;ok&#x27;)</span><br><span class="line">    server.sendmail(from_addr, [to_addr], msg.as_string())</span><br><span class="line">    server.quit()</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>编写了一个函数<code>_format_addr()</code>来格式化一个邮件地址。注意不能简单地传入<code>name &lt;addr@example.com&gt;</code>，因为如果包含中文，需要通过<code>Header</code>对象进行编码。<code>msg[&#39;To&#39;]</code>接收的是字符串而不是<code>list</code>，如果有多个邮件地址，用,分隔即可。</p>
</li>
<li><p>用<code>set_debuglevel(1)</code>就可以打印出和SMTP服务器交互的所有信息。SMTP协议就是简单的文本命令和响应。<code>login()</code>方法用来登录SMTP服务器，<code>sendmail()</code>方法就是发邮件，由于可以一次发给多个人，所以传入一个<code>list</code>，邮件正文是一个<code>str</code>，<code>as_string()</code>把<code>MIMEText</code>对象变成<code>str</code>。</p>
</li>
<li><p><code>From</code>:发件人</p>
</li>
<li><p><code>To</code>:收件人</p>
</li>
<li><p><code>Cc</code>:抄送人</p>
</li>
<li><p><code>Subject</code>：主题</p>
</li>
<li><p>此处必须注意<code>smtplib.SMTP_SSL</code>和<code>smtplib.SMTP</code>的区分，否则会报错提示连接失败。</p>
</li>
</ul>
<p>这样我们就收到了一封测试邮件。</p>
<img src="https://img.mknight.cn/medivh/1550985997669.png" />

<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!usr/bin/env python</span><br><span class="line"># -*- coding:utf-8 _*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">@author:medivh</span><br><span class="line">@file: ex_send_mail.py</span><br><span class="line">@time: 2019/02/24</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import smtplib</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">from email import encoders</span><br><span class="line">from email.header import Header</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">from email.utils import parseaddr, formataddr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def _format_addr(s):</span><br><span class="line">    name, addr = parseaddr(s)</span><br><span class="line">    return formataddr((Header(name, &#x27;utf-8&#x27;).encode(), addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 输入Email地址和口令:</span><br><span class="line">from_addr = xxx@x.com</span><br><span class="line">password = xxxxxxx</span><br><span class="line"># 输入收件人地址:</span><br><span class="line">to_addr = xxx@xx.com</span><br><span class="line"># 输入SMTP服务器地址，以QQ企业邮箱为例</span><br><span class="line">smtp_server = smtp.exmail.qq.com</span><br><span class="line"></span><br><span class="line">msg = MIMEText(&#x27;hello, send by Python...&#x27;, &#x27;plain&#x27;, &#x27;utf-8&#x27;)</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Cc&#x27;] = _format_addr(&#x27;其他成员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line"></span><br><span class="line">server = smtplib.SMTP_SSL(smtp_server, 465)  # SMTP SSL协议默认端口是465，注意使用SMTP_SSL</span><br><span class="line">#server = smtplib.SMTP(smtp_server, 25)  # 25端口的话注意使用SMTP</span><br><span class="line">server.set_debuglevel(1)</span><br><span class="line">try:</span><br><span class="line">    server.login(from_addr, password)</span><br><span class="line">    print(&#x27;ok&#x27;)</span><br><span class="line">    server.sendmail(from_addr, [to_addr], msg.as_string())</span><br><span class="line">    server.quit()</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="samele-2-附件邮件"><a href="#samele-2-附件邮件" class="headerlink" title="samele 2.附件邮件"></a>samele 2.附件邮件</h3><p>如果Email中要加上附件怎么办？带附件的邮件可以看做包含若干部分的邮件：文本和各个附件本身，所以，可以构造一个MIMEMultipart对象代表邮件本身，然后往里面加上一个MIMEText作为邮件正文，再继续往里面加上表示附件的MIMEBase对象即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 邮件对象:</span><br><span class="line">msg = MIMEMultipart()</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line">msg_text = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; + &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.mknight.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; + &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span><br><span class="line">msg.attach(MIMEText(msg, &#x27;html&#x27;, &#x27;utf-8&#x27;))</span><br><span class="line"></span><br><span class="line"># 添加附件就是加上一个MIMEBase，从本地读取一个图片:</span><br><span class="line">with open(&#x27;./hi.png&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">    # 设置附件的MIME和文件名，这里是png类型:</span><br><span class="line">    FileApart = MIMEApplication(f.read())</span><br><span class="line">    FileApart.add_header(&#x27;Content-Disposition&#x27;, &#x27;attachment&#x27;, filename=&#x27;hi.png&#x27;)</span><br><span class="line">    msg.attach(FileApart)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="https://img.mknight.cn/medivh/1550987252487.png" />

<h3 id="sample-3-html-邮件"><a href="#sample-3-html-邮件" class="headerlink" title="sample 3.html 邮件"></a>sample 3.html 邮件</h3><p>在构造MIMEText对象时，把HTML字符串传进去，再把第二个参数由plain变为html就可以了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">msg = MIMEText(&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; +</span><br><span class="line">    &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.mknight.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; +</span><br><span class="line">    &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;, &#x27;html&#x27;, &#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1550986154659.png" />
### samele 3.图片邮件
要把图片嵌入到邮件正文中，我们只需按照发送附件的方式，先把邮件作为附件添加进去，然后，在HTML中通过引用src="cid:0"就可以把附件作为图片嵌入了。如果有多个图片，给它们依次编号，然后引用不同的cid:x即可。
事实上，无论图片还是音频文件,使用方式都是一样的。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msgText = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; + &#x27;&lt;p&gt;&lt;img src=&quot;cid:0&quot;&gt;&lt;/p&gt;&#x27; + &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.mknight.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; + &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span><br><span class="line"></span><br><span class="line"># 添加附件就是加上一个MIMEImage，从本地读取一个图片:</span><br><span class="line">with open(&#x27;./hi.png&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">    # 设置附件的MIME和文件名，这里是png类型:</span><br><span class="line">    FileApart = MIMEImage(f.read())</span><br><span class="line">    FileApart.add_header(&#x27;Content-ID&#x27;, &#x27;&lt;0&gt;&#x27;)</span><br><span class="line">    msg.attach(FileApart)</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1550988329662.png" />

<p>全部代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#!usr/bin/env python</span><br><span class="line"># -*- coding:utf-8 _*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">@author:medivh</span><br><span class="line">@file: ex_send_mail.py</span><br><span class="line">@time: 2019/02/24</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import smtplib</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">from email.mime.multipart import MIMEMultipart</span><br><span class="line">from email.mime.application import MIMEApplication</span><br><span class="line">from email.mime.image import MIMEImage</span><br><span class="line">from email.header import Header</span><br><span class="line">from email.utils import parseaddr, formataddr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def _format_addr(s):</span><br><span class="line">    name, addr = parseaddr(s)</span><br><span class="line">    return formataddr((Header(name, &#x27;utf-8&#x27;).encode(), addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 输入Email地址和口令:</span><br><span class="line">from_addr = xxx@x.com</span><br><span class="line">password = xxxx</span><br><span class="line"># 输入收件人地址:</span><br><span class="line">to_addr = xx@xx.com</span><br><span class="line"># 输入SMTP服务器地址，以QQ企业邮箱为例</span><br><span class="line">smtp_server = &#x27;smtp.exmail.qq.com&#x27;</span><br><span class="line"></span><br><span class="line">msg = MIMEMultipart()</span><br><span class="line">msg[&#x27;From&#x27;] = _format_addr(&#x27;Python爱好者 &lt;%s&gt;&#x27; % from_addr)</span><br><span class="line">msg[&#x27;To&#x27;] = _format_addr(&#x27;管理员 &lt;%s&gt;&#x27; % to_addr)</span><br><span class="line">msg[&#x27;Subject&#x27;] = Header(&#x27;来自SMTP的问候……&#x27;, &#x27;utf-8&#x27;).encode()</span><br><span class="line">msgText = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&#x27; + &#x27;&lt;p&gt;&lt;img src=&quot;cid:0&quot;&gt;&lt;/p&gt;&#x27; + &#x27;&lt;p&gt;send by &lt;a href=&quot;http://www.mknight.cn&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&#x27; + &#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span><br><span class="line">msg.attach(MIMEText(msgText, &#x27;html&#x27;, &#x27;utf-8&#x27;))</span><br><span class="line"># 添加附件就是加上一个MIMEImage，从本地读取一个图片:</span><br><span class="line">with open(&#x27;./hi.png&#x27;, &#x27;rb&#x27;) as f:</span><br><span class="line">    # 设置附件的MIME和文件名，这里是png类型:</span><br><span class="line">    FileApart = MIMEImage(f.read())</span><br><span class="line">    FileApart.add_header(&#x27;Content-ID&#x27;, &#x27;&lt;0&gt;&#x27;)</span><br><span class="line">    msg.attach(FileApart)</span><br><span class="line"></span><br><span class="line">server = smtplib.SMTP_SSL(smtp_server, 465)  # SMTP SSL协议默认端口是465，注意使用SMTP_SSL</span><br><span class="line">server.set_debuglevel(3)</span><br><span class="line">try:</span><br><span class="line">    server.login(from_addr, password)</span><br><span class="line">    server.sendmail(from_addr, [to_addr], msg.as_string())</span><br><span class="line">    server.quit()</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="MIME-类型"><a href="#MIME-类型" class="headerlink" title="MIME 类型"></a>MIME 类型</h3><h4 id="通用类型"><a href="#通用类型" class="headerlink" title="通用类型"></a>通用类型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class email.mime.application.MIMEApplication(_data, _subtype=&#x27;octet-stream&#x27;, _encoder=email.encoders.encode_base64, *, policy=compat32, **_params)</span><br><span class="line">Module: email.mime.application</span><br><span class="line"></span><br><span class="line">    A subclass of MIMENonMultipart, the MIMEApplication class is used to represent MIME message objects of major type application. _data is a string containing the raw byte data. Optional _subtype specifies the MIME subtype and defaults to octet-stream.</span><br><span class="line"></span><br><span class="line">    Optional _encoder is a callable (i.e. function) which will perform the actual encoding of the data for transport. This callable takes one argument, which is the MIMEApplication instance. It should use get_payload() and set_payload() to change the payload to encoded form. It should also add any Content-Transfer-Encoding or other headers to the message object as necessary. The default encoding is base64. See the email.encoders module for a list of the built-in encoders.</span><br><span class="line"></span><br><span class="line">    Optional policy argument defaults to compat32.</span><br><span class="line"></span><br><span class="line">    _params are passed straight through to the base class constructor.</span><br><span class="line"></span><br><span class="line">    Changed in version 3.6: Added policy keyword-only parameter.</span><br></pre></td></tr></table></figure>
<h4 id="音频类型"><a href="#音频类型" class="headerlink" title="音频类型"></a>音频类型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class email.mime.audio.MIMEAudio(_audiodata, _subtype=None, _encoder=email.encoders.encode_base64, *, policy=compat32, **_params)¶</span><br><span class="line">    Module: email.mime.audio</span><br><span class="line"></span><br><span class="line">    A subclass of MIMENonMultipart, the MIMEAudio class is used to create MIME message objects of major type audio. _audiodata is a string containing the raw audio data. If this data can be decoded by the standard Python module sndhdr, then the subtype will be automatically included in the Content-Type header. Otherwise you can explicitly specify the audio subtype via the _subtype argument. If the minor type could not be guessed and _subtype was not given, then TypeError is raised.</span><br><span class="line"></span><br><span class="line">    Optional _encoder is a callable (i.e. function) which will perform the actual encoding of the audio data for transport. This callable takes one argument, which is the MIMEAudio instance. It should use get_payload() and set_payload() to change the payload to encoded form. It should also add any Content-Transfer-Encoding or other headers to the message object as necessary. The default encoding is base64. See the email.encoders module for a list of the built-in encoders.</span><br><span class="line"></span><br><span class="line">    Optional policy argument defaults to compat32.</span><br><span class="line"></span><br><span class="line">    _params are passed straight through to the base class constructor.</span><br><span class="line"></span><br><span class="line">    Changed in version 3.6: Added policy keyword-only parameter.</span><br></pre></td></tr></table></figure>
<h4 id="图片类型"><a href="#图片类型" class="headerlink" title="图片类型"></a>图片类型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class email.mime.image.MIMEImage(_imagedata, _subtype=None, _encoder=email.encoders.encode_base64, *, policy=compat32, **_params)</span><br><span class="line">    Module: email.mime.image</span><br><span class="line"></span><br><span class="line">    A subclass of MIMENonMultipart, the MIMEImage class is used to create MIME message objects of major type image. _imagedata is a string containing the raw image data. If this data can be decoded by the standard Python module imghdr, then the subtype will be automatically included in the Content-Type header. Otherwise you can explicitly specify the image subtype via the _subtype argument. If the minor type could not be guessed and _subtype was not given, then TypeError is raised.</span><br><span class="line"></span><br><span class="line">    Optional _encoder is a callable (i.e. function) which will perform the actual encoding of the image data for transport. This callable takes one argument, which is the MIMEImage instance. It should use get_payload() and set_payload() to change the payload to encoded form. It should also add any Content-Transfer-Encoding or other headers to the message object as necessary. The default encoding is base64. See the email.encoders module for a list of the built-in encoders.</span><br><span class="line"></span><br><span class="line">    Optional policy argument defaults to compat32.</span><br><span class="line"></span><br><span class="line">    _params are passed straight through to the MIMEBase constructor.</span><br><span class="line"></span><br><span class="line">    Changed in version 3.6: Added policy keyword-only parameter.</span><br></pre></td></tr></table></figure>
<p>综上所述，如果想不起来啥类型就使用<code>MIMEApplication</code>。</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/email.mime.html">https://docs.python.org/3/library/email.mime.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Mac%E9%83%A8%E5%88%86%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Mac%E9%83%A8%E5%88%86%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93.html" class="post-title-link" itemprop="url">Mac 技巧</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="查看中文字体"><a href="#查看中文字体" class="headerlink" title="查看中文字体"></a>查看中文字体</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew  install fontconfig</span><br><span class="line">fc-list :lang=zh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Python%E6%89%B9%E9%87%8F%E8%BD%AC%E6%8D%A2HTML%E4%B8%BAPDF.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Python%E6%89%B9%E9%87%8F%E8%BD%AC%E6%8D%A2HTML%E4%B8%BAPDF.html" class="post-title-link" itemprop="url">Python批量转换HTML为PDF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="wkhtmltopdf"><a href="#wkhtmltopdf" class="headerlink" title="wkhtmltopdf"></a>wkhtmltopdf</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>wkhtmltopdf and wkhtmltoimage are open source (LGPLv3) command line tools to render HTML into PDF and various image formats using the Qt WebKit rendering engine. These run entirely “headless” and do not require a display or display service.  </p>
</blockquote>
<p>wkhtmltopdf 和 wkhtmltoimage是一个开元的命令行工具，用来转换html为pdf和各种图像格式。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://wkhtmltopdf.org/downloads.html">https://wkhtmltopdf.org/downloads.html</a><br>mac的话可以直接安装了，其他系统就看着办吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install Caskroom/cask/wkhtmltopdf</span><br></pre></td></tr></table></figure>

<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><ul>
<li>Download a precompiled binary or build from source</li>
<li>Create your HTML document that you want to turn into a PDF (or image)</li>
<li>Run your HTML document through the tool.</li>
<li>For example, if I really like the treatment Google has done to their logo today and want to capture it forever as a PDF:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wkhtmltopdf http://google.com google.pdf</span><br></pre></td></tr></table></figure>
下载安装-》创建HTML文件-》命令行执行</li>
</ul>
<h2 id="Pdfkit"><a href="#Pdfkit" class="headerlink" title="Pdfkit"></a>Pdfkit</h2><p>A JavaScript PDF generation library for Node and the browser.</p>
<h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>PDFKit is a PDF document generation library for Node and the browser that makes creating complex, multi-page, printable documents easy. It’s written in CoffeeScript, but you can choose to use the API in plain ‘ol JavaScript if you like. The API embraces chainability, and includes both low level functions as well as abstractions for higher level functionality. The PDFKit API is designed to be simple, so generating complex documents is often as simple as a few function calls.</p>
</blockquote>
<p>pdfkit 是 wkhtmltopdf 的Python封装包。</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install pdfkit</span><br><span class="line">or </span><br><span class="line">pip install pdfkit</span><br></pre></td></tr></table></figure>
<h3 id="支持模块"><a href="#支持模块" class="headerlink" title="支持模块"></a>支持模块</h3><img src="https://img.mknight.cn/medivh/1545302451080.png" /> 

<p>支持以下方式：</p>
<ul>
<li>URL</li>
<li>文件</li>
<li>字符串</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pdfkit.from_url(&#x27;https://www.google.com.hk&#x27;,&#x27;out1.pdf&#x27;)   </span><br><span class="line">pdfkit.from_file(&#x27;123.html&#x27;,&#x27;out2.pdf&#x27;)  </span><br><span class="line">pdfkit.from_string(&#x27;Hello!&#x27;,&#x27;out3.pdf&#x27;)</span><br></pre></td></tr></table></figure>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!usr/bin/env python</span><br><span class="line"># -*- coding:utf-8 _*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">@author:medivh</span><br><span class="line">@file: html_to_pdf.py</span><br><span class="line">@time: 2018/12/20</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import pdfkit</span><br><span class="line">import os</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">src = &#x27;/Users/medivh/Downloads/tmp/new/&#x27;</span><br><span class="line">desc = &#x27;/Users/medivh/Downloads/tmp/new-pdf/&#x27;</span><br><span class="line"># read file path and destination path</span><br><span class="line">sem = threading.Semaphore(10)</span><br><span class="line">#控制线程数量</span><br><span class="line">try:</span><br><span class="line">    os.mkdir(desc)</span><br><span class="line">except:</span><br><span class="line">    pass</span><br><span class="line">def ToPdf(filename):</span><br><span class="line">    with  sem:</span><br><span class="line">        try:</span><br><span class="line">            with open(src + filename, encoding=&quot;utf-8&quot;) as f:</span><br><span class="line">                pdf_name = desc + filename[:-6] + &#x27;.pdf&#x27;</span><br><span class="line">                #拼接文件名</span><br><span class="line">                pdfkit.from_file(f, pdf_name)</span><br><span class="line">        except:</span><br><span class="line">            print(filename)</span><br><span class="line"></span><br><span class="line">threads = list()</span><br><span class="line">for i in os.listdir(src):</span><br><span class="line">    t = threading.Thread(target=ToPdf, args=(i,))</span><br><span class="line">    threads.append(t)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    for t in threads:</span><br><span class="line">        t.setDaemon(True)</span><br><span class="line">        t.start()</span><br><span class="line">    for t in threads:</span><br><span class="line">        t.join()</span><br><span class="line">    start = len(os.listdir(src))</span><br><span class="line">    end = len(os.listdir(desc))</span><br><span class="line">    print(start,end)</span><br><span class="line">    if start == end:</span><br><span class="line">        print(&#x27;ok&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        print(&#x27;no&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><ul>
<li><code>&#39;ascii&#39; codec can&#39;t decode byte 0xb4 in position 11: ordinal not in range(128）</code><ul>
<li>解决：加上encoding,<code>with open(src + filename, encoding=&quot;utf-8&quot;)</code></li>
</ul>
</li>
<li>注意文件数量，否则数量太大而且没设置线程数的话机器会卡死<ul>
<li>解决：使用<code>threading.Semaphore(10)</code></li>
</ul>
</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="http://pdfkit.org/">http://pdfkit.org/</a><br><a target="_blank" rel="noopener" href="https://wkhtmltopdf.org/index.html">https://wkhtmltopdf.org/index.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/kubernetes%E6%9C%80%E6%96%B0%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/kubernetes%E6%9C%80%E6%96%B0%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3.html" class="post-title-link" itemprop="url">kubernetes最新部署文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" itemprop="url" rel="index"><span itemprop="name">云原生</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>CentOS</p>
<p>Caution: This guide was originally written for Kubernetes 1.1.0 and is deprecated and is replaced by kubeadm.<br>Prerequisites</p>
<p>To configure Kubernetes with CentOS, you’ll need a machine to act as a master, and one or more CentOS 7 hosts to act as cluster nodes.<br>Starting a clusteru</p>
<p>This is a getting started guide for CentOS. It is a manual configuration so you understand all the underlying packages &#x2F; services &#x2F; ports, etc…<br>The Kubernetes package provides a few services: kube-apiserver, kube-scheduler, kube-controller-manager, kubelet, kube-proxy. These services are managed by systemd and the configuration resides in a central location: &#x2F;etc&#x2F;kubernetes. We will break the services up between the hosts. The first host, centos-master, will be the Kubernetes master. This host will run the kube-apiserver, kube-controller-manager and kube-scheduler. In addition, the master will also run etcd. The remaining hosts, centos-minion-n will be the nodes and run kubelet, proxy, cadvisor and docker.<br>All of them run flanneld as networking overlay.<br>System Information:<br>Hosts:<br>Please replace host IP with your environment.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">centos-master = 192.168.121.9</span><br><span class="line">centos-minion-1 = 192.168.121.65</span><br><span class="line">centos-minion-2 = 192.168.121.66</span><br><span class="line">centos-minion-3 = 192.168.121.67</span><br></pre></td></tr></table></figure>
<p>Prepare the hosts:</p>
<ul>
<li>Create a &#x2F;etc&#x2F;yum.repos.d&#x2F;virt7-docker-common-release.repo on all hosts - centos-{master,minion-n} with following information.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[virt7-docker-common-release]</span><br><span class="line">name=virt7-docker-common-release</span><br><span class="line">baseurl=http://cbs.centos.org/repos/virt7-docker-common-release/x86_64/os/</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure></li>
<li>Install Kubernetes, etcd and flannel on all hosts - centos-{master,minion-n}. This will also pull in docker and cadvisor.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install --enablerepo=virt7-docker-common-release kubernetes etcd flannel</span><br></pre></td></tr></table></figure></li>
<li>Add master and node to &#x2F;etc&#x2F;hosts on all machines (not needed if hostnames already in DNS)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;192.168.121.9    centos-master</span><br><span class="line">192.168.121.65    centos-minion-1</span><br><span class="line">192.168.121.66  centos-minion-2</span><br><span class="line">192.168.121.67  centos-minion-3&quot; &gt;&gt; /etc/hosts</span><br><span class="line">```  </span><br><span class="line">* Edit /etc/kubernetes/config which will be the same on all hosts to contain:</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="logging-to-stderr-means-we-get-it-in-the-systemd-journal"><a href="#logging-to-stderr-means-we-get-it-in-the-systemd-journal" class="headerlink" title="logging to stderr means we get it in the systemd journal"></a>logging to stderr means we get it in the systemd journal</h1><p>KUBE_LOGTOSTDERR&#x3D;”–logtostderr&#x3D;true”</p>
<h1 id="journal-message-level-0-is-debug"><a href="#journal-message-level-0-is-debug" class="headerlink" title="journal message level, 0 is debug"></a>journal message level, 0 is debug</h1><p>KUBE_LOG_LEVEL&#x3D;”–v&#x3D;0”</p>
<h1 id="Should-this-cluster-be-allowed-to-run-privileged-docker-containers"><a href="#Should-this-cluster-be-allowed-to-run-privileged-docker-containers" class="headerlink" title="Should this cluster be allowed to run privileged docker containers"></a>Should this cluster be allowed to run privileged docker containers</h1><p>KUBE_ALLOW_PRIV&#x3D;”–allow-privileged&#x3D;false”</p>
<h1 id="How-the-replication-controller-and-scheduler-find-the-kube-apiserver"><a href="#How-the-replication-controller-and-scheduler-find-the-kube-apiserver" class="headerlink" title="How the replication controller and scheduler find the kube-apiserver"></a>How the replication controller and scheduler find the kube-apiserver</h1><p>KUBE_MASTER&#x3D;”–master&#x3D;<a target="_blank" rel="noopener" href="http://centos-master:8080/">http://centos-master:8080</a>“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* Disable the firewall on the master and all the nodes, as docker does not play well with other firewall rule managers. CentOS won’t let you disable the firewall as long as SELinux is enforcing, so that needs to be disabled first.</span><br><span class="line">* If you disable SELinux, make sure you reboot your machine before continuing to more steps.</span><br></pre></td></tr></table></figure>
<p>setenforce 0<br>systemctl disable iptables-services firewalld<br>systemctl stop iptables-services firewalld</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Configure the Kubernetes services on the master.</span><br><span class="line">* Edit /etc/etcd/etcd.conf to appear as such:</span><br></pre></td></tr></table></figure>
<h1 id="member"><a href="#member" class="headerlink" title="[member]"></a>[member]</h1><p>ETCD_NAME&#x3D;default<br>ETCD_DATA_DIR&#x3D;”&#x2F;var&#x2F;lib&#x2F;etcd&#x2F;default.etcd”<br>ETCD_LISTEN_CLIENT_URLS&#x3D;”<a target="_blank" rel="noopener" href="http://0.0.0.0:2379/">http://0.0.0.0:2379</a>“</p>
<p>#[cluster]<br>ETCD_ADVERTISE_CLIENT_URLS&#x3D;”<a target="_blank" rel="noopener" href="http://0.0.0.0:2379/">http://0.0.0.0:2379</a>“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* Edit /etc/kubernetes/apiserver to appear as such:</span><br></pre></td></tr></table></figure>
<h1 id="The-address-on-the-local-server-to-listen-to"><a href="#The-address-on-the-local-server-to-listen-to" class="headerlink" title="The address on the local server to listen to."></a>The address on the local server to listen to.</h1><p>KUBE_API_ADDRESS&#x3D;”–address&#x3D;0.0.0.0”</p>
<h1 id="The-port-on-the-local-server-to-listen-on"><a href="#The-port-on-the-local-server-to-listen-on" class="headerlink" title="The port on the local server to listen on."></a>The port on the local server to listen on.</h1><p>KUBE_API_PORT&#x3D;”–port&#x3D;8080”</p>
<h1 id="Port-kubelets-listen-on"><a href="#Port-kubelets-listen-on" class="headerlink" title="Port kubelets listen on"></a>Port kubelets listen on</h1><p>KUBELET_PORT&#x3D;”–kubelet-port&#x3D;10250”</p>
<h1 id="Comma-separated-list-of-nodes-in-the-etcd-cluster"><a href="#Comma-separated-list-of-nodes-in-the-etcd-cluster" class="headerlink" title="Comma separated list of nodes in the etcd cluster"></a>Comma separated list of nodes in the etcd cluster</h1><p>KUBE_ETCD_SERVERS&#x3D;”–etcd-servers&#x3D;<a target="_blank" rel="noopener" href="http://centos-master:2379/">http://centos-master:2379</a>“</p>
<h1 id="Address-range-to-use-for-services"><a href="#Address-range-to-use-for-services" class="headerlink" title="Address range to use for services"></a>Address range to use for services</h1><p>KUBE_SERVICE_ADDRESSES&#x3D;”–service-cluster-ip-range&#x3D;10.254.0.0&#x2F;16”</p>
<h1 id="Add-your-own"><a href="#Add-your-own" class="headerlink" title="Add your own!"></a>Add your own!</h1><p>KUBE_API_ARGS&#x3D;””</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* Start ETCD and configure it to hold the network overlay configuration on master: Warning This network must be unused in your network infrastructure! 172.30.0.0/16 is free in our network.</span><br></pre></td></tr></table></figure>
<p>systemctl start etcd<br>etcdctl mkdir &#x2F;kube-centos&#x2F;network<br>etcdctl mk &#x2F;kube-centos&#x2F;network&#x2F;config “{ &quot;Network&quot;: &quot;10.1.0.0&#x2F;16&quot;, &quot;SubnetLen&quot;: 24, &quot;Backend&quot;: { &quot;Type&quot;: &quot;vxlan&quot; } }”</p>
<ul>
<li>Configure flannel to overlay Docker network in &#x2F;etc&#x2F;sysconfig&#x2F;flanneld on the master (also in the nodes as we’ll see):<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"># Flanneld configuration options</span><br><span class="line"></span><br><span class="line"># etcd url location.  Point this to the server where etcd runs</span><br><span class="line">FLANNEL_ETCD_ENDPOINTS=&quot;http://centos-master:2379&quot;</span><br><span class="line"></span><br><span class="line"># etcd config key.  This is the configuration key that flannel queries</span><br><span class="line"># For address range assignment</span><br><span class="line">FLANNEL_ETCD_PREFIX=&quot;/kube-centos/network&quot;</span><br><span class="line"></span><br><span class="line"># Any additional options that you want to pass</span><br><span class="line">#FLANNEL_OPTIONS=&quot;&quot;</span><br></pre></td></tr></table></figure></li>
<li>Start the appropriate services on master:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for SERVICES in etcd kube-apiserver kube-controller-manager kube-scheduler flanneld; do</span><br><span class="line">    systemctl restart $SERVICES</span><br><span class="line">    systemctl enable $SERVICES</span><br><span class="line">    systemctl status $SERVICES</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
Configure the Kubernetes services on the nodes.<br>We need to configure the kubelet and start the kubelet and proxy</li>
<li>Edit &#x2F;etc&#x2F;kubernetes&#x2F;kubelet to appear as such:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># The address for the info server to serve on</span><br><span class="line">KUBELET_ADDRESS=&quot;--address=0.0.0.0&quot;</span><br><span class="line"></span><br><span class="line"># The port for the info server to serve on</span><br><span class="line">KUBELET_PORT=&quot;--port=10250&quot;</span><br><span class="line"></span><br><span class="line"># You may leave this blank to use the actual hostname</span><br><span class="line"># Check the node number!</span><br><span class="line">KUBELET_HOSTNAME=&quot;--hostname-override=centos-minion-n&quot;</span><br><span class="line"></span><br><span class="line"># Location of the api-server</span><br><span class="line">KUBELET_API_SERVER=&quot;--api-servers=http://centos-master:8080&quot;</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBELET_ARGS=&quot;&quot;</span><br></pre></td></tr></table></figure></li>
<li>Configure flannel to overlay Docker network in &#x2F;etc&#x2F;sysconfig&#x2F;flanneld (in all the nodes)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Flanneld configuration options</span><br><span class="line"></span><br><span class="line"># etcd url location.  Point this to the server where etcd runs</span><br><span class="line">FLANNEL_ETCD_ENDPOINTS=&quot;http://centos-master:2379&quot;</span><br><span class="line"></span><br><span class="line"># etcd config key.  This is the configuration key that flannel queries</span><br><span class="line"># For address range assignment</span><br><span class="line">FLANNEL_ETCD_PREFIX=&quot;/kube-centos/network&quot;</span><br><span class="line"></span><br><span class="line"># Any additional options that you want to pass</span><br><span class="line">#FLANNEL_OPTIONS=&quot;&quot;</span><br></pre></td></tr></table></figure></li>
<li>Start the appropriate services on node (centos-minion-n).<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for SERVICES in kube-proxy kubelet flanneld docker; do</span><br><span class="line">    systemctl restart $SERVICES</span><br><span class="line">    systemctl enable $SERVICES</span><br><span class="line">    systemctl status $SERVICES</span><br><span class="line">done</span><br></pre></td></tr></table></figure></li>
<li>Configure kubectl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster default-cluster --server=http://centos-master:8080</span><br><span class="line">kubectl config set-context default-context --cluster=default-cluster --user=default-admin</span><br><span class="line">kubectl config use-context default-context</span><br></pre></td></tr></table></figure>
You should be finished!</li>
<li>Check to make sure the cluster can see the node (on centos-master)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME                   STATUS     AGE     VERSION</span><br><span class="line">centos-minion-1        Ready      3d      v1.6.0+fff5156</span><br><span class="line">centos-minion-2        Ready      3d      v1.6.0+fff5156</span><br><span class="line">centos-minion-3        Ready      3d      v1.6.0+fff5156</span><br></pre></td></tr></table></figure>
The cluster should be running! Launch a test pod.<br>Support Level</li>
</ul>
<p>IaaS Provider	Config. Mgmt	OS	Networking	Docs	Conforms	Support Level<br>Bare-metal	custom	CentOS	flannel	docs	 	Community (@coolsvap)<br>For support level information on all solutions, see the Table of solutions chart.<br>Create an Issue Edit this Page</p>
<h3 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h3><p>跨节点无法通信</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line">iptables -F</span><br><span class="line">iptables -L -n</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Gitlab%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0Nginx.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Gitlab%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0Nginx.html" class="post-title-link" itemprop="url">Gitlab使用本地Nginx</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="配置文件编辑"><a href="#配置文件编辑" class="headerlink" title="配置文件编辑"></a>配置文件编辑</h3><p>vi &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb </p>
<ul>
<li>添加：<code>nginx[&#39;enable&#39;] = false</code></li>
<li>Set the username of the non-bundled web-server user 设置gitlab的用户名为你的webserver(也就是我的ngxin)的用户名还是在gitlab.rb中添加：<code>web_server[&#39;external_users&#39;] = [&#39;nginx&#39;]</code>(因为我的nginx的username是‘nginx’)</li>
<li><code>gitlab_rails[&#39;trusted_proxies&#39;] = [ &#39;127.0.0.1&#39; ]</code></li>
<li><code>gitlab_workhorse[&#39;listen_network&#39;] = &quot;tcp&quot;</code></li>
<li><code>gitlab_workhorse[&#39;listen_addr&#39;] = &quot;127.0.0.1:8181&quot;</code></li>
</ul>
<p>我们重载配置文件,执行命令：<code>gitlab-ctl reconfigure</code>等待完成。<code>gitlab-ctl start/stop</code>分别是启动和停止命令</p>
<h3 id="nginx配置文件"><a href="#nginx配置文件" class="headerlink" title="nginx配置文件"></a>nginx配置文件</h3><p>增加一个站点即可，注意监听的是之前配置的8181端口。<br><img src="https://img.mknight.cn/medivh/1547453735621.png" /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/request_time%E5%92%8Cupstream_response_time%E7%9A%84%E5%8C%BA%E5%88%AB.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/request_time%E5%92%8Cupstream_response_time%E7%9A%84%E5%8C%BA%E5%88%AB.html" class="post-title-link" itemprop="url">request_time和upstream_response_time的区别</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>一个正常的请求过程如下：</p>
<ol>
<li>用户发出请求</li>
<li>建立NGINX连接</li>
<li>发送响应</li>
<li>接收程序的响应数据</li>
<li>关闭NGINX连接</li>
</ol>
<p><strong>request_time</strong><br>request processing time in seconds with a milliseconds resolution; time elapsed between the first bytes were read from the client and the log write after the last bytes were sent to the client.</p>
<p>指的就是从接受用户请求的第一个字节到发送完响应数据的时间，即包括接收请求数据时间、程序响应时间、输出响应数据时间。<br>对于此部分对应的是1+2+3+4+5。</p>
<p><strong>upstream_response_time</strong><br>keeps times of responses obtained from upstream servers; times are kept in seconds with a milliseconds resolution. Several response times are separated by commas and colons like addresses in the $upstream_addr variable.<br>是指从Nginx向后端（php-cgi)建立连接开始到接受完数据然后关闭连接为止的时间。<br>对于此部分对应的是2+3+4+5。</p>
<p>从上面的描述可以看出，<code>$request_time</code>肯定大于等于<code>$upstream_response_time</code>，特别是使用POST方式传递参数时，因为Nginx会把<code>request body</code>缓存住，接受完毕后才会把数据一起发给后端。所以如果用户网络较差，或者传递数据较大时，<code>$request_time</code>会比<code>$upstream_response_time</code>大很多。</p>
<p>如果要从access_log中查看较慢的接口的话，可以在<code>log_format</code>中加入<code>$upstream_response_time</code>。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>从网上看到下列一组图片，感觉画的很形象。</p>
<ul>
<li><code>request_time</code>是从接收到客户端的第一个字节开始，到把所有的响应数据都发送完为止。<br><img src="https://img.mknight.cn/medivh/1637907742862.png" alt="1637907742862.png"></li>
<li><code>upstream_response_time</code>是从与后端建立TCP连接开始到接收完响应数据并关闭连接为止。<br><img src="https://img.mknight.cn/medivh/1637907762851.png" alt="1637907762851.png"></li>
</ul>
<p>所以，<code>request_time</code>会大于等于<code>upstream_response_time</code>。</p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p>对于较高的request—_time很可能是由于连接速度较慢的客户端造成的，对此无能为力，但是较高的request_time并不代表服务器或者程序的性能不够。总体来说，没必要在request_time上花费较多时间，而是应该重点关注upstream_response_time。</p>
<h3 id="nginx-log-format"><a href="#nginx-log-format" class="headerlink" title="nginx log_format"></a>nginx log_format</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_addr</span>,<span class="variable">$http_x_forwarded_for</span>  <span class="comment">#记录客户端IP地址</span></span><br><span class="line"><span class="variable">$remote_user</span>   <span class="comment">#记录客户端用户名称</span></span><br><span class="line"><span class="variable">$request</span>       <span class="comment">#记录请求的URL和HTTP协议</span></span><br><span class="line"><span class="variable">$status</span>        <span class="comment">#记录请求状态</span></span><br><span class="line"><span class="variable">$body_bytes_sent</span>  <span class="comment">#发送给客户端的字节数，不包括响应头的大小；该变量与Apache模块mod_log_config李的“%B”参数兼容</span></span><br><span class="line"><span class="variable">$bytes_sent</span>    <span class="comment">#发送给客户端的总字节数</span></span><br><span class="line"><span class="variable">$connection</span>    <span class="comment">#连接到序列号</span></span><br><span class="line"><span class="variable">$connection_requests</span> <span class="comment">#当前通过一个链接获得的请求数量</span></span><br><span class="line"><span class="variable">$msec</span>       <span class="comment">#日志写入时间，单位为秒精度是毫秒。</span></span><br><span class="line"><span class="variable">$pipe</span>       <span class="comment">#如果请求是通过HTTP流水线(pipelined)发送，pipe值为“p”,否则为&quot;.&quot;.</span></span><br><span class="line"><span class="variable">$http_referer</span>  <span class="comment">#记录从那个页面链接访问过来的</span></span><br><span class="line"><span class="variable">$http_user_agent</span>  <span class="comment">#记录客户端浏览器相关信息</span></span><br><span class="line"><span class="variable">$request_length</span>   <span class="comment">#请求的长度（包括请求行，请求头和请求正文）。</span></span><br><span class="line"><span class="variable">$request_time</span> <span class="comment">#请求处理时间，单位为秒，精度毫秒；从读入客户端的第一个字节开始，知道把最后一个字符发送给客户端后进行日志写入位置。</span></span><br><span class="line"><span class="variable">$time_iso8601</span> ISO8601标准格式下的本地时间</span><br><span class="line"><span class="variable">$time_local</span>  <span class="comment">#通用日志格式下的本地时间</span></span><br></pre></td></tr></table></figure>

<h2 id="NGINX的文件传输"><a href="#NGINX的文件传输" class="headerlink" title="NGINX的文件传输"></a>NGINX的文件传输</h2><h3 id="sendile"><a href="#sendile" class="headerlink" title="sendile"></a>sendile</h3><p>参数sendfile on 用于开启文件高效传输模式，同时配合tcp_nopush on 和tcp_nodelay on 两个指令，可防止网络及磁盘I&#x2F;O阻塞，提升Nginx工作效率。但需要注意的是，linux内核版本2.5.9以后的版本中两者是可以兼容的。</p>
<p>三个指令都开启的好处是，sendfile可以开启高效的文件传输模式，tcp_nopush开启可以确保在发送到客户端之前数据包已经充分“填满”， 这大大减少了网络开销，并加快了文件发送的速度。 然后，当它到达最后一个可能因为没有“填满”而暂停的数据包时，Nginx会忽略tcp_nopush参数， 然后，tcp_nodelay强制套接字发送数据。</p>
<p><img src="https://img.mknight.cn/medivh/1637918539854.png" alt="1637918539854.png"></p>
<h3 id="tcp-nopush"><a href="#tcp-nopush" class="headerlink" title="tcp_nopush"></a>tcp_nopush</h3><p>当有数据时，先别着急发送, 确保数据包已经装满数据, 避免了网络拥塞。需要我们等到数据量达到最大时才通过网络一次发送全部数据，这种数据传输方式有益于大量数据的通信性能，典型的应用就是文件服务器。<br>对于nginx配置文件中的tcp_nopush，默认就是tcp_nopush,不需要特别指定，这个选项对于www，ftp等大文件很有帮助。</p>
<h3 id="tcp-nodelay"><a href="#tcp-nodelay" class="headerlink" title="tcp_nodelay"></a>tcp_nodelay</h3><p>有时要抓紧发货, 确保数据尽快发送, 提高可数据传输效率。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>平时对request_time和upstream_response_time这两个参数没什么研究，关注的不多，主要关注request_time。但是最近阿里云的日志服务统计数据出现了异常，request_time和upstream_response_time的值完全违反了字段定义的原则。理论上request_time无论如何也会大于upstream_response_time的，但是客服死活不承认。无奈之下，好好研究一番，通过阿里云官网文档截图和历史正常数据已经现在的异常数据，客服最终承认存在问题，表示整改。<br>事实证明，阿里云的客服技术水平也是良莠不齐。</p>
<p>经过此次事件，也遇到了一些Markdown语法的问题，不过幸运的是vs code提供了很多帮助，能直接定位到问题，而对应的问题都有参考方案。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_log_module.html">ngx_http_log_module</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/DavidAnson/markdownlint/blob/v0.24.0/doc/Rules.md">https://github.com/DavidAnson/markdownlint/blob/v0.24.0/doc/Rules.md</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Mac%20%E5%88%9D%E5%A7%8B%E5%8C%96%E7%8E%AF%E5%A2%83.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Mac%20%E5%88%9D%E5%A7%8B%E5%8C%96%E7%8E%AF%E5%A2%83.html" class="post-title-link" itemprop="url">Mac 初始化环境</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>很多时候，没有人愿意重装系统，除非万不得已。<br>在拥有一台刚初始化操作系统后的笔记本后，停下来想一想自己要做什么。</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li>安装优秀的终端管理工具iTerm2&#x2F;zsh以及包管理工具homebrew</li>
<li>安装开发环境<ul>
<li>Python<ul>
<li>pip</li>
<li>virtualenv</li>
</ul>
</li>
<li>redis</li>
<li>mysql</li>
<li>nginx</li>
</ul>
</li>
<li>其他常用软件<ul>
<li>KVM管理工具</li>
<li>图床</li>
</ul>
</li>
</ol>
<h2 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h2><h3 id="iterm2"><a href="#iterm2" class="headerlink" title="iterm2"></a>iterm2</h3><p>安装<br><a target="_blank" rel="noopener" href="https://img.mknight.cn/iTerm2-3_4_10.zip">https://img.mknight.cn/iTerm2-3_4_10.zip</a></p>
<h3 id="brew"><a href="#brew" class="headerlink" title="brew"></a>brew</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="brew的备份和恢复"><a href="#brew的备份和恢复" class="headerlink" title="brew的备份和恢复"></a>brew的备份和恢复</h4><p>homebrew-bundle可以帮助我们备份已安装的包和app们，这样我们在重装系统或者换电脑后可以一键恢复安装，节省时间。</p>
<ul>
<li>–describe代表会加上包的描述</li>
<li>–force代表覆盖已有的文件</li>
<li>–file指定输出文件</li>
</ul>
<p>参考示例：<br>备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew bundle dump --describe --force --all --file=&quot;~/Desktop/Brewfile&quot;</span><br></pre></td></tr></table></figure>

<p>恢复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 安装 mas</span><br><span class="line">brew install mas</span><br><span class="line"># 批量安装软件 </span><br><span class="line">brew bundle --file=&quot;~/Desktop/Brewfile&quot;</span><br></pre></td></tr></table></figure>

<h3 id="zsh"><a href="#zsh" class="headerlink" title="zsh"></a>zsh</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;</span><br><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure>

<h4 id="bash-zsh切换"><a href="#bash-zsh切换" class="headerlink" title="bash&#x2F;zsh切换"></a>bash&#x2F;zsh切换</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh</span><br></pre></td></tr></table></figure>

<p><img src="https://img.mknight.cn/medivh/1632292508749.png" alt="1632292508749.png"></p>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><h4 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo easy_install pip</span><br><span class="line">sudo pip install requests</span><br></pre></td></tr></table></figure>

<h4 id="pip源"><a href="#pip源" class="headerlink" title="pip源"></a>pip源</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">豆瓣 https://pypi.douban.com/simple</span><br><span class="line">阿里云 https://mirrors.aliyun.com/pypi/simple</span><br><span class="line">清华大学 https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">中国科学技术大学 https://pypi.mirrors.ustc.edu.cn/simple</span><br><span class="line">中国科技大学 https://pypi.mirrors.ustc.edu.cn/simple</span><br><span class="line">官方 https://pypi.python.org/simple/</span><br></pre></td></tr></table></figure>

<h4 id="pip-加速"><a href="#pip-加速" class="headerlink" title="pip 加速"></a>pip 加速</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">format = columns</span><br></pre></td></tr></table></figure>

<p>插件目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/medivh/.oh-my-zsh/plugins</span><br></pre></td></tr></table></figure>

<h4 id="virtualenv"><a href="#virtualenv" class="headerlink" title="virtualenv"></a>virtualenv</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pip install virtualenv</span><br><span class="line"># 不安装任何第三方包</span><br><span class="line">virtualenv --no-site-packages venv </span><br><span class="line"></span><br><span class="line"># 指定版本</span><br><span class="line">virtualenv -p /usr/bin/python2.7 venv</span><br><span class="line"></span><br><span class="line">#激活虚拟环境</span><br><span class="line">source venv/bin/activate</span><br><span class="line"></span><br><span class="line">#推出虚拟环境</span><br><span class="line">deactivate</span><br></pre></td></tr></table></figure>

<h4 id="Mac-redis"><a href="#Mac-redis" class="headerlink" title="Mac redis"></a>Mac redis</h4><p><code>brew install redis</code><br>开机启动<br><code>brew services start redis</code></p>
<p>配置文件<br><code>/usr/local/etc/redis.conf</code></p>
<p>编辑配置文件 配置后台运行<br><code>daemonize yes</code></p>
<p>服务端启动及查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server /usr/local/etc/redis.conf</span><br><span class="line">ps aux | grep redis</span><br></pre></td></tr></table></figure>

<p>客户端调用<br><code>redis-cli</code></p>
<p>给redis设置密码<br>打开redis.conf文件，找到以下配置项<br><code># requirepass foobared</code><br>更改为<br><code>requirepass 你的密码</code><br>注意：由于上诉操作更改了redis.conf文件，所以下次再启动的时候，要手动加载一下redis.conf文件。例如<br>进入到redis根目录，启动如下<br><code>redis-server /usr/local/etc/redis.conf</code></p>
<h2 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h2><h3 id="Markdown-图床"><a href="#Markdown-图床" class="headerlink" title="Markdown 图床"></a>Markdown 图床</h3><p>参考<a target="_blank" rel="noopener" href="http://mknight.cn/markdown%20%E5%9B%BE%E5%BA%8A%E7%94%9F%E6%88%90.html">http://mknight.cn/markdown%20%E5%9B%BE%E5%BA%8A%E7%94%9F%E6%88%90.html</a></p>
<h3 id="vs-code"><a href="#vs-code" class="headerlink" title="vs code"></a>vs code</h3><ul>
<li>安装vs code</li>
<li>安装插件 markdownlint evermonkey</li>
<li>配置插件-印象笔记<ul>
<li>命令行输入 ever tokent，然后分别粘贴evermonkey.token, evermonkey.noteStoreUrl</li>
<li>新建笔记 option+n</li>
<li>推送笔记 option+</li>
</ul>
</li>
</ul>
<h3 id="hexo-环境"><a href="#hexo-环境" class="headerlink" title="hexo 环境"></a>hexo 环境</h3><p>参考<a target="_blank" rel="noopener" href="http://mknight.cn/Hexo-%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E6%90%AD%E5%BB%BA.html">http://mknight.cn/Hexo-%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E6%90%AD%E5%BB%BA.html</a></p>
<h3 id="Mac-kvm"><a href="#Mac-kvm" class="headerlink" title="Mac kvm"></a>Mac kvm</h3><p><a target="_blank" rel="noopener" href="https://github.com/jeffreywildman/homebrew-virt-manager.git">https://github.com/jeffreywildman/homebrew-virt-manager.git</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">brew tap jeffreywildman/homebrew-virt-manager</span><br><span class="line">brew install virt-manager virt-viewer</span><br><span class="line"></span><br><span class="line">#使用</span><br><span class="line">virt-manager -c &#x27;qemu+ssh://user@libvirthost/system?socket=/var/run/libvirt/libvirt-sock&#x27;</span><br><span class="line">virt-viewer -c &#x27;qemu+ssh://user@libvirthost/system?socket=/var/run/libvirt/libvirt-sock&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><h3 id="Mac-部分进程负载较高（bird）"><a href="#Mac-部分进程负载较高（bird）" class="headerlink" title="Mac 部分进程负载较高（bird）"></a>Mac 部分进程负载较高（bird）</h3><ul>
<li>关闭iCloud 文稿&#x2F;桌面的备份</li>
<li>从iCloud中复制出来文稿里面的文件，因为关闭同步后文稿会自动清空。其实感觉这个就像软链</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/Mongodb%20%E6%8E%A2%E7%B4%A2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Mongodb%20%E6%8E%A2%E7%B4%A2.html" class="post-title-link" itemprop="url">Mongodb 探索</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>MongoDB是一个跨平台，面向文档的数据库，提供高性能，高可用性和易于扩展。MongoDB是工作在集合和文档上一种概念。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li>支持特别查询在MongoDB中，可以通过字段，范围查询进行搜索，并且还支持正则表达式搜索。</li>
<li>索引可以索引文档中的任何字段。</li>
<li>复制MongoDB支持主从复制。主机可以执行读写操作，从机从主机复制数据，只能用于读取或备份(不写入)</li>
<li>复制数据MongoDB可以在多台服务器上运行。 复制数据以保持系统正常运行，并在硬件故障的情况下保持其运行状态。</li>
<li>负载均衡由于数据放在碎片中，因此具有自动负载平衡配置。</li>
<li>支持映射缩减和聚合工具</li>
<li>使用JavaScript而不是Procedure</li>
<li>它是一个用C++编写的无模式数据库</li>
<li>提供高性能</li>
<li>轻松存储任何大小的文件，而不会使您的堆栈复杂化</li>
<li>在故障的情况下易于管理</li>
<li>它还支持：<ul>
<li>具有动态模式的JSON数据模型</li>
<li>自动分片用于水平可扩展性</li>
<li>内置复制高可用性</li>
</ul>
</li>
</ul>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>MongoDB 的架构较少。它是一个文档数据库，它的一个集合持有不同的文档。</li>
<li>从一个到另一个的文档的数量，内容和大小可能有差异。</li>
<li>MongoDB 中单个对象的结构很清淅。</li>
<li>MongoDB 中没有复杂的连接。</li>
<li>MongoDB 提供深度查询的功能，因为它支持对文档的强大的动态查询。</li>
<li>MongoDB 很容易扩展。</li>
<li>它使用内部存储器来存储工作集，这是其快速访问的原因。</li>
</ul>
<h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><ul>
<li>大而复杂的数据</li>
<li>移动和社会基础设施数据</li>
<li>内容管理和交付</li>
<li>用户数据管理</li>
<li>数据中心</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.0.6.tgz    # 下载</span><br><span class="line">tar -zxvf mongodb-linux-x86_64-3.0.6.tgz                                   # 解压</span><br><span class="line"></span><br><span class="line">mv  mongodb-linux-x86_64-3.0.6/ /usr/local/mongodb                         # 将解压包拷贝到指定目录</span><br></pre></td></tr></table></figure>
<p>MongoDB 的可执行文件位于 bin 目录下，所以可以将其添加到 PATH 路径中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=&lt;mongodb-install-directory&gt;/bin:$PATH</span><br></pre></td></tr></table></figure>
<p><mongodb-install-directory> 为你 MongoDB 的安装路径。如本文的 &#x2F;usr&#x2F;local&#x2F;mongodb 。</p>
<h3 id="创建数据库目录"><a href="#创建数据库目录" class="headerlink" title="创建数据库目录"></a>创建数据库目录</h3><p>MongoDB的数据存储在data目录的db目录下，但是这个目录在安装过程不会自动创建，所以你需要手动创建data目录，并在data目录中创建db目录。</p>
<p>以下实例中我们将data目录创建于根目录下(&#x2F;)。</p>
<p>注意：&#x2F;data&#x2F;db 是 MongoDB 默认的启动的数据库路径(–dbpath)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/db</span><br></pre></td></tr></table></figure>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>可以在命令行中执行mongo安装目录中的bin目录执行mongod命令来启动mongdb服务。如果你的数据库目录不是&#x2F;data&#x2F;db，可以通过 –dbpath 来指定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./mongod</span><br></pre></td></tr></table></figure>
<h3 id="启动参数"><a href="#启动参数" class="headerlink" title="启动参数"></a>启动参数</h3><ul>
<li>–dbpath 指定数据目录，默认是&#x2F;data&#x2F;db,每个mongod进程都需要独立的数据目录</li>
<li>–port 指定服务器监听端口，默认27017</li>
<li>–fork 以守护进程的方式运行服务</li>
<li>–logpath 指定输出日志的路径，而不是输出到命令行</li>
<li>–config 指定配置文件</li>
</ul>
<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><ul>
<li>查看进程，使用kill命令</li>
<li>在客户端进去，使用db.shutdownServer()</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show dbs;</span><br><span class="line">#查看数据库</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546668277063.png" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use wesure;</span><br><span class="line">#切换或者创建（如果没有该库的话）</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.getName();</span><br><span class="line">#db; db和getName方法是一样的效果，都可以查询当前使用的数据库</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546668518239.png" />

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.stats();</span><br><span class="line">#查看数据库状态</span><br></pre></td></tr></table></figure>
<img src="https://img.mknight.cn/medivh/1546668460378.png" />

<h3 id="用户相关"><a href="#用户相关" class="headerlink" title="用户相关"></a>用户相关</h3><p>1、添加一个用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.addUser(&quot;name&quot;);</span><br><span class="line"></span><br><span class="line">db.addUser(&quot;userName&quot;, &quot;pwd123&quot;, true); 添加用户、设置密码、是否只读</span><br></pre></td></tr></table></figure>
<p>2、数据库认证、安全模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.auth(&quot;userName&quot;, &quot;123123&quot;);</span><br></pre></td></tr></table></figure>
<p>3、显示当前所有用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show users;</span><br></pre></td></tr></table></figure>
<p>4、删除用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.removeUser(&quot;userName&quot;);</span><br></pre></td></tr></table></figure>
<p>其他</p>
<ul>
<li>查询之前的错误信息<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.getPrevError();</span><br></pre></td></tr></table></figure></li>
<li>清除错误记录<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.resetError();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="克隆"><a href="#克隆" class="headerlink" title="克隆"></a>克隆</h3><p>使用copyDatabase命令实现数据库复制，可以在几秒内创建数据库副本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.copyDatabase(fromdb, todb, fromhost, username, password, mechanism)¶</span><br></pre></td></tr></table></figure>

<img src="https://img.mknight.cn/medivh/1630924290229.png"  />


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@gz-tencent mongo]# mongo localhost:27018</span><br><span class="line">&gt; db.copyDatabase(&quot;backup&quot;,&quot;backup&quot;,&quot;xxx.x.x.x:27017&quot;);</span><br><span class="line">WARNING: db.copyDatabase is deprecated. See http://dochub.mongodb.org/core/copydb-clone-deprecation</span><br><span class="line">&#123;</span><br><span class="line">    &quot;note&quot; : &quot;Support for the copydb command has been deprecated. See http://dochub.mongodb.org/core/copydb-clone-deprecation&quot;,</span><br><span class="line">    &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，执行后不会立刻展示正确的容量大小，取决于数据库实际的大小和网速。另外4.0以后的版本以及不能使用该命令了。</p>
<blockquote>
<p>IMPORTANT<br>Starting in version 4.2, MongoDB removes the copydb command. The deprecated db.copyDatabase(), which wraps the copydb command, can only be run against MongoDB 4.0 or earlier versions. For behavior and examples, refer to the 4.0 or earlier version of the manual.<br>For an alternative in version 4.2+, see Copy&#x2F;Clone a Database. </p>
</blockquote>
<h4 id="4-2-copy-clone"><a href="#4-2-copy-clone" class="headerlink" title="4.2 copy&#x2F;clone"></a>4.2 copy&#x2F;clone</h4><p>As an alternative, users can use mongodump and mongorestore (with the mongorestore options –nsFrom and –nsTo).</p>
<p>For example, to copy the test database from a local instance running on the default port 27017 to the examples database on the same instance, you can:</p>
<ol>
<li>Use mongodump to dump the test database to an archive mongodump-test-db:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodump --archive=&quot;mongodump-test-db&quot; --db=test</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Use mongorestore with –nsFrom and –nsTo to restore (with database name change) from the archive:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongorestore --archive=&quot;mongodump-test-db&quot; --nsFrom=&#x27;test.*&#x27; --nsTo=&#x27;examples.*&#x27;</span><br></pre></td></tr></table></figure>

<p>简单来说分为两步，首先dump导出，然后restore恢复，也可以指定源空间和目标空间。</p>
<h4 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h4><p>The canonical name for a collection or index in MongoDB. The namespace is a combination of the database name and the name of the collection or index, like so: [database-name].[collection-or-index-name]. All documents belong to a namespace. See Namespaces.</p>
<p>规范的命名是集合或者索引在MongoDB中。命名空间是由数据库名和集合或者索引共同组成。</p>
<h4 id="database"><a href="#database" class="headerlink" title="database"></a>database</h4><p>A physical container for collections. Each database gets its own set of files on the file system. A single MongoDB server typically has multiple databases.</p>
<p>一种存放集合的物理容器。每个数据库在文件系统都有自己的文件。单个MongoDB服务可以有多个数据库。</p>
<h4 id="journal"><a href="#journal" class="headerlink" title="journal"></a>journal</h4><p>A sequential, binary transaction log used to bring the database into a valid state in the event of a hard shutdown. Journaling writes data first to the journal and then to the core data files. MongoDB enables journaling by default for 64-bit builds of MongoDB version 2.0 and newer. Journal files are pre-allocated and exist as files in the data directory. See Journaling.</p>
<p>一种连续的，二进制不间断的日志用来数据库有效状态记录事件在硬件宕机的时候。</p>
<h4 id="数据文件类型"><a href="#数据文件类型" class="headerlink" title="数据文件类型"></a>数据文件类型</h4><ol>
<li>journal 日志文件</li>
<li>namespace 表名文件</li>
<li>data 数据及索引文件</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/introduction/">https://docs.mongodb.com/manual/introduction/</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/markdown%20%E5%9B%BE%E5%BA%8A%E7%94%9F%E6%88%90.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/markdown%20%E5%9B%BE%E5%BA%8A%E7%94%9F%E6%88%90.html" class="post-title-link" itemprop="url">Markdown 图床设置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B9%90%E8%B6%A3/" itemprop="url" rel="index"><span itemprop="name">乐趣</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="七牛云"><a href="#七牛云" class="headerlink" title="七牛云"></a>七牛云</h2><p>安装requests库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install requests</span><br></pre></td></tr></table></figure>
<h4 id="获取图床信息"><a href="#获取图床信息" class="headerlink" title="获取图床信息"></a>获取图床信息</h4><p>选择新建存储空间，记住这个空间的名字。</p>
<img src="https://img.mknight.cn/blog/1545128054650.png"/>


<h4 id="获取访问域名"><a href="#获取访问域名" class="headerlink" title="获取访问域名"></a>获取访问域名</h4><img src="https://img.mknight.cn/blog/1545128359995.png" />

<p>注意该测试域名有效期30天，并且每天限流30G，也足够测试使用啦，以后最好还是绑定自己的域名。</p>
<h4 id="图床认证信息"><a href="#图床认证信息" class="headerlink" title="图床认证信息"></a>图床认证信息</h4><p>获取AK和SK</p>
<img src="https://img.mknight.cn/blog/1545128556695.png" />

<h2 id="Alfred"><a href="#Alfred" class="headerlink" title="Alfred"></a>Alfred</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载地址<br><a target="_blank" rel="noopener" href="https://img.mknight.cn/alfred%203.0.3.dmg">https://img.mknight.cn/alfred%203.0.3.dmg</a><br>提取码<code>wkem</code> 必须得激活，不然用不了workflow.</p>
<p>OS X 10.14 激活参考<a target="_blank" rel="noopener" href="https://img.mknight.cn/alfred_3.0_CORE%20Keygen.app.zip">https://img.mknight.cn/alfred_3.0_CORE%20Keygen.app.zip</a></p>
<p>今天试了一下MacBook Pro 2021 版本的也没啥问题。</p>
<h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><p>下载地址<br><a target="_blank" rel="noopener" href="https://img.mknight.cn/markdown_img.alfredworkflow">https://img.mknight.cn/markdown_img.alfredworkflow</a> </p>
<h3 id="workflow-1"><a href="#workflow-1" class="headerlink" title="workflow"></a>workflow</h3><p>在 alfred 里面输入mdimgsetup,就会弹出一个文本文档，如下：<br><img src="https://img.mknight.cn/medivh/1545129537529.png" /></p>
<ul>
<li>ak&#x2F;sk</li>
<li>URL改为自己的域名或者测试域名</li>
<li>bucket就是刚才创建的，注意保持一致</li>
</ul>
<h3 id="调整URL"><a href="#调整URL" class="headerlink" title="调整URL"></a>调整URL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># coding: utf-8</span><br><span class="line">from clipboard import get_paste_img_file</span><br><span class="line">from upload import upload_qiniu</span><br><span class="line">import util</span><br><span class="line">import os</span><br><span class="line">import subprocess</span><br><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if not os.path.exists(util.CONFIG_FILE):</span><br><span class="line">    util.generate_config_file()</span><br><span class="line"></span><br><span class="line">config = util.read_config()</span><br><span class="line">if not config:</span><br><span class="line">    util.notice(&#x27;请先设置你的七牛图床信息&#x27;)</span><br><span class="line">    util.open_with_editor(util.CONFIG_FILE)</span><br><span class="line">    sys.exit(0)</span><br><span class="line"></span><br><span class="line">url = &#x27;%s/%s&#x27; % (config[&#x27;url&#x27;], config[&#x27;prefix&#x27;])</span><br><span class="line"></span><br><span class="line">img_file, need_format, format = get_paste_img_file()</span><br><span class="line">if img_file:</span><br><span class="line">    # has image</span><br><span class="line"></span><br><span class="line">    # use time to generate a unique upload_file name, we can not use the tmp file name</span><br><span class="line">    upload_name = &quot;%s.%s&quot; % (int(time.time() * 1000), format)</span><br><span class="line">    if need_format:</span><br><span class="line">        size_str = subprocess.check_output(&#x27;sips -g pixelWidth %s | tail -n1 | cut -d&quot; &quot; -f4&#x27; % img_file.name, shell=True)</span><br><span class="line">        size = int(size_str.strip()) / 2</span><br><span class="line">        markdown_url = &#x27;&lt;img src=&quot;%s/%s&quot;  /&gt;&#x27; % (url, upload_name)</span><br><span class="line">    else:</span><br><span class="line">        markdown_url = &#x27;%s/%s&#x27; % (url, upload_name)</span><br><span class="line"></span><br><span class="line">    # make it to clipboard</span><br><span class="line">    os.system(&quot;echo &#x27;%s&#x27; | pbcopy&quot; % markdown_url)</span><br><span class="line">    os.system(&#x27;osascript -e \&#x27;tell application &quot;System Events&quot; to keystroke &quot;v&quot; using command down\&#x27;&#x27;)</span><br><span class="line">    upload_file = util.try_compress_png(img_file, format!=&#x27;gif&#x27;)</span><br><span class="line">    if not upload_qiniu(upload_file.name, upload_name): util.notice(&quot;上传图片到图床失败，请检查网络后重试&quot;)</span><br><span class="line">else:</span><br><span class="line">    util.notice(&quot;剪切版里没有图片！&quot;)</span><br></pre></td></tr></table></figure>
<p>根据个人需求，设置markdown_url拼接格式。如果出现什么问题，而且没有弹窗就再次导入alfed文件。</p>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><p>###截图<br>使用任意截图工具截图之后，在任意编辑器里面你需要插入markdown格式图片的地方，按下cmd + ctrl + P即可！</p>
<h3 id="已有图片"><a href="#已有图片" class="headerlink" title="已有图片"></a>已有图片</h3><p>如果你已经有一张图片了，希望上传到图床得到一个链接；通常的方式需要图床客户端或者浏览器插件，通过这个alfred插件：<br>直接复制本地图片，然后按下cmd + ctrl + P 就能得到图床的链接！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://econow.cn/%E4%B8%80%E4%B8%AAFlask%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="medivh">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Medivh's castle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Medivh's castle">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%B8%80%E4%B8%AAFlask%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html" class="post-title-link" itemprop="url">一个Flask项目经验总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-10-30 17:45:56" itemprop="dateCreated datePublished" datetime="2023-10-30T17:45:56+08:00">2023-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题整理"><a href="#问题整理" class="headerlink" title="问题整理"></a>问题整理</h2><h3 id="Error-While-importing-‘run-app-dev’-an-ImportError-was-raised"><a href="#Error-While-importing-‘run-app-dev’-an-ImportError-was-raised" class="headerlink" title="Error: While importing ‘run_app_dev’, an ImportError was raised"></a>Error: While importing ‘run_app_dev’, an ImportError was raised</h3><p>网上说是循环调用的问题，但这个项目在我笔记本上是可以运行的，怀疑是不是flask的版本问题，因为我直接安装了最新的flask&#x3D;&#x3D;2.0.2，把最新的flask卸载后，安装1.1.2的flask 此问题解决。</p>
<h3 id="当flask-migrate没有MigrateCommand时"><a href="#当flask-migrate没有MigrateCommand时" class="headerlink" title="当flask_migrate没有MigrateCommand时"></a>当flask_migrate没有MigrateCommand时</h3><p>出现这个情况的原因是最新的flask_migrate，已经去除了MigrateCommand，可以直接在命令行中使用,如果需要使用MigrateCommand的话:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">可用 pip install flask_migrate==xx 命令</span><br><span class="line">把flask_migrate降低一个版本</span><br><span class="line">这里用的2.7.0版本的把问题解决了</span><br></pre></td></tr></table></figure>

<h3 id="ModuleNotFoundError-No-module-named-‘Crypto’解决方案"><a href="#ModuleNotFoundError-No-module-named-‘Crypto’解决方案" class="headerlink" title="ModuleNotFoundError: No module named ‘Crypto’解决方案"></a>ModuleNotFoundError: No module named ‘Crypto’解决方案</h3><p>方案一：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 uninstall pycryptodome</span><br><span class="line">pip3 uninstall crypto</span><br><span class="line">Pip3 install pycrypto</span><br></pre></td></tr></table></figure>

<p>方案二：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Pip3 install pycrypto</span><br><span class="line"><span class="comment">#然后手动修改 site-packages/crypto 目录改为Crypto即可</span></span><br></pre></td></tr></table></figure>

<h3 id="如何转义JSON"><a href="#如何转义JSON" class="headerlink" title="如何转义JSON"></a>如何转义JSON</h3><p>飞书更新的接口文档，要求卡片信息格式必须为转移后的JSON，和普通JSON的区别就是必须加转义符“\”。这个就很麻烦了。<br>实现方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">s1 = &#123;<span class="string">&quot;elements&quot;</span>:[&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hi&quot;</span>,<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;markdown&quot;</span>&#125;,&#123;<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;hr&quot;</span>&#125;,&#123;<span class="string">&quot;elements&quot;</span>:[&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;hi text&quot;</span>,<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;plain_text&quot;</span>&#125;],<span class="string">&quot;tag&quot;</span>:<span class="string">&quot;note&quot;</span>&#125;]&#125;</span><br><span class="line">s2 = json.dumps(s1)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(s2))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印结果</span></span><br><span class="line"><span class="string">&quot;&#123;\&quot;elements\&quot;: [&#123;\&quot;content\&quot;: \&quot;hi\&quot;, \&quot;tag\&quot;: \&quot;markdown\&quot;&#125;, &#123;\&quot;tag\&quot;: \&quot;hr\&quot;&#125;, &#123;\&quot;elements\&quot;: [&#123;\&quot;content\&quot;: \&quot;hi text\&quot;, \&quot;tag\&quot;: \&quot;plain_text\&quot;&#125;], \&quot;tag\&quot;: \&quot;note\&quot;&#125;]&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>简单来说就是通过两次<code>json.dumps()</code>来实现自动增加转义符的。</p>
<h3 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h3><p>在模糊查询的时候经常会遇到字段不确定的情况，因此使用原生SQL更为简单，并且能结合模糊查询来实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> request.args.get(<span class="string">&#x27;key&#x27;</span>) <span class="keyword">and</span> request.args.get(<span class="string">&#x27;value&#x27;</span>):</span><br><span class="line">    sql = <span class="string">&quot;&quot;&quot;select * from user where %s like &#x27;%s&#x27;&quot;&quot;&quot;</span> % (key, <span class="string">&quot;%&quot;</span> + value + <span class="string">&quot;%&quot;</span>)</span><br><span class="line">    c = db.session.execute(sql).fetchall()</span><br><span class="line">    <span class="keyword">if</span> c:</span><br><span class="line">        res_obj = c[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res_obj = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>单独动态查询的话也容易实现，但是模糊查询不太容易结合，只能使用下面的方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">params = &#123;key: value&#125;</span><br><span class="line">res_obj = db.session.query(User).filter_by(**params).<span class="built_in">all</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="二次优化"><a href="#二次优化" class="headerlink" title="二次优化"></a>二次优化</h4><p>将查询记录转变为非list类型的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&quot;&quot;&quot;select * from user where %s like &#x27;%s&#x27;&quot;&quot;&quot;</span> % (key, <span class="string">&quot;%&quot;</span> + value + <span class="string">&quot;%&quot;</span>)</span><br><span class="line">c = db.session.execute(sql).fetchall()</span><br><span class="line"><span class="keyword">if</span> c:</span><br><span class="line">    res_obj = <span class="built_in">tuple</span>(c)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    res_obj = <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增加判断条件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> <span class="built_in">isinstance</span>(res, <span class="built_in">tuple</span>):  <span class="comment"># 针对于模糊查询的情况</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> res:</span><br><span class="line">        lst.append(<span class="built_in">dict</span>(<span class="built_in">zip</span>(col.keys(), col)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当为tuple类型的时候，单独处理，独立于之前的list处理模式。</p>
<h3 id="flask-apscheduler-上下文的问题"><a href="#flask-apscheduler-上下文的问题" class="headerlink" title="flask_apscheduler 上下文的问题"></a>flask_apscheduler 上下文的问题</h3><p>最近调试apscheduler的时候出现以下的错误：</p>
<blockquote>
<p>RuntimeError: Working outside of application context.<br>This typically means that you attempted to use functionality that needed to interface with the current application object in some way. To solve this, set up an application context with app.app_context().  See the documentation for more information.</p>
</blockquote>
<p>其主要原因是由于调用到了公共变量，而flask引入了应用上下文管理，但是并没有获取到上下文导致。<br>解决方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> scheduler</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncAssets</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    同步资产信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> scheduler.app.app_context():</span><br><span class="line">            access_key_id = current_app.config.get(<span class="string">&#x27;ALI_KEY_ID&#x27;</span>)</span><br><span class="line">            access_key = current_app.config.get(<span class="string">&#x27;ALI_KEY&#x27;</span>)</span><br><span class="line">            access_r = current_app.config.get(<span class="string">&#x27;ALI_R&#x27;</span>)</span><br><span class="line">            self.client = AcsClient(access_key_id, access_key, access_r)</span><br></pre></td></tr></table></figure>

<h3 id="vue-时间格式化的问题"><a href="#vue-时间格式化的问题" class="headerlink" title="vue 时间格式化的问题"></a>vue 时间格式化的问题</h3><p>时间格式化处理使用moment.js。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install moment</span><br></pre></td></tr></table></figure>

<p>需要注意在格式化时间戳的时候检查是多少位，考虑是否除以1000和UTC的问题。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://momentjs.cn/">http://momentjs.cn</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17063827号-2 </a>
      <img src="https://beian.miit.gov.cn/#/Integrated/index" alt="">
  </div>
  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">medivh</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
